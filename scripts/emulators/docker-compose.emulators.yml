services:
  localstack:
    image: localstack/localstack:3.5
    container_name: honua-localstack
    ports:
      - "4566:4566"
    environment:
      - SERVICES=s3,secretsmanager,route53
      - AWS_ACCESS_KEY_ID=test
      - AWS_SECRET_ACCESS_KEY=test
      - DEFAULT_REGION=us-east-1
      - LOCALSTACK_AUTH_TOKEN=${LOCALSTACK_AUTH_TOKEN-}
    volumes:
      - localstack-data:/var/lib/localstack
    healthcheck:
      test: ["CMD", "bash", "-c", "awslocal s3 ls || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 10

  azurite:
    image: mcr.microsoft.com/azure-storage/azurite:3.30.0
    container_name: honua-azurite
    command: azurite-blob --blobHost 0.0.0.0 --blobPort 10000
    ports:
      - "10000:10000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:10000/devstoreaccount1?comp=list"]
      interval: 10s
      timeout: 5s
      retries: 10

  gcs:
    image: fsouza/fake-gcs-server:1.52.2
    container_name: honua-gcs
    command:
      - "-scheme"
      - "http"
      - "-backend"
      - "memory"
      - "-host"
      - "0.0.0.0"
      - "-port"
      - "4443"
    ports:
      - "4443:4443"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://127.0.0.1:4443/storage/v1/b"]
      interval: 10s
      timeout: 5s
      retries: 10

  postgres:
    image: postgis/postgis:16-3.4
    container_name: honua-postgis
    environment:
      - POSTGRES_DB=honua
      - POSTGRES_USER=honua
      - POSTGRES_PASSWORD=honua
    ports:
      - "15432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $$POSTGRES_USER -d $$POSTGRES_DB"]
      interval: 10s
      timeout: 5s
      retries: 10
    volumes:
      - postgis-data:/var/lib/postgresql/data

volumes:
  localstack-data:
  postgis-data:
