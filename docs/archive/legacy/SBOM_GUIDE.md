# Honua SBOM Guide

## Overview

This guide explains how to access, verify, and use Software Bill of Materials (SBOM) for Honua container images. SBOMs provide transparency about the software components and dependencies in our images, essential for security compliance and supply chain integrity.

## Table of Contents

- [What is an SBOM?](#what-is-an-sbom)
- [SBOM Formats](#sbom-formats)
- [Accessing SBOMs](#accessing-sboms)
- [Verifying SBOM Attestations](#verifying-sbom-attestations)
- [Using SBOMs for Security](#using-sboms-for-security)
- [Integration with CI/CD](#integration-with-cicd)
- [Troubleshooting](#troubleshooting)

## What is an SBOM?

A Software Bill of Materials (SBOM) is a comprehensive inventory of all components, libraries, and dependencies used in a software application. For Honua, we generate SBOMs at two levels:

1. **Application SBOM**: Lists .NET packages and application dependencies
2. **Container SBOM**: Lists OS packages and container image layers

SBOMs are attached to our container images as OCI artifacts, making them immutable and verifiable through cryptographic signatures.

## SBOM Formats

Honua generates SBOMs in multiple industry-standard formats:

### SPDX (Software Package Data Exchange)
- **Format**: JSON
- **Specification**: SPDX 2.3
- **Use Case**: Industry standard, widely supported
- **Example**: `container-sbom-spdx.json`

```json
{
  "spdxVersion": "SPDX-2.3",
  "dataLicense": "CC0-1.0",
  "name": "Honua Geospatial Server",
  "documentNamespace": "https://honua.io/...",
  "packages": [...]
}
```

### CycloneDX
- **Format**: JSON
- **Specification**: CycloneDX 1.4+
- **Use Case**: Enhanced vulnerability tracking
- **Example**: `honua-cyclonedx.json`

```json
{
  "bomFormat": "CycloneDX",
  "specVersion": "1.4",
  "metadata": {
    "component": {
      "name": "Honua.Server.Host"
    }
  },
  "components": [...]
}
```

### Syft JSON
- **Format**: JSON
- **Specification**: Syft native format
- **Use Case**: Detailed container layer analysis
- **Example**: `container-sbom-syft.json`

## Accessing SBOMs

### Method 1: Download from Container Image (Recommended)

Using Cosign to download the SBOM directly from the container image:

```bash
# Install cosign
curl -O -L "https://github.com/sigstore/cosign/releases/latest/download/cosign-linux-amd64"
sudo mv cosign-linux-amd64 /usr/local/bin/cosign
sudo chmod +x /usr/local/bin/cosign

# Download SBOM
cosign download sbom ghcr.io/honuaio/honua:latest > honua-sbom.json

# View SBOM
cat honua-sbom.json | jq '.'
```

### Method 2: Download from GitHub Releases

SBOMs are attached to GitHub releases:

```bash
# Download from latest release
wget https://github.com/honuaio/honua/releases/latest/download/honua-cyclonedx.json
wget https://github.com/honuaio/honua/releases/latest/download/container-sbom-spdx.json
```

### Method 3: Download from GitHub Actions Artifacts

For specific commits:

1. Navigate to [GitHub Actions](https://github.com/honuaio/honua/actions/workflows/sbom.yml)
2. Click on the workflow run for your commit
3. Download the `sbom-<commit-sha>` artifact

### Method 4: Use the Verification Script

```bash
# Clone repository
git clone https://github.com/honuaio/honua.git
cd honua

# Run verification script
./scripts/verify-sbom.sh latest

# Or specify a version
./scripts/verify-sbom.sh v1.2.3

# Or use a digest
./scripts/verify-sbom.sh sha256:abc123...
```

## Verifying SBOM Attestations

### Verify Cryptographic Signature

Verify that the SBOM was generated by Honua's CI/CD pipeline:

```bash
# Verify image signature
cosign verify ghcr.io/honuaio/honua:latest \
  --certificate-identity-regexp='.*' \
  --certificate-oidc-issuer-regexp='.*'

# Verify SBOM attestation
cosign verify-attestation \
  --type https://spdx.dev/Document \
  ghcr.io/honuaio/honua:latest
```

### Verify SBOM Integrity

Check that the SBOM hasn't been tampered with:

```bash
# Download and verify
cosign verify-attestation \
  --type https://spdx.dev/Document \
  ghcr.io/honuaio/honua:latest | \
  jq -r '.payload | @base64d | fromjson'
```

### Verify Provenance

Verify build provenance (SLSA attestation):

```bash
cosign verify-attestation \
  --type slsaprovenance \
  ghcr.io/honuaio/honua:latest
```

## Using SBOMs for Security

### Vulnerability Scanning

#### Using Grype

```bash
# Install grype
curl -sSfL https://raw.githubusercontent.com/anchore/grype/main/install.sh | sh -s -- -b /usr/local/bin

# Scan SBOM
cosign download sbom ghcr.io/honuaio/honua:latest > sbom.json
grype sbom:sbom.json

# Filter by severity
grype sbom:sbom.json --fail-on critical
```

#### Using Trivy

```bash
# Install trivy
wget -qO - https://aquasecurity.github.io/trivy-repo/deb/public.key | sudo apt-key add -
echo "deb https://aquasecurity.github.io/trivy-repo/deb $(lsb_release -sc) main" | sudo tee -a /etc/apt/sources.list.d/trivy.list
sudo apt-get update
sudo apt-get install trivy

# Scan image
trivy image ghcr.io/honuaio/honua:latest

# Scan SBOM
trivy sbom sbom.json
```

### License Compliance

Extract license information from SBOM:

```bash
# SPDX format
cat sbom-spdx.json | jq -r '.packages[] | "\(.name): \(.licenseConcluded)"'

# CycloneDX format
cat sbom-cyclonedx.json | jq -r '.components[] | "\(.name): \(.licenses[]?.license.id)"'
```

### Dependency Analysis

Find specific packages:

```bash
# Find a package in SPDX
cat sbom-spdx.json | jq '.packages[] | select(.name | contains("netcore"))'

# Find a package in CycloneDX
cat sbom-cyclonedx.json | jq '.components[] | select(.name | contains("System.Text.Json"))'

# Count packages
cat sbom-spdx.json | jq '.packages | length'
```

## Integration with CI/CD

### GitHub Actions

The SBOM workflow runs automatically on:
- Push to `master`, `main`, or `dev` branches
- Release creation
- Manual workflow dispatch

```yaml
# .github/workflows/sbom.yml
name: SBOM Generation & Attestation
on:
  push:
    branches: [ master, dev ]
  release:
    types: [ published ]
```

### Kubernetes Deployment Verification

Add SBOM verification to your deployment pipeline:

```yaml
# kubernetes/verify-sbom-job.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: verify-sbom
spec:
  template:
    spec:
      containers:
      - name: verify
        image: gcr.io/projectsigstore/cosign:latest
        command:
        - cosign
        - verify
        - ghcr.io/honuaio/honua:latest
      restartPolicy: Never
```

### Docker Compose

Verify SBOM before starting services:

```bash
#!/bin/bash
# verify-and-start.sh

IMAGE="ghcr.io/honuaio/honua:latest"

echo "Verifying SBOM for $IMAGE..."
cosign verify "$IMAGE" || exit 1

echo "Downloading SBOM..."
cosign download sbom "$IMAGE" > sbom.json

echo "Scanning for vulnerabilities..."
grype sbom:sbom.json --fail-on high || exit 1

echo "Starting services..."
docker-compose up -d
```

### Terraform

Include SBOM verification in infrastructure deployment:

```hcl
# Verify SBOM before deployment
resource "null_resource" "verify_sbom" {
  provisioner "local-exec" {
    command = "cosign verify ghcr.io/honuaio/honua:${var.image_tag}"
  }
}

resource "aws_ecs_task_definition" "honua" {
  depends_on = [null_resource.verify_sbom]
  # ... rest of configuration
}
```

## Automated SBOM Analysis

### Integration with Dependency-Track

[Dependency-Track](https://dependencytrack.org/) provides continuous monitoring:

```bash
# Upload SBOM to Dependency-Track
curl -X "POST" "https://dependency-track.example.com/api/v1/bom" \
  -H "X-Api-Key: $API_KEY" \
  -H "Content-Type: multipart/form-data" \
  -F "project=$PROJECT_UUID" \
  -F "bom=@container-sbom-cyclonedx.json"
```

### Integration with JFrog Xray

```bash
# Index SBOM in Xray
jfrog rt upload container-sbom-*.json honua-sbom/
```

### Integration with Snyk

```bash
# Test SBOM with Snyk
snyk test --file=sbom-cyclonedx.json --package-manager=deb
```

## SBOM in Air-Gapped Environments

For deployments without internet access:

1. **Download SBOM during build**:
   ```bash
   cosign download sbom ghcr.io/honuaio/honua:latest > honua-sbom.json
   ```

2. **Transfer to air-gapped environment**:
   ```bash
   # Copy SBOM with image
   docker save ghcr.io/honuaio/honua:latest > honua-image.tar
   # Transfer both files
   ```

3. **Verify in air-gapped environment**:
   ```bash
   # Load image
   docker load < honua-image.tar

   # Verify SBOM locally (using pre-downloaded public keys)
   cosign verify-blob --key cosign.pub honua-sbom.json
   ```

## SBOM Policy Enforcement

### Using OPA (Open Policy Agent)

Create policies to enforce SBOM requirements:

```rego
# sbom-policy.rego
package sbom

# Deny images without SBOM attestation
deny[msg] {
  input.attestations.sbom == false
  msg = "Container image must have SBOM attestation"
}

# Deny high-severity vulnerabilities
deny[msg] {
  vuln := input.vulnerabilities[_]
  vuln.severity == "CRITICAL"
  msg = sprintf("Critical vulnerability found: %v", [vuln.id])
}
```

### Using Kyverno

```yaml
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: verify-sbom
spec:
  validationFailureAction: enforce
  rules:
  - name: verify-sbom-attestation
    match:
      resources:
        kinds:
        - Pod
    verifyImages:
    - image: "ghcr.io/honuaio/honua:*"
      attestations:
      - type: https://spdx.dev/Document
```

## Monitoring and Alerting

### Set up alerts for new vulnerabilities

```bash
# Continuous monitoring script
#!/bin/bash
while true; do
  cosign download sbom ghcr.io/honuaio/honua:latest > current-sbom.json

  # Check for new vulnerabilities
  NEW_VULNS=$(grype sbom:current-sbom.json --only-fixed -o json | jq '.matches | length')

  if [ "$NEW_VULNS" -gt 0 ]; then
    # Send alert
    curl -X POST https://alerts.example.com/webhook \
      -d "New vulnerabilities found: $NEW_VULNS"
  fi

  sleep 3600  # Check hourly
done
```

## Compliance Reporting

### Generate compliance report

```bash
#!/bin/bash
# compliance-report.sh

IMAGE="ghcr.io/honuaio/honua:latest"

echo "=== Honua SBOM Compliance Report ===" > report.txt
echo "Date: $(date)" >> report.txt
echo "Image: $IMAGE" >> report.txt
echo "" >> report.txt

# Download SBOM
cosign download sbom "$IMAGE" > sbom.json

# Package count
echo "Total packages: $(jq '.packages | length' sbom.json)" >> report.txt

# License summary
echo "" >> report.txt
echo "License Summary:" >> report.txt
jq -r '.packages[].licenseConcluded' sbom.json | sort | uniq -c | sort -rn >> report.txt

# Vulnerability scan
echo "" >> report.txt
echo "Vulnerability Summary:" >> report.txt
grype sbom:sbom.json --output table >> report.txt

cat report.txt
```

## Troubleshooting

### SBOM Not Found

**Issue**: `cosign download sbom` returns "no matching attestations found"

**Solutions**:
1. Verify you're using the correct image reference:
   ```bash
   # Use digest instead of tag
   docker inspect ghcr.io/honuaio/honua:latest | jq -r '.[0].RepoDigests[0]'
   cosign download sbom ghcr.io/honuaio/honua@sha256:...
   ```

2. Check if the image has attestations:
   ```bash
   cosign tree ghcr.io/honuaio/honua:latest
   ```

3. Ensure you're authenticated:
   ```bash
   docker login ghcr.io
   ```

### Signature Verification Fails

**Issue**: `cosign verify` fails with "no matching signatures found"

**Solutions**:
1. Images are signed using keyless signing (OIDC). Use:
   ```bash
   cosign verify ghcr.io/honuaio/honua:latest \
     --certificate-identity-regexp='.*' \
     --certificate-oidc-issuer-regexp='.*'
   ```

2. For older images, verification may not be available. Check the image build date.

### SBOM Format Not Recognized

**Issue**: Tools don't recognize SBOM format

**Solutions**:
1. Check SBOM format:
   ```bash
   cat sbom.json | jq 'keys'
   ```

2. Convert between formats:
   ```bash
   # CycloneDX to SPDX (requires conversion tool)
   cyclonedx-cli convert --input-file sbom-cyclonedx.json --output-file sbom-spdx.json --output-format spdxjson
   ```

### Large SBOM Files

**Issue**: SBOM files are too large to process

**Solutions**:
1. Filter packages:
   ```bash
   cat sbom.json | jq '{packages: [.packages[] | select(.name | startswith("Honua"))]}' > filtered-sbom.json
   ```

2. Use streaming processing:
   ```bash
   jq -c '.packages[]' sbom.json | while read pkg; do
     echo "$pkg" | jq '.name'
   done
   ```

## Best Practices

1. **Always Verify**: Never trust an SBOM without verifying its signature
2. **Automate Checks**: Integrate SBOM verification into your CI/CD pipeline
3. **Regular Scanning**: Scan SBOMs regularly for new vulnerabilities
4. **Version Control**: Store SBOMs alongside your deployment manifests
5. **Access Control**: Protect SBOM artifacts as they contain sensitive information about your stack
6. **Retention**: Keep historical SBOMs for compliance and audit purposes
7. **Monitoring**: Set up alerts for critical vulnerabilities in your SBOM

## Additional Resources

- [SBOM Generation Workflow](.github/workflows/sbom.yml)
- [SBOM Verification Script](scripts/verify-sbom.sh)
- [Cosign Documentation](https://docs.sigstore.dev/cosign/overview/)
- [SPDX Specification](https://spdx.dev/specifications/)
- [CycloneDX Specification](https://cyclonedx.org/specification/overview/)
- [CISA SBOM Resources](https://www.cisa.gov/sbom)
- [NTIA Minimum Elements for SBOM](https://www.ntia.gov/report/2021/minimum-elements-software-bill-materials-sbom)

## Support

For questions or issues related to SBOMs:
- Open an issue: https://github.com/honuaio/honua/issues
- Security concerns: security@honua.io
- Documentation: https://docs.honua.io/sbom
