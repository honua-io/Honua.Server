1. Geoservices sync controller ships without any actions
- Location: src/Honua.Server.Host/GeoservicesREST/GeoservicesRestSyncController.cs:24
- Problem: The new controller registered under FeatureServer routing exposes no endpoints—sync/replica operations like createReplica/syncReplica were never ported from the legacy controller.
- Impact: ArcGIS clients calling replica/sync routes receive 404/405 despite the service advertising sync capability, breaking offline data workflows and partner integrations.
- Recommendation: Either rewire existing sync handlers from GeoservicesRESTFeatureServerController or temporarily remove this controller and advertise sync as unsupported.
2. Metadata controller registered without endpoints
- Location: src/Honua.Server.Host/GeoservicesREST/GeoservicesRestMetadataController.cs:27
- Problem: The new metadata controller exposes the FeatureServer base route but still contains only TODO comments; service/layer metadata requests remain wired to the 3.5k line legacy controller.
- Impact: Refactors that disable or reorder controllers risk accidentally short-circuiting metadata routes (since attribute routing now matches this stub), producing 404s or blank responses in production.
- Recommendation: Either fully port GetService/GetLayer handlers into this controller or remove the stub routes until the migration is complete.
3. Attachment controller route collides with legacy handler
- Location: src/Honua.Server.Host/GeoservicesREST/GeoservicesRestAttachmentController.cs:29
- Problem: The new attachment controller reserves /FeatureServer/{layerIndex} but implements zero actions; routing falls back to legacy controller today, yet any future handler ordering change will match this empty controller first and return 404.
- Impact: GeoServices attachment browsing/upload fails instantly under ASP.NET’s “ambiguous match” rules once the legacy controller is trimmed, derailing attachment support for ArcGIS clients.
- Recommendation: Either port the attachment endpoints now or disable this controller (e.g., remove [ApiController]/[Route]) until the migration is finished.
4. Query controller stub risks intercepting real query routes
- Location: src/Honua.Server.Host/GeoservicesREST/GeoservicesRestQueryController.cs:26
- Problem: Attribute routing for /FeatureServer/{layerIndex}/query now maps to an empty controller—all actual query logic still lives in GeoservicesRESTFeatureServerController.
- Impact: When the monolith controller is trimmed or re-ordered, GeoServices query/related-record requests will return 404 or blank responses, rendering the FeatureServer unusable.
- Recommendation: Port the query/related-record handlers into this controller (preserving streaming fixes) or temporarily disable the stub so routing continues to hit the working implementation.
5. Legacy OGC collections links emit relative URLs
- Location: src/Honua.Server.Host/Ogc/OgcApiEndpointExtensions.cs:116
- Problem: BuildLegacyCollectionsResponse hard-codes href values like "/ogc/{serviceId}/collections/{layerId}" without using RequestLinkHelper or the current request to build absolute links.
- Impact: External clients (esp. behind reverse proxies) receive broken self/items links that resolve relative to their own base path, violating OGC conformance and breaking catalog navigation.
- Recommendation: Accept HttpRequest in the handler and generate absolute URLs via RequestLinkHelper so proxy-aware scheme/host detection is honoured.
6. Legacy collection detail response also uses relative links
- Location: src/Honua.Server.Host/Ogc/OgcApiEndpointExtensions.cs:146
- Problem: BuildLegacyCollectionResponse constructs link objects with bare “/ogc/…” paths and never inspects the incoming request, so proxies or alternate base paths generate broken navigation links.
- Impact: Clients following the advertised `self`/`items` links end up on invalid URLs when the API is hosted under a subpath or TLS terminator, degrading backwards-compatible endpoints.
- Recommendation: Pass HttpRequest into the helper and generate fully-qualified URLs through RequestLinkHelper (respecting forwarded headers).
7. Editing controller placeholder blocks applyEdits routing
- Location: src/Honua.Server.Host/GeoservicesREST/GeoservicesRestEditController.cs:26
- Problem: The new editing controller claims /FeatureServer/{layerIndex}/applyEdits but contains no actions; legacy edit logic still lives in the monolithic controller.
- Impact: Once route ordering changes—or when the legacy controller is trimmed—ArcGIS applyEdits/addFeatures calls will return 404, halting editing pipelines.
- Recommendation: Move applyEdits/add/update/delete handlers into this controller or remove the route attributes until the migration lands.
8. Secrets manager ships with deterministic dev passphrase
- Location: src/Honua.Cli.AI.Secrets/EncryptedFileSecretsManager.cs:548
- Problem: In non-production environments the secrets manager falls back to `${MachineName}::${UserName}::honua-secrets-v1`, a predictable, low-entropy passphrase.
- Impact: Any attacker with filesystem access (even read-only) can decrypt stored secrets, and the pattern is easy to brute-force for CI usernames; the code path is triggered automatically whenever HONUA_SECRETS_PASSPHRASE is unset.
- Recommendation: Require the caller to supply a passphrase even in dev/test (fail fast) or integrate with OS keychain; at minimum randomize per-installation and store alongside the vault with ACLs.
9. Alert receiver logs full alert payload at information level
- Location: src/Honua.Server.AlertReceiver/Controllers/AlertController.cs:54
- Problem: ProcessAlert iterates every alert and logs name/status/severity/description at Information level; descriptions and labels often contain secrets or customer identifiers from Alertmanager.
- Impact: Production logs capture sensitive operational data and can leak credentials/PII wherever alerts embed them, violating compliance requirements.
- Recommendation: Downgrade to Debug, scrub sensitive labels/annotations, or make logging opt-in per environment.
10. Query helper drops multi-valued parameters
- Location: src/Honua.Server.Host/Utilities/RequestLinkHelper.cs:80
- Problem: AddOrReplaceQuery flattens the parsed query into a Dictionary<string,string?>, so keys with multiple values collapse to the last item.
- Impact: Link generation for OGC filters (e.g., multiple `collections` or repeated `bbox`) loses values, producing incorrect navigation links and confusing clients following pagination.
- Recommendation: Preserve StringValues when rebuilding the query (use NameValueCollection semantics or QueryBuilder) instead of a simple dictionary.
11. JSON-LD exporter ignores proxy-aware base URL
- Location: src/Honua.Server.Host/Ogc/OgcFeaturesHandlers.cs:1167
- Problem: GetCollectionItem builds `baseUri` with `$"{request.Scheme}://{request.Host}"`, bypassing RequestLinkHelper and BasePath awareness.
- Impact: JSON-LD responses behind reverse proxies (different host, https) emit incorrect `@id`/`links`, breaking client dereferencing and enabling host header injection.
- Recommendation: Produce the base URL via RequestLinkHelper (or TrustedProxyValidator) so scheme/host/path are normalized for proxied deployments.
12. Pagination helper throws when offset exceeds numberMatched
- Location: src/Honua.Server.Host/Ogc/OgcSharedHandlers.cs:1890
- Problem: BuildItemsLinks sets `remaining = (int)(numberMatched - offset)` and passes `Math.Min(remaining, limit)` to PaginationHelper.CalculateNextOffset; when clients request an offset beyond the dataset, `remaining` becomes negative and CalculateNextOffset throws ArgumentOutOfRangeException.
- Impact: Instead of returning an empty page (per spec), the API emits HTTP 500, breaking pagination safety and polluting telemetry.
- Recommendation: Clamp `remaining` to >=0 before calling CalculateNextOffset or short-circuit when offset >= numberMatched.
13. Search pagination blows up on out-of-range offsets
- Location: src/Honua.Server.Host/Ogc/OgcSharedHandlers.cs:1930
- Problem: BuildSearchLinks repeats the same `remaining = numberMatched - offset` math before calling CalculateNextOffset; negative remaining values trigger ArgumentOutOfRangeException.
- Impact: `/ogc/search` returns 500 when clients request offsets past the end of the result set instead of gracefully returning an empty page.
- Recommendation: Guard against `offset >= numberMatched` and skip `next` link generation rather than feeding a negative count into PaginationHelper.
14. Pagination links drop bbox/temporal filters
- Location: src/Honua.Server.Host/Ogc/OgcSharedHandlers.cs:2307
- Problem: BuildHref deliberately omits bbox, datetime, and resultType from generated links unless overrides supply them; most callers don’t add overrides, so `self`/`next` links lose the user’s spatial/temporal filters.
- Impact: Clients following pagination immediately fall back to the unfiltered collection, returning wrong data sets and wasting bandwidth.
- Recommendation: Carry forward all active filters (bbox, datetime, filter, ids, property selections) when constructing navigation links.
15. CQL filter context is lost in Ogc links
- Location: src/Honua.Server.Host/Ogc/OgcSharedHandlers.cs:2296
- Problem: FeatureQuery.Filter and PropertyNames are ignored when recomputing queryParameters, so `self`/`next` links omit the active CQL filter and selected fields.
- Impact: Following the provided navigation links removes predicate filtering—clients suddenly see full datasets, making pagination unusable for filtered queries.
- Recommendation: Serialize the active filter (`filter`, `filter-lang`) and projected properties into the link query string so navigation maintains the same constraints.
16. WMTS handler still returns stubbed responses
- Location: src/Honua.Server.Host/Ogc/WmtsHandlers.cs:33
- Problem: The new WMTS handler is registered but still serves a hard-coded capabilities skeleton and a 1×1 transparent PNG tile.
- Impact: Any deployment wiring IWmtsHandler (e.g., via DI overrides) would ship a broken WMTS endpoint, and future refactors that instantiate this class will silently regress tiles.
- Recommendation: Port the real implementations from OgcSharedHandlers before enabling DI registration; in the meantime, guard the type with `[Obsolete]` or remove it to avoid accidental use.
17. WMS handler exposes placeholder payloads
- Location: src/Honua.Server.Host/Ogc/WmsHandlers.cs:24
- Problem: The refactored WMS handler is still a stub that delegates to trivial helpers; once DI starts using it, GetMap returns only pass-through content without the actual business logic now sitting in OgcSharedHandlers.
- Impact: Future refactors risk shipping an effectively empty WMS implementation (no style handling, no caching, no query limits), breaking map clients.
- Recommendation: Complete the extraction by moving concrete GetMap/GetFeatureInfo implementations out of OgcSharedHandlers before switching DI to the new handler.
18. WFS handler skeleton risks wire-up regressions
- Location: src/Honua.Server.Host/Ogc/WfsHandlers.cs:24
- Problem: Like WMS/WMTS, the WFS handler file contains only TODO scaffolding; real transaction/query logic still lives in OgcSharedHandlers.
- Impact: When the extraction is completed or when DI mistakenly resolves IWfsHandler to this type, `/wfs` immediately degrades to empty responses.
- Recommendation: Block DI registration until the handler mirrors OgcSharedHandlers’ implementations, or delete the stub to avoid accidental use.
19. WCS handler remains unimplemented
- Location: src/Honua.Server.Host/Ogc/WcsHandlers.cs:23
- Problem: The WCS handler stub is checked in but never filled out; raster GetCoverage/GetCapabilities logic still lives in OgcSharedHandlers.
- Impact: Any attempt to modularize WCS (or enable the stub) would yield empty responses and regress coverage downloads.
- Recommendation: Finish the extraction or remove the stub from the solution to avoid misconfiguration.
20. CSRF origin check ignores trusted proxy metadata
- Location: src/Honua.Server.Host/Security/CsrfTokenEndpoints.cs:83
- Problem: ValidateSameOrigin compares Origin/Referer against `request.Scheme` and `request.Host`, ignoring TrustedProxyValidator and X-Forwarded-* headers.
- Impact: Deployments behind TLS terminators or reverse proxies see scheme/host mismatches, so clients can’t fetch CSRF tokens and every form submission fails.
- Recommendation: Resolve the effective origin via RequestLinkHelper (or TrustedProxyValidator) before comparing headers.
21. Vector tile datetime filter drops timezone information
- Location: src/Honua.Server.Core/Data/Postgres/PostgresVectorTileGenerator.cs:58
- Problem: `DateTime.TryParse(..., DateTimeStyles.RoundtripKind, out var parsed)` stores the result in a `DateTime` and later passes it as `@datetime`—any timezone offset is discarded because the column compare expects UTC.
- Impact: Tiles requested with explicit offsets (e.g., `2024-05-01T00:00:00-05:00`) are evaluated against the wrong instant, returning incorrect datasets for non-UTC users.
- Recommendation: Parse into `DateTimeOffset`, normalize to UTC, and adjust the SQL predicate to compare against consistent UTC timestamps.
22. Metrics polling spins up a new HttpClient per check
- Location: src/Honua.Cli.AI/Services/Processes/Steps/Upgrade/SwitchTrafficStep.cs:1109
- Problem: Each metrics probe (`CheckErrorRate`, `CheckLatency`, `CheckStatusCodes`) creates and disposes a new `HttpClient` every 10 seconds.
- Impact: Long-running traffic switches exhaust ephemeral ports and hammer DNS caches, and retries during outages exacerbate failures.
- Recommendation: Reuse a singleton HttpClient (or IHttpClientFactory) across checks and respect cancellation tokens.
23. Metrics parser is culture-sensitive
- Location: src/Honua.Cli.AI/Services/Processes/Steps/Upgrade/SwitchTrafficStep.cs:1138
- Problem: The code calls `double.TryParse(errorRateStr, out var errorRate)` without specifying `CultureInfo.InvariantCulture`.
- Impact: On locales where the decimal separator is “,” (many European servers), parsing the Prometheus value fails and the traffic switch aborts unnecessarily.
- Recommendation: Parse using `double.TryParse(value, NumberStyles.Float, CultureInfo.InvariantCulture, out var parsed)`.
24. Latency parser ignores invariant culture
- Location: src/Honua.Cli.AI/Services/Processes/Steps/Upgrade/SwitchTrafficStep.cs:1218
- Problem: Prometheus returns decimals with '.' but the code parses with the current culture; non-US locales turn “0.123” into zero.
- Impact: Traffic switch reads latency as zero and misses regressions or throws when parsing fails.
- Recommendation: Use `double.TryParse(latencyStr, NumberStyles.Float, CultureInfo.InvariantCulture, out var latencySeconds)`.
25. Status code aggregation misparses floats on non-US locales
- Location: src/Honua.Cli.AI/Services/Processes/Steps/Upgrade/SwitchTrafficStep.cs:1305
- Problem: Parsing the Prometheus rate string relies on default culture, so locales with “,” decimal separator interpret every value as zero.
- Impact: The CLI never detects 5xx spikes in those environments, undermining the traffic safety check.
- Recommendation: Parse using invariant culture and guard against null `rate` fields.
26. bbox validation rejects non-CRS84 coordinates
- Location: src/Honua.Server.Host/Utilities/QueryParsingHelpers.cs:55
- Problem: ParseBoundingBox enforces longitude/latitude ranges of [-180,180]/[-90,90] even when callers supply `bbox-crs=EPSG:3857`.
- Impact: Requests using projected bounding boxes (e.g., WebMercator meters) are rejected with 400, so tile services honoring bbox-crs can’t be used.
- Recommendation: Defer range checks when a non-default CRS is specified or transform the bbox before validation.
27. bbox parser rejects dateline-wrapping ranges
- Location: src/Honua.Server.Host/Utilities/QueryParsingHelpers.cs:99
- Problem: After parsing the coordinates, the helper enforces `minX <= maxX`, so bounding boxes crossing the antimeridian (e.g., 170°E to -170°W) are rejected.
- Impact: Collections spanning the dateline can’t be queried with small window bboxes, breaking valid OGC API workflows.
- Recommendation: Allow minX > maxX to represent wrap-around extents and let downstream tile logic split the range.
28. Edit orchestrator starts one transaction for mixed datasources
- Location: src/Honua.Server.Core/Editing/FeatureEditOrchestrator.cs:56
- Problem: The orchestrator opens a transaction against the first command’s provider but never verifies subsequent commands use the same data source; repository calls are executed without the transaction when providers differ.
- Impact: Multi-layer edit batches (common in ArcGIS applyEdits) leave some edits outside the transaction, so partial failures commit silently even with RollbackOnFailure=true.
- Recommendation: Validate that every command targets the same provider before opening the transaction, or group commands per data source and execute sequentially.
29. RollbackOnFailure silently ignored when provider lacks transactions
- Location: src/Honua.Server.Core/Editing/FeatureEditOrchestrator.cs:64
- Problem: If `BeginTransactionAsync` returns null (provider has no transaction support), the orchestrator continues but still honours `RollbackOnFailure`, giving callers false confidence their batch is atomic.
- Impact: ApplyEdits with rollback=true on datastores without transactions will partially apply changes after an error.
- Recommendation: Detect null transaction and fail fast (or disable rollback) so callers know cross-command atomicity isn’t guaranteed.
30. Deduplication ignores severity upgrades
- Location: src/Honua.Server.AlertReceiver/Services/AlertDeduplicator.cs:31
- Problem: Alert history is keyed solely by fingerprint; when an alert escalates from warning to critical, it shares the same dedup window and is suppressed as a duplicate.
- Impact: Critical notifications never reach operators if a lower-severity version fired recently, defeating escalation workflows.
- Recommendation: Include severity in the deduplication key or reset history when severity increases.
31. GeoJSON upload parser lacks size limits
- Location: src/Honua.Server.Host/Ogc/OgcSharedHandlers.cs:2535
- Problem: ParseJsonDocumentAsync buffers the entire request body without imposing any max size; a malicious client can post multi-GB JSON and exhaust memory before Kestrel’s limits kick in.
- Impact: OGC feature ingestion endpoints are vulnerable to DoS attacks via oversized payloads.
- Recommendation: Enforce a configurable maximum body size before enabling buffering or stream features instead of parsing whole documents.
32. Alert timestamps lose timezone information
- Location: src/Honua.Server.AlertReceiver/Models/GenericAlert.cs:43
- Problem: `GenericAlert.Timestamp` uses `DateTime` with default `DateTimeKind.Unspecified` (JSON default), so serialized alerts may be interpreted in local time when persisted or forwarded.
- Impact: Alerts appear to occur hours off, breaking dedup windows and SLA metrics in multi-timezone deployments.
- Recommendation: Switch to `DateTimeOffset` and ensure serialization uses ISO 8601 offsets.
33. Silencing rules store naive DateTime values
- Location: src/Honua.Server.AlertReceiver/Services/AlertSilencingService.cs:67
- Problem: Silencing rules accept `DateTime` start/end arguments without normalising to UTC or enforcing `DateTimeKind.Utc`.
- Impact: Rules created from clients in different time zones go active/inactive at the wrong moment.
- Recommendation: Use `DateTimeOffset` everywhere and persist in UTC.
34. Silencing rule label match is case-sensitive
- Location: src/Honua.Server.AlertReceiver/Services/AlertSilencingService.cs:103
- Problem: For unknown matcher keys, the code looks up `alert.Labels.GetValueOrDefault(matcher.Key, "")`; since `GenericAlert.Labels` uses the default case-sensitive dictionary, rules for `environment=Prod` fail when alerts send `Environment` or `environment` with different casing.
- Impact: Silencing rules silently fail, causing alert storms despite configured suppressions.
- Recommendation: Normalise both matcher keys and label dictionary to a common case (e.g., use OrdinalIgnoreCase dictionary).
35. Alert webhook model uses DateTime instead of DateTimeOffset
- Location: src/Honua.Server.AlertReceiver/Models/AlertManagerWebhook.cs:36
- Problem: `Alert.StartsAt`/`EndsAt` are `DateTime` without explicit UTC handling, so serialization depends on server locale.
- Impact: Published alerts show inconsistent timestamps in external systems (PagerDuty, Slack) when the server runs outside UTC.
- Recommendation: Model timestamps as `DateTimeOffset` and normalise to UTC.
36. PagerDuty publisher chains ConfigureAwait twice
- Location: src/Honua.Server.AlertReceiver/Services/PagerDutyAlertPublisher.cs:122
- Problem: The code calls `await HttpClient.PostAsync(...).ConfigureAwait(false).ConfigureAwait(false);`; the second `ConfigureAwait` compiles but blocks on the already completed response, defeating the async intent and risking deadlocks.
- Impact: PagerDuty publishing can deadlock under certain sync contexts or throw runtime exceptions when `ConfigureAwait` is evaluated on the HttpResponseMessage.
- Recommendation: Keep a single `.ConfigureAwait(false)` before the await.
37. Opsgenie publisher repeats ConfigureAwait chain
- Location: src/Honua.Server.AlertReceiver/Services/OpsgenieAlertPublisher.cs:152
- Problem: `await HttpClient.SendAsync(...).ConfigureAwait(false).ConfigureAwait(false);` mistakenly chains `.ConfigureAwait` twice, leading to the same risk of deadlocks or invalid await semantics.
- Impact: Opsgenie deliveries can hang or throw under concurrency when the extra ConfigureAwait runs on the result object.
- Recommendation: Remove the redundant `.ConfigureAwait(false)` so the await operates on a single configured task.
38. SandboxUp registers CancelKeyPress without unsubscribing
- Location: src/Honua.Cli/Commands/SandboxUpCommand.cs:49
- Problem: Each execution attaches a new `Console.CancelKeyPress` handler and never detaches it.
- Impact: Subsequent command runs trigger multiple duplicate handlers, leading to repeated kill attempts and noisy output.
- Recommendation: Remove the handler after the process exits (in finally) or use a scoped Console.CancelKeyPress registration helper.
39. KML exporter drops layer styling
- Location: src/Honua.Server.Host/GeoservicesREST/GeoservicesRESTFeatureServerController.cs:2325
- Problem: The code still has `// TODO: Pass style to StreamingKmlWriter when it supports styling`, so KML/KMZ exports ignore layer symbology.
- Impact: Clients downloading KML get unstyled geometries, breaking cartographic expectations and map readability.
- Recommendation: Extend StreamingKmlWriter to accept styles and wire it up here.
40. Kerchunk generator omits byte offset references
- Location: src/Honua.Server.Core/Raster/Kerchunk/GdalKerchunkGenerator.cs:259
- Problem: The GDAL kerchunk generator still has a TODO for byte offset references, so generated kerchunk manifests are incomplete for cloud-optimized workflows.
- Impact: Downstream xarray/zarr clients cannot lazily read rasters from object storage, nullifying the kerchunk API.
- Recommendation: Implement chunk offset extraction or disable the endpoint until supported.
