version: '3.8'

# Shared Test Environment for Honua Server
# ========================================
# This docker-compose file provides a shared, cached test environment that can be used
# by all test suites (C#, Python, Node.js) for faster test execution.
#
# Key Benefits:
# - Start once, reuse across multiple test runs
# - Fast startup with SQLite backend (<1s vs 10-30s for PostgreSQL)
# - Pre-populated with consistent test data
# - Language-agnostic (works with C#, Python, Node.js tests)
#
# Usage:
#   Start:   docker-compose -f docker-compose.shared-test-env.yml up -d
#   Stop:    docker-compose -f docker-compose.shared-test-env.yml down
#   Restart: docker-compose -f docker-compose.shared-test-env.yml restart honua-test
#   Logs:    docker-compose -f docker-compose.shared-test-env.yml logs -f honua-test

services:
  # ============================================================================
  # Honua Server (SQLite Backend) - Fast, Cached Test Instance
  # ============================================================================
  honua-test:
    image: honua-server:test
    container_name: honua-test-shared
    build:
      context: ..
      dockerfile: src/Honua.Server.Host/Dockerfile
      target: final
    environment:
      # Database Configuration (SQLite for speed)
      - ConnectionStrings__HonuaDb=Data Source=/app/data/ogc-sample.db
      - ConnectionStrings__StacCatalogDb=Data Source=/tmp/stac-catalog.db

      # Metadata Configuration
      - HONUA__METADATA__PATH=/app/data/test-metadata.json

      # Disable STAC catalog synchronization for testing
      - honua__services__stac__enabled=false
      - Honua__Services__Stac__Enabled=false

      # Authentication (SQLite)
      - Authentication__Provider=SQLite
      - Authentication__SQLite__DatabasePath=/app/data/auth/auth.db

      # Disable features not needed for tests
      - Redis__Enabled=false
      - OutputCaching__Enabled=false
      - Telemetry__Enabled=false

      # Environment
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_HTTP_PORTS=8080
    volumes:
      # Mount test data (writable to allow cache directory creation)
      - ./TestData:/app/data
      # Cache directory for any runtime-generated files
      - ./shared-cache:/app/cache
    ports:
      - "5100:8080"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 5s
      timeout: 3s
      retries: 20
      start_period: 10s
    networks:
      - honua-test-net

  # ============================================================================
  # PostgreSQL + PostGIS (For Integration Tests Requiring Real DB)
  # ============================================================================
  postgres-test:
    image: postgis/postgis:16-3.4
    container_name: postgres-test-shared
    environment:
      - POSTGRES_DB=honua_test
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=test
      - POSTGRES_HOST_AUTH_METHOD=trust
    volumes:
      # Seed data for integration tests
      - ./TestData/seed-data:/docker-entrypoint-initdb.d/data:ro
      # Persistent volume for faster restarts
      - postgres-test-data:/var/lib/postgresql/data
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 3s
      retries: 10
      start_period: 10s
    networks:
      - honua-test-net

  # ============================================================================
  # Redis (For Caching Tests)
  # ============================================================================
  redis-test:
    image: redis:7-alpine
    container_name: redis-test-shared
    ports:
      - "6380:6379"
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - honua-test-net

  # ============================================================================
  # Qdrant (For Vector Search Tests)
  # ============================================================================
  qdrant-test:
    image: qdrant/qdrant:latest
    container_name: qdrant-test-shared
    ports:
      - "6334:6333"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 5s
      timeout: 3s
      retries: 10
    networks:
      - honua-test-net

networks:
  honua-test-net:
    name: honua-test-network
    driver: bridge

volumes:
  postgres-test-data:
    name: honua-postgres-test-data
