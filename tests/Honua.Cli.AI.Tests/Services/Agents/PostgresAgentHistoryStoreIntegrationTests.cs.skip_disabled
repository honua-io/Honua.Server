using System;
using System.Collections.Generic;
using System.Linq;
using System.Text.Json;
using System.Threading;
using System.Threading.Tasks;
using FluentAssertions;
using Honua.Cli.AI.Services.Agents;
using Honua.Cli.AI.Tests.TestFixtures;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.Logging;
using Moq;
using Xunit;

namespace Honua.Cli.AI.Tests.Services.Agents;

[Collection("PostgreSQL")]
public class PostgresAgentHistoryStoreIntegrationTests : IAsyncLifetime
{
    private readonly PostgreSqlTestFixture _fixture;
    private readonly PostgresAgentHistoryStore _sut;
    private readonly Mock<ILogger<PostgresAgentHistoryStore>> _loggerMock;
    private readonly IConfiguration _configuration;

    public PostgresAgentHistoryStoreIntegrationTests(PostgreSqlTestFixture fixture)
    {
        _fixture = fixture;
        _loggerMock = new Mock<ILogger<PostgresAgentHistoryStore>>();

        var configBuilder = new ConfigurationBuilder();
        configBuilder.AddInMemoryCollection(new Dictionary<string, string?>
        {
            ["ConnectionStrings:PostgreSQL"] = _fixture.ConnectionString
        });
        _configuration = configBuilder.Build();

        _sut = new PostgresAgentHistoryStore(_configuration, _loggerMock.Object);
    }

    public Task InitializeAsync() => _fixture.ResetAsync();
    public Task DisposeAsync() => Task.CompletedTask;

    [Fact]
    public async Task SaveInteractionAsync_Should_PersistInteraction()
    {
        // Arrange
        var sessionId = Guid.NewGuid().ToString();
        var metadata = JsonDocument.Parse(@"{ ""key"": ""value"" }");

        // Act
        await _sut.SaveInteractionAsync(
            sessionId: sessionId,
            agentName: "TestAgent",
            userRequest: "Test request",
            agentResponse: "Test response",
            success: true,
            confidenceScore: 0.95,
            taskType: "query",
            executionTimeMs: 100,
            errorMessage: null,
            metadata: metadata,
            cancellationToken: CancellationToken.None);

        // Assert
        var history = await _sut.GetSessionHistoryAsync(sessionId);
        history.Should().HaveCount(1);

        var interaction = history.First();
        interaction.SessionId.Should().Be(sessionId);
        interaction.AgentName.Should().Be("TestAgent");
        interaction.UserRequest.Should().Be("Test request");
        interaction.AgentResponse.Should().Be("Test response");
        interaction.Success.Should().BeTrue();
        interaction.ConfidenceScore.Should().Be(0.95);
        interaction.TaskType.Should().Be("query");
        interaction.ExecutionTimeMs.Should().Be(100);
        interaction.ErrorMessage.Should().BeNull();
        interaction.MetadataJson.Should().Contain("\"key\"");
        interaction.MetadataJson.Should().Contain("\"value\"");
    }

    [Fact]
    public async Task SaveInteractionAsync_Should_HandleNullMetadata()
    {
        // Arrange
        var sessionId = Guid.NewGuid().ToString();

        // Act
        await _sut.SaveInteractionAsync(
            sessionId: sessionId,
            agentName: "TestAgent",
            userRequest: "Test request",
            agentResponse: null,
            success: false,
            errorMessage: "Test error",
            cancellationToken: CancellationToken.None);

        // Assert
        var history = await _sut.GetSessionHistoryAsync(sessionId);
        history.Should().HaveCount(1);
        history.First().MetadataJson.Should().BeNull();
        history.First().ErrorMessage.Should().Be("Test error");
    }

    [Fact]
    public async Task GetSessionHistoryAsync_Should_ReturnInteractionsInOrder()
    {
        // Arrange
        var sessionId = Guid.NewGuid().ToString();

        // Act
        for (int i = 0; i < 5; i++)
        {
            await _sut.SaveInteractionAsync(
                sessionId: sessionId,
                agentName: $"Agent{i}",
                userRequest: $"Request {i}",
                agentResponse: $"Response {i}",
                success: true,
                cancellationToken: CancellationToken.None);

            await Task.Delay(10); // Ensure different timestamps
        }

        // Assert
        var history = await _sut.GetSessionHistoryAsync(sessionId);
        history.Should().HaveCount(5);
        history.Select(h => h.AgentName).Should().BeEquivalentTo(
            new[] { "Agent0", "Agent1", "Agent2", "Agent3", "Agent4" },
            options => options.WithStrictOrdering());
    }

    [Fact]
    public async Task GetAgentInteractionsAsync_Should_ReturnInteractionsByAgent()
    {
        // Arrange
        var agentName = "SpecificAgent";

        for (int i = 0; i < 3; i++)
        {
            await _sut.SaveInteractionAsync(
                sessionId: Guid.NewGuid().ToString(),
                agentName: agentName,
                userRequest: $"Request {i}",
                agentResponse: $"Response {i}",
                success: true,
                cancellationToken: CancellationToken.None);
        }

        await _sut.SaveInteractionAsync(
            sessionId: Guid.NewGuid().ToString(),
            agentName: "OtherAgent",
            userRequest: "Other request",
            agentResponse: "Other response",
            success: true,
            cancellationToken: CancellationToken.None);

        // Act
        var interactions = await _sut.GetAgentInteractionsAsync(agentName, limit: 10);

        // Assert
        interactions.Should().HaveCount(3);
        interactions.Should().OnlyContain(i => i.AgentName == agentName);
    }

    [Fact]
    public async Task GetAgentInteractionsAsync_Should_RespectLimit()
    {
        // Arrange
        var agentName = "TestAgent";

        for (int i = 0; i < 10; i++)
        {
            await _sut.SaveInteractionAsync(
                sessionId: Guid.NewGuid().ToString(),
                agentName: agentName,
                userRequest: $"Request {i}",
                agentResponse: $"Response {i}",
                success: true,
                cancellationToken: CancellationToken.None);
        }

        // Act
        var interactions = await _sut.GetAgentInteractionsAsync(agentName, limit: 5);

        // Assert
        interactions.Should().HaveCount(5);
    }

    [Fact]
    public async Task SaveSessionSummaryAsync_Should_PersistSummary()
    {
        // Arrange
        var sessionId = Guid.NewGuid().ToString();
        var agentsUsed = new[] { "Agent1", "Agent2", "Agent3" };
        var metadata = JsonDocument.Parse(@"{ ""environment"": ""test"" }");

        // Act
        await _sut.SaveSessionSummaryAsync(
            sessionId: sessionId,
            initialRequest: "Initial request",
            finalOutcome: "success",
            agentsUsed: agentsUsed,
            interactionCount: 5,
            totalDurationMs: 2500,
            userSatisfaction: 4,
            metadata: metadata,
            cancellationToken: CancellationToken.None);

        // Assert
        var summaries = await _sut.GetSessionSummariesAsync(limit: 10);
        summaries.Should().HaveCount(1);

        var summary = summaries.First();
        summary.SessionId.Should().Be(sessionId);
        summary.InitialRequest.Should().Be("Initial request");
        summary.FinalOutcome.Should().Be("success");
        summary.AgentsUsed.Should().BeEquivalentTo(agentsUsed);
        summary.InteractionCount.Should().Be(5);
        summary.TotalDurationMs.Should().Be(2500);
        summary.UserSatisfaction.Should().Be(4);
        summary.MetadataJson.Should().Contain("\"environment\"");
        summary.MetadataJson.Should().Contain("\"test\"");
    }

    [Fact]
    public async Task SaveSessionSummaryAsync_Should_HandleDuplicateSessionId()
    {
        // Arrange
        var sessionId = Guid.NewGuid().ToString();

        // Act - Save first summary
        await _sut.SaveSessionSummaryAsync(
            sessionId: sessionId,
            initialRequest: "First request",
            finalOutcome: "success",
            agentsUsed: new[] { "Agent1" },
            interactionCount: 1,
            totalDurationMs: 100,
            cancellationToken: CancellationToken.None);

        // Act - Try to save duplicate (should update, not insert)
        await _sut.SaveSessionSummaryAsync(
            sessionId: sessionId,
            initialRequest: "Updated request",
            finalOutcome: "failure",
            agentsUsed: new[] { "Agent1", "Agent2" },
            interactionCount: 2,
            totalDurationMs: 200,
            cancellationToken: CancellationToken.None);

        // Assert
        var summaries = await _sut.GetSessionSummariesAsync(limit: 10);
        summaries.Should().HaveCount(1);

        var summary = summaries.First();
        summary.InitialRequest.Should().Be("Updated request");
        summary.FinalOutcome.Should().Be("failure");
        summary.InteractionCount.Should().Be(2);
    }

    [Fact]
    public async Task SaveInteractionAsync_Should_NotThrowOnDatabaseError()
    {
        // Arrange
        var badConfig = new ConfigurationBuilder()
            .AddInMemoryCollection(new Dictionary<string, string?>
            {
                ["ConnectionStrings:PostgreSQL"] = "Host=invalid;Port=5432;Database=test;Username=test;Password=test"
            })
            .Build();

        var badStore = new PostgresAgentHistoryStore(badConfig, _loggerMock.Object);

        // Act
        var act = () => badStore.SaveInteractionAsync(
            sessionId: "test",
            agentName: "TestAgent",
            userRequest: "Test",
            agentResponse: "Response",
            success: true,
            cancellationToken: CancellationToken.None);

        // Assert - Should not throw, errors are swallowed
        await act.Should().NotThrowAsync();

        // Verify error was logged
        _loggerMock.Verify(
            x => x.Log(
                LogLevel.Error,
                It.IsAny<EventId>(),
                It.Is<It.IsAnyType>((o, t) => o.ToString()!.Contains("Failed to save agent interaction")),
                It.IsAny<Exception>(),
                It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
            Times.Once);
    }

    [Fact]
    public async Task GetSessionHistoryAsync_Should_HandleCancellation()
    {
        // Arrange
        var cts = new CancellationTokenSource();
        cts.Cancel();

        // Act
        var act = () => _sut.GetSessionHistoryAsync("test", cts.Token);

        // Assert
        await act.Should().ThrowAsync<OperationCanceledException>();
    }

    [Fact]
    public async Task SaveInteractionAsync_Should_HandleConcurrentWrites()
    {
        // Arrange
        var sessionId = Guid.NewGuid().ToString();
        var tasks = new List<Task>();

        // Act - Save 10 interactions concurrently
        for (int i = 0; i < 10; i++)
        {
            var index = i; // Capture loop variable
            tasks.Add(Task.Run(async () =>
            {
                await _sut.SaveInteractionAsync(
                    sessionId: sessionId,
                    agentName: $"Agent{index}",
                    userRequest: $"Request {index}",
                    agentResponse: $"Response {index}",
                    success: true,
                    executionTimeMs: index * 10,
                    cancellationToken: CancellationToken.None);
            }));
        }

        await Task.WhenAll(tasks);

        // Assert
        var history = await _sut.GetSessionHistoryAsync(sessionId);
        history.Should().HaveCount(10);
        history.Select(h => h.AgentName).Distinct().Should().HaveCount(10);
    }

    [Fact]
    public async Task GetTopAgentsBySuccessRateAsync_Should_ReturnCorrectStats()
    {
        // Arrange
        // Agent1: 3 success, 1 failure = 75% success rate
        for (int i = 0; i < 3; i++)
        {
            await _sut.SaveInteractionAsync(
                sessionId: Guid.NewGuid().ToString(),
                agentName: "Agent1",
                userRequest: "Request",
                agentResponse: "Response",
                success: true,
                cancellationToken: CancellationToken.None);
        }
        await _sut.SaveInteractionAsync(
            sessionId: Guid.NewGuid().ToString(),
            agentName: "Agent1",
            userRequest: "Request",
            agentResponse: null,
            success: false,
            cancellationToken: CancellationToken.None);

        // Agent2: 2 success, 0 failure = 100% success rate
        for (int i = 0; i < 2; i++)
        {
            await _sut.SaveInteractionAsync(
                sessionId: Guid.NewGuid().ToString(),
                agentName: "Agent2",
                userRequest: "Request",
                agentResponse: "Response",
                success: true,
                cancellationToken: CancellationToken.None);
        }

        // Act
        var topAgents = await _sut.GetTopAgentsBySuccessRateAsync(limit: 5);

        // Assert
        topAgents.Should().HaveCount(2);

        var agent2Stats = topAgents.First(a => a.AgentName == "Agent2");
        agent2Stats.SuccessRate.Should().Be(1.0);
        agent2Stats.TotalInteractions.Should().Be(2);

        var agent1Stats = topAgents.First(a => a.AgentName == "Agent1");
        agent1Stats.SuccessRate.Should().Be(0.75);
        agent1Stats.TotalInteractions.Should().Be(4);
    }

    [Fact]
    public async Task SaveInteractionAsync_Should_HandleLargeMetadata()
    {
        // Arrange
        var sessionId = Guid.NewGuid().ToString();
        var largeObject = new
        {
            data = Enumerable.Range(0, 1000).Select(i => new
            {
                id = i,
                name = $"Item_{i}",
                description = new string('x', 100)
            }).ToArray()
        };
        var metadata = JsonDocument.Parse(JsonSerializer.Serialize(largeObject));

        // Act
        await _sut.SaveInteractionAsync(
            sessionId: sessionId,
            agentName: "TestAgent",
            userRequest: "Test with large metadata",
            agentResponse: "Response",
            success: true,
            metadata: metadata,
            cancellationToken: CancellationToken.None);

        // Assert
        var history = await _sut.GetSessionHistoryAsync(sessionId);
        history.Should().HaveCount(1);
        history.First().MetadataJson.Should().NotBeNullOrEmpty();
        history.First().MetadataJson!.Length.Should().BeGreaterThan(100000);
    }
}