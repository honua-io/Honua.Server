using System;
using System.Threading.Tasks;
using Dapper;
using Npgsql;
using Respawn;
using Testcontainers.PostgreSql;
using Xunit;

namespace Honua.Cli.AI.Tests.TestFixtures;

public class PostgreSqlTestFixture : IAsyncLifetime
{
    private PostgreSqlContainer _container = null!;
    private Respawner _respawner = null!;

    public string ConnectionString { get; private set; } = string.Empty;

    public async Task InitializeAsync()
    {
        _container = new PostgreSqlBuilder()
            .WithImage("postgres:15-alpine")
            .WithDatabase("honua_test")
            .WithUsername("test")
            .WithPassword("test")
            .Build();

        await _container.StartAsync();

        ConnectionString = _container.GetConnectionString();

        // Initialize database schema
        await InitializeSchemaAsync();

        // Setup Respawn for test data cleanup
        await using var connection = new NpgsqlConnection(ConnectionString);
        await connection.OpenAsync();

        _respawner = await Respawner.CreateAsync(connection, new RespawnerOptions
        {
            DbAdapter = DbAdapter.Postgres,
            SchemasToInclude = new[] { "public" },
            TablesToIgnore = new[] { "schema_version" }
        });
    }

    private async Task InitializeSchemaAsync()
    {
        await using var connection = new NpgsqlConnection(ConnectionString);
        await connection.OpenAsync();

        // Create agent history tables
        await connection.ExecuteAsync(@"
            CREATE TABLE IF NOT EXISTS agent_interactions (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                session_id VARCHAR(255) NOT NULL,
                agent_name VARCHAR(255) NOT NULL,
                user_request TEXT NOT NULL,
                agent_response TEXT,
                success BOOLEAN NOT NULL,
                confidence_score DOUBLE PRECISION,
                task_type VARCHAR(100),
                execution_time_ms INTEGER,
                error_message TEXT,
                metadata JSONB,
                created_at TIMESTAMP NOT NULL DEFAULT NOW()
            );

            CREATE INDEX IF NOT EXISTS idx_agent_interactions_session_id ON agent_interactions(session_id);
            CREATE INDEX IF NOT EXISTS idx_agent_interactions_agent_name ON agent_interactions(agent_name);
            CREATE INDEX IF NOT EXISTS idx_agent_interactions_created_at ON agent_interactions(created_at);
            CREATE INDEX IF NOT EXISTS idx_agent_interactions_task_type ON agent_interactions(task_type);
            CREATE INDEX IF NOT EXISTS idx_agent_interactions_success ON agent_interactions(success);
        ");

        await connection.ExecuteAsync(@"
            CREATE TABLE IF NOT EXISTS agent_session_summaries (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                session_id VARCHAR(255) NOT NULL UNIQUE,
                initial_request TEXT NOT NULL,
                final_outcome TEXT NOT NULL,
                agents_used TEXT[] NOT NULL,
                interaction_count INTEGER NOT NULL,
                total_duration_ms INTEGER NOT NULL,
                user_satisfaction INTEGER CHECK (user_satisfaction >= 1 AND user_satisfaction <= 5),
                metadata JSONB,
                created_at TIMESTAMP NOT NULL DEFAULT NOW()
            );

            CREATE INDEX IF NOT EXISTS idx_agent_session_summaries_session_id ON agent_session_summaries(session_id);
            CREATE INDEX IF NOT EXISTS idx_agent_session_summaries_created_at ON agent_session_summaries(created_at);
            CREATE INDEX IF NOT EXISTS idx_agent_session_summaries_user_satisfaction ON agent_session_summaries(user_satisfaction);
        ");

        // Create pattern usage telemetry table
        await connection.ExecuteAsync(@"
            CREATE TABLE IF NOT EXISTS pattern_usage_telemetry (
                id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
                pattern_id VARCHAR(255) NOT NULL,
                pattern_name TEXT NOT NULL,
                usage_context TEXT,
                confidence_score DOUBLE PRECISION,
                user_feedback VARCHAR(50),
                execution_time_ms INTEGER,
                metadata JSONB,
                created_at TIMESTAMP NOT NULL DEFAULT NOW()
            );

            CREATE INDEX IF NOT EXISTS idx_pattern_usage_pattern_id ON pattern_usage_telemetry(pattern_id);
            CREATE INDEX IF NOT EXISTS idx_pattern_usage_created_at ON pattern_usage_telemetry(created_at);
        ");
    }

    public async Task ResetAsync()
    {
        await using var connection = new NpgsqlConnection(ConnectionString);
        await connection.OpenAsync();
        await _respawner.ResetAsync(connection);
    }

    public async Task DisposeAsync()
    {
        await _container.DisposeAsync();
    }
}

[CollectionDefinition("PostgreSQL")]
public class PostgreSqlCollection : ICollectionFixture<PostgreSqlTestFixture>
{
    // This class has no code, and is never created. Its purpose is simply
    // to be the place to apply [CollectionDefinition] and all the
    // ICollectionFixture<> interfaces.
}