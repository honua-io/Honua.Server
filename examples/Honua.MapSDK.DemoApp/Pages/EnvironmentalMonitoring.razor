@page "/environmental-monitoring"
<PageTitle>Environmental Monitoring - Honua MapSDK</PageTitle>

<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1 class="dashboard-title">
                    <MudIcon Icon="@Icons.Material.Filled.Co2" Class="mr-2" />
                    Environmental Monitoring Dashboard
                </h1>
                <p class="dashboard-subtitle">
                    Monitor air quality and temperature sensors across the city.
                    View real-time readings and analyze trends over time.
                </p>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <MudChip Color="Color.Success" Icon="@Icons.Material.Filled.Sensors">
                    @_activeSensors Active
                </MudChip>
                <MudChip Color="Color.Warning" Icon="@Icons.Material.Filled.Warning">
                    @_warningSensors Warnings
                </MudChip>
                <MudChip Color="Color.Info" Icon="@Icons.Material.Filled.AccessTime">
                    Last updated: @DateTime.Now.ToString("HH:mm")
                </MudChip>
            </div>
        </div>
    </div>

    <!-- Dashboard Layout with Sidebar -->
    <div class="dashboard-with-sidebar">
        <!-- Sidebar with Legend and Stats -->
        <div class="dashboard-sidebar">
            <!-- Air Quality Legend -->
            <div class="component-panel mb-3">
                <div class="panel-header">
                    <h3 class="panel-title">Air Quality Index</h3>
                </div>
                <MudList Dense="true">
                    <MudListItem>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; height: 24px; background: #4CAF50; border-radius: 50%;"></div>
                            <div>
                                <MudText Typo="Typo.body2">Good (0-50)</MudText>
                            </div>
                        </div>
                    </MudListItem>
                    <MudListItem>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; height: 24px; background: #8BC34A; border-radius: 50%;"></div>
                            <div>
                                <MudText Typo="Typo.body2">Moderate (51-100)</MudText>
                            </div>
                        </div>
                    </MudListItem>
                    <MudListItem>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 24px; height: 24px; background: #FF9800; border-radius: 50%;"></div>
                            <div>
                                <MudText Typo="Typo.body2">Unhealthy (101-150)</MudText>
                            </div>
                        </div>
                    </MudListItem>
                </MudList>
            </div>

            <!-- Quick Stats -->
            <div class="component-panel mb-3">
                <div class="panel-header">
                    <h3 class="panel-title">Statistics</h3>
                </div>
                <MudStack Spacing="3">
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Average Temperature</MudText>
                        <MudText Typo="Typo.h5">@_avgTemperature.ToString("F1")째F</MudText>
                    </div>
                    <MudDivider />
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Average Air Quality</MudText>
                        <MudText Typo="Typo.h5">@_avgAirQuality.ToString("F0") AQI</MudText>
                    </div>
                    <MudDivider />
                    <div>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Average Humidity</MudText>
                        <MudText Typo="Typo.h5">@_avgHumidity.ToString("F0")%</MudText>
                    </div>
                </MudStack>
            </div>

            <!-- Filter Panel -->
            <div class="component-panel">
                <div class="panel-header">
                    <h3 class="panel-title">Filters</h3>
                </div>
                <MudStack Spacing="2">
                    <MudSelect T="string" Label="Sensor Type" @bind-Value="_selectedSensorType" Variant="Variant.Outlined" Dense="true">
                        <MudSelectItem Value="@("All")">All Types</MudSelectItem>
                        <MudSelectItem Value="@("Air Quality")">Air Quality</MudSelectItem>
                        <MudSelectItem Value="@("Temperature")">Temperature</MudSelectItem>
                    </MudSelect>

                    <MudSelect T="string" Label="Status" @bind-Value="_selectedStatus" Variant="Variant.Outlined" Dense="true">
                        <MudSelectItem Value="@("All")">All Status</MudSelectItem>
                        <MudSelectItem Value="@("Active")">Active</MudSelectItem>
                        <MudSelectItem Value="@("Warning")">Warning</MudSelectItem>
                        <MudSelectItem Value="@("Maintenance")">Maintenance</MudSelectItem>
                    </MudSelect>

                    <MudSlider @bind-Value="_minAirQuality" Min="0" Max="100" Step="5" Color="Color.Primary">
                        Min Air Quality: @_minAirQuality
                    </MudSlider>

                    <MudButton Variant="Variant.Outlined" Color="Color.Error" FullWidth="true" StartIcon="@Icons.Material.Filled.Clear"
                               OnClick="@ClearFilters">
                        Clear Filters
                    </MudButton>
                </MudStack>
            </div>
        </div>

        <!-- Main Content Area -->
        <div class="dashboard-content">
            <!-- Map -->
            <div class="dashboard-map-section" style="height: 400px;">
                <HonuaMap Id="sensor-map"
                          MapStyle="https://basemaps.cartocdn.com/gl/positron-gl-style/style.json"
                          Center="new[] { -122.4194, 37.7749 }"
                          Zoom="12.5"
                          OnFeatureClicked="@OnSensorClicked"
                          Style="width: 100%; height: 100%;" />
            </div>

            <!-- Charts Row -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px;">
                <!-- Temperature Line Chart -->
                <div class="dashboard-chart-card" style="height: 300px;">
                    <HonuaChart Id="temperature-chart"
                                SyncWith="sensor-map"
                                Type="ChartType.Line"
                                Field="temperature"
                                TimeField="time"
                                Title="Temperature Trends (24 Hours)"
                                Aggregation="AggregationType.Avg"
                                ColorScheme="warm"
                                EnableFilter="false"
                                AutoSync="true"
                                Style="width: 100%; height: 100%;" />
                </div>

                <!-- Air Quality Bar Chart -->
                <div class="dashboard-chart-card" style="height: 300px;">
                    <HonuaChart Id="airquality-chart"
                                SyncWith="sensor-map"
                                Type="ChartType.Bar"
                                Field="airQuality"
                                Title="Air Quality by Sensor"
                                Aggregation="AggregationType.Avg"
                                ColorScheme="cool"
                                EnableFilter="true"
                                AutoSync="true"
                                Style="width: 100%; height: 100%;" />
                </div>
            </div>

            <!-- Data Grid -->
            <div class="dashboard-grid-container">
                <HonuaDataGrid TItem="SensorFeature"
                               Id="sensor-grid"
                               SyncWith="sensor-map"
                               DataSource="data/sensors.geojson"
                               Title="Sensor Network"
                               ShowToolbar="true"
                               ShowSearch="true"
                               ShowExport="true"
                               Dense="true"
                               PageSize="15"
                               Filterable="true"
                               Sortable="true"
                               OnDataLoaded="@OnDataLoaded">
                    <Columns>
                        <PropertyColumn Property="x => x.Properties.Id" Title="ID" Sortable="true" />
                        <PropertyColumn Property="x => x.Properties.Name" Title="Name" Sortable="true" Filterable="true" />
                        <PropertyColumn Property="x => x.Properties.Type" Title="Type" Sortable="true" Filterable="true">
                            <CellTemplate>
                                <MudChip Size="Size.Small" Color="@GetTypeColor(context.Properties.Type)">
                                    @context.Properties.Type
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.Temperature" Title="Temp (째F)" Sortable="true">
                            <CellTemplate>
                                <span style="color: @GetTemperatureColor(context.Properties.Temperature);">
                                    @context.Properties.Temperature.ToString("F1")째F
                                </span>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.AirQuality" Title="AQI" Sortable="true">
                            <CellTemplate>
                                <MudChip Size="Size.Small" Color="@GetAQIColor(context.Properties.AirQuality)">
                                    @context.Properties.AirQuality
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.Humidity" Title="Humidity" Sortable="true">
                            <CellTemplate>
                                @context.Properties.Humidity%
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.Status" Title="Status" Sortable="true" Filterable="true">
                            <CellTemplate>
                                <MudChip Size="Size.Small" Color="@GetStatusColor(context.Properties.Status)">
                                    @context.Properties.Status
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                    </Columns>
                </HonuaDataGrid>
            </div>
        </div>
    </div>

    <!-- Sensor Detail Dialog -->
    @if (_selectedSensor != null)
    {
        <MudDialog @bind-IsVisible="_showSensorDialog" Options="_dialogOptions">
            <TitleContent>
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.Sensors" Class="mr-2" />
                    Sensor Details
                </MudText>
            </TitleContent>
            <DialogContent>
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h5">@_selectedSensor.Properties.Name</MudText>
                        <MudChip Size="Size.Small" Color="@GetStatusColor(_selectedSensor.Properties.Status)">
                            @_selectedSensor.Properties.Status
                        </MudChip>
                        <MudDivider Class="my-3" />
                    </MudItem>

                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Sensor ID</MudText>
                        <MudText Typo="Typo.body1">@_selectedSensor.Properties.Id</MudText>
                    </MudItem>

                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Sensor Type</MudText>
                        <MudText Typo="Typo.body1">@_selectedSensor.Properties.Type</MudText>
                    </MudItem>

                    <MudItem xs="12">
                        <MudDivider Class="my-2" />
                        <MudText Typo="Typo.h6" Class="mb-2">Current Readings</MudText>
                    </MudItem>

                    <MudItem xs="4">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: rgba(33, 150, 243, 0.1);">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Temperature</MudText>
                            <MudText Typo="Typo.h5">@_selectedSensor.Properties.Temperature.ToString("F1")째F</MudText>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="4">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: rgba(76, 175, 80, 0.1);">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Air Quality</MudText>
                            <MudText Typo="Typo.h5">@_selectedSensor.Properties.AirQuality AQI</MudText>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="4">
                        <MudPaper Class="pa-3" Elevation="0" Style="background: rgba(156, 39, 176, 0.1);">
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Humidity</MudText>
                            <MudText Typo="Typo.h5">@_selectedSensor.Properties.Humidity%</MudText>
                        </MudPaper>
                    </MudItem>

                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Last Updated</MudText>
                        <MudText Typo="Typo.body1">@_selectedSensor.Properties.Timestamp</MudText>
                    </MudItem>
                </MudGrid>
            </DialogContent>
            <DialogActions>
                <MudButton Color="Color.Primary" OnClick="@(() => _showSensorDialog = false)">Close</MudButton>
            </DialogActions>
        </MudDialog>
    }
</div>

@code {
    private int _activeSensors = 0;
    private int _warningSensors = 0;
    private double _avgTemperature = 0;
    private double _avgAirQuality = 0;
    private double _avgHumidity = 0;

    private string _selectedSensorType = "All";
    private string _selectedStatus = "All";
    private int _minAirQuality = 0;

    private SensorFeature? _selectedSensor;
    private bool _showSensorDialog = false;

    private DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseButton = true
    };

    private void OnDataLoaded(int count)
    {
        // This would normally calculate from loaded data
        _activeSensors = 8;
        _warningSensors = 2;
        _avgTemperature = 69.5;
        _avgAirQuality = 42.3;
        _avgHumidity = 65.8;
        StateHasChanged();
    }

    private void OnSensorClicked(FeatureClickedMessage message)
    {
        if (message.Properties.ContainsKey("id"))
        {
            _selectedSensor = new SensorFeature
            {
                Type = "Feature",
                Properties = new SensorProperties
                {
                    Id = message.Properties["id"]?.ToString() ?? "",
                    Name = message.Properties["name"]?.ToString() ?? "",
                    Type = message.Properties["type"]?.ToString() ?? "",
                    Temperature = Convert.ToDouble(message.Properties["temperature"]),
                    AirQuality = Convert.ToInt32(message.Properties["airQuality"]),
                    Humidity = Convert.ToInt32(message.Properties["humidity"]),
                    Timestamp = message.Properties["timestamp"]?.ToString() ?? "",
                    Status = message.Properties["status"]?.ToString() ?? ""
                },
                Geometry = message.Geometry
            };

            _showSensorDialog = true;
            StateHasChanged();
        }
    }

    private void ClearFilters()
    {
        _selectedSensorType = "All";
        _selectedStatus = "All";
        _minAirQuality = 0;
    }

    private Color GetTypeColor(string type) => type switch
    {
        "Air Quality" => Color.Success,
        "Temperature" => Color.Warning,
        _ => Color.Default
    };

    private Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Warning" => Color.Warning,
        "Maintenance" => Color.Error,
        _ => Color.Default
    };

    private Color GetAQIColor(int aqi)
    {
        if (aqi <= 50) return Color.Success;
        if (aqi <= 100) return Color.Info;
        return Color.Warning;
    }

    private string GetTemperatureColor(double temp)
    {
        if (temp < 60) return "#2196F3";
        if (temp < 70) return "#4CAF50";
        if (temp < 80) return "#FF9800";
        return "#F44336";
    }

    public class SensorFeature
    {
        public string Type { get; set; } = "Feature";
        public SensorProperties Properties { get; set; } = new();
        public object? Geometry { get; set; }
    }

    public class SensorProperties
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string Type { get; set; } = "";
        public double Temperature { get; set; }
        public int AirQuality { get; set; }
        public int Humidity { get; set; }
        public string Timestamp { get; set; } = "";
        public string Status { get; set; } = "";
    }
}
