@page "/vehicle-tracking"
<PageTitle>Vehicle Tracking - Honua MapSDK</PageTitle>

<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 16px;">
            <div>
                <h1 class="dashboard-title">
                    <MudIcon Icon="@Icons.Material.Filled.LocalShipping" Class="mr-2" />
                    Vehicle Tracking Dashboard
                </h1>
                <p class="dashboard-subtitle">
                    Monitor fleet operations in real-time. Track vehicle locations, status, and performance metrics.
                </p>
            </div>
            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                <MudChip Color="Color.Success" Icon="@Icons.Material.Filled.DirectionsCar">
                    @_activeVehicles Active
                </MudChip>
                <MudChip Color="Color.Warning" Icon="@Icons.Material.Filled.PauseCircle">
                    @_idleVehicles Idle
                </MudChip>
                <MudChip Color="Color.Error" Icon="@Icons.Material.Filled.Build">
                    @_maintenanceVehicles Maintenance
                </MudChip>
            </div>
        </div>
    </div>

    <!-- Dashboard Grid -->
    <div class="dashboard-grid">
        <!-- Map Section -->
        <div class="dashboard-map-section">
            <HonuaMap Id="vehicle-map"
                      MapStyle="https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json"
                      Center="new[] { -122.4194, 37.7749 }"
                      Zoom="12"
                      OnFeatureClicked="@OnVehicleClicked"
                      Style="width: 100%; height: 100%;" />
        </div>

        <!-- Data Section -->
        <div class="dashboard-data-section">
            <!-- Data Grid -->
            <div class="dashboard-grid-container">
                <HonuaDataGrid TItem="VehicleFeature"
                               Id="vehicle-grid"
                               SyncWith="vehicle-map"
                               DataSource="data/vehicles.geojson"
                               Title="Fleet Status"
                               ShowToolbar="true"
                               ShowSearch="true"
                               ShowExport="true"
                               Dense="true"
                               PageSize="10"
                               Filterable="true"
                               Sortable="true"
                               OnDataLoaded="@OnDataLoaded">
                    <Columns>
                        <PropertyColumn Property="x => x.Properties.Id" Title="ID" Sortable="true" />
                        <PropertyColumn Property="x => x.Properties.Name" Title="Vehicle" Sortable="true" Filterable="true">
                            <CellTemplate>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <MudIcon Icon="@GetVehicleIcon(context.Properties.VehicleType)" Size="Size.Small" />
                                    <span>@context.Properties.Name</span>
                                </div>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.VehicleType" Title="Type" Sortable="true" Filterable="true">
                            <CellTemplate>
                                <MudChip Size="Size.Small" Color="@GetVehicleTypeColor(context.Properties.VehicleType)">
                                    @context.Properties.VehicleType
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.Status" Title="Status" Sortable="true" Filterable="true">
                            <CellTemplate>
                                <MudChip Size="Size.Small" Color="@GetStatusColor(context.Properties.Status)">
                                    @context.Properties.Status
                                </MudChip>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.Speed" Title="Speed (mph)" Sortable="true">
                            <CellTemplate>
                                <span style="color: @GetSpeedColor(context.Properties.Speed);">
                                    @context.Properties.Speed mph
                                </span>
                            </CellTemplate>
                        </PropertyColumn>
                        <PropertyColumn Property="x => x.Properties.Driver" Title="Driver" Sortable="true" Filterable="true" />
                        <PropertyColumn Property="x => x.Properties.Route" Title="Route" Sortable="true" Filterable="true" />
                    </Columns>
                </HonuaDataGrid>
            </div>

            <!-- Charts Section -->
            <div class="dashboard-charts-container">
                <!-- Vehicle Status Bar Chart -->
                <div class="dashboard-chart-card">
                    <HonuaChart Id="status-chart"
                                SyncWith="vehicle-map"
                                Type="ChartType.Bar"
                                Field="status"
                                Title="Vehicles by Status"
                                Aggregation="AggregationType.Count"
                                EnableFilter="true"
                                AutoSync="true"
                                ColorScheme="cool"
                                Style="width: 100%; height: 200px;" />
                </div>

                <!-- Vehicle Type Pie Chart -->
                <div class="dashboard-chart-card">
                    <HonuaChart Id="type-chart"
                                SyncWith="vehicle-map"
                                Type="ChartType.Doughnut"
                                Field="vehicleType"
                                Title="Fleet Composition"
                                Aggregation="AggregationType.Count"
                                EnableFilter="true"
                                AutoSync="true"
                                ShowLegend="true"
                                LegendPosition="bottom"
                                Style="width: 100%; height: 200px;" />
                </div>

                <!-- Quick Stats Card -->
                <div class="component-panel" style="padding: 16px;">
                    <MudText Typo="Typo.h6" Class="mb-3">Fleet Metrics</MudText>
                    <MudStack Spacing="2">
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Total Fleet</MudText>
                            <MudText Typo="Typo.h5">@_totalVehicles</MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Avg Speed</MudText>
                            <MudText Typo="Typo.h6">@_avgSpeed.ToString("F1") mph</MudText>
                        </div>
                        <MudDivider />
                        <div>
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Utilization</MudText>
                            <MudProgressLinear Color="Color.Success" Value="@_utilization" Size="Size.Medium" Class="my-2" />
                            <MudText Typo="Typo.body2">@_utilization.ToString("F0")%</MudText>
                        </div>
                    </MudStack>
                </div>
            </div>
        </div>
    </div>

    <!-- Vehicle Detail Dialog -->
    @if (_selectedVehicle != null)
    {
        <MudDialog @bind-IsVisible="_showVehicleDialog" Options="_dialogOptions">
            <TitleContent>
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@GetVehicleIcon(_selectedVehicle.Properties.VehicleType)" Class="mr-2" />
                    Vehicle Details
                </MudText>
            </TitleContent>
            <DialogContent>
                <MudGrid>
                    <MudItem xs="12">
                        <MudText Typo="Typo.h5">@_selectedVehicle.Properties.Name</MudText>
                        <MudChip Size="Size.Small" Color="@GetStatusColor(_selectedVehicle.Properties.Status)">
                            @_selectedVehicle.Properties.Status
                        </MudChip>
                        <MudDivider Class="my-3" />
                    </MudItem>

                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Vehicle ID</MudText>
                        <MudText Typo="Typo.body1">@_selectedVehicle.Properties.Id</MudText>
                    </MudItem>

                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Vehicle Type</MudText>
                        <MudText Typo="Typo.body1">@_selectedVehicle.Properties.VehicleType</MudText>
                    </MudItem>

                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Current Speed</MudText>
                        <MudText Typo="Typo.h5" Style="@($"color: {GetSpeedColor(_selectedVehicle.Properties.Speed)};")">
                            @_selectedVehicle.Properties.Speed mph
                        </MudText>
                    </MudItem>

                    <MudItem xs="6">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Driver</MudText>
                        <MudText Typo="Typo.body1">@_selectedVehicle.Properties.Driver</MudText>
                    </MudItem>

                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Route</MudText>
                        <MudText Typo="Typo.body1">@_selectedVehicle.Properties.Route</MudText>
                    </MudItem>

                    <MudItem xs="12">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Last Update</MudText>
                        <MudText Typo="Typo.body2">@_selectedVehicle.Properties.Timestamp</MudText>
                    </MudItem>

                    @if (_selectedVehicle.Properties.Status == "Maintenance")
                    {
                        <MudItem xs="12">
                            <MudAlert Severity="Severity.Warning" Dense="true">
                                This vehicle is currently under maintenance and unavailable for dispatch.
                            </MudAlert>
                        </MudItem>
                    }
                </MudGrid>
            </DialogContent>
            <DialogActions>
                <MudButton Variant="Variant.Text" OnClick="@(() => _showVehicleDialog = false)">Close</MudButton>
                <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Route">
                    View Route History
                </MudButton>
            </DialogActions>
        </MudDialog>
    }
</div>

@code {
    private int _totalVehicles = 0;
    private int _activeVehicles = 0;
    private int _idleVehicles = 0;
    private int _maintenanceVehicles = 0;
    private double _avgSpeed = 0;
    private double _utilization = 0;

    private VehicleFeature? _selectedVehicle;
    private bool _showVehicleDialog = false;

    private DialogOptions _dialogOptions = new()
    {
        MaxWidth = MaxWidth.Medium,
        FullWidth = true,
        CloseButton = true
    };

    private void OnDataLoaded(int count)
    {
        _totalVehicles = count;
        _activeVehicles = 8;
        _idleVehicles = 2;
        _maintenanceVehicles = 2;
        _avgSpeed = 23.5;
        _utilization = 66.7;
        StateHasChanged();
    }

    private void OnVehicleClicked(FeatureClickedMessage message)
    {
        if (message.Properties.ContainsKey("id"))
        {
            _selectedVehicle = new VehicleFeature
            {
                Type = "Feature",
                Properties = new VehicleProperties
                {
                    Id = message.Properties["id"]?.ToString() ?? "",
                    Name = message.Properties["name"]?.ToString() ?? "",
                    VehicleType = message.Properties["vehicleType"]?.ToString() ?? "",
                    Status = message.Properties["status"]?.ToString() ?? "",
                    Speed = Convert.ToInt32(message.Properties["speed"]),
                    Driver = message.Properties["driver"]?.ToString() ?? "",
                    Route = message.Properties["route"]?.ToString() ?? "",
                    Timestamp = message.Properties["timestamp"]?.ToString() ?? ""
                },
                Geometry = message.Geometry
            };

            _showVehicleDialog = true;
            StateHasChanged();
        }
    }

    private Color GetStatusColor(string status) => status switch
    {
        "Active" => Color.Success,
        "Idle" => Color.Warning,
        "Maintenance" => Color.Error,
        _ => Color.Default
    };

    private Color GetVehicleTypeColor(string type) => type switch
    {
        "Delivery Truck" => Color.Primary,
        "Service Van" => Color.Info,
        "Sedan" => Color.Success,
        _ => Color.Default
    };

    private string GetVehicleIcon(string type) => type switch
    {
        "Delivery Truck" => Icons.Material.Filled.LocalShipping,
        "Service Van" => Icons.Material.Filled.DirectionsBus,
        "Sedan" => Icons.Material.Filled.DirectionsCar,
        _ => Icons.Material.Filled.DirectionsCar
    };

    private string GetSpeedColor(int speed)
    {
        if (speed == 0) return "#9E9E9E";
        if (speed < 25) return "#4CAF50";
        if (speed < 40) return "#FF9800";
        return "#F44336";
    }

    public class VehicleFeature
    {
        public string Type { get; set; } = "Feature";
        public VehicleProperties Properties { get; set; } = new();
        public object? Geometry { get; set; }
    }

    public class VehicleProperties
    {
        public string Id { get; set; } = "";
        public string Name { get; set; } = "";
        public string VehicleType { get; set; } = "";
        public string Status { get; set; } = "";
        public int Speed { get; set; }
        public string Driver { get; set; } = "";
        public string Route { get; set; } = "";
        public string Timestamp { get; set; } = "";
    }
}
