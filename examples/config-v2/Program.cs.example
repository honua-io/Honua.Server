// Copyright (c) 2025 HonuaIO
// Licensed under the Elastic License 2.0. See LICENSE file in the project root for full license information.

// Example Program.cs using Honua Configuration 2.0
// This replaces hundreds of lines of manual service registration!

using Honua.Server.Core.Configuration.V2;
using Honua.Server.Core.Configuration.V2.Services;
using Honua.Server.Core.Configuration.V2.Validation;

var builder = WebApplication.CreateBuilder(args);

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// CONFIGURATION 2.0: DECLARATIVE, VALIDATED, SIMPLE
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

// 1. Load configuration from file
var configPath = Environment.GetEnvironmentVariable("HONUA_CONFIG")
    ?? Path.Combine(builder.Environment.ContentRootPath, "honua.config.hcl");

var config = await HonuaConfigLoader.LoadAsync(configPath);

// 2. Validate configuration (fail fast!)
var validationResult = await ConfigurationValidator.ValidateFileAsync(
    configPath,
    ValidationOptions.Default); // Syntax + semantic validation (fast)

if (!validationResult.IsValid)
{
    Console.WriteLine("âŒ Configuration validation failed:\n");
    Console.WriteLine(validationResult.GetSummary());
    Environment.Exit(1);
}

if (validationResult.Warnings.Count > 0)
{
    Console.WriteLine("âš ï¸  Configuration warnings:\n");
    foreach (var warning in validationResult.Warnings)
    {
        Console.WriteLine($"  â€¢ {warning.Message}");
    }
    Console.WriteLine();
}

// 3. Register ALL services from configuration automatically!
// No more manual if/else chains, no more Program.cs plumbing!
builder.Services.AddHonuaFromConfiguration(config, options =>
{
    // Optional: customize discovery
    // options.AssembliesToScan.Add(typeof(MyCustomService).Assembly);
    // options.ThrowOnValidationErrors = true;
});

// 4. Add standard ASP.NET Core services
builder.Services.AddControllers();
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen();

var app = builder.Build();

// 5. Configure middleware pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();
app.UseAuthorization();

// 6. Map ALL service endpoints from configuration automatically!
// No more manual MapXxxEndpoints() calls!
app.MapHonuaEndpoints();

app.MapControllers();

// 7. Display startup information
var metadata = app.Services.GetRequiredService<HonuaServiceMetadata>();
Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");
Console.WriteLine($"ğŸš€ Honua Server starting in {config.Honua.Environment} mode");
Console.WriteLine($"ğŸ“‹ Configuration: {Path.GetFileName(configPath)}");
Console.WriteLine($"âœ… Registered {metadata.RegisteredServices.Count} services:");
foreach (var service in metadata.RegisteredServices)
{
    Console.WriteLine($"   â€¢ {service}");
}
Console.WriteLine("â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”");

app.Run();

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// BEFORE (OLD SYSTEM) - Hundreds of lines:
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
/*
var odataEnabled = config.GetValue<bool>("honua:services:odata:enabled");
if (odataEnabled)
{
    builder.Services.AddOData(options => {
        options.AllowWrites = config.GetValue<bool>("honua:services:odata:allowWrites");
        options.MaxPageSize = config.GetValue<int>("honua:services:odata:maxPageSize");
        // ... 20 more settings
    });
}

var ogcApiEnabled = config.GetValue<bool>("honua:services:ogcapi:enabled");
if (ogcApiEnabled)
{
    builder.Services.AddOgcApi(options => {
        // ... configure
    });
}

// ... repeat for 10+ services

// Then in app configuration:
if (odataEnabled)
{
    app.MapODataEndpoints();
}

if (ogcApiEnabled)
{
    app.MapOgcApiEndpoints();
}

// ... repeat for 10+ services
*/

// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
// AFTER (NEW SYSTEM) - 7 lines total:
// â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
/*
var config = await HonuaConfigLoader.LoadAsync("honua.config.hcl");
await ConfigurationValidator.ValidateFileAsync("honua.config.hcl");

builder.Services.AddHonuaFromConfiguration(config);
// ... standard ASP.NET setup
app.MapHonuaEndpoints();

// DONE! All services configured from .honua file!
*/
