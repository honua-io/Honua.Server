# Dockerfile.test-cached
# Cached Honua build with preloaded test data for fast parallel integration testing
#
# This image includes:
# - Prebuilt Honua binaries (ReadyToRun optimized)
# - SQLite databases with seed data (ogc-sample.db, stac-catalog.db)
# - Test metadata configuration
# - Authentication database
#
# Build: docker build -f Dockerfile.test-cached -t honua:test-cached .
# Run:   docker run -p 8080:8080 honua:test-cached

FROM mcr.microsoft.com/dotnet/sdk:9.0-alpine AS build
WORKDIR /src

# Copy and restore dependencies (cached layer)
COPY ["src/Honua.Server.Host/Honua.Server.Host.csproj", "src/Honua.Server.Host/"]
COPY ["src/Honua.Server.Core/Honua.Server.Core.csproj", "src/Honua.Server.Core/"]
COPY ["src/Honua.Server.Enterprise/Honua.Server.Enterprise.csproj", "src/Honua.Server.Enterprise/"]
COPY ["Directory.Build.props", "./"]
RUN dotnet restore "src/Honua.Server.Host/Honua.Server.Host.csproj" \
    -r linux-musl-x64

# Copy source and build
COPY src/ src/
RUN dotnet publish "src/Honua.Server.Host/Honua.Server.Host.csproj" \
    -c Release \
    -o /app/publish \
    -r linux-musl-x64 \
    --no-restore \
    --self-contained false

# Runtime stage with preloaded test data
FROM mcr.microsoft.com/dotnet/aspnet:9.0-alpine AS runtime
WORKDIR /app

# Install health check dependencies
RUN apk add --no-cache wget

# Copy published application
COPY --from=build /app/publish .

# Create data directory and copy test data
RUN mkdir -p /data /data/auth

# Copy prebuilt test databases (these will be baked into the image)
COPY tests/TestData/ogc-sample.db /data/ogc-sample.db
COPY tests/TestData/test-metadata.json /data/test-metadata.json

# Set permissions
RUN chmod -R 755 /data

# Environment configuration for test mode
ENV ASPNETCORE_ENVIRONMENT=Development \
    ASPNETCORE_URLS=http://+:8080 \
    HONUA__METADATA__PROVIDER=json \
    HONUA__METADATA__PATH=/data/test-metadata.json \
    HONUA__AUTHENTICATION__MODE=Local \
    HONUA__AUTHENTICATION__ENFORCE=false \
    HONUA__AUTHENTICATION__QUICKSTART__ENABLED=true \
    HONUA__CACHE__PROVIDER=memory \
    DOTNET_TieredPGO=1 \
    DOTNET_ReadyToRun=1 \
    Logging__LogLevel__Default=Information \
    Logging__LogLevel__Microsoft.AspNetCore=Warning \
    Logging__LogLevel__Honua=Debug

EXPOSE 8080

HEALTHCHECK --interval=5s --timeout=3s --retries=10 --start-period=20s \
    CMD wget --no-verbose --tries=1 --spider http://localhost:8080/health || exit 1

ENTRYPOINT ["dotnet", "Honua.Server.Host.dll"]
