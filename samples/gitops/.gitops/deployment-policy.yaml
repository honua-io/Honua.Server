apiVersion: honua.io/v1
kind: DeploymentPolicy
metadata:
  name: honua-deployment-policy

environments:
  development:
    autoApprove: true
    requiresValidation: true
    allowBreakingChanges: true

    safety:
      requireBackup: false
      healthCheckTimeout: 60
      rollbackOnFailure: true

  staging:
    autoApprove: true
    requiresValidation: true
    allowBreakingChanges: true

    safety:
      requireBackup: true
      healthCheckTimeout: 120
      rollbackOnFailure: true

  production:
    autoApprove: false  # Manual approval required
    requiresValidation: true
    allowBreakingChanges: false

    # Approval required if any of these conditions are met
    approvalRules:
      - name: resources-removed
        condition: resourcesRemoved > 0
        reason: "Removing resources requires approval"

      - name: significant-changes
        condition: (resourcesModified + resourcesAdded) > 10
        reason: "Large changes require approval"

      - name: breaking-changes
        condition: breakingChanges == true
        reason: "Breaking changes require approval"

      - name: datasource-changes
        condition: type == "datasource"
        reason: "Database connection changes require approval"

    # Additional safety checks for production
    safety:
      requireBackup: true
      healthCheckTimeout: 300
      rollbackOnFailure: true

      # Deployment windows (UTC)
      deploymentWindows:
        - dayOfWeek: Monday
          startTime: "09:00"
          endTime: "17:00"
        - dayOfWeek: Tuesday
          startTime: "09:00"
          endTime: "17:00"
        - dayOfWeek: Wednesday
          startTime: "09:00"
          endTime: "17:00"
        - dayOfWeek: Thursday
          startTime: "09:00"
          endTime: "17:00"
        - dayOfWeek: Friday
          startTime: "09:00"
          endTime: "15:00"  # No Friday afternoon deploys

      # Blackout periods (no deployments allowed)
      blackoutPeriods:
        - name: "Holiday Season"
          startDate: "2024-12-20"
          endDate: "2025-01-05"
          reason: "Deployment freeze during holiday season"

    # Notification settings
    notifications:
      onApprovalRequired:
        - type: email
          recipients:
            - ops@example.com
            - devops@example.com

        - type: slack
          channel: "#deployments"

      onDeploymentCompleted:
        - type: slack
          channel: "#deployments"

      onDeploymentFailed:
        - type: pagerduty
          serviceKey: "${PAGERDUTY_SERVICE_KEY}"

        - type: slack
          channel: "#incidents"
