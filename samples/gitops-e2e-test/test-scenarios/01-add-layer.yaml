# Test Scenario 01: Add a New Layer
#
# This scenario tests the GitOps workflow when adding a completely new layer
# to an existing service.

scenario:
  id: "01-add-layer"
  name: "Add New Layer to Service"
  description: "Add a new facilities layer to the test service"
  risk_level: "low"
  environment: "development"

objectives:
  - Test that GitWatcher detects the metadata change
  - Verify HonuaReconciler successfully processes the new layer
  - Confirm MetadataRegistry reloads with the new layer
  - Validate the new layer is accessible via API

steps:
  - step: 1
    action: "Navigate to test repository"
    command: "cd /tmp/honua-gitops-test-repo"

  - step: 2
    action: "Edit metadata.json to add new layer"
    command: "vim environments/development/metadata.json"
    note: "Add the layer definition shown in the 'layer_to_add' section below"

  - step: 3
    action: "Commit the change"
    commands:
      - "git add environments/development/metadata.json"
      - "git commit -m 'Add facilities layer for testing'"

  - step: 4
    action: "Wait for GitWatcher to detect change"
    expected_time: "10-15 seconds"
    expected_log: "Detected new commit:"

  - step: 5
    action: "Verify reconciliation"
    expected_log: "Successfully reconciled 'metadata' for environment 'development'"

  - step: 6
    action: "Validate deployment state"
    command: "cat /tmp/honua-gitops-state/deployments/*.json | jq '.State'"
    expected_output: "Completed"

layer_to_add:
  description: "Add this layer to the 'layers' array in metadata.json"
  json: |
    {
      "id": "facilities",
      "title": "Facilities",
      "description": "Public facilities and amenities",
      "datasource": "test-postgis",
      "table": "public.facilities",
      "geometryColumn": "geom",
      "geometryType": "Point",
      "srid": 4326,
      "fields": [
        {
          "name": "id",
          "type": "integer",
          "alias": "Facility ID"
        },
        {
          "name": "name",
          "type": "string",
          "alias": "Facility Name"
        },
        {
          "name": "facility_type",
          "type": "string",
          "alias": "Type"
        },
        {
          "name": "status",
          "type": "string",
          "alias": "Status"
        },
        {
          "name": "capacity",
          "type": "integer",
          "alias": "Capacity"
        }
      ]
    }

expected_behavior:
  - event: "Git commit detected"
    timing: "Within poll interval (10 seconds)"
    log_pattern: "Detected new commit: .* -> .*"

  - event: "Reconciliation triggered"
    timing: "Immediately after detection"
    log_pattern: "Starting reconciliation for environment 'development'"

  - event: "Metadata file retrieved"
    timing: "During reconciliation"
    log_pattern: "Retrieving 'metadata' configuration from Git"

  - event: "JSON validation"
    timing: "Before applying"
    log_pattern: "Successfully parsed JSON for 'metadata'"

  - event: "Configuration applied"
    timing: "After validation"
    log_pattern: "Applying 'metadata' configuration"

  - event: "Metadata registry reload"
    timing: "Final step"
    log_pattern: "Successfully reloaded metadata registry"

  - event: "Reconciliation complete"
    timing: "End of process"
    log_pattern: "Successfully completed reconciliation.*in \\d+ms"

validation:
  checks:
    - type: "log"
      description: "Verify reconciliation succeeded"
      command: "grep 'Successfully completed reconciliation' logs/honua-*.log | tail -1"
      expected_contains: "development"

    - type: "state"
      description: "Check deployment state is Completed"
      command: "cat /tmp/honua-gitops-state/deployments/*.json | jq -r '.State' | tail -1"
      expected_output: "Completed"

    - type: "metadata"
      description: "Verify new layer exists in reconciled metadata"
      command: "cat /tmp/honua-gitops-test-repo/reconciled/development/metadata.json | jq '.services[0].layers | length'"
      expected_output: "2"  # Original layer + new facilities layer

    - type: "validation_results"
      description: "Check validation results are successful"
      command: "cat /tmp/honua-gitops-state/deployments/*.json | jq -r '.ValidationResults[-1].Success' | tail -1"
      expected_output: "true"

troubleshooting:
  issues:
    - symptom: "Change not detected"
      possible_causes:
        - "GitWatcher not running"
        - "Poll interval not elapsed"
        - "File path doesn't match watched environment"
      solutions:
        - "Check Honua logs for GitWatcher startup"
        - "Wait for full poll interval (10 seconds)"
        - "Verify file is in environments/development/"

    - symptom: "Invalid JSON error"
      possible_causes:
        - "Missing comma between layers"
        - "Extra comma after last field"
        - "Mismatched brackets"
      solutions:
        - "Validate JSON: cat metadata.json | jq '.'"
        - "Check for trailing commas"
        - "Ensure proper array syntax"

    - symptom: "Reconciliation fails"
      possible_causes:
        - "Invalid layer schema"
        - "Missing required fields"
        - "Datasource doesn't exist"
      solutions:
        - "Check reconciliation error in logs"
        - "Verify all required fields are present"
        - "Confirm datasource 'test-postgis' is defined"

notes:
  - "This is a low-risk, non-breaking change"
  - "No approval should be required for development environment"
  - "The layer can be removed in scenario 03-delete-layer"
  - "Actual database table doesn't need to exist for testing reconciliation"

related_scenarios:
  - "02-modify-layer.yaml - Test modifying the added layer"
  - "03-delete-layer.yaml - Test removing this layer"

success_criteria:
  - "Commit detected within 10 seconds"
  - "Reconciliation completes without errors"
  - "Deployment state transitions to Completed"
  - "No error logs generated"
  - "Metadata registry reflects new layer"
