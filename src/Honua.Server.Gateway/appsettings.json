{
  "ServiceName": "honua-gateway",
  "ServiceVersion": "1.0.0",

  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Yarp": "Information"
    }
  },

  "Serilog": {
    "Using": ["Serilog.Sinks.Console"],
    "MinimumLevel": {
      "Default": "Information",
      "Override": {
        "Microsoft": "Warning",
        "System": "Warning"
      }
    },
    "WriteTo": [
      {
        "Name": "Console",
        "Args": {
          "outputTemplate": "[{Timestamp:yyyy-MM-dd HH:mm:ss.fff zzz}] [{Level:u3}] [{SourceContext}] {Message:lj}{NewLine}{Exception}"
        }
      }
    ],
    "Enrich": ["FromLogContext", "WithMachineName", "WithThreadId"]
  },

  "AllowedHosts": "*",

  "OpenTelemetry": {
    "OtlpEndpoint": ""
  },

  "Redis": {
    "ConnectionString": ""
  },

  "BackendServices": {
    "api": "http://honua-api.honua.svc.cluster.local:8080",
    "intake": "http://honua-intake.honua.svc.cluster.local:8080",
    "orchestrator": "http://honua-orchestrator.honua.svc.cluster.local:8080",
    "prometheus": "http://prometheus.honua.svc.cluster.local:9090",
    "grafana": "http://grafana.honua.svc.cluster.local:3000"
  },

  "RateLimiting": {
    "GlobalPermitLimit": 10000,
    "GlobalWindowSeconds": 60,
    "PerIpPermitLimit": 100,
    "PerIpWindowSeconds": 60
  },

  "Cors": {
    "AllowedOrigins": []
  },

  "ReverseProxy": {
    "Routes": {
      "tenant-odata-route": {
        "ClusterId": "odata-cluster",
        "Match": {
          "Hosts": ["{tenant}.honua.io"],
          "Path": "/odata/{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeader": "X-Tenant-Id",
            "Set": "{tenant}"
          },
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Order": 1,
        "Metadata": {
          "Description": "Tenant OData endpoints (non-AOT, reflection enabled)"
        }
      },
      "tenant-raster-route": {
        "ClusterId": "raster-cluster",
        "Match": {
          "Hosts": ["{tenant}.honua.io"],
          "Path": "/raster/{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeader": "X-Tenant-Id",
            "Set": "{tenant}"
          },
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Order": 2,
        "Metadata": {
          "Description": "Tenant raster processing (heavyweight ECS/K8s)"
        }
      },
      "tenant-vector-route": {
        "ClusterId": "vector-cluster",
        "Match": {
          "Hosts": ["{tenant}.honua.io"],
          "Path": "/vector/{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeader": "X-Tenant-Id",
            "Set": "{tenant}"
          },
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Order": 3,
        "Metadata": {
          "Description": "Tenant vector data (lightweight Lambda functions)"
        }
      },
      "tenant-stac-route": {
        "ClusterId": "api-cluster",
        "Match": {
          "Hosts": ["{tenant}.honua.io"],
          "Path": "/stac/{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeader": "X-Tenant-Id",
            "Set": "{tenant}"
          },
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Order": 4,
        "Metadata": {
          "Description": "Tenant STAC API endpoints"
        }
      },
      "tenant-api-route": {
        "ClusterId": "api-cluster",
        "Match": {
          "Hosts": ["{tenant}.honua.io"],
          "Path": "/api/{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeader": "X-Tenant-Id",
            "Set": "{tenant}"
          },
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Order": 5,
        "Metadata": {
          "Description": "Tenant core API endpoints"
        }
      },
      "tenant-root-route": {
        "ClusterId": "api-cluster",
        "Match": {
          "Hosts": ["{tenant}.honua.io"],
          "Path": "/{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeader": "X-Tenant-Id",
            "Set": "{tenant}"
          },
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Order": 100,
        "Metadata": {
          "Description": "Tenant catch-all route"
        }
      },
      "api-route": {
        "ClusterId": "api-cluster",
        "Match": {
          "Hosts": ["api.honua.io"],
          "Path": "{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Order": 200,
        "Metadata": {
          "Description": "Main API endpoints - STAC, OGC, GeoServices"
        }
      },
      "intake-route": {
        "ClusterId": "intake-cluster",
        "Match": {
          "Hosts": ["intake.honua.example.com", "intake.honua.io"],
          "Path": "{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeaderOriginalHost": "true"
          },
          {
            "RequestHeadersCopy": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Metadata": {
          "Description": "Data ingestion service"
        }
      },
      "orchestrator-route": {
        "ClusterId": "orchestrator-cluster",
        "Match": {
          "Hosts": ["orchestrator.honua.example.com", "orchestrator.honua.io"],
          "Path": "{**catch-all}"
        },
        "Transforms": [
          {
            "RequestHeaderOriginalHost": "true"
          }
        ],
        "RateLimiterPolicy": "per-ip",
        "Metadata": {
          "Description": "Build orchestrator service"
        }
      },
      "prometheus-route": {
        "ClusterId": "prometheus-cluster",
        "Match": {
          "Hosts": ["prometheus.honua.example.com", "prometheus.honua.io"],
          "Path": "{**catch-all}"
        },
        "AuthorizationPolicy": "authenticated",
        "Metadata": {
          "Description": "Prometheus monitoring (requires authentication)"
        }
      },
      "grafana-route": {
        "ClusterId": "grafana-cluster",
        "Match": {
          "Hosts": ["grafana.honua.example.com", "grafana.honua.io"],
          "Path": "{**catch-all}"
        },
        "AuthorizationPolicy": "authenticated",
        "Metadata": {
          "Description": "Grafana dashboards (requires authentication)"
        }
      }
    },

    "Clusters": {
      "odata-cluster": {
        "Destinations": {
          "odata-primary": {
            "Address": "http://honua-odata.honua.svc.cluster.local:8080"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:10",
            "Policy": "ConsecutiveFailures",
            "Path": "/health/ready"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:10:00"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "OData API (non-AOT)"
        }
      },

      "raster-cluster": {
        "Destinations": {
          "raster-primary": {
            "Address": "http://honua-raster.honua.svc.cluster.local:8080"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:10",
            "Policy": "ConsecutiveFailures",
            "Path": "/health/ready"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:20:00"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "Raster Processing (heavyweight)"
        }
      },

      "vector-cluster": {
        "Destinations": {
          "vector-lambda": {
            "Address": "https://LAMBDA_URL.lambda-url.us-east-1.on.aws"
          }
        },
        "HttpRequest": {
          "Timeout": "00:05:00",
          "Version": "2",
          "VersionPolicy": "RequestVersionOrHigher"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "Vector Data (Lambda serverless)"
        }
      },

      "api-cluster": {
        "Destinations": {
          "api-primary": {
            "Address": "http://honua-api.honua.svc.cluster.local:8080",
            "Health": "http://honua-api.honua.svc.cluster.local:8080/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:10",
            "Policy": "ConsecutiveFailures",
            "Path": "/health/ready"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:10:00",
          "Version": "2",
          "VersionPolicy": "RequestVersionOrLower"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "Main API"
        }
      },

      "intake-cluster": {
        "Destinations": {
          "intake-primary": {
            "Address": "http://honua-intake.honua.svc.cluster.local:8080",
            "Health": "http://honua-intake.honua.svc.cluster.local:8080/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:10",
            "Policy": "ConsecutiveFailures",
            "Path": "/health/ready"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:10:00",
          "Version": "2",
          "VersionPolicy": "RequestVersionOrLower"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "Data Ingestion"
        }
      },

      "orchestrator-cluster": {
        "Destinations": {
          "orchestrator-primary": {
            "Address": "http://honua-orchestrator.honua.svc.cluster.local:8080",
            "Health": "http://honua-orchestrator.honua.svc.cluster.local:8080/health"
          }
        },
        "HealthCheck": {
          "Active": {
            "Enabled": true,
            "Interval": "00:00:30",
            "Timeout": "00:00:10",
            "Policy": "ConsecutiveFailures",
            "Path": "/health/ready"
          },
          "Passive": {
            "Enabled": true,
            "Policy": "TransportFailureRate",
            "ReactivationPeriod": "00:01:00"
          }
        },
        "HttpRequest": {
          "Timeout": "00:10:00",
          "Version": "2",
          "VersionPolicy": "RequestVersionOrLower"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "Build Orchestrator"
        }
      },

      "prometheus-cluster": {
        "Destinations": {
          "prometheus-primary": {
            "Address": "http://prometheus.honua.svc.cluster.local:9090"
          }
        },
        "HttpRequest": {
          "Timeout": "00:05:00"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "Prometheus Monitoring"
        }
      },

      "grafana-cluster": {
        "Destinations": {
          "grafana-primary": {
            "Address": "http://grafana.honua.svc.cluster.local:3000"
          }
        },
        "HttpRequest": {
          "Timeout": "00:05:00"
        },
        "LoadBalancingPolicy": "RoundRobin",
        "Metadata": {
          "Service": "Grafana Dashboards"
        }
      }
    }
  }
}
