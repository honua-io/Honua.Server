# Kubernetes Integration Example for YARP Traffic Management
# This demonstrates how to deploy blue-green environments and integrate with the YARP gateway

---
# Blue Deployment (Current/Stable Version)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: honua-api-blue
  namespace: honua
  labels:
    app: honua-api
    environment: blue
    version: v1.0.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: honua-api
      environment: blue
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: honua-api
        environment: blue
        version: v1.0.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: api
          image: honua-api:v1.0.0
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Production"
            - name: DEPLOYMENT_ENVIRONMENT
              value: "blue"
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
          startupProbe:
            httpGet:
              path: /health/startup
              port: http
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30

---
# Green Deployment (New Version)
apiVersion: apps/v1
kind: Deployment
metadata:
  name: honua-api-green
  namespace: honua
  labels:
    app: honua-api
    environment: green
    version: v1.1.0
spec:
  replicas: 3
  selector:
    matchLabels:
      app: honua-api
      environment: green
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: honua-api
        environment: green
        version: v1.1.0
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "8080"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: api
          image: honua-api:v1.1.0
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 8080
              protocol: TCP
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Production"
            - name: DEPLOYMENT_ENVIRONMENT
              value: "green"
          resources:
            requests:
              cpu: 500m
              memory: 512Mi
            limits:
              cpu: 2000m
              memory: 2Gi
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 2
          startupProbe:
            httpGet:
              path: /health/startup
              port: http
            initialDelaySeconds: 0
            periodSeconds: 5
            timeoutSeconds: 3
            failureThreshold: 30

---
# Blue Service
apiVersion: v1
kind: Service
metadata:
  name: honua-api-blue
  namespace: honua
  labels:
    app: honua-api
    environment: blue
spec:
  type: ClusterIP
  selector:
    app: honua-api
    environment: blue
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
  sessionAffinity: None

---
# Green Service
apiVersion: v1
kind: Service
metadata:
  name: honua-api-green
  namespace: honua
  labels:
    app: honua-api
    environment: green
spec:
  type: ClusterIP
  selector:
    app: honua-api
    environment: green
  ports:
    - name: http
      port: 8080
      targetPort: http
      protocol: TCP
  sessionAffinity: None

---
# YARP Gateway Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: honua-gateway
  namespace: honua
  labels:
    app: honua-gateway
spec:
  replicas: 2
  selector:
    matchLabels:
      app: honua-gateway
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: honua-gateway
      annotations:
        prometheus.io/scrape: "true"
        prometheus.io/port: "5000"
        prometheus.io/path: "/metrics"
    spec:
      containers:
        - name: gateway
          image: honua-gateway:latest
          imagePullPolicy: Always
          ports:
            - name: http
              containerPort: 5000
              protocol: TCP
          env:
            - name: ASPNETCORE_ENVIRONMENT
              value: "Production"
            - name: ASPNETCORE_URLS
              value: "http://+:5000"
          resources:
            requests:
              cpu: 250m
              memory: 256Mi
            limits:
              cpu: 1000m
              memory: 1Gi
          livenessProbe:
            httpGet:
              path: /health/live
              port: http
            initialDelaySeconds: 10
            periodSeconds: 10
          readinessProbe:
            httpGet:
              path: /health/ready
              port: http
            initialDelaySeconds: 5
            periodSeconds: 5
          volumeMounts:
            - name: config
              mountPath: /app/appsettings.json
              subPath: appsettings.json
              readOnly: true
      volumes:
        - name: config
          configMap:
            name: gateway-config

---
# Gateway Service (LoadBalancer for external access)
apiVersion: v1
kind: Service
metadata:
  name: honua-gateway
  namespace: honua
  labels:
    app: honua-gateway
spec:
  type: LoadBalancer
  selector:
    app: honua-gateway
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
    - name: https
      port: 443
      targetPort: http
      protocol: TCP
  sessionAffinity: None

---
# Gateway ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: gateway-config
  namespace: honua
data:
  appsettings.json: |
    {
      "ServiceName": "honua-gateway",
      "ServiceVersion": "1.0.0",
      "Logging": {
        "LogLevel": {
          "Default": "Information",
          "Yarp": "Information"
        }
      },
      "ReverseProxy": {
        "Routes": {
          "api-route": {
            "ClusterId": "api-cluster",
            "Match": {
              "Path": "/{**catch-all}"
            }
          }
        },
        "Clusters": {
          "api-cluster": {
            "Destinations": {
              "blue": {
                "Address": "http://honua-api-blue.honua.svc.cluster.local:8080",
                "Health": "http://honua-api-blue.honua.svc.cluster.local:8080/health"
              },
              "green": {
                "Address": "http://honua-api-green.honua.svc.cluster.local:8080",
                "Health": "http://honua-api-green.honua.svc.cluster.local:8080/health"
              }
            },
            "LoadBalancingPolicy": "WeightedRoundRobin",
            "HealthCheck": {
              "Active": {
                "Enabled": true,
                "Interval": "00:00:10",
                "Timeout": "00:00:05",
                "Policy": "ConsecutiveFailures",
                "Path": "/health/ready"
              },
              "Passive": {
                "Enabled": true,
                "Policy": "TransportFailureRate",
                "ReactivationPeriod": "00:01:00"
              }
            }
          }
        }
      }
    }

---
# ServiceAccount for traffic management operations (optional, for K8s-based automation)
apiVersion: v1
kind: ServiceAccount
metadata:
  name: traffic-manager
  namespace: honua

---
# Role for traffic management
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: traffic-manager
  namespace: honua
rules:
  - apiGroups: [""]
    resources: ["configmaps"]
    verbs: ["get", "list", "watch", "update", "patch"]
  - apiGroups: [""]
    resources: ["services"]
    verbs: ["get", "list", "watch"]
  - apiGroups: ["apps"]
    resources: ["deployments"]
    verbs: ["get", "list", "watch"]
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["get", "list", "watch"]

---
# RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: traffic-manager
  namespace: honua
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: traffic-manager
subjects:
  - kind: ServiceAccount
    name: traffic-manager
    namespace: honua

---
# Example Job: Automated Canary Deployment
apiVersion: batch/v1
kind: Job
metadata:
  name: canary-deployment
  namespace: honua
spec:
  ttlSecondsAfterFinished: 3600
  template:
    metadata:
      labels:
        job: canary-deployment
    spec:
      serviceAccountName: traffic-manager
      restartPolicy: OnFailure
      containers:
        - name: deploy
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              # Wait for green deployment to be ready
              echo "Waiting for green deployment to be ready..."
              kubectl wait --for=condition=available --timeout=300s deployment/honua-api-green -n honua

              # Perform canary deployment via gateway API
              echo "Starting canary deployment..."
              curl -X POST http://honua-gateway.honua.svc.cluster.local/admin/traffic/canary \
                -H "Authorization: Bearer $GATEWAY_TOKEN" \
                -H "Content-Type: application/json" \
                -d '{
                  "serviceName": "api-cluster",
                  "blueEndpoint": "http://honua-api-blue.honua.svc.cluster.local:8080",
                  "greenEndpoint": "http://honua-api-green.honua.svc.cluster.local:8080",
                  "strategy": {
                    "trafficSteps": [10, 25, 50, 100],
                    "soakDurationSeconds": 300,
                    "autoRollback": true
                  }
                }'

              echo "Canary deployment completed"
          env:
            - name: GATEWAY_TOKEN
              valueFrom:
                secretKeyRef:
                  name: gateway-api-token
                  key: token

---
# Example HorizontalPodAutoscaler for blue environment
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: honua-api-blue
  namespace: honua
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: honua-api-blue
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30

---
# Example HorizontalPodAutoscaler for green environment
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: honua-api-green
  namespace: honua
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: honua-api-green
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 50
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 60
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
