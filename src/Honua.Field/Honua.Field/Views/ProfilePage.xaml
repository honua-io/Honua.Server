<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:HonuaField.ViewModels"
             xmlns:converters="clr-namespace:HonuaField.Converters"
             x:Class="HonuaField.Views.ProfilePage"
             x:DataType="viewmodels:ProfileViewModel"
             Title="{Binding Title}">

    <ContentPage.Resources>
        <ResourceDictionary>
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:FileSizeToStringConverter x:Key="FileSizeConverter" />
            <converters:PercentageToProgressConverter x:Key="PercentageToProgressConverter" />
            <converters:IsNotNullConverter x:Key="IsNotNullConverter" />
        </ResourceDictionary>
    </ContentPage.Resources>

    <ScrollView>
        <VerticalStackLayout Style="{StaticResource FormLayout}">

            <!-- User Profile Header -->
            <Frame Style="{StaticResource CardFrame}">
                <Grid ColumnDefinitions="Auto,*" ColumnSpacing="16">
                    <!-- Avatar/Initials Circle -->
                    <Frame Grid.Column="0"
                           WidthRequest="80"
                           HeightRequest="80"
                           CornerRadius="40"
                           BackgroundColor="{StaticResource PrimaryBlue}"
                           Padding="0"
                           HasShadow="False"
                           VerticalOptions="Center">
                        <Label Text="{Binding Username, StringFormat='{0:0.2}'}"
                               Style="{StaticResource H2}"
                               TextColor="{StaticResource White}"
                               HorizontalOptions="Center"
                               VerticalOptions="Center" />
                    </Frame>

                    <!-- User Info -->
                    <VerticalStackLayout Grid.Column="1" Spacing="4" VerticalOptions="Center">
                        <Label Text="{Binding FullName}"
                               Style="{StaticResource H3}"
                               IsVisible="{Binding FullName, Converter={StaticResource IsNotNullConverter}}" />
                        <Label Text="{Binding Username}"
                               Style="{StaticResource BodyMedium}"
                               FontAttributes="Bold" />
                        <Label Text="{Binding Email}"
                               Style="{StaticResource BodySmall}"
                               TextColor="{StaticResource TextSecondary}" />
                        <HorizontalStackLayout Spacing="8" Margin="0,4,0,0">
                            <Label Text="ID:"
                                   Style="{StaticResource CaptionText}" />
                            <Label Text="{Binding UserId}"
                                   Style="{StaticResource CaptionText}"
                                   FontAttributes="Bold" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Grid>
            </Frame>

            <!-- Account Information -->
            <Label Text="ACCOUNT" Style="{StaticResource SectionHeader}" />
            <Frame Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="16">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Organization" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding OrganizationId}" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                        </VerticalStackLayout>
                    </Grid>

                    <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" />

                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Account Type" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding AccountType}" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                        </VerticalStackLayout>
                        <Label Grid.Column="1"
                               Text="âœ“ Verified"
                               Style="{StaticResource BodySmall}"
                               TextColor="{StaticResource SuccessGreen}"
                               IsVisible="{Binding IsAccountVerified}"
                               VerticalOptions="Center" />
                    </Grid>

                    <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" />

                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Member Since" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding AccountCreatedDate, StringFormat='{0:MMM dd, yyyy}'}"
                                   Style="{StaticResource BodyMedium}"
                                   FontAttributes="Bold" />
                        </VerticalStackLayout>
                    </Grid>

                    <HorizontalStackLayout Spacing="12">
                        <Button Text="Edit Profile"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding EditProfileCommand}"
                                HorizontalOptions="FillAndExpand" />
                        <Button Text="View Details"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding ViewAccountDetailsCommand}"
                                HorizontalOptions="FillAndExpand" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Storage Usage -->
            <Label Text="STORAGE" Style="{StaticResource SectionHeader}" />
            <Frame Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="16">
                    <HorizontalStackLayout Spacing="8">
                        <Label Text="{Binding StorageUsed}"
                               Style="{StaticResource BodyMedium}"
                               FontAttributes="Bold" />
                        <Label Text="of"
                               Style="{StaticResource BodyMedium}" />
                        <Label Text="{Binding StorageAvailable}"
                               Style="{StaticResource BodyMedium}"
                               FontAttributes="Bold" />
                        <Label Text="used"
                               Style="{StaticResource BodyMedium}" />
                    </HorizontalStackLayout>

                    <ProgressBar Progress="{Binding StoragePercentage, Converter={StaticResource PercentageToProgressConverter}}"
                                 ProgressColor="{StaticResource PrimaryBlue}"
                                 HeightRequest="8" />

                    <HorizontalStackLayout Spacing="8">
                        <Label Text="{Binding StoragePercentage, StringFormat='{0}%'}"
                               Style="{StaticResource BodySmall}"
                               TextColor="{StaticResource TextSecondary}" />
                        <Label Text="used"
                               Style="{StaticResource BodySmall}"
                               TextColor="{StaticResource TextSecondary}" />
                    </HorizontalStackLayout>

                    <Button Text="Manage Storage"
                            Style="{StaticResource SecondaryButton}"
                            Command="{Binding ManageStorageCommand}" />
                </VerticalStackLayout>
            </Frame>

            <!-- Sync Status -->
            <Label Text="SYNC STATUS" Style="{StaticResource SectionHeader}" />
            <Frame Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="16">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Last Sync" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding LastSyncTime}" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                        </VerticalStackLayout>
                        <ActivityIndicator Grid.Column="1"
                                         IsRunning="{Binding IsSyncing}"
                                         IsVisible="{Binding IsSyncing}"
                                         VerticalOptions="Center" />
                    </Grid>

                    <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" />

                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Status" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding SyncStatus}" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                        </VerticalStackLayout>
                    </Grid>

                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12"
                          IsVisible="{Binding PendingChanges}">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Pending Changes" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding PendingChanges}" Style="{StaticResource BodyMedium}" FontAttributes="Bold" TextColor="{StaticResource WarningYellow}" />
                        </VerticalStackLayout>
                    </Grid>

                    <HorizontalStackLayout Spacing="12">
                        <Button Text="Sync Now"
                                Style="{StaticResource PrimaryButton}"
                                Command="{Binding SyncNowCommand}"
                                IsEnabled="{Binding IsSyncing, Converter={StaticResource InverseBoolConverter}}"
                                HorizontalOptions="FillAndExpand" />
                        <Button Text="History"
                                Style="{StaticResource SecondaryButton}"
                                Command="{Binding ViewSyncHistoryCommand}"
                                HorizontalOptions="FillAndExpand" />
                    </HorizontalStackLayout>
                </VerticalStackLayout>
            </Frame>

            <!-- Offline Capabilities -->
            <Label Text="OFFLINE MODE" Style="{StaticResource SectionHeader}" />
            <Frame Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="16">
                    <Grid ColumnDefinitions="*,Auto" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Offline Mode" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                            <Label Text="Work without internet connection" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                        </VerticalStackLayout>
                        <Switch Grid.Column="1"
                                IsToggled="{Binding OfflineModeEnabled}"
                                OnColor="{StaticResource PrimaryBlue}"
                                VerticalOptions="Center"
                                Toggled="OnOfflineModeToggled" />
                    </Grid>

                    <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" />

                    <Grid ColumnDefinitions="*,*" ColumnSpacing="12">
                        <VerticalStackLayout Grid.Column="0">
                            <Label Text="Offline Features" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding OfflineFeaturesCount}" Style="{StaticResource H3}" />
                        </VerticalStackLayout>
                        <VerticalStackLayout Grid.Column="1">
                            <Label Text="Offline Maps" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                            <Label Text="{Binding OfflineMapsCount}" Style="{StaticResource H3}" />
                        </VerticalStackLayout>
                    </Grid>

                    <Button Text="Download Offline Data"
                            Style="{StaticResource SecondaryButton}"
                            Command="{Binding DownloadOfflineDataCommand}" />
                </VerticalStackLayout>
            </Frame>

            <!-- Actions -->
            <Label Text="ACTIONS" Style="{StaticResource SectionHeader}" />
            <Frame Style="{StaticResource CardFrame}">
                <VerticalStackLayout Spacing="12">
                    <Button Text="Refresh Profile"
                            Style="{StaticResource PrimaryButton}"
                            Command="{Binding RefreshCommand}" />
                    <Button Text="Change Password"
                            Style="{StaticResource SecondaryButton}"
                            Command="{Binding ChangePasswordCommand}" />
                </VerticalStackLayout>
            </Frame>

            <!-- Loading Indicator -->
            <ActivityIndicator IsRunning="{Binding IsBusy}"
                             IsVisible="{Binding IsBusy}"
                             HorizontalOptions="Center"
                             VerticalOptions="Center"
                             Margin="0,20" />

        </VerticalStackLayout>
    </ScrollView>
</ContentPage>
