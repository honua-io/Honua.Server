<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:viewmodels="clr-namespace:HonuaField.ViewModels"
             x:Class="HonuaField.Views.OnboardingPage"
             x:DataType="viewmodels:OnboardingViewModel"
             Title="{Binding Title}"
             Shell.NavBarIsVisible="False">

    <Grid RowDefinitions="*,Auto,Auto">

        <!-- Onboarding Content -->
        <ScrollView Grid.Row="0">
            <VerticalStackLayout Spacing="24" Padding="24" VerticalOptions="Center">

                <!-- Step Header -->
                <VerticalStackLayout Spacing="16" Margin="0,40,0,0">
                    <Label Text="{Binding StepTitle}"
                           Style="{StaticResource H1}"
                           HorizontalOptions="Center" />
                    <Label Text="{Binding StepDescription}"
                           Style="{StaticResource SubtitleText}"
                           HorizontalOptions="Center"
                           HorizontalTextAlignment="Center" />
                </VerticalStackLayout>

                <!-- Step 0: Welcome -->
                <VerticalStackLayout Spacing="20" x:Name="WelcomeStep">
                    <Label Text="ðŸ‘‹"
                           FontSize="72"
                           HorizontalOptions="Center" />
                    <Label Text="Collect and manage field data even without an internet connection. Sync when you're back online."
                           Style="{StaticResource BodyLarge}"
                           HorizontalTextAlignment="Center"
                           Margin="0,20" />
                </VerticalStackLayout>

                <!-- Step 1: Permissions -->
                <VerticalStackLayout Spacing="16" x:Name="PermissionsStep" IsVisible="False">
                    <Frame Style="{StaticResource CardFrame}">
                        <VerticalStackLayout Spacing="16">
                            <!-- Location Permission -->
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <Label Grid.Column="0"
                                       Text="ðŸ“"
                                       FontSize="24"
                                       VerticalOptions="Center" />
                                <VerticalStackLayout Grid.Column="1">
                                    <Label Text="Location" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                                    <Label Text="Capture GPS coordinates" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                                </VerticalStackLayout>
                                <Label Grid.Column="2"
                                       x:Name="LocationPermissionIcon"
                                       Text="â—‹"
                                       TextColor="{StaticResource Gray400}"
                                       Style="{StaticResource H3}"
                                       VerticalOptions="Center" />
                            </Grid>

                            <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" />

                            <!-- Camera Permission -->
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <Label Grid.Column="0"
                                       Text="ðŸ“·"
                                       FontSize="24"
                                       VerticalOptions="Center" />
                                <VerticalStackLayout Grid.Column="1">
                                    <Label Text="Camera" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                                    <Label Text="Attach photos to features" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                                </VerticalStackLayout>
                                <Label Grid.Column="2"
                                       x:Name="CameraPermissionIcon"
                                       Text="â—‹"
                                       TextColor="{StaticResource Gray400}"
                                       Style="{StaticResource H3}"
                                       VerticalOptions="Center" />
                            </Grid>

                            <BoxView HeightRequest="1" Color="{StaticResource BorderDefault}" />

                            <!-- Storage Permission -->
                            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                                <Label Grid.Column="0"
                                       Text="ðŸ’¾"
                                       FontSize="24"
                                       VerticalOptions="Center" />
                                <VerticalStackLayout Grid.Column="1">
                                    <Label Text="Storage" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                                    <Label Text="Save data offline" Style="{StaticResource BodySmall}" TextColor="{StaticResource TextSecondary}" />
                                </VerticalStackLayout>
                                <Label Grid.Column="2"
                                       x:Name="StoragePermissionIcon"
                                       Text="â—‹"
                                       TextColor="{StaticResource Gray400}"
                                       Style="{StaticResource H3}"
                                       VerticalOptions="Center" />
                            </Grid>

                            <Button Text="Grant Permissions"
                                    Style="{StaticResource PrimaryButton}"
                                    Command="{Binding RequestAllPermissionsCommand}"
                                    Margin="0,8,0,0" />
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>

                <!-- Step 2: Server Setup -->
                <VerticalStackLayout Spacing="16" x:Name="ServerStep" IsVisible="False">
                    <Frame Style="{StaticResource CardFrame}">
                        <VerticalStackLayout Spacing="16">
                            <Label Text="Server URL" Style="{StaticResource BodyMedium}" FontAttributes="Bold" />
                            <Entry Text="{Binding ServerUrl}"
                                   Placeholder="https://api.honua.io"
                                   Keyboard="Url"
                                   Style="{StaticResource DefaultEntry}" />

                            <Button Text="Test Connection"
                                    Style="{StaticResource SecondaryButton}"
                                    Command="{Binding TestServerConnectionCommand}"
                                    IsEnabled="{Binding IsBusy, Converter={StaticResource InverseBoolConverter}}" />

                            <Label Text="âœ“ Connection successful"
                                   Style="{StaticResource BodyMedium}"
                                   TextColor="{StaticResource SuccessGreen}"
                                   IsVisible="{Binding ServerConfigured}"
                                   HorizontalOptions="Center" />
                        </VerticalStackLayout>
                    </Frame>
                </VerticalStackLayout>

                <!-- Step 3: All Set -->
                <VerticalStackLayout Spacing="20" x:Name="AllSetStep" IsVisible="False">
                    <Label Text="âœ…"
                           FontSize="72"
                           HorizontalOptions="Center" />
                    <Label Text="Sign in to begin using Honua Field."
                           Style="{StaticResource BodyLarge}"
                           HorizontalTextAlignment="Center"
                           Margin="0,20" />
                </VerticalStackLayout>

            </VerticalStackLayout>
        </ScrollView>

        <!-- Progress Indicators -->
        <HorizontalStackLayout Grid.Row="1"
                             HorizontalOptions="Center"
                             Spacing="8"
                             Margin="0,0,0,20">
            <Frame x:Name="ProgressDot0" WidthRequest="10" HeightRequest="10" CornerRadius="5"
                   BackgroundColor="{StaticResource PrimaryBlue}"
                   Padding="0" HasShadow="False" />
            <Frame x:Name="ProgressDot1" WidthRequest="10" HeightRequest="10" CornerRadius="5"
                   BackgroundColor="{StaticResource Gray400}"
                   Padding="0" HasShadow="False" />
            <Frame x:Name="ProgressDot2" WidthRequest="10" HeightRequest="10" CornerRadius="5"
                   BackgroundColor="{StaticResource Gray400}"
                   Padding="0" HasShadow="False" />
            <Frame x:Name="ProgressDot3" WidthRequest="10" HeightRequest="10" CornerRadius="5"
                   BackgroundColor="{StaticResource Gray400}"
                   Padding="0" HasShadow="False" />
        </HorizontalStackLayout>

        <!-- Navigation Buttons -->
        <Frame Grid.Row="2"
               Padding="16,16,16,32"
               CornerRadius="0"
               HasShadow="False"
               BackgroundColor="{StaticResource SurfaceDefault}">
            <Grid ColumnDefinitions="Auto,*,Auto" ColumnSpacing="12">
                <!-- Previous Button -->
                <Button Grid.Column="0"
                        Text="â† Previous"
                        Style="{StaticResource SecondaryButton}"
                        Command="{Binding PreviousStepCommand}"
                        IsVisible="{Binding CanGoPrevious}" />

                <!-- Skip Button -->
                <Button Grid.Column="1"
                        Text="Skip"
                        Style="{StaticResource TextButton}"
                        Command="{Binding SkipOnboardingCommand}"
                        IsVisible="{Binding ShowSkipButton}"
                        HorizontalOptions="Center" />

                <!-- Next/Complete Button -->
                <Button Grid.Column="2"
                        Style="{StaticResource PrimaryButton}"
                        Command="{Binding NextStepCommand}">
                    <Button.Triggers>
                        <DataTrigger TargetType="Button" Binding="{Binding CanGoNext}" Value="True">
                            <Setter Property="Text" Value="Next â†’" />
                        </DataTrigger>
                        <DataTrigger TargetType="Button" Binding="{Binding CanGoNext}" Value="False">
                            <Setter Property="Text" Value="Complete" />
                        </DataTrigger>
                    </Button.Triggers>
                </Button>
            </Grid>
        </Frame>

        <!-- Loading Indicator -->
        <ActivityIndicator Grid.Row="0"
                         IsRunning="{Binding IsBusy}"
                         IsVisible="{Binding IsBusy}"
                         HorizontalOptions="Center"
                         VerticalOptions="Center" />
    </Grid>

    <ContentPage.Resources>
        <ResourceDictionary>
            <!-- Add converters needed for onboarding -->
            <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
            <converters:BoolToColorConverter x:Key="BoolToColorConverter"
                                           TrueColor="{StaticResource SuccessGreen}"
                                           FalseColor="{StaticResource Gray400}" />
        </ResourceDictionary>
    </ContentPage.Resources>
</ContentPage>
