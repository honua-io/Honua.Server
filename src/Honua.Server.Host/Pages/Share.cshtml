@page "/share/{token}"
@model Honua.Server.Host.Pages.ShareModel
@{
    ViewData["Title"] = Model.ShareToken?.MapId ?? "Shared Map";
    Layout = null;
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@ViewData["Title"] - Honua</title>

    <!-- Honua MapSDK -->
    <link rel="stylesheet" href="~/css/honua-map.css" />
    <script src="~/js/honua-map.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
        }

        #map {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .share-header {
            position: absolute;
            top: 16px;
            left: 16px;
            z-index: 1000;
            background: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            max-width: 400px;
        }

        .share-header h1 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .share-header p {
            font-size: 14px;
            color: #666;
        }

        .comments-panel {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 350px;
            max-height: 400px;
            background: white;
            border-top-left-radius: 8px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            z-index: 1000;
            display: flex;
            flex-direction: column;
            transition: transform 0.3s ease;
        }

        .comments-panel.collapsed {
            transform: translateY(calc(100% - 48px));
        }

        .comments-header {
            padding: 12px 16px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .comments-header h3 {
            font-size: 16px;
            font-weight: 600;
        }

        .comments-list {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .comment {
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid #eee;
        }

        .comment:last-child {
            border-bottom: none;
        }

        .comment-author {
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 4px;
        }

        .comment-text {
            font-size: 14px;
            line-height: 1.5;
            margin-bottom: 4px;
        }

        .comment-date {
            font-size: 12px;
            color: #999;
        }

        .comment-form {
            padding: 16px;
            border-top: 1px solid #eee;
        }

        .comment-form input,
        .comment-form textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .comment-form textarea {
            min-height: 80px;
            resize: vertical;
        }

        .comment-form button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .comment-form button:hover {
            background: #0056b3;
        }

        .error-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 32px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 400px;
        }

        .error-message h2 {
            font-size: 24px;
            margin-bottom: 16px;
            color: #d9534f;
        }

        .error-message p {
            font-size: 16px;
            color: #666;
        }

        .password-prompt {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 32px;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            z-index: 2000;
            min-width: 350px;
        }

        .password-prompt h2 {
            font-size: 20px;
            margin-bottom: 16px;
        }

        .password-prompt input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 16px;
        }

        .password-prompt button {
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .password-prompt button:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    @if (Model.ErrorMessage != null)
    {
        <div class="error-message">
            <h2>Unable to Load Map</h2>
            <p>@Model.ErrorMessage</p>
        </div>
    }
    else if (Model.RequiresPassword)
    {
        <div class="password-prompt">
            <h2>Password Required</h2>
            <form method="get">
                <input type="password" name="password" placeholder="Enter password" required />
                <button type="submit">Access Map</button>
            </form>
        </div>
    }
    else
    {
        <div id="map"></div>

        @if (!string.IsNullOrEmpty(Model.ShareToken?.MapId))
        {
            <div class="share-header">
                <h1>@Model.ShareToken.MapId</h1>
                <p>Shared Map View</p>
            </div>
        }

        @if (Model.CanComment)
        {
            <div class="comments-panel collapsed" id="commentsPanel">
                <div class="comments-header" onclick="toggleComments()">
                    <h3>Comments <span id="commentCount">(0)</span></h3>
                    <span id="toggleIcon">▲</span>
                </div>
                <div class="comments-list" id="commentsList">
                    <!-- Comments loaded via JavaScript -->
                </div>
                <div class="comment-form">
                    <input type="text" id="authorName" placeholder="Your name" required />
                    <input type="email" id="authorEmail" placeholder="Your email (optional)" />
                    <textarea id="commentText" placeholder="Add a comment..." required></textarea>
                    <button onclick="submitComment()">Post Comment</button>
                </div>
            </div>
        }

        <script>
            const shareToken = '@Model.Token';
            const mapId = '@Model.ShareToken?.MapId';
            const canComment = @Model.CanComment.ToString().ToLower();

            // Initialize map
            async function initMap() {
                try {
                    // Fetch map configuration
                    const response = await fetch(`/api/v1/maps/${mapId}`);
                    if (!response.ok) {
                        throw new Error('Failed to load map configuration');
                    }

                    const mapConfig = await response.json();

                    // Initialize Honua map
                    window.map = new HonuaMap('map', {
                        center: mapConfig.center || [0, 0],
                        zoom: mapConfig.zoom || 2,
                        basemap: mapConfig.basemap || 'osm'
                    });

                    // Load layers
                    if (mapConfig.layers) {
                        mapConfig.layers.forEach(layer => {
                            window.map.addLayer(layer);
                        });
                    }

                    if (canComment) {
                        loadComments();
                    }
                } catch (error) {
                    console.error('Error initializing map:', error);
                }
            }

            // Toggle comments panel
            function toggleComments() {
                const panel = document.getElementById('commentsPanel');
                const icon = document.getElementById('toggleIcon');
                panel.classList.toggle('collapsed');
                icon.textContent = panel.classList.contains('collapsed') ? '▲' : '▼';
            }

            // Load comments
            async function loadComments() {
                try {
                    const response = await fetch(`/api/v1/maps/share/${shareToken}/comments`);
                    const comments = await response.json();

                    const commentsList = document.getElementById('commentsList');
                    const commentCount = document.getElementById('commentCount');

                    commentCount.textContent = `(${comments.length})`;

                    if (comments.length === 0) {
                        commentsList.innerHTML = '<p style="color: #999; text-align: center;">No comments yet</p>';
                        return;
                    }

                    commentsList.innerHTML = comments.map(comment => `
                        <div class="comment">
                            <div class="comment-author">${escapeHtml(comment.author)}</div>
                            <div class="comment-text">${escapeHtml(comment.commentText)}</div>
                            <div class="comment-date">${new Date(comment.createdAt).toLocaleDateString()}</div>
                        </div>
                    `).join('');
                } catch (error) {
                    console.error('Error loading comments:', error);
                }
            }

            // Submit comment
            async function submitComment() {
                const author = document.getElementById('authorName').value;
                const email = document.getElementById('authorEmail').value;
                const text = document.getElementById('commentText').value;

                if (!author || !text) {
                    alert('Please fill in your name and comment');
                    return;
                }

                try {
                    const response = await fetch(`/api/v1/maps/share/${shareToken}/comments`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            mapId: mapId,
                            author: author,
                            guestEmail: email || null,
                            commentText: text
                        })
                    });

                    if (!response.ok) {
                        throw new Error('Failed to post comment');
                    }

                    // Clear form
                    document.getElementById('commentText').value = '';

                    // Reload comments
                    await loadComments();

                    alert('Comment posted! It will be visible after moderation.');
                } catch (error) {
                    console.error('Error posting comment:', error);
                    alert('Failed to post comment. Please try again.');
                }
            }

            // Utility function to escape HTML
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            // Initialize on page load
            document.addEventListener('DOMContentLoaded', initMap);
        </script>
    }
</body>
</html>
