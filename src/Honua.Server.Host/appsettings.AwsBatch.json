{
  "$schema": "https://json.schemastore.org/appsettings.json",
  "_comment": "AWS Batch Configuration for Large-Scale Geoprocessing",
  "_comment2": "Copy relevant sections to appsettings.Production.json or appsettings.Development.json",
  "_comment3": "Use environment variables or AWS Secrets Manager for sensitive values in production",

  "Geoprocessing": {
    "AwsBatch": {
      "_comment": "AWS Batch executor configuration for Tier 3 (CloudBatch) operations",

      "Region": "us-east-1",
      "_region_comment": "AWS region for Batch, S3, and SNS. If null, uses default AWS SDK credential chain region.",

      "InputBucket": "honua-geoprocessing-inputs",
      "_inputBucket_comment": "S3 bucket for staging job inputs. Must exist and be accessible with appropriate IAM permissions.",

      "OutputBucket": "honua-geoprocessing-outputs",
      "_outputBucket_comment": "S3 bucket for storing job results. Must exist and be accessible with appropriate IAM permissions.",

      "JobQueue": "honua-geoprocessing-queue",
      "_jobQueue_comment": "AWS Batch job queue name. Must be created in AWS Batch console or via IaC.",

      "JobDefinition": "honua-geoprocessing:1",
      "_jobDefinition_comment": "AWS Batch job definition. Format: name:revision. Container image should be pre-configured with geoprocessing tools.",

      "SnsTopicArn": "arn:aws:sns:us-east-1:123456789012:honua-batch-notifications",
      "_snsTopicArn_comment": "SNS topic ARN for job completion notifications. Optional - if not provided, polling will be used.",

      "LogGroupName": "/aws/batch/honua-geoprocessing",
      "_logGroupName_comment": "CloudWatch log group for batch job logs. Should match job definition configuration.",

      "CallbackUrl": "https://api.honua.example.com",
      "_callbackUrl_comment": "Base URL for webhook callbacks. SNS will POST to {CallbackUrl}/api/geoprocessing/webhooks/batch-complete",

      "DefaultTimeoutSeconds": 1800,
      "_defaultTimeoutSeconds_comment": "Default job timeout (30 minutes). Can be overridden per operation.",

      "RetryAttempts": 3,
      "_retryAttempts_comment": "Number of automatic retry attempts for failed jobs.",

      "EnableSpotInstances": true,
      "_enableSpotInstances_comment": "Use EC2 Spot instances for cost optimization. Jobs may be interrupted but will auto-retry.",

      "SpotMaxPricePercentage": 100,
      "_spotMaxPricePercentage_comment": "Maximum Spot price as percentage of On-Demand (1-100). 100 = bid up to On-Demand price.",

      "PollingIntervalSeconds": 10,
      "_pollingIntervalSeconds_comment": "Job status polling interval if SNS is not configured. Lower values increase API costs.",

      "MaxPollingDurationSeconds": 3600,
      "_maxPollingDurationSeconds_comment": "Maximum time to poll for job completion (1 hour). After this, job marked as timeout.",

      "S3RetentionDays": 7,
      "_s3RetentionDays_comment": "Days to retain job data in S3. Set to 0 to disable automatic cleanup. Use S3 lifecycle policies for enforcement.",

      "ContainerImageOverride": null,
      "_containerImageOverride_comment": "Optional: Override container image from job definition. Example: 123456789012.dkr.ecr.us-east-1.amazonaws.com/honua-geoprocessing:latest",

      "VCpus": null,
      "_vCpus_comment": "Optional: Override vCPU allocation. If null, uses job definition defaults. Example: 2, 4, 8",

      "MemoryMB": null,
      "_memoryMB_comment": "Optional: Override memory allocation in MB. If null, uses job definition defaults. Example: 4096, 8192, 16384",

      "Gpus": null,
      "_gpus_comment": "Optional: Number of GPUs for GPU-accelerated operations. Example: 1, 2, 4",

      "EnvironmentVariables": {
        "GDAL_DATA": "/usr/share/gdal",
        "PROJ_LIB": "/usr/share/proj"
      },
      "_environmentVariables_comment": "Additional environment variables passed to batch jobs. Customize based on container setup.",

      "JobTags": {
        "Project": "Honua",
        "Component": "Geoprocessing",
        "CostCenter": "Engineering"
      },
      "_jobTags_comment": "Tags applied to batch jobs for cost allocation and tracking.",

      "EnableCloudWatchLogs": true,
      "_enableCloudWatchLogs_comment": "Enable CloudWatch Logs streaming. Recommended for debugging and monitoring.",

      "EnableDetailedMetrics": false,
      "_enableDetailedMetrics_comment": "Enable detailed CloudWatch metrics. May incur additional costs."
    }
  },

  "_aws_credentials_comment": "AWS credentials configuration",
  "_aws_credentials_production": "In production, use IAM roles (EC2/ECS instance profile) instead of access keys",
  "_aws_credentials_development": "For development, use AWS CLI credentials or environment variables",

  "AWS": {
    "_comment": "AWS SDK uses default credential chain: Environment variables -> IAM role -> Shared credentials file",
    "Region": "us-east-1",
    "Profile": null,
    "_profile_comment": "Optional: AWS CLI profile name. Only needed for development with multiple profiles."
  },

  "_iam_permissions_required": [
    "batch:SubmitJob",
    "batch:DescribeJobs",
    "batch:TerminateJob",
    "s3:PutObject (on input bucket)",
    "s3:GetObject (on output bucket)",
    "s3:PutObjectTagging (for lifecycle policies)",
    "logs:GetLogEvents (for CloudWatch Logs)",
    "sns:Publish (if using SNS notifications)",
    "sns:Subscribe (if using SNS notifications)"
  ],

  "_infrastructure_setup": {
    "s3_buckets": [
      "Create input bucket: honua-geoprocessing-inputs",
      "Create output bucket: honua-geoprocessing-outputs",
      "Configure CORS on buckets if needed for direct browser uploads",
      "Set up S3 lifecycle policies to delete old jobs based on tags"
    ],
    "batch": [
      "Create compute environment (EC2 or Fargate, Spot or On-Demand)",
      "Create job queue associated with compute environment",
      "Create job definition with container image and resource requirements",
      "Container should include: GDAL, GEOS, PROJ, PostGIS client, custom geoprocessing tools"
    ],
    "sns": [
      "Create SNS topic for batch notifications",
      "Subscribe webhook endpoint to SNS topic",
      "Configure EventBridge rule to send Batch job state changes to SNS"
    ],
    "cloudwatch": [
      "Create log group: /aws/batch/honua-geoprocessing",
      "Set retention policy (e.g., 30 days)",
      "Create CloudWatch dashboard for monitoring"
    ],
    "eventbridge": [
      "Create rule to match Batch job state changes",
      "Pattern: { \"source\": [\"aws.batch\"], \"detail-type\": [\"Batch Job State Change\"] }",
      "Target: SNS topic for notifications"
    ]
  },

  "_cost_optimization": {
    "spot_instances": "Enable for 50-90% cost savings. Jobs may be interrupted but auto-retry.",
    "fargate_spot": "Consider Fargate Spot for serverless compute with auto-scaling.",
    "s3_lifecycle": "Use lifecycle policies to transition old data to Glacier or delete after N days.",
    "reserved_capacity": "For predictable workloads, purchase Savings Plans or Reserved Instances.",
    "right_sizing": "Monitor CloudWatch metrics to optimize vCPU/memory allocation per operation type."
  },

  "_monitoring_alerts": {
    "job_failures": "Create CloudWatch alarm for failed jobs (>5% failure rate)",
    "job_duration": "Alert on jobs exceeding expected duration (P95 + buffer)",
    "queue_depth": "Alert on large queue backlog (>100 pending jobs)",
    "spot_interruptions": "Track Spot interruption rate and retry overhead",
    "costs": "Set up AWS Cost Anomaly Detection for unexpected spending"
  }
}
