{
  "$schema": "https://json.schemastore.org/appsettings.json",
  "_comment": "This is an example configuration file for Honua Server with all available options documented.",

  "Logging": {
    "_comment": "ASP.NET Core logging configuration",
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning",
      "Microsoft.AspNetCore.Hosting.Diagnostics": "Information",
      "System.Net.Http.HttpClient": "Warning"
    }
  },

  "observability": {
    "_comment": "Observability configuration for metrics, logging, and tracing",
    "logging": {
      "jsonConsole": true,
      "_comment_jsonConsole": "Use JSON format for console logging (true) or simple text format (false)",
      "includeScopes": true,
      "_comment_includeScopes": "Include logging scopes in output for better context"
    },
    "metrics": {
      "enabled": true,
      "_comment_enabled": "Enable Prometheus metrics endpoint",
      "endpoint": "/metrics",
      "_comment_endpoint": "HTTP endpoint for Prometheus scraping",
      "usePrometheus": true,
      "_comment_usePrometheus": "Export metrics in Prometheus format"
    },
    "tracing": {
      "exporter": "none",
      "_comment_exporter": "Trace exporter type: 'none', 'console', or 'otlp'",
      "otlpEndpoint": "http://localhost:4317",
      "_comment_otlpEndpoint": "OTLP endpoint URL for distributed tracing (e.g., Jaeger, Tempo)"
    }
  },

  "RateLimiting": {
    "_comment": "Rate limiting configuration for DoS protection - acts as fallback when YARP is not present",
    "Enabled": true,
    "_comment_Enabled": "Enable/disable rate limiting globally",
    "OnlyIfNoReverseProxy": true,
    "_comment_OnlyIfNoReverseProxy": "Only apply rate limiting if YARP/reverse proxy is not detected (fallback mode). Set to false for defense-in-depth.",
    "DefaultRequestsPerMinute": 100,
    "_comment_DefaultRequestsPerMinute": "Default requests per minute for endpoints without specific limits",
    "DefaultBurstSize": 10,
    "_comment_DefaultBurstSize": "Default burst size for token bucket strategy",
    "MaxConcurrentRequests": 50,
    "_comment_MaxConcurrentRequests": "Maximum number of concurrent requests (0 to disable)",
    "DefaultStrategy": "SlidingWindow",
    "_comment_DefaultStrategy": "Default rate limiting strategy: FixedWindow, SlidingWindow, TokenBucket, or Concurrency",
    "UseAuthenticatedLimits": true,
    "_comment_UseAuthenticatedLimits": "Give authenticated users higher rate limits",
    "AuthenticatedMultiplier": 2.0,
    "_comment_AuthenticatedMultiplier": "Multiplier for authenticated user rate limits (e.g., 2.0 = 2x the limit)",
    "WindowSeconds": 60,
    "_comment_WindowSeconds": "Window size in seconds for rate limiting strategies",
    "SegmentsPerWindow": 4,
    "_comment_SegmentsPerWindow": "Number of segments per window for sliding window (higher = more accurate, more memory)",
    "EndpointLimits": {
      "_comment": "Per-endpoint rate limit overrides",
      "/api/alerts": {
        "PathPattern": "/api/alerts/*",
        "RequestsPerMinute": 10,
        "BurstSize": 2,
        "Strategy": "SlidingWindow",
        "Enabled": true,
        "_comment": "Restrictive limits for alert webhook endpoints"
      },
      "/api/data/ingestion": {
        "PathPattern": "/api/data/ingestion/*",
        "RequestsPerMinute": 5,
        "BurstSize": 1,
        "Strategy": "TokenBucket",
        "Enabled": true,
        "_comment": "Very restrictive for data ingestion to prevent overload"
      },
      "/ogc": {
        "PathPattern": "/ogc/**",
        "RequestsPerMinute": 100,
        "BurstSize": 20,
        "Strategy": "SlidingWindow",
        "Enabled": true,
        "_comment": "Moderate limits for OGC API endpoints"
      },
      "/stac": {
        "PathPattern": "/stac/**",
        "RequestsPerMinute": 100,
        "BurstSize": 20,
        "Strategy": "SlidingWindow",
        "Enabled": true,
        "_comment": "Moderate limits for STAC catalog endpoints"
      },
      "/api/features": {
        "PathPattern": "/api/features/**",
        "RequestsPerMinute": 150,
        "BurstSize": 30,
        "Strategy": "SlidingWindow",
        "Enabled": true,
        "AuthenticatedMultiplier": 3.0,
        "_comment": "Higher limits for feature API, especially for authenticated users"
      }
    },
    "ExemptIpAddresses": [
      "127.0.0.1",
      "::1"
    ],
    "_comment_ExemptIpAddresses": "IP addresses exempt from rate limiting (e.g., localhost, monitoring systems)",
    "ExemptPaths": [
      "/health",
      "/ready",
      "/live",
      "/metrics"
    ],
    "_comment_ExemptPaths": "Paths exempt from rate limiting (health checks, monitoring endpoints)"
  },

  "RequestLimits": {
    "_comment": "HTTP request body size limits",
    "MaxBodySize": 1073741824,
    "_comment_MaxBodySize": "Maximum request body size in bytes (default: 1GB)"
  },

  "AllowedHosts": "*",
  "_comment_AllowedHosts": "Semicolon-separated list of allowed host headers (use '*' for any host)",

  "honua": {
    "_comment": "Honua-specific configuration",

    "workspacePath": "./metadata",
    "_comment_workspacePath": "Path to metadata workspace directory",

    "authentication": {
      "mode": "Local",
      "_comment_mode": "Authentication mode: 'Local', 'Jwt', 'QuickStart', or 'None'",
      "enforce": true,
      "_comment_enforce": "Require authentication for protected endpoints",

      "quickStart": {
        "enabled": false,
        "_comment_enabled": "Enable QuickStart mode (development only - no authentication required)"
      },

      "local": {
        "sessionLifetime": "08:00:00",
        "_comment_sessionLifetime": "Session duration (HH:MM:SS format)",
        "requireEmailVerification": false,
        "_comment_requireEmailVerification": "Require email verification for new users",
        "minPasswordLength": 12,
        "_comment_minPasswordLength": "Minimum password length",
        "requireUppercase": true,
        "requireLowercase": true,
        "requireDigit": true,
        "requireSpecialCharacter": true
      },

      "jwt": {
        "issuer": "Honua.Server",
        "_comment_issuer": "JWT issuer claim",
        "audience": "Honua.Clients",
        "_comment_audience": "JWT audience claim",
        "signingKey": "${JWT_SIGNING_KEY}",
        "_comment_signingKey": "JWT signing key (store in environment variable)",
        "expirationMinutes": 60,
        "_comment_expirationMinutes": "Token expiration time in minutes",
        "clockSkewMinutes": 5,
        "_comment_clockSkewMinutes": "Clock skew tolerance for token validation"
      }
    },

    "authorization": {
      "_comment": "Fine-grained resource-based authorization configuration",
      "enabled": true,
      "_comment_enabled": "Enable resource-based authorization for layers and collections",
      "cacheDurationSeconds": 300,
      "_comment_cacheDurationSeconds": "Cache duration for authorization decisions (seconds)",
      "maxCacheSize": 10000,
      "_comment_maxCacheSize": "Maximum number of cached authorization decisions",
      "defaultAction": "Deny",
      "_comment_defaultAction": "Default action when no policy matches: 'Allow' or 'Deny'",
      "policies": [
        {
          "id": "admin-full-access",
          "resourceType": "layer",
          "resourcePattern": "*",
          "allowedOperations": ["*"],
          "roles": ["administrator"],
          "priority": 100,
          "enabled": true
        },
        {
          "id": "publisher-weather-access",
          "resourceType": "layer",
          "resourcePattern": "weather:*",
          "allowedOperations": ["read", "write"],
          "roles": ["datapublisher"],
          "priority": 50,
          "enabled": true
        },
        {
          "id": "viewer-read-only",
          "resourceType": "layer",
          "resourcePattern": "*",
          "allowedOperations": ["read"],
          "roles": ["viewer"],
          "priority": 10,
          "enabled": true
        },
        {
          "id": "collection-admin-access",
          "resourceType": "collection",
          "resourcePattern": "*",
          "allowedOperations": ["*"],
          "roles": ["administrator"],
          "priority": 100,
          "enabled": true
        },
        {
          "id": "collection-publisher-access",
          "resourceType": "collection",
          "resourcePattern": "*",
          "allowedOperations": ["read", "write"],
          "roles": ["datapublisher"],
          "priority": 50,
          "enabled": true
        }
      ]
    },

    "odata": {
      "enabled": true,
      "_comment_enabled": "Enable OData query support",
      "allowWrites": false,
      "_comment_allowWrites": "Allow write operations via OData (POST, PATCH, DELETE)",
      "defaultPageSize": 100,
      "_comment_defaultPageSize": "Default page size for OData queries",
      "maxPageSize": 1000,
      "_comment_maxPageSize": "Maximum allowed page size",
      "emitWktShadowProperties": true,
      "_comment_emitWktShadowProperties": "Include WKT representations of geometry in OData responses"
    },

    "cors": {
      "_comment": "CORS configuration is defined in metadata.yaml per service",
      "allowAnyOrigin": false,
      "_comment_allowAnyOrigin": "Allow requests from any origin (not recommended for production)",
      "allowCredentials": true,
      "_comment_allowCredentials": "Allow credentials (cookies, authorization headers) in CORS requests"
    },

    "storage": {
      "_comment": "Cloud storage configuration for rasters and attachments",
      "type": "FileSystem",
      "_comment_type": "Storage type: 'FileSystem', 'AzureBlob', or 'S3'",
      "basePath": "./data/storage",
      "_comment_basePath": "Base path for FileSystem storage",

      "azureBlob": {
        "connectionString": "${AZURE_STORAGE_CONNECTION_STRING}",
        "containerName": "honua-data"
      },

      "s3": {
        "accessKey": "${AWS_ACCESS_KEY_ID}",
        "secretKey": "${AWS_SECRET_ACCESS_KEY}",
        "region": "us-west-2",
        "bucketName": "honua-data"
      }
    },

    "cache": {
      "_comment": "Tile cache configuration",
      "enabled": true,
      "provider": "FileSystem",
      "_comment_provider": "Cache provider: 'FileSystem', 'Redis', or 'Memory'",
      "basePath": "./data/cache",
      "_comment_basePath": "Base path for FileSystem cache",
      "maxSizeMb": 10240,
      "_comment_maxSizeMb": "Maximum cache size in megabytes (10GB default)",
      "evictionPolicy": "LRU",
      "_comment_evictionPolicy": "Cache eviction policy: 'LRU' or 'LFU'"
    }
  },

  "SchemaValidation": {
    "_comment": "Database schema validation settings",
    "Enabled": true,
    "_comment_Enabled": "Enable schema validation on startup",
    "FailOnMismatch": false,
    "_comment_FailOnMismatch": "Fail startup if schema doesn't match metadata",
    "LogWarnings": true,
    "_comment_LogWarnings": "Log warnings for schema mismatches"
  },

  "Features": {
    "_comment": "Feature flags for graceful degradation",
    "AIConsultant": {
      "Enabled": true,
      "_comment_Enabled": "Enable AI consultant features (chat, deployment assistance)",
      "Required": false,
      "_comment_Required": "If true, application won't start if feature is unhealthy",
      "MinHealthScore": 50,
      "_comment_MinHealthScore": "Minimum health score (0-100) to keep feature enabled",
      "RecoveryCheckInterval": 60,
      "_comment_RecoveryCheckInterval": "Seconds between recovery checks for degraded features"
    },
    "AdvancedCaching": {
      "Enabled": true,
      "_comment_Enabled": "Enable advanced distributed caching (Redis)",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60,
      "Strategy": {
        "Type": "Fallback",
        "_comment_Type": "Degradation type: Disable, ReduceQuality, ReduceFunctionality, ReducePerformance, Fallback",
        "Message": "Using in-memory cache (Redis unavailable)"
      }
    },
    "Search": {
      "Enabled": true,
      "_comment_Enabled": "Enable search and indexing capabilities",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60,
      "Strategy": {
        "Type": "ReduceFunctionality",
        "Message": "Search degraded to database scan"
      }
    },
    "RealTimeMetrics": {
      "Enabled": true,
      "_comment_Enabled": "Enable real-time metrics collection and export",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60,
      "Strategy": {
        "Type": "Fallback",
        "Message": "Metrics collection degraded to log-only mode"
      }
    },
    "StacCatalog": {
      "Enabled": true,
      "_comment_Enabled": "Enable STAC catalog features",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60,
      "Strategy": {
        "Type": "ReduceFunctionality",
        "Message": "STAC catalog degraded to basic metadata"
      }
    },
    "AdvancedRasterProcessing": {
      "Enabled": true,
      "_comment_Enabled": "Enable advanced raster processing (COG, Zarr)",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60,
      "Strategy": {
        "Type": "ReduceQuality",
        "Message": "Raster processing degraded to lower resolution",
        "ReduceQuality": true,
        "QualityReduction": 0.5
      }
    },
    "VectorTiles": {
      "Enabled": true,
      "_comment_Enabled": "Enable vector tile generation and caching",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60
    },
    "Analytics": {
      "Enabled": true,
      "_comment_Enabled": "Enable analytics and usage tracking",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60
    },
    "ExternalStorage": {
      "Enabled": true,
      "_comment_Enabled": "Enable external storage providers (S3, Azure Blob, GCS)",
      "Required": false,
      "MinHealthScore": 50,
      "RecoveryCheckInterval": 60
    },
    "OidcAuthentication": {
      "Enabled": false,
      "_comment_Enabled": "Enable OpenID Connect authentication",
      "Required": false,
      "MinHealthScore": 80,
      "_comment_MinHealthScore": "Higher threshold for auth features",
      "RecoveryCheckInterval": 30
    }
  },

  "Kestrel": {
    "_comment": "Kestrel web server configuration",
    "Limits": {
      "MaxRequestBodySize": 1073741824,
      "MaxConcurrentConnections": 100,
      "MaxConcurrentUpgradedConnections": 100,
      "RequestHeadersTimeout": "00:00:30",
      "KeepAliveTimeout": "00:02:00"
    },
    "Endpoints": {
      "Http": {
        "Url": "http://0.0.0.0:5000"
      },
      "Https": {
        "Url": "https://0.0.0.0:5001",
        "Certificate": {
          "Path": "/path/to/certificate.pfx",
          "Password": "${CERT_PASSWORD}"
        }
      }
    }
  }
}
