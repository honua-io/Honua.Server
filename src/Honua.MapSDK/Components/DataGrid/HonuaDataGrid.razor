@using Honua.MapSDK.Core
@using Honua.MapSDK.Core.Messages
@using System.Text.Json
@typeparam TItem

<div class="honua-data-grid @CssClass" style="@Style">
    <MudDataGrid T="TItem"
                 @ref="_dataGrid"
                 Items="@_items"
                 Loading="@_isLoading"
                 ReadOnly="false"
                 Elevation="0"
                 Dense="@Dense"
                 Hover="true"
                 MultiSelection="@MultiSelection"
                 SelectOnRowClick="true"
                 SelectedItem="_selectedItem"
                 SelectedItemChanged="OnRowSelected"
                 SelectedItems="_selectedItems"
                 SelectedItemsChanged="OnMultipleRowsSelected"
                 Filterable="@Filterable"
                 FilterMode="@DataGridFilterMode.Simple"
                 FilterCaseSensitivity="@DataGridFilterCaseSensitivity.CaseInsensitive"
                 Sortable="@Sortable"
                 SortMode="@SortMode.Multiple"
                 Hideable="@HideableColumns"
                 ColumnResizeMode="@ResizeMode.Column"
                 ShowMenuIcon="true"
                 QuickFilter="@_quickFilterFunc"
                 RowsPerPage="@PageSize">

        <ToolBarContent>
            @if (ShowToolbar)
            {
                <MudText Typo="Typo.h6">@Title</MudText>
                <MudSpacer />

                @if (ShowSearch)
                {
                    <MudTextField @bind-Value="_searchString"
                                  Placeholder="Search..."
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  IconSize="Size.Medium"
                                  Immediate="true"
                                  Class="mt-0"
                                  DebounceInterval="300"
                                  Clearable="true">
                    </MudTextField>
                }

                @if (ShowExport)
                {
                    <MudMenu Icon="@Icons.Material.Filled.FileDownload"
                             Color="Color.Primary"
                             Variant="Variant.Text"
                             AnchorOrigin="Origin.BottomRight"
                             TransformOrigin="Origin.TopRight">
                        <MudMenuItem OnClick="@ExportToJson">Export JSON</MudMenuItem>
                        <MudMenuItem OnClick="@ExportToCsv">Export CSV</MudMenuItem>
                        <MudMenuItem OnClick="@ExportToGeoJson" Disabled="@(!_hasGeometry)">Export GeoJSON</MudMenuItem>
                    </MudMenu>
                }

                @if (ShowRefresh)
                {
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                   Color="Color.Primary"
                                   OnClick="@RefreshData"
                                   Disabled="@_isLoading" />
                }

                @if (SyncWith != null && _isSynced)
                {
                    <MudChip Size="Size.Small"
                             Color="Color.Success"
                             Icon="@Icons.Material.Filled.Sync"
                             OnClose="@(() => DisableSync())">
                        Synced with @SyncWith
                    </MudChip>
                }

                @ToolbarContent
            }
        </ToolBarContent>

        <Columns>
            @if (Columns != null)
            {
                @Columns
            }
            else if (_autoGeneratedColumns)
            {
                @foreach (var column in _columnDefinitions)
                {
                    <PropertyColumn Property="@column.PropertyFunc"
                                    Title="@column.Title"
                                    Sortable="@column.Sortable"
                                    Filterable="@column.Filterable"
                                    Hideable="@column.Hideable"
                                    Hidden="@column.Hidden">
                        <CellTemplate>
                            @{
                                var value = column.PropertyFunc(context);
                                if (column.IsGeometry)
                                {
                                    <MudChip Size="Size.Small" Color="Color.Info">
                                        @GetGeometryType(value)
                                    </MudChip>
                                }
                                else if (value != null)
                                {
                                    @FormatValue(value, column.Format)
                                }
                            }
                        </CellTemplate>
                    </PropertyColumn>
                }
            }
        </Columns>

        <PagerContent>
            <MudDataGridPager T="TItem"
                              PageSizeOptions="@PageSizeOptions"
                              InfoFormat="@PagerInfoFormat" />
        </PagerContent>

        <NoRecordsContent>
            <MudText Typo="Typo.body1" Align="Align.Center" Class="my-4">
                @if (_isLoading)
                {
                    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
                    <br />
                    <text>Loading data...</text>
                }
                else if (!string.IsNullOrEmpty(_errorMessage))
                {
                    <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
                }
                else
                {
                    <text>No records found</text>
                }
            </MudText>
        </NoRecordsContent>
    </MudDataGrid>
</div>
