@page "/import"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@using Microsoft.AspNetCore.Components.Forms
@attribute [Authorize(Roles = "administrator,datapublisher")]
@inject ImportApiClient ImportApi
@inject ServiceApiClient ServiceApi
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@implements IAsyncDisposable

<PageTitle>Import Data - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-6 mt-4">
        <MudText Typo="Typo.h4" Class="mb-6">Import Geospatial Data</MudText>

        <MudStepper @ref="_stepper" @bind-ActiveIndex="_activeStep" Linear="true" HeaderTextView="HeaderTextView.All">

            @* Step 1: Upload File *@
            <MudStep Title="Upload File" Icon="@Icons.Material.Filled.Upload">
                <ChildContent>
                    <MudStack Spacing="4" Class="mt-4">
                        <MudText Typo="Typo.h6">Select a geospatial file to import</MudText>

                        <MudAlert Severity="Severity.Info">
                            Supported formats: Shapefile (ZIP), GeoJSON, GeoPackage, KML, GML, CSV (with geometry)
                        </MudAlert>

                        @if (_wizardState.SelectedFile == null)
                        {
                            <MudPaper id="fileDropZone"
                                      Outlined="true"
                                      Class="pa-8 text-center cursor-pointer @(_isDraggingOver ? "drag-over" : "")"
                                      @onclick="@(() => document.getElementById("fileInput").click())"
                                      @ondragenter="HandleDragEnter"
                                      @ondragover="HandleDragOver"
                                      @ondragleave="HandleDragLeave"
                                      @ondrop="HandleDrop"
                                      Style="border: 2px dashed @(_isDraggingOver ? "var(--mud-palette-primary)" : "#ccc"); background-color: @(_isDraggingOver ? "var(--mud-palette-primary-lighten)" : "transparent"); transition: all 0.2s ease;">
                                <MudIcon Icon="@Icons.Material.Filled.CloudUpload"
                                         Size="Size.Large"
                                         Color="@(_isDraggingOver ? Color.Primary : Color.Default)"
                                         Class="mb-2" />
                                <MudText Typo="Typo.h6" Color="@(_isDraggingOver ? Color.Primary : Color.Default)">
                                    @if (_isDraggingOver)
                                    {
                                        <text>Drop file here</text>
                                    }
                                    else
                                    {
                                        <text>Click to select a file</text>
                                    }
                                </MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">or drag and drop</MudText>
                                <MudText Typo="Typo.caption" Class="mt-2">Max file size: 500 MB</MudText>
                            </MudPaper>
                            <InputFile id="fileInput" OnChange="@HandleFileSelected" hidden accept=".zip,.geojson,.json,.gpkg,.kml,.gml,.csv" />
                        }
                        else
                        {
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Color="Color.Primary" />
                                        <div>
                                            <MudText Typo="Typo.body1">@_wizardState.SelectedFile</MudText>
                                            <MudText Typo="Typo.caption">@FormatFileSize(_wizardState.FileSize)</MudText>
                                        </div>
                                    </MudStack>
                                    <MudIconButton Icon="@Icons.Material.Filled.Close"
                                                   Color="Color.Error"
                                                   Size="Size.Small"
                                                   OnClick="ClearSelectedFile" />
                                </MudStack>
                            </MudPaper>
                        }
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.FlexEnd" Class="mt-4">
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="@(() => _activeStep++)"
                                   Disabled="@(_wizardState.SelectedFile == null || _selectedFile == null)">
                            Next
                        </MudButton>
                    </MudStack>
                </ChildContent>
            </MudStep>

            @* Step 2: Configure Target *@
            <MudStep Title="Configure Target" Icon="@Icons.Material.Filled.Settings">
                <ChildContent>
                    <MudStack Spacing="4" Class="mt-4">
                        <MudText Typo="Typo.h6">Configure import settings</MudText>

                        @if (_validationErrors.Any())
                        {
                            <MudAlert Severity="Severity.Warning">
                                <MudText Typo="Typo.body1"><b>Please fix @_validationErrors.Count error(s):</b></MudText>
                                <MudList Dense="true" Class="mt-2">
                                    @foreach (var error in _validationErrors)
                                    {
                                        <MudListItem Icon="@Icons.Material.Filled.Error" IconColor="Color.Warning">
                                            <MudText Typo="Typo.body2">@error</MudText>
                                        </MudListItem>
                                    }
                                </MudList>
                            </MudAlert>
                        }

                        <MudSelect T="string"
                                   Label="Target Service"
                                   @bind-Value="_wizardState.TargetServiceId"
                                   Variant="Variant.Filled"
                                   Required="true"
                                   Placeholder="Select a service">
                            @foreach (var service in _services)
                            {
                                <MudSelectItem Value="@service.Id">@service.Title (@service.Id)</MudSelectItem>
                            }
                        </MudSelect>

                        <MudDivider />

                        <MudText Typo="Typo.subtitle1">Layer Configuration</MudText>

                        <MudSwitch T="bool" @bind-Checked="_wizardState.CreateNewLayer"
                                   Color="Color.Primary"
                                   Label="Create new layer" />

                        @if (_wizardState.CreateNewLayer)
                        {
                            <MudTextField @ref="_layerIdField"
                                          Label="Layer ID"
                                          @bind-Value="_wizardState.TargetLayerId"
                                          Required="true"
                                          Immediate="true"
                                          Variant="Variant.Filled"
                                          HelperText="Unique identifier (e.g., 'parcels', 'roads')"
                                          Validation="@(new Func<string, IEnumerable<string>>(ValidateLayerId))"
                                          Adornment="Adornment.End"
                                          AdornmentIcon="@GetValidationIcon(nameof(_wizardState.TargetLayerId))"
                                          AdornmentColor="@GetValidationColor(nameof(_wizardState.TargetLayerId))"
                                          OnBlur="@(() => OnFieldBlur(nameof(_wizardState.TargetLayerId)))" />

                            <MudTextField Label="Layer Name"
                                          @bind-Value="_wizardState.TargetLayerName"
                                          Variant="Variant.Filled"
                                          HelperText="Display name (optional)" />
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Warning">
                                Appending to existing layers is not supported yet. Please create a new layer.
                            </MudAlert>
                        }
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                        <MudButton Variant="Variant.Text" OnClick="@(() => _activeStep--)">Back</MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="@(() => _activeStep++)"
                                   Disabled="@(!IsConfigurationValid())">
                            Next
                        </MudButton>
                    </MudStack>
                </ChildContent>
            </MudStep>

            @* Step 3: Review & Import *@
            <MudStep Title="Review & Import" Icon="@Icons.Material.Filled.CheckCircle">
                <ChildContent>
                    <MudStack Spacing="4" Class="mt-4">
                        <MudText Typo="Typo.h6">Review import configuration</MudText>

                        <MudSimpleTable Elevation="0" Dense="true">
                            <tbody>
                                <tr>
                                    <td><strong>File:</strong></td>
                                    <td>@_wizardState.SelectedFile</td>
                                </tr>
                                <tr>
                                    <td><strong>File Size:</strong></td>
                                    <td>@FormatFileSize(_wizardState.FileSize)</td>
                                </tr>
                                <tr>
                                    <td><strong>Target Service:</strong></td>
                                    <td>@GetServiceDisplayName(_wizardState.TargetServiceId)</td>
                                </tr>
                                <tr>
                                    <td><strong>Layer ID:</strong></td>
                                    <td>@_wizardState.TargetLayerId</td>
                                </tr>
                                @if (!string.IsNullOrEmpty(_wizardState.TargetLayerName))
                                {
                                    <tr>
                                        <td><strong>Layer Name:</strong></td>
                                        <td>@_wizardState.TargetLayerName</td>
                                    </tr>
                                }
                            </tbody>
                        </MudSimpleTable>

                        @if (_importing)
                        {
                            <MudPaper Outlined="true" Class="pa-4 my-4">
                                <MudStack Spacing="2">
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudText Typo="Typo.body1">
                                            @if (_uploadProgress < 100)
                                            {
                                                <text>Uploading file...</text>
                                            }
                                            else
                                            {
                                                <text>Processing file...</text>
                                            }
                                        </MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Primary">
                                            <b>@($"{_uploadProgress:F1}%")</b>
                                        </MudText>
                                    </MudStack>

                                    <MudProgressLinear Value="@_uploadProgress" Color="Color.Primary" Size="Size.Medium" />

                                    @if (_uploadProgress < 100 && _uploadProgress > 0)
                                    {
                                        <MudStack Row="true" Justify="Justify.SpaceBetween">
                                            <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                @FormatFileSize((long)(_wizardState.FileSize * _uploadProgress / 100)) / @FormatFileSize(_wizardState.FileSize)
                                            </MudText>
                                            @if (_uploadStartTime.HasValue)
                                            {
                                                var elapsed = DateTime.Now - _uploadStartTime.Value;
                                                var bytesUploaded = (long)(_wizardState.FileSize * _uploadProgress / 100);
                                                var speed = elapsed.TotalSeconds > 0 ? bytesUploaded / elapsed.TotalSeconds : 0;
                                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                    @($"{FormatFileSize((long)speed)}/s")
                                                </MudText>
                                            }
                                        </MudStack>
                                    }
                                </MudStack>
                            </MudPaper>
                        }

                        @if (_wizardState.JobId.HasValue)
                        {
                            <MudAlert Severity="Severity.Success" Class="mt-4">
                                <MudText Typo="Typo.body1">
                                    Import job created successfully! Job ID: @_wizardState.JobId
                                </MudText>
                            </MudAlert>

                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       StartIcon="@Icons.Material.Filled.RemoveRedEye"
                                       Href="@($"/import/jobs/{_wizardState.JobId}")">
                                View Job Status
                            </MudButton>
                        }
                    </MudStack>
                    <MudStack Row="true" Justify="Justify.SpaceBetween" Class="mt-4">
                        @if (!_wizardState.JobId.HasValue)
                        {
                            <MudButton Variant="Variant.Text" OnClick="@(() => _activeStep--)" Disabled="@_importing">Back</MudButton>
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Success"
                                       StartIcon="@Icons.Material.Filled.CloudUpload"
                                       OnClick="StartImport"
                                       Disabled="@_importing">
                                Start Import
                            </MudButton>
                        }
                        else
                        {
                            <MudButton Variant="Variant.Text" OnClick="ResetWizard">Import Another File</MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/import/jobs">View All Jobs</MudButton>
                        }
                    </MudStack>
                </ChildContent>
            </MudStep>

        </MudStepper>
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Import Data", href: null, disabled: true)
    };

    private MudStepper? _stepper;
    private int _activeStep = 0;
    private ImportWizardState _wizardState = new();
    private IBrowserFile? _selectedFile;
    private List<ServiceListItem> _services = new();
    private bool _importing = false;
    private bool _isDraggingOver = false;
    private IJSObjectReference? _dragDropModule;
    private bool _dragDropInitialized = false;
    private double _uploadProgress = 0;
    private DateTime? _uploadStartTime;

    // Field references
    private MudTextField<string> _layerIdField = default!;

    // Validation tracking
    private Dictionary<string, bool> _fieldValidity = new();
    private Dictionary<string, bool> _fieldTouched = new();
    private List<string> _validationErrors = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadServicesAsync();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_dragDropInitialized)
        {
            try
            {
                _dragDropModule = await JSRuntime.InvokeAsync<IJSObjectReference>(
                    "initializeDragAndDrop",
                    "fileDropZone",
                    "fileInput");
                _dragDropInitialized = true;
            }
            catch (Exception ex)
            {
                // Silently fail - drag and drop is an enhancement, not critical
                Console.WriteLine($"Failed to initialize drag and drop: {ex.Message}");
            }
        }
    }

    private async Task LoadServicesAsync()
    {
        try
        {
            _services = await ServiceApi.GetServicesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading services: {ex.Message}", Severity.Error);
        }
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _wizardState.SelectedFile = e.File.Name;
        _wizardState.FileSize = e.File.Size;

        // Auto-advance to next step
        await Task.Delay(100);
        _activeStep++;
    }

    private void ClearSelectedFile()
    {
        _selectedFile = null;
        _wizardState.SelectedFile = null;
        _wizardState.FileSize = 0;
    }

    // Drag and drop event handlers
    private void HandleDragEnter(DragEventArgs e)
    {
        _isDraggingOver = true;
    }

    private void HandleDragOver(DragEventArgs e)
    {
        // Prevent default to allow drop
        _isDraggingOver = true;
    }

    private void HandleDragLeave(DragEventArgs e)
    {
        _isDraggingOver = false;
    }

    private void HandleDrop(DragEventArgs e)
    {
        _isDraggingOver = false;
        // JavaScript handles the actual file transfer to InputFile component
    }

    private bool IsConfigurationValid()
    {
        return !string.IsNullOrWhiteSpace(_wizardState.TargetServiceId)
            && !string.IsNullOrWhiteSpace(_wizardState.TargetLayerId);
    }

    private string GetServiceDisplayName(string? serviceId)
    {
        if (string.IsNullOrEmpty(serviceId))
            return "None";

        var service = _services.FirstOrDefault(s => s.Id == serviceId);
        return service != null ? $"{service.Title} ({service.Id})" : serviceId;
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private async Task StartImport()
    {
        if (_selectedFile == null || string.IsNullOrEmpty(_wizardState.TargetServiceId) || string.IsNullOrEmpty(_wizardState.TargetLayerId))
        {
            Snackbar.Add("Please complete all required fields", Severity.Warning);
            return;
        }

        _importing = true;
        _uploadProgress = 0;
        _uploadStartTime = DateTime.Now;

        try
        {
            var progress = new Progress<double>(percent =>
            {
                _uploadProgress = percent;
                InvokeAsync(StateHasChanged);
            });

            var job = await ImportApi.CreateImportJobAsync(
                _wizardState.TargetServiceId,
                _wizardState.TargetLayerId,
                _selectedFile,
                overwrite: false,
                progress: progress);

            if (job != null)
            {
                _wizardState.JobId = job.JobId;
                Snackbar.Add("Import job created successfully!", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to create import job", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error starting import: {ex.Message}", Severity.Error);
        }
        finally
        {
            _importing = false;
            _uploadProgress = 0;
            _uploadStartTime = null;
        }
    }

    private void ResetWizard()
    {
        _wizardState = new ImportWizardState();
        _selectedFile = null;
        _activeStep = 0;
        _fieldValidity.Clear();
        _fieldTouched.Clear();
        _validationErrors.Clear();
    }

    private IEnumerable<string> ValidateLayerId(string id)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(id))
        {
            errors.Add("Layer ID is required");
            UpdateFieldValidity(nameof(_wizardState.TargetLayerId), false);
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(id, "^[a-zA-Z0-9_-]+$"))
        {
            errors.Add("Layer ID must contain only alphanumeric characters, hyphens, and underscores");
            UpdateFieldValidity(nameof(_wizardState.TargetLayerId), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_wizardState.TargetLayerId), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private void UpdateFieldValidity(string fieldName, bool isValid)
    {
        _fieldValidity[fieldName] = isValid;
    }

    private void OnFieldBlur(string fieldName)
    {
        _fieldTouched[fieldName] = true;
        StateHasChanged();
    }

    private string GetValidationIcon(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return string.Empty;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Icons.Material.Filled.CheckCircle
            : Icons.Material.Filled.Error;
    }

    private Color GetValidationColor(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return Color.Default;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Color.Success
            : Color.Error;
    }

    private void UpdateValidationSummary()
    {
        _validationErrors.Clear();

        if (string.IsNullOrWhiteSpace(_wizardState.TargetServiceId))
        {
            _validationErrors.Add("Target Service: Please select a service");
        }

        if (_wizardState.CreateNewLayer)
        {
            if (_fieldTouched.GetValueOrDefault(nameof(_wizardState.TargetLayerId)) &&
                !_fieldValidity.GetValueOrDefault(nameof(_wizardState.TargetLayerId)))
            {
                _validationErrors.Add("Layer ID: Invalid format or missing");
            }
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_dragDropModule != null)
        {
            try
            {
                await _dragDropModule.InvokeVoidAsync("dispose");
                await _dragDropModule.DisposeAsync();
            }
            catch
            {
                // Ignore disposal errors
            }
        }
    }
}
