@* Copyright (c) 2025 HonuaIO *@
@* Licensed under the Elastic License 2.0. See LICENSE file in the project root for full license information. *@

@page "/styles"
@page "/styles/edit/{StyleId}"
@using Honua.Admin.Blazor.Shared.Models
@using Honua.Admin.Blazor.Shared.Services
@using System.Text.Json
@inject StyleApiClient StyleApiClient
@inject LayerApiClient LayerApiClient
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@attribute [Authorize]

<PageTitle>Style Editor - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="pt-4">
    @if (_isLoading)
    {
        <MudStack AlignItems="AlignItems.Center" Justify="Justify.Center" Style="min-height: 400px;">
            <MudProgressCircular Color="MudColor.Primary" Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6">Loading style editor...</MudText>
        </MudStack>
    }
    else if (_showStyleList)
    {
        <MudStack Spacing="3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudText Typo="Typo.h4">Style Management</MudText>
                <MudButton Variant="Variant.Filled"
                           Color="MudColor.Primary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="CreateNewStyle">
                    Create Style
                </MudButton>
            </MudStack>

            <MudPaper Class="pa-3">
                <MudStack Row="true" Spacing="2">
                    <MudTextField @bind-Value="_searchText"
                                  Label="Search styles"
                                  Variant="Variant.Outlined"
                                  Margin="Margin.Dense"
                                  Adornment="Adornment.Start"
                                  AdornmentIcon="@Icons.Material.Filled.Search"
                                  Immediate="true"
                                  Style="flex: 1;" />

                    <MudSelect @bind-Value="_filterLayerId"
                               Label="Filter by layer"
                               Variant="Variant.Outlined"
                               Margin="Margin.Dense"
                               Clearable="true"
                               T="string?"
                               Style="min-width: 250px;">
                        @foreach (var layer in _layers)
                        {
                            <MudSelectItem Value="@layer.Id">@layer.Name</MudSelectItem>
                        }
                    </MudSelect>
                </MudStack>
            </MudPaper>

            <MudTable Items="@GetFilteredStyles()" Hover="true" Striped="true" Breakpoint="Breakpoint.Sm">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Layer</MudTh>
                    <MudTh>Geometry Type</MudTh>
                    <MudTh>Renderer Type</MudTh>
                    <MudTh>Default</MudTh>
                    <MudTh>Created</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudIcon Icon="@GetGeometryIcon(context.GeometryType)" Size="Size.Small" />
                            <MudText>@context.Name</MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Layer">@context.LayerName</MudTd>
                    <MudTd DataLabel="Geometry Type">
                        <MudChip Size="Size.Small" Color="MudColor.Default">@context.GeometryType</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Renderer Type">
                        <MudChip Size="Size.Small" Color="@GetRendererColor(context.RendererType)">
                            @FormatRendererType(context.RendererType)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Default">
                        @if (context.IsDefault)
                        {
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="MudColor.Success" Size="Size.Small" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Created">@context.CreatedAt.ToString("MMM d, yyyy")</MudTd>
                    <MudTd DataLabel="Actions">
                        <MudStack Row="true" Spacing="1">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Size="Size.Small"
                                           Color="MudColor.Primary"
                                           OnClick="@(() => EditStyle(context.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.ContentCopy"
                                           Size="Size.Small"
                                           Color="MudColor.Secondary"
                                           OnClick="@(() => DuplicateStyle(context.Id))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           Color="MudColor.Error"
                                           OnClick="@(() => DeleteStyle(context.Id))" />
                        </MudStack>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        </MudStack>
    }
    else
    {
        @* Style Editor *@
        <MudStack Spacing="3">
            <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                    <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                                   OnClick="BackToList" />
                    <MudText Typo="Typo.h4">
                        @(_isNewStyle ? "Create Style" : $"Edit Style: {_currentStyle?.Name}")
                    </MudText>
                </MudStack>

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               StartIcon="@Icons.Material.Filled.Cancel"
                               OnClick="BackToList">
                        Cancel
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="MudColor.Primary"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="SaveStyle"
                               Disabled="_isSaving">
                        @(_isSaving ? "Saving..." : "Save")
                    </MudButton>
                </MudStack>
            </MudStack>

            @if (_currentStyle != null)
            {
                <MudGrid>
                    @* Left Panel - Style Configuration (40%) *@
                    <MudItem xs="12" md="5">
                        <MudPaper Class="pa-4" Style="height: calc(100vh - 200px); overflow-y: auto;">
                            <MudStack Spacing="3">
                                <MudText Typo="Typo.h6">Style Properties</MudText>

                                <MudTextField @bind-Value="_currentStyle.Name"
                                              Label="Style Name"
                                              Variant="Variant.Outlined"
                                              Required="true"
                                              Margin="Margin.Dense" />

                                <MudTextField @bind-Value="_currentStyle.Description"
                                              Label="Description"
                                              Variant="Variant.Outlined"
                                              Lines="2"
                                              Margin="Margin.Dense" />

                                <MudSelect @bind-Value="_currentStyle.LayerId"
                                           Label="Layer"
                                           Variant="Variant.Outlined"
                                           Required="true"
                                           Margin="Margin.Dense"
                                           T="string"
                                           Disabled="!_isNewStyle"
                                           ValueChanged="OnLayerChanged">
                                    @foreach (var layer in _layers)
                                    {
                                        <MudSelectItem Value="@layer.Id">@layer.Name</MudSelectItem>
                                    }
                                </MudSelect>

                                <MudSelect @bind-Value="_currentStyle.GeometryType"
                                           Label="Geometry Type"
                                           Variant="Variant.Outlined"
                                           Required="true"
                                           Margin="Margin.Dense"
                                           T="string"
                                           Disabled="!_isNewStyle"
                                           ValueChanged="OnGeometryTypeChanged">
                                    <MudSelectItem Value="@("point")">Point</MudSelectItem>
                                    <MudSelectItem Value="@("line")">Line</MudSelectItem>
                                    <MudSelectItem Value="@("polygon")">Polygon</MudSelectItem>
                                    <MudSelectItem Value="@("raster")">Raster</MudSelectItem>
                                </MudSelect>

                                <MudDivider />

                                <MudText Typo="Typo.h6">Renderer Configuration</MudText>

                                <MudTabs Elevation="0" Rounded="true" Color="MudColor.Primary" @bind-ActivePanelIndex="_activeRendererTab">
                                    <MudTabPanel Text="Simple" Icon="@Icons.Material.Filled.Circle">
                                        <div class="pt-3">
                                            <SimpleRendererEditor Renderer="@GetSimpleRenderer()"
                                                                  RendererChanged="OnRendererChanged"
                                                                  RecentColors="_recentColors" />
                                        </div>
                                    </MudTabPanel>
                                    <MudTabPanel Text="Categorized" Icon="@Icons.Material.Filled.Category">
                                        <div class="pt-3">
                                            <UniqueValueRendererEditor Renderer="@GetUniqueValueRenderer()"
                                                                       RendererChanged="OnRendererChanged"
                                                                       LayerId="@_currentStyle.LayerId"
                                                                       GeometryType="@_currentStyle.GeometryType"
                                                                       RecentColors="_recentColors" />
                                        </div>
                                    </MudTabPanel>
                                    <MudTabPanel Text="Rule-Based" Icon="@Icons.Material.Filled.Rule">
                                        <div class="pt-3">
                                            <RuleBasedRendererEditor Renderer="@GetRuleBasedRenderer()"
                                                                     RendererChanged="OnRendererChanged"
                                                                     GeometryType="@_currentStyle.GeometryType"
                                                                     RecentColors="_recentColors" />
                                        </div>
                                    </MudTabPanel>
                                </MudTabs>
                            </MudStack>
                        </MudPaper>
                    </MudItem>

                    @* Right Panel - Preview and JSON (60%) *@
                    <MudItem xs="12" md="7">
                        <MudPaper Class="pa-4" Style="height: calc(100vh - 200px); overflow-y: auto;">
                            <MudTabs Elevation="0" Rounded="true" Color="MudColor.Primary">
                                <MudTabPanel Text="Preview" Icon="@Icons.Material.Filled.Visibility">
                                    <div class="pt-3">
                                        <MudStack Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.Center" Style="min-height: 400px;">
                                            <MudIcon Icon="@Icons.Material.Filled.Map" Size="Size.Large" Color="MudColor.Secondary" />
                                            <MudText Typo="Typo.h6" Color="MudColor.Secondary">Live Map Preview</MudText>
                                            <MudText Typo="Typo.body2" Color="MudColor.Secondary" Align="Align.Center">
                                                Map preview will be displayed here once integrated with the mapping engine.
                                            </MudText>
                                            <MudAlert Severity="Severity.Info">
                                                This preview area will show how your style appears on actual map data.
                                            </MudAlert>
                                        </MudStack>
                                    </div>
                                </MudTabPanel>
                                <MudTabPanel Text="JSON" Icon="@Icons.Material.Filled.Code">
                                    <div class="pt-3">
                                        <MudStack Spacing="2">
                                            <MudStack Row="true" Justify="Justify.SpaceBetween">
                                                <MudText Typo="Typo.subtitle1">Style Definition (mvp-style format)</MudText>
                                                <MudButton Size="Size.Small"
                                                           StartIcon="@Icons.Material.Filled.ContentCopy"
                                                           OnClick="CopyJsonToClipboard">
                                                    Copy
                                                </MudButton>
                                            </MudStack>
                                            <MudPaper Elevation="0" Outlined="true" Class="pa-3">
                                                <pre style="overflow-x: auto; max-height: 600px;">@GetFormattedJson()</pre>
                                            </MudPaper>
                                        </MudStack>
                                    </div>
                                </MudTabPanel>
                                <MudTabPanel Text="Export" Icon="@Icons.Material.Filled.Download">
                                    <div class="pt-3">
                                        <MudStack Spacing="3">
                                            <MudText Typo="Typo.subtitle1">Export Style</MudText>

                                            <MudButton Variant="Variant.Outlined"
                                                       StartIcon="@Icons.Material.Filled.Download"
                                                       FullWidth="true"
                                                       OnClick="@(() => ExportStyle("sld"))"
                                                       Disabled="string.IsNullOrEmpty(_currentStyle.Id)">
                                                Export as SLD (Styled Layer Descriptor)
                                            </MudButton>

                                            <MudButton Variant="Variant.Outlined"
                                                       StartIcon="@Icons.Material.Filled.Download"
                                                       FullWidth="true"
                                                       OnClick="@(() => ExportStyle("mapbox"))"
                                                       Disabled="string.IsNullOrEmpty(_currentStyle.Id)">
                                                Export as MapBox Style Spec
                                            </MudButton>

                                            <MudDivider />

                                            <MudText Typo="Typo.subtitle1">Import Style</MudText>

                                            <MudFileUpload T="IBrowserFile" Accept=".sld,.xml" FilesChanged="ImportSldFile">
                                                <ButtonTemplate>
                                                    <MudButton HtmlTag="label"
                                                               Variant="Variant.Outlined"
                                                               StartIcon="@Icons.Material.Filled.Upload"
                                                               FullWidth="true"
                                                               for="@context">
                                                        Import SLD File
                                                    </MudButton>
                                                </ButtonTemplate>
                                            </MudFileUpload>
                                        </MudStack>
                                    </div>
                                </MudTabPanel>
                            </MudTabs>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            }
        </MudStack>
    }
</MudContainer>

@code {
    [Parameter]
    public string? StyleId { get; set; }

    private bool _isLoading = true;
    private bool _isSaving = false;
    private bool _showStyleList = true;
    private bool _isNewStyle = false;

    private StyleDefinition? _currentStyle;
    private List<StyleListItem> _allStyles = new();
    private List<LayerListItem> _layers = new();

    private string _searchText = string.Empty;
    private string? _filterLayerId;
    private int _activeRendererTab = 0;

    private List<string> _recentColors = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    protected override async Task OnParametersSetAsync()
    {
        if (!string.IsNullOrEmpty(StyleId))
        {
            _showStyleList = false;
            await LoadStyleForEditingAsync(StyleId);
        }
    }

    private async Task LoadDataAsync()
    {
        try
        {
            _allStyles = await StyleApiClient.GetStylesAsync();
            _layers = await LayerApiClient.GetLayersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadStyleForEditingAsync(string styleId)
    {
        try
        {
            _currentStyle = await StyleApiClient.GetStyleByIdAsync(styleId);
            _isNewStyle = false;

            // Set active renderer tab based on renderer type
            _activeRendererTab = _currentStyle?.Renderer switch
            {
                SimpleRenderer => 0,
                UniqueValueRenderer => 1,
                RuleBasedRenderer => 2,
                _ => 0
            };
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to load style: {ex.Message}", Severity.Error);
            BackToList();
        }
    }

    private void CreateNewStyle()
    {
        _isNewStyle = true;
        _showStyleList = false;
        _currentStyle = new StyleDefinition
        {
            Id = string.Empty,
            Name = "New Style",
            GeometryType = "point",
            Renderer = new SimpleRenderer
            {
                Symbol = new PointSymbol()
            }
        };
        _activeRendererTab = 0;
    }

    private void EditStyle(string styleId)
    {
        NavigationManager.NavigateTo($"/styles/edit/{styleId}");
    }

    private void BackToList()
    {
        _showStyleList = true;
        _currentStyle = null;
        NavigationManager.NavigateTo("/styles");
    }

    private async Task SaveStyle()
    {
        if (_currentStyle == null || string.IsNullOrEmpty(_currentStyle.Name) || string.IsNullOrEmpty(_currentStyle.LayerId))
        {
            Snackbar.Add("Please fill in all required fields", Severity.Warning);
            return;
        }

        _isSaving = true;
        try
        {
            if (_isNewStyle)
            {
                var request = new CreateStyleRequest
                {
                    Name = _currentStyle.Name,
                    Description = _currentStyle.Description,
                    LayerId = _currentStyle.LayerId,
                    GeometryType = _currentStyle.GeometryType,
                    Renderer = _currentStyle.Renderer
                };
                _currentStyle = await StyleApiClient.CreateStyleAsync(request);
                Snackbar.Add("Style created successfully", Severity.Success);
            }
            else
            {
                var request = new UpdateStyleRequest
                {
                    Name = _currentStyle.Name,
                    Description = _currentStyle.Description,
                    Renderer = _currentStyle.Renderer
                };
                _currentStyle = await StyleApiClient.UpdateStyleAsync(_currentStyle.Id, request);
                Snackbar.Add("Style updated successfully", Severity.Success);
            }

            await LoadDataAsync();
            BackToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to save style: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task DuplicateStyle(string styleId)
    {
        try
        {
            var newName = $"Copy of {_allStyles.FirstOrDefault(s => s.Id == styleId)?.Name ?? "Style"}";
            await StyleApiClient.DuplicateStyleAsync(styleId, newName);
            Snackbar.Add("Style duplicated successfully", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to duplicate style: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteStyle(string styleId)
    {
        var confirmed = await Snackbar.ShowMessageBox("Confirm Delete", "Are you sure you want to delete this style?",
            yesText: "Delete", cancelText: "Cancel");
        if (confirmed != true) return;

        try
        {
            await StyleApiClient.DeleteStyleAsync(styleId);
            Snackbar.Add("Style deleted successfully", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to delete style: {ex.Message}", Severity.Error);
        }
    }

    private async Task ExportStyle(string format)
    {
        if (_currentStyle == null || string.IsNullOrEmpty(_currentStyle.Id)) return;

        try
        {
            string content = format.ToLowerInvariant() switch
            {
                "sld" => await StyleApiClient.ExportToSldAsync(_currentStyle.Id),
                "mapbox" => await StyleApiClient.ExportToMapBoxAsync(_currentStyle.Id),
                _ => throw new ArgumentException("Unknown format")
            };

            // Trigger download (simplified - in real app would use JS interop)
            Snackbar.Add($"Style exported to {format.ToUpperInvariant()}", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to export style: {ex.Message}", Severity.Error);
        }
    }

    private async Task ImportSldFile(IBrowserFile file)
    {
        try
        {
            using var stream = file.OpenReadStream();
            using var reader = new StreamReader(stream);
            var sldContent = await reader.ReadToEndAsync();

            if (_currentStyle != null && !string.IsNullOrEmpty(_currentStyle.LayerId))
            {
                _currentStyle = await StyleApiClient.ImportFromSldAsync(_currentStyle.LayerId, sldContent, _currentStyle.Name);
                Snackbar.Add("SLD imported successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to import SLD: {ex.Message}", Severity.Error);
        }
    }

    private void OnLayerChanged(string layerId)
    {
        if (_currentStyle != null)
        {
            _currentStyle.LayerId = layerId;
            var layer = _layers.FirstOrDefault(l => l.Id == layerId);
            if (layer != null)
            {
                _currentStyle.GeometryType = layer.GeometryType;
                OnGeometryTypeChanged(layer.GeometryType);
            }
        }
    }

    private void OnGeometryTypeChanged(string geometryType)
    {
        if (_currentStyle?.Renderer is SimpleRenderer simpleRenderer)
        {
            simpleRenderer.Symbol = geometryType.ToLowerInvariant() switch
            {
                "point" => new PointSymbol(),
                "line" => new LineSymbol(),
                "polygon" => new PolygonSymbol(),
                _ => new PointSymbol()
            };
        }
    }

    private void OnRendererChanged()
    {
        StateHasChanged();
    }

    private SimpleRenderer? GetSimpleRenderer()
    {
        if (_currentStyle?.Renderer is not SimpleRenderer simple)
        {
            simple = new SimpleRenderer
            {
                Symbol = _currentStyle?.GeometryType.ToLowerInvariant() switch
                {
                    "point" => new PointSymbol(),
                    "line" => new LineSymbol(),
                    "polygon" => new PolygonSymbol(),
                    _ => new PointSymbol()
                }
            };
            if (_currentStyle != null)
                _currentStyle.Renderer = simple;
        }
        return simple;
    }

    private UniqueValueRenderer? GetUniqueValueRenderer()
    {
        if (_currentStyle?.Renderer is not UniqueValueRenderer unique)
        {
            var defaultSymbol = _currentStyle?.GeometryType.ToLowerInvariant() switch
            {
                "point" => new PointSymbol { Color = "#cccccc" },
                "line" => new LineSymbol { Color = "#cccccc" },
                "polygon" => new PolygonSymbol { FillColor = "#cccccc" },
                _ => (SymbolBase)new PointSymbol()
            };

            unique = new UniqueValueRenderer
            {
                Field = "type",
                DefaultSymbol = defaultSymbol,
                DefaultLabel = "Other"
            };
            if (_currentStyle != null)
                _currentStyle.Renderer = unique;
        }
        return unique;
    }

    private RuleBasedRenderer? GetRuleBasedRenderer()
    {
        if (_currentStyle?.Renderer is not RuleBasedRenderer ruleBased)
        {
            var defaultSymbol = _currentStyle?.GeometryType.ToLowerInvariant() switch
            {
                "point" => new PointSymbol { Color = "#cccccc" },
                "line" => new LineSymbol { Color = "#cccccc" },
                "polygon" => new PolygonSymbol { FillColor = "#cccccc" },
                _ => (SymbolBase)new PointSymbol()
            };

            ruleBased = new RuleBasedRenderer
            {
                DefaultSymbol = defaultSymbol
            };
            if (_currentStyle != null)
                _currentStyle.Renderer = ruleBased;
        }
        return ruleBased;
    }

    private IEnumerable<StyleListItem> GetFilteredStyles()
    {
        var filtered = _allStyles.AsEnumerable();

        if (!string.IsNullOrEmpty(_searchText))
        {
            filtered = filtered.Where(s =>
                s.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                s.LayerName.Contains(_searchText, StringComparison.OrdinalIgnoreCase));
        }

        if (!string.IsNullOrEmpty(_filterLayerId))
        {
            filtered = filtered.Where(s => s.LayerId == _filterLayerId);
        }

        return filtered;
    }

    private string GetFormattedJson()
    {
        if (_currentStyle == null) return "{}";

        try
        {
            return JsonSerializer.Serialize(_currentStyle, new JsonSerializerOptions
            {
                WriteIndented = true,
                PropertyNamingPolicy = JsonNamingPolicy.CamelCase
            });
        }
        catch
        {
            return "Error formatting JSON";
        }
    }

    private Task CopyJsonToClipboard()
    {
        // In real app, would use JS interop to copy to clipboard
        Snackbar.Add("JSON copied to clipboard", Severity.Success);
        return Task.CompletedTask;
    }

    private string GetGeometryIcon(string geometryType) => geometryType.ToLowerInvariant() switch
    {
        "point" => Icons.Material.Filled.Circle,
        "line" => Icons.Material.Filled.Timeline,
        "polygon" => Icons.Material.Filled.Hexagon,
        "raster" => Icons.Material.Filled.GridOn,
        _ => Icons.Material.Filled.Help
    };

    private MudColor GetRendererColor(string rendererType) => rendererType.ToLowerInvariant() switch
    {
        "simple" => MudColor.Primary,
        "uniquevalue" => MudColor.Secondary,
        "rulebased" => MudColor.Tertiary,
        _ => MudColor.Default
    };

    private string FormatRendererType(string rendererType) => rendererType switch
    {
        "simple" => "Simple",
        "uniqueValue" => "Categorized",
        "ruleBased" => "Rule-Based",
        _ => rendererType
    };
}
