@page "/"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@using Honua.Admin.Blazor.Components.Shared
@using System.Timers
@attribute [Authorize]
@rendermode InteractiveServer
@inject DashboardApiClient DashboardApi
@inject NavigationState NavState
@inject ILogger<Home> Logger
@implements IDisposable

<PageTitle>Dashboard - Honua Admin</PageTitle>

<MudStack Spacing="3">
    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
        <div>
            <MudText Typo="Typo.h3">Dashboard</MudText>
            <MudText Class="mt-1" Color="Color.Secondary">Monitor and manage your GIS services</MudText>
        </div>
        @if (_metrics != null && _refreshTimer != null)
        {
            <MudChip Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.AutorenewOutlined" Variant="Variant.Text">
                Auto-refresh
            </MudChip>
        }
    </MudStack>

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" />
    }

    @* Overview Metrics *@
    <MudGrid>
        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.h4">@(_metrics?.Overview.TotalServices ?? 0)</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Services</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Tertiary">
                            @(_metrics?.Overview.EnabledServices ?? 0) enabled
                        </MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Layers" Color="Color.Primary" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.h4">@(_metrics?.Overview.TotalLayers ?? 0)</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Layers</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Tertiary">
                            @(_metrics?.Overview.TotalFolders ?? 0) folders
                        </MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Map" Color="Color.Secondary" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.h4">@FormatLargeNumber(_metrics?.Overview.TotalRequests24h ?? 0)</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Requests (24h)</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Tertiary">
                            @(_metrics?.Performance.RequestsPerSecond.ToString("F1") ?? "0") req/s
                        </MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.TrendingUp" Color="Color.Info" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudPaper Elevation="2" Class="pa-4">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <div>
                        <MudText Typo="Typo.h4">@((_metrics?.Performance.CacheHitRate * 100).ToString("F0") ?? "0")%</MudText>
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Cache Hit Rate</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Tertiary">
                            @(_metrics?.Performance.AverageResponseTime.ToString("F0") ?? "0")ms avg
                        </MudText>
                    </div>
                    <MudIcon Icon="@Icons.Material.Filled.Speed" Color="@GetCacheHitRateColor()" Size="Size.Large" />
                </MudStack>
            </MudPaper>
        </MudItem>
    </MudGrid>

    @* Performance Metrics *@
    <MudGrid>
        <MudItem xs="12" md="8">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Performance Metrics</MudText>
                <MudGrid>
                    <MudItem xs="6" sm="3">
                        <MudStack AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h5">@(_metrics?.Performance.AverageResponseTime.ToString("F0") ?? "0")ms</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">Avg Response</MudText>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudStack AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h5">@(_metrics?.Performance.P95ResponseTime.ToString("F0") ?? "0")ms</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">P95 Response</MudText>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudStack AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h5">@(_metrics?.Performance.P99ResponseTime.ToString("F0") ?? "0")ms</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">P99 Response</MudText>
                        </MudStack>
                    </MudItem>
                    <MudItem xs="6" sm="3">
                        <MudStack AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.h5" Color="@GetErrorRateColor()">@((_metrics?.Performance.ErrorRate * 100).ToString("F2") ?? "0")%</MudText>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Align="Align.Center">Error Rate</MudText>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <MudItem xs="12" md="4">
            <HealthStatusCard Health="@_metrics?.HealthStatus" />
        </MudItem>
    </MudGrid>

    @* Service Distribution and Activity Feed *@
    <MudGrid>
        <MudItem xs="12" md="4">
            <ServiceDistributionChart Distribution="@_metrics?.ServiceDistribution" />
        </MudItem>

        <MudItem xs="12" md="8">
            <ActivityFeed Activities="@_metrics?.RecentActivity" MaxItems="10" />
        </MudItem>
    </MudGrid>

    @* Quick Actions *@
    <MudPaper Elevation="2" Class="pa-4">
        <MudText Typo="Typo.h6" Class="mb-3">Quick Actions</MudText>
        <MudStack Row="true" Spacing="2" Wrap="Wrap.Wrap">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add" Href="/services/new">
                Create Service
            </MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.Upload" Href="/import">
                Import Data
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Folder" Href="/folders">
                Browse Folders
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Security" Href="/audit">
                View Audit Log
            </MudButton>
            <MudButton Variant="Variant.Outlined" Color="Color.Default" StartIcon="@Icons.Material.Filled.Storage" Href="/cache">
                Cache Settings
            </MudButton>
        </MudStack>
    </MudPaper>
</MudStack>

@code {
    private DashboardMetrics? _metrics;
    private bool _loading = true;
    private Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        NavState.Reset();
        await LoadDashboardMetricsAsync();

        // Auto-refresh every 30 seconds
        _refreshTimer = new Timer(30000);
        _refreshTimer.Elapsed += async (sender, e) => await RefreshMetricsAsync();
        _refreshTimer.AutoReset = true;
        _refreshTimer.Start();
    }

    private async Task LoadDashboardMetricsAsync()
    {
        _loading = true;

        try
        {
            var request = new DashboardMetricsRequest
            {
                StartTime = DateTimeOffset.UtcNow.AddHours(-24),
                EndTime = DateTimeOffset.UtcNow,
                IncludeTimeSeries = true,
                IncludeRecentActivity = true,
                ActivityLimit = 20
            };

            _metrics = await DashboardApi.GetMetricsAsync(request);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load dashboard metrics");
            // Create empty metrics to avoid null reference
            _metrics = new DashboardMetrics();
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RefreshMetricsAsync()
    {
        try
        {
            var request = new DashboardMetricsRequest
            {
                StartTime = DateTimeOffset.UtcNow.AddHours(-24),
                EndTime = DateTimeOffset.UtcNow,
                IncludeTimeSeries = false, // Don't reload time series on refresh
                IncludeRecentActivity = true,
                ActivityLimit = 20
            };

            _metrics = await DashboardApi.GetMetricsAsync(request);
            await InvokeAsync(StateHasChanged);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to refresh dashboard metrics");
        }
    }

    private string FormatLargeNumber(long number)
    {
        if (number >= 1_000_000)
            return $"{number / 1_000_000.0:F1}M";
        if (number >= 1_000)
            return $"{number / 1_000.0:F1}K";
        return number.ToString();
    }

    private Color GetCacheHitRateColor()
    {
        if (_metrics == null)
            return Color.Default;

        var hitRate = _metrics.Performance.CacheHitRate;
        if (hitRate >= 0.8)
            return Color.Success;
        if (hitRate >= 0.5)
            return Color.Warning;
        return Color.Error;
    }

    private Color GetErrorRateColor()
    {
        if (_metrics == null)
            return Color.Default;

        var errorRate = _metrics.Performance.ErrorRate;
        if (errorRate < 0.01)
            return Color.Success;
        if (errorRate < 0.05)
            return Color.Warning;
        return Color.Error;
    }

    public void Dispose()
    {
        if (_refreshTimer != null)
        {
            _refreshTimer.Stop();
            _refreshTimer.Dispose();
            _refreshTimer = null;
        }
    }
}
