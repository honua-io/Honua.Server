@page "/versions"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator")]
@inject SnapshotApiClient SnapshotApi
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Version History - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">Metadata Snapshots</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.AddPhotoAlternate"
                       OnClick="OpenCreateSnapshotDialog">
                Create Snapshot
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Default"
                           OnClick="LoadSnapshotsAsync"
                           Title="Refresh" />
        </MudStack>

        <MudAlert Severity="Severity.Info" Class="mb-4">
            Snapshots preserve the complete state of your metadata configuration (services, layers, folders, etc.) at a specific point in time. You can restore any snapshot to roll back changes.
        </MudAlert>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        <MudTable Items="@_snapshots"
                  Hover="true"
                  Breakpoint="Breakpoint.Sm"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary"
                  @bind-SelectedItem="_selectedSnapshot">
            <HeaderContent>
                <MudTh>Label</MudTh>
                <MudTh>Created</MudTh>
                <MudTh>Size</MudTh>
                <MudTh>Notes</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Label">
                    <MudText Typo="Typo.body1"><b>@context.Label</b></MudText>
                    @if (!string.IsNullOrEmpty(context.Checksum))
                    {
                        <MudText Typo="Typo.caption" Class="text-monospace">@context.Checksum.Substring(0, Math.Min(8, context.Checksum.Length))...</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Created">
                    <MudText Typo="Typo.body2">@context.CreatedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    <MudText Typo="Typo.caption">@GetRelativeTime(context.CreatedAtUtc)</MudText>
                </MudTd>
                <MudTd DataLabel="Size">
                    @if (context.SizeBytes.HasValue)
                    {
                        <MudText Typo="Typo.body2">@FormatBytes(context.SizeBytes.Value)</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Notes">
                    @if (!string.IsNullOrEmpty(context.Notes))
                    {
                        <MudText Typo="Typo.body2">@context.Notes</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No notes</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.CompareArrows"
                                       Size="Size.Small"
                                       Color="Color.Info"
                                       OnClick="@(() => CompareSnapshot(context))"
                                       Title="Compare with current"
                                       Disabled="@(_snapshots.Count < 2)" />
                        <MudIconButton Icon="@Icons.Material.Filled.Restore"
                                       Size="Size.Small"
                                       Color="Color.Warning"
                                       OnClick="@(() => RestoreSnapshot(context))"
                                       Title="Restore this snapshot" />
                        <MudIconButton Icon="@Icons.Material.Filled.Info"
                                       Size="Size.Small"
                                       Color="Color.Default"
                                       OnClick="@(() => ViewSnapshotDetails(context))"
                                       Title="View details" />
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="py-4">
                    No snapshots yet. Create your first snapshot to preserve the current metadata state.
                </MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Version History", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private List<SnapshotDescriptor> _snapshots = new();
    private SnapshotDescriptor? _selectedSnapshot;

    protected override async Task OnInitializedAsync()
    {
        await LoadSnapshotsAsync();
    }

    private async Task LoadSnapshotsAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            _snapshots = await SnapshotApi.ListSnapshotsAsync();
            // Sort by created date descending (newest first)
            _snapshots = _snapshots.OrderByDescending(s => s.CreatedAtUtc).ToList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading snapshots: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenCreateSnapshotDialog()
    {
        var parameters = new DialogParameters
        {
            { "Title", "Create Metadata Snapshot" }
        };

        var dialog = await DialogService.ShowAsync<CreateSnapshotDialog>("Create Snapshot", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CreateSnapshotRequest request)
        {
            await CreateSnapshot(request);
        }
    }

    private async Task CreateSnapshot(CreateSnapshotRequest request)
    {
        try
        {
            var snapshot = await SnapshotApi.CreateSnapshotAsync(request);
            if (snapshot != null)
            {
                Snackbar.Add($"Snapshot '{snapshot.Label}' created successfully", Severity.Success);
                await LoadSnapshotsAsync();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating snapshot: {ex.Message}", Severity.Error);
        }
    }

    private async Task RestoreSnapshot(SnapshotDescriptor snapshot)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Restore",
            $"Are you sure you want to restore snapshot '{snapshot.Label}'? This will replace your current metadata configuration.",
            yesText: "Restore",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                _loading = true;
                StateHasChanged();

                var success = await SnapshotApi.RestoreSnapshotAsync(snapshot.Label);
                if (success)
                {
                    Snackbar.Add($"Snapshot '{snapshot.Label}' restored successfully. The page will reload.", Severity.Success);
                    // Reload page after 2 seconds to reflect restored state
                    await Task.Delay(2000);
                    Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
                }
            }
            catch (Exception ex)
            {
                _loading = false;
                Snackbar.Add($"Error restoring snapshot: {ex.Message}", Severity.Error);
            }
        }
    }

    private void CompareSnapshot(SnapshotDescriptor snapshot)
    {
        Navigation.NavigateTo($"/versions/compare/{Uri.EscapeDataString(snapshot.Label)}");
    }

    private async Task ViewSnapshotDetails(SnapshotDescriptor snapshot)
    {
        var parameters = new DialogParameters
        {
            { "Snapshot", snapshot }
        };

        await DialogService.ShowAsync<SnapshotDetailsDialog>("Snapshot Details", parameters, new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        });
    }

    private string FormatBytes(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string GetRelativeTime(DateTimeOffset time)
    {
        var span = DateTimeOffset.UtcNow - time.ToUniversalTime();

        if (span.TotalMinutes < 1)
            return "just now";
        if (span.TotalMinutes < 60)
            return $"{(int)span.TotalMinutes} minutes ago";
        if (span.TotalHours < 24)
            return $"{(int)span.TotalHours} hours ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays} days ago";
        if (span.TotalDays < 30)
            return $"{(int)(span.TotalDays / 7)} weeks ago";
        if (span.TotalDays < 365)
            return $"{(int)(span.TotalDays / 30)} months ago";

        return $"{(int)(span.TotalDays / 365)} years ago";
    }
}
