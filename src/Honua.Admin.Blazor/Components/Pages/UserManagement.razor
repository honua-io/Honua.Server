@page "/users"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator")]
@inject UserApiClient UserApi
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject ILogger<UserManagement> _logger

<PageTitle>User Management - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">User Management</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.PersonAdd"
                       OnClick="OpenCreateUserDialog">
                Create User
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Default"
                           OnClick="LoadUsersAsync"
                           Title="Refresh" />
        </MudStack>

        <MudAlert Severity="Severity.Info" Class="mb-4">
            Manage user accounts and role assignments. Users can be assigned Administrator, Data Publisher, or Viewer roles.
        </MudAlert>

        @* Statistics Cards *@
        @if (_statistics != null)
        {
            <MudGrid Class="mb-4">
                <MudItem xs="12" sm="6" md="3">
                    <MudCard>
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Total Users</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Info">@_statistics.TotalUsers</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard>
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Active</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Success">@_statistics.ActiveUsers</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard>
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Locked</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Warning">@_statistics.LockedUsers</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard>
                        <MudCardContent>
                            <MudText Typo="Typo.h6">Disabled</MudText>
                            <MudText Typo="Typo.h3" Color="Color.Error">@_statistics.DisabledUsers</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>
        }

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        @* Users Table *@
        <MudTable Items="@_users"
                  Hover="true"
                  Breakpoint="Breakpoint.Sm"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary"
                  Dense="false">
            <HeaderContent>
                <MudTh>Username</MudTh>
                <MudTh>Display Name</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Roles</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Last Login</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Username">
                    <MudStack Row="false" Spacing="1">
                        <MudText Typo="Typo.body1"><b>@context.Username</b></MudText>
                        <MudText Typo="Typo.caption" Class="text-monospace">@context.Id.Substring(0, Math.Min(12, context.Id.Length))</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Display Name">
                    <MudText Typo="Typo.body2">@(context.DisplayName ?? "-")</MudText>
                </MudTd>
                <MudTd DataLabel="Email">
                    <MudText Typo="Typo.body2">@(context.Email ?? "-")</MudText>
                </MudTd>
                <MudTd DataLabel="Roles">
                    @foreach (var role in context.Roles)
                    {
                        var roleInfo = RoleOptions.GetRoleInfo(role);
                        <MudChip T="string" Size="Size.Small" Color="@GetRoleColor(role)">
                            @(roleInfo?.DisplayName ?? role)
                        </MudChip>
                    }
                    @if (!context.Roles.Any())
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">No roles</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Status">
                    @if (context.IsLockedOut)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Lock">Locked</MudChip>
                    }
                    else if (!context.IsEnabled)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Block">Disabled</MudChip>
                    }
                    else
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Active</MudChip>
                    }
                    @if (context.FailedLoginAttempts > 0)
                    {
                        <MudText Typo="Typo.caption" Color="Color.Warning">@context.FailedLoginAttempts failed attempts</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Last Login">
                    @if (context.LastLogin.HasValue)
                    {
                        <MudText Typo="Typo.body2">@GetRelativeTime(context.LastLogin.Value)</MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Never</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => OpenEditUserDialog(context))">
                            Edit
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Security" OnClick="@(() => OpenRoleAssignmentDialog(context))">
                            Manage Roles
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Key" OnClick="@(() => OpenChangePasswordDialog(context))">
                            Change Password
                        </MudMenuItem>
                        <MudDivider />
                        @if (context.IsLockedOut)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.LockOpen" OnClick="@(() => UnlockUser(context))">
                                Unlock
                            </MudMenuItem>
                        }
                        @if (context.IsEnabled)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Block" OnClick="@(() => DisableUser(context))">
                                Disable
                            </MudMenuItem>
                        }
                        else
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.CheckCircle" OnClick="@(() => EnableUser(context))">
                                Enable
                            </MudMenuItem>
                        }
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteUser(context))">
                            <MudText Color="Color.Error">Delete</MudText>
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="py-4">
                    No users found. Create your first user to get started.
                </MudText>
            </NoRecordsContent>
        </MudTable>
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("User Management", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private List<UserResponse> _users = new();
    private UserStatistics? _statistics;

    protected override async Task OnInitializedAsync()
    {
        await LoadUsersAsync();
        await LoadStatisticsAsync();
    }

    private async Task LoadUsersAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var response = await UserApi.ListUsersAsync();
            _users = response?.Users ?? new List<UserResponse>();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading users: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadStatisticsAsync()
    {
        try
        {
            _statistics = await UserApi.GetStatisticsAsync();
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Error loading user statistics");
        }
    }

    private async Task OpenCreateUserDialog()
    {
        var dialog = await DialogService.ShowAsync<UserDialog>("Create User", new DialogParameters
        {
            { "IsEditMode", false }
        });
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CreateUserRequest request)
        {
            try
            {
                var user = await UserApi.CreateUserAsync(request);
                if (user != null)
                {
                    Snackbar.Add($"User '{user.Username}' created successfully", Severity.Success);
                    await LoadUsersAsync();
                    await LoadStatisticsAsync();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error creating user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenEditUserDialog(UserResponse user)
    {
        var dialog = await DialogService.ShowAsync<UserDialog>("Edit User", new DialogParameters
        {
            { "IsEditMode", true },
            { "User", user }
        });
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is UpdateUserRequest request)
        {
            try
            {
                var updated = await UserApi.UpdateUserAsync(user.Id, request);
                if (updated != null)
                {
                    Snackbar.Add($"User '{user.Username}' updated successfully", Severity.Success);
                    await LoadUsersAsync();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error updating user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenRoleAssignmentDialog(UserResponse user)
    {
        var dialog = await DialogService.ShowAsync<RoleAssignmentDialog>("Manage Roles", new DialogParameters
        {
            { "User", user }
        });
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is List<string> roles)
        {
            try
            {
                var updated = await UserApi.AssignRolesAsync(user.Id, new AssignRolesRequest { Roles = roles });
                if (updated != null)
                {
                    Snackbar.Add($"Roles updated for user '{user.Username}'", Severity.Success);
                    await LoadUsersAsync();
                    await LoadStatisticsAsync();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error assigning roles: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task OpenChangePasswordDialog(UserResponse user)
    {
        var dialog = await DialogService.ShowAsync<ChangePasswordDialog>("Change Password", new DialogParameters
        {
            { "Username", user.Username }
        });
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is ChangePasswordRequest request)
        {
            try
            {
                await UserApi.ChangePasswordAsync(user.Id, request);
                Snackbar.Add($"Password changed for user '{user.Username}'", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error changing password: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task EnableUser(UserResponse user)
    {
        try
        {
            await UserApi.EnableUserAsync(user.Id);
            Snackbar.Add($"User '{user.Username}' enabled", Severity.Success);
            await LoadUsersAsync();
            await LoadStatisticsAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error enabling user: {ex.Message}", Severity.Error);
        }
    }

    private async Task DisableUser(UserResponse user)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Disable",
            $"Are you sure you want to disable user '{user.Username}'? They will not be able to log in.",
            yesText: "Disable",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await UserApi.DisableUserAsync(user.Id);
                Snackbar.Add($"User '{user.Username}' disabled", Severity.Success);
                await LoadUsersAsync();
                await LoadStatisticsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error disabling user: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task UnlockUser(UserResponse user)
    {
        try
        {
            await UserApi.UnlockUserAsync(user.Id);
            Snackbar.Add($"User '{user.Username}' unlocked", Severity.Success);
            await LoadUsersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error unlocking user: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteUser(UserResponse user)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete user '{user.Username}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await UserApi.DeleteUserAsync(user.Id);
                Snackbar.Add($"User '{user.Username}' deleted", Severity.Success);
                await LoadUsersAsync();
                await LoadStatisticsAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting user: {ex.Message}", Severity.Error);
            }
        }
    }

    private Color GetRoleColor(string role)
    {
        return role.ToLowerInvariant() switch
        {
            "administrator" => Color.Error,
            "datapublisher" => Color.Warning,
            "viewer" => Color.Info,
            _ => Color.Default
        };
    }

    private string GetRelativeTime(DateTimeOffset time)
    {
        var span = DateTimeOffset.UtcNow - time.ToUniversalTime();

        if (span.TotalMinutes < 1)
            return "just now";
        if (span.TotalMinutes < 60)
            return $"{(int)span.TotalMinutes} minutes ago";
        if (span.TotalHours < 24)
            return $"{(int)span.TotalHours} hours ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays} days ago";
        if (span.TotalDays < 30)
            return $"{(int)(span.TotalDays / 7)} weeks ago";

        return $"{(int)(span.TotalDays / 30)} months ago";
    }
}
