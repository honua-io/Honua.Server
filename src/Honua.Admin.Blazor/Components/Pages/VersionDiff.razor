@page "/versions/compare/{SnapshotLabel}"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator")]
@inject SnapshotApiClient SnapshotApi
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Compare Versions - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                           OnClick="@(() => Navigation.NavigateTo("/versions"))"
                           Title="Back to versions" />
            <MudText Typo="Typo.h4">Compare Snapshot</MudText>
            <MudSpacer />
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        @if (_diff != null && _snapshotDetails != null)
        {
            <MudGrid>
                <MudItem xs="12">
                    <MudAlert Severity="Severity.Info" Class="mb-4">
                        Comparing snapshot <b>@_snapshotDetails.Snapshot.Label</b> (@_snapshotDetails.Snapshot.CreatedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm")) with <b>current metadata</b>.
                    </MudAlert>
                </MudItem>

                @if (!_diff.HasChanges())
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Success">
                            No changes detected. The snapshot matches the current metadata state.
                        </MudAlert>
                    </MudItem>
                }
                else
                {
                    <MudItem xs="12">
                        <MudAlert Severity="Severity.Warning">
                            Found <b>@_diff.TotalChanges()</b> changes between the snapshot and current state.
                        </MudAlert>
                    </MudItem>

                    @* Services Changes *@
                    @if (_diff.AddedServices.Any() || _diff.RemovedServices.Any() || _diff.ModifiedServices.Any())
                    {
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.h6" Class="mb-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small" /> Services
                                </MudText>

                                @if (_diff.AddedServices.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Success" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" /> Added (@_diff.AddedServices.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.AddedServices)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }

                                @if (_diff.RemovedServices.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Remove" Size="Size.Small" /> Removed (@_diff.RemovedServices.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.RemovedServices)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }

                                @if (_diff.ModifiedServices.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Warning" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" /> Modified (@_diff.ModifiedServices.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.ModifiedServices)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }
                            </MudPaper>
                        </MudItem>
                    }

                    @* Layers Changes *@
                    @if (_diff.AddedLayers.Any() || _diff.RemovedLayers.Any() || _diff.ModifiedLayers.Any())
                    {
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.h6" Class="mb-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Map" Size="Size.Small" /> Layers
                                </MudText>

                                @if (_diff.AddedLayers.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Success" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" /> Added (@_diff.AddedLayers.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.AddedLayers)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }

                                @if (_diff.RemovedLayers.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Remove" Size="Size.Small" /> Removed (@_diff.RemovedLayers.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.RemovedLayers)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }

                                @if (_diff.ModifiedLayers.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Warning" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Edit" Size="Size.Small" /> Modified (@_diff.ModifiedLayers.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.ModifiedLayers)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }
                            </MudPaper>
                        </MudItem>
                    }

                    @* Folders Changes *@
                    @if (_diff.AddedFolders.Any() || _diff.RemovedFolders.Any())
                    {
                        <MudItem xs="12" md="6">
                            <MudPaper Elevation="1" Class="pa-4">
                                <MudText Typo="Typo.h6" Class="mb-3">
                                    <MudIcon Icon="@Icons.Material.Filled.Folder" Size="Size.Small" /> Folders
                                </MudText>

                                @if (_diff.AddedFolders.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Success" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Add" Size="Size.Small" /> Added (@_diff.AddedFolders.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.AddedFolders)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }

                                @if (_diff.RemovedFolders.Any())
                                {
                                    <MudText Typo="Typo.subtitle2" Color="Color.Error" Class="mt-2">
                                        <MudIcon Icon="@Icons.Material.Filled.Remove" Size="Size.Small" /> Removed (@_diff.RemovedFolders.Count)
                                    </MudText>
                                    <MudList Dense="true">
                                        @foreach (var id in _diff.RemovedFolders)
                                        {
                                            <MudListItem>
                                                <MudText Typo="Typo.body2" Class="text-monospace">@id</MudText>
                                            </MudListItem>
                                        }
                                    </MudList>
                                }
                            </MudPaper>
                        </MudItem>
                    }
                }
            </MudGrid>
        }
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public string? SnapshotLabel { get; set; }

    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Version History", href: "/versions"),
        new BreadcrumbItem("Compare", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private SnapshotDetails? _snapshotDetails;
    private SnapshotDetails? _currentDetails;
    private MetadataDiffResult? _diff;

    protected override async Task OnInitializedAsync()
    {
        if (string.IsNullOrEmpty(SnapshotLabel))
        {
            _errorMessage = "Snapshot label is required";
            _loading = false;
            return;
        }

        await LoadComparisonAsync();
    }

    private async Task LoadComparisonAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            // Load snapshot details
            _snapshotDetails = await SnapshotApi.GetSnapshotAsync(SnapshotLabel!);
            if (_snapshotDetails == null)
            {
                _errorMessage = "Snapshot not found";
                return;
            }

            // Get current metadata from latest snapshot or live state
            // For now, compare with the most recent snapshot (could be enhanced to compare with live state)
            var snapshots = await SnapshotApi.ListSnapshotsAsync();
            var latestSnapshot = snapshots.OrderByDescending(s => s.CreatedAtUtc).FirstOrDefault();

            if (latestSnapshot != null && latestSnapshot.Label != SnapshotLabel)
            {
                _currentDetails = await SnapshotApi.GetSnapshotAsync(latestSnapshot.Label);

                if (_currentDetails != null)
                {
                    // Compute diff
                    _diff = SnapshotApi.ComputeDiff(_snapshotDetails.Metadata, _currentDetails.Metadata);
                }
            }
            else
            {
                _errorMessage = "Cannot compare - this is the only snapshot or the latest snapshot";
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading comparison: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
}
