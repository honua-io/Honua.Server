@page "/layers/{Id}"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize]
@inject LayerApiClient LayerApi
@inject ServiceApiClient ServiceApi
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Layer Details - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    @if (_loading)
    {
        <MudProgressLinear Indeterminate="true" Class="mt-4" />
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="mt-4">@_errorMessage</MudAlert>
    }

    @if (_layer != null)
    {
        <MudPaper Elevation="2" Class="pa-6 mt-4">
            <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
                <MudText Typo="Typo.h4">@_layer.Title</MudText>
                <MudSpacer />
                <MudButton Variant="Variant.Outlined"
                           Color="Color.Default"
                           StartIcon="@Icons.Material.Filled.ArrowBack"
                           Href="@($"/services/{_layer.ServiceId}/layers")">
                    Back to Layers
                </MudButton>
                <MudButton Variant="Variant.Filled"
                           Color="Color.Primary"
                           StartIcon="@Icons.Material.Filled.Edit"
                           Href="@($"/layers/{_layer.Id}/edit")">
                    Edit Layer
                </MudButton>
            </MudStack>

            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Layer ID</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3 text-monospace">@_layer.Id</MudText>

                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Service</MudText>
                    <MudLink Href="@($"/services/{_layer.ServiceId}")" Class="mb-3">
                        @(_serviceName ?? _layer.ServiceId)
                    </MudLink>

                    @if (!string.IsNullOrEmpty(_layer.Description))
                    {
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary" Class="mt-3">Description</MudText>
                        <MudText Typo="Typo.body1" Class="mb-3">@_layer.Description</MudText>
                    }
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Geometry Type</MudText>
                    <MudChip T="string" Size="Size.Small" Color="@GetGeometryTypeColor(_layer.GeometryType)" Class="mb-3">
                        @GeometryTypes.GetDisplayName(_layer.GeometryType)
                    </MudChip>

                    @if (_layer.CreatedAt.HasValue)
                    {
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Created</MudText>
                        <MudText Typo="Typo.body1" Class="mb-3">@_layer.CreatedAt.Value.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    }

                    @if (_layer.UpdatedAt.HasValue)
                    {
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Last Updated</MudText>
                        <MudText Typo="Typo.body1" Class="mb-3">@_layer.UpdatedAt.Value.ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    }
                </MudItem>
            </MudGrid>
        </MudPaper>

        <MudPaper Elevation="2" Class="pa-6 mt-4">
            <MudText Typo="Typo.h5" Class="mb-4">Schema Configuration</MudText>
            <MudGrid>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">ID Field</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3 text-monospace">@_layer.IdField</MudText>
                </MudItem>
                <MudItem xs="12" md="4">
                    <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Geometry Field</MudText>
                    <MudText Typo="Typo.body1" Class="mb-3 text-monospace">@_layer.GeometryField</MudText>
                </MudItem>
                @if (!string.IsNullOrEmpty(_layer.DisplayField))
                {
                    <MudItem xs="12" md="4">
                        <MudText Typo="Typo.subtitle2" Color="Color.Secondary">Display Field</MudText>
                        <MudText Typo="Typo.body1" Class="mb-3 text-monospace">@_layer.DisplayField</MudText>
                    </MudItem>
                }
            </MudGrid>
        </MudPaper>

        <MudPaper Elevation="2" Class="pa-6 mt-4">
            <MudText Typo="Typo.h5" Class="mb-4">Coordinate Reference Systems (CRS)</MudText>
            @if (_layer.Crs.Count > 0)
            {
                <MudStack Spacing="2">
                    @foreach (var crs in _layer.Crs)
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center">
                            <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                            <MudText Typo="Typo.body1" Class="text-monospace">@crs</MudText>
                            @{
                                var crsName = CommonCrs.WellKnownCrs.FirstOrDefault(c => c.Code == crs).Name;
                                if (!string.IsNullOrEmpty(crsName))
                                {
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">- @crsName</MudText>
                                }
                            }
                        </MudStack>
                    }
                </MudStack>
            }
            else
            {
                <MudText Color="Color.Secondary">No CRS configured</MudText>
            }
        </MudPaper>
    }
</MudContainer>

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private LayerResponse? _layer;
    private string? _serviceName;
    private bool _loading = true;
    private string? _errorMessage;
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadLayerAsync();
    }

    private async Task LoadLayerAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            _layer = await LayerApi.GetLayerByIdAsync(Id);
            if (_layer == null)
            {
                _errorMessage = $"Layer '{Id}' not found.";
            }
            else
            {
                // Load service name
                var service = await ServiceApi.GetServiceByIdAsync(_layer.ServiceId);
                _serviceName = service?.Title;

                UpdateBreadcrumbs();
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading layer: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void UpdateBreadcrumbs()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Layers", href: "/layers"),
            new BreadcrumbItem(_layer?.Title ?? Id, href: null, disabled: true)
        };
    }

    private Color GetGeometryTypeColor(string geometryType) => geometryType.ToUpperInvariant() switch
    {
        GeometryTypes.Point => Color.Primary,
        GeometryTypes.LineString => Color.Info,
        GeometryTypes.Polygon => Color.Success,
        GeometryTypes.MultiPoint => Color.Secondary,
        GeometryTypes.MultiLineString => Color.Tertiary,
        GeometryTypes.MultiPolygon => Color.Warning,
        _ => Color.Default
    };
}
