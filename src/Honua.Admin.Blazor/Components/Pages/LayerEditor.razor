@page "/layers/new"
@page "/layers/{Id}/edit"
@page "/services/{ServiceId}/layers/new"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@using Honua.Admin.Blazor.Shared.Components
@inherits AutoSaveFormBase<LayerEditor.LayerEditorModel>
@inject LayerApiClient LayerApi
@inject ServiceApiClient ServiceApi
@inject EditorState EditorState

<PageTitle>@(_isEditMode ? "Edit Layer" : "Create Layer") - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-6 mt-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">
                @(_isEditMode ? $"Edit Layer: {_model.Title}" : "Create New Layer")
            </MudText>
            @RenderDraftStatus()
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        @if (_validationErrors.Any())
        {
            <MudAlert Severity="Severity.Warning" Class="mb-4">
                <MudText Typo="Typo.body1"><b>Please fix @_validationErrors.Count error(s) before saving:</b></MudText>
                <MudList Dense="true" Class="mt-2">
                    @foreach (var error in _validationErrors)
                    {
                        <MudListItem Icon="@Icons.Material.Filled.Error" IconColor="Color.Warning">
                            <MudText Typo="Typo.body2">@error</MudText>
                        </MudListItem>
                    }
                </MudList>
            </MudAlert>
        }

        <MudForm @ref="_form" @bind-IsValid="@_formValid" ValidationDelay="0">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @ref="_layerIdField"
                                  @bind-Value="_model.Id"
                                  @bind-Value:after="OnModelChanged"
                                  Label="Layer ID"
                                  Required="true"
                                  Disabled="@_isEditMode"
                                  Immediate="true"
                                  HelperText="Unique identifier (alphanumeric, hyphens, underscores)"
                                  Validation="@(new Func<string, IEnumerable<string>>(ValidateLayerId))"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@GetValidationIcon(nameof(_model.Id))"
                                  AdornmentColor="@GetValidationColor(nameof(_model.Id))"
                                  OnBlur="@(() => OnFieldBlur(nameof(_model.Id)))" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_model.ServiceId"
                               @bind-Value:after="OnModelChanged"
                               Label="Service"
                               Required="true"
                               Disabled="@(_isEditMode || !string.IsNullOrEmpty(ServiceId))"
                               HelperText="Parent service for this layer">
                        @foreach (var service in _services)
                        {
                            <MudSelectItem Value="@service.Id">@service.Title</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @ref="_titleField"
                                  @bind-Value="_model.Title"
                                  @bind-Value:after="OnModelChanged"
                                  Label="Title"
                                  Required="true"
                                  Immediate="true"
                                  HelperText="Display name for the layer"
                                  Validation="@(new Func<string, IEnumerable<string>>(ValidateTitleField))"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@GetValidationIcon(nameof(_model.Title))"
                                  AdornmentColor="@GetValidationColor(nameof(_model.Title))"
                                  OnBlur="@(() => OnFieldBlur(nameof(_model.Title)))" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Description"
                                  @bind-Value:after="OnModelChanged"
                                  Label="Description"
                                  Lines="3"
                                  HelperText="Optional description of the layer" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_model.GeometryType"
                               Label="Geometry Type"
                               Required="true"
                               HelperText="Type of geometry stored in this layer">
                        @foreach (var (type, _) in GeometryTypes.AllTypes)
                        {
                            <MudSelectItem Value="@type">@GeometryTypes.GetDisplayName(type)</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @ref="_idField"
                                  @bind-Value="_model.IdField"
                                  Label="ID Field"
                                  Required="true"
                                  Immediate="true"
                                  HelperText="Feature ID column name"
                                  Validation="@(new Func<string, IEnumerable<string>>(ValidateIdField))"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@GetValidationIcon(nameof(_model.IdField))"
                                  AdornmentColor="@GetValidationColor(nameof(_model.IdField))"
                                  OnBlur="@(() => OnFieldBlur(nameof(_model.IdField)))" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @ref="_geometryField"
                                  @bind-Value="_model.GeometryField"
                                  Label="Geometry Field"
                                  Required="true"
                                  Immediate="true"
                                  HelperText="Geometry column name"
                                  Validation="@(new Func<string, IEnumerable<string>>(ValidateGeometryField))"
                                  Adornment="Adornment.End"
                                  AdornmentIcon="@GetValidationIcon(nameof(_model.GeometryField))"
                                  AdornmentColor="@GetValidationColor(nameof(_model.GeometryField))"
                                  OnBlur="@(() => OnFieldBlur(nameof(_model.GeometryField)))" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.DisplayField"
                                  Label="Display Field"
                                  HelperText="Optional field to use for feature labels" />
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">Coordinate Reference Systems (CRS)</MudText>
                    <MudDivider Class="mb-4" />
                </MudItem>

                <MudItem xs="12">
                    <MudSelect T="string"
                               Label="Add CRS"
                               Variant="Variant.Outlined"
                               AdornmentIcon="@Icons.Material.Filled.Add"
                               AdornmentColor="Color.Primary"
                               ValueChanged="@AddCrs">
                        <MudSelectItem T="string" Value="@string.Empty" Disabled="true">Select CRS to add</MudSelectItem>
                        @foreach (var (code, name) in CommonCrs.WellKnownCrs)
                        {
                            @if (!_model.Crs.Contains(code))
                            {
                                <MudSelectItem T="string" Value="@(code)">@(code) - @(name)</MudSelectItem>
                            }
                        }
                        <MudSelectItem T="string" Value="@("custom")">Custom CRS...</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    @if (_model.Crs.Count > 0)
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-2">Selected CRS:</MudText>
                        <MudStack Spacing="1">
                            @foreach (var crs in _model.Crs)
                            {
                                <MudChip T="string" Color="Color.Primary"
                                         OnClose="@(() => RemoveCrs(crs))"
                                         CloseIcon="@Icons.Material.Filled.Cancel">
                                    @crs
                                </MudChip>
                            }
                        </MudStack>
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Warning">At least one CRS is required</MudAlert>
                    }
                </MudItem>
            </MudGrid>
        </MudForm>

        <MudStack Row="true" Class="mt-6" Spacing="2">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="HandleSaveAsync"
                       Disabled="@(!_formValid || _saving || _model.Crs.Count == 0)">
                @if (_saving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                @(_isEditMode ? "Save Changes" : "Create Layer")
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       OnClick="HandleCancelAsync"
                       Disabled="@_saving">
                Cancel
            </MudButton>

            @if (_isEditMode)
            {
                <MudSpacer />
                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           OnClick="HandleDeleteAsync"
                           Disabled="@_saving">
                    Delete Layer
                </MudButton>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public string? Id { get; set; }

    [Parameter]
    public string? ServiceId { get; set; }

    private MudForm _form = default!;
    private MudTextField<string> _layerIdField = default!;
    private MudTextField<string> _titleField = default!;
    private MudTextField<string> _idField = default!;
    private MudTextField<string> _geometryField = default!;
    private bool _formValid;
    private bool _loading;
    private bool _saving;
    private bool _isEditMode => !string.IsNullOrEmpty(Id);
    private string? _errorMessage;
    private LayerEditorModel _model = new();
    private List<ServiceListItem> _services = new();
    private List<BreadcrumbItem> _breadcrumbs = new();

    // Validation tracking
    private Dictionary<string, bool> _fieldValidity = new();
    private Dictionary<string, bool> _fieldTouched = new();
    private List<string> _validationErrors = new();

    protected override async Task OnInitializedAsync()
    {
        // Call base to load drafts
        await base.OnInitializedAsync();

        await LoadServicesAsync();

        if (_isEditMode && !string.IsNullOrEmpty(Id))
        {
            await LoadLayerAsync();
        }
        else
        {
            // Set defaults for new layer if not loaded from draft
            if (string.IsNullOrEmpty(_model.GeometryType))
            {
                _model.GeometryType = GeometryTypes.Point;
            }
            if (string.IsNullOrEmpty(_model.IdField))
            {
                _model.IdField = "id";
            }
            if (string.IsNullOrEmpty(_model.GeometryField))
            {
                _model.GeometryField = "geom";
            }
            if (_model.Crs.Count == 0)
            {
                _model.Crs.Add("EPSG:4326");
            }

            // Pre-select service if provided in URL
            if (!string.IsNullOrEmpty(ServiceId) && string.IsNullOrEmpty(_model.ServiceId))
            {
                _model.ServiceId = ServiceId;
            }
        }

        UpdateBreadcrumbs();
    }

    private async Task LoadServicesAsync()
    {
        try
        {
            _services = await ServiceApi.GetServicesAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading services: {ex.Message}";
        }
    }

    private async Task LoadLayerAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var layer = await LayerApi.GetLayerByIdAsync(Id!);
            if (layer == null)
            {
                _errorMessage = $"Layer '{Id}' not found.";
                return;
            }

            _model = new LayerEditorModel
            {
                Id = layer.Id,
                ServiceId = layer.ServiceId,
                Title = layer.Title,
                Description = layer.Description ?? string.Empty,
                GeometryType = layer.GeometryType,
                IdField = layer.IdField,
                GeometryField = layer.GeometryField,
                DisplayField = layer.DisplayField ?? string.Empty,
                Crs = new List<string>(layer.Crs)
            };
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading layer: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private void AddCrs(string crsCode)
    {
        if (crsCode == "custom")
        {
            // TODO: Show dialog for custom CRS input
            Snackbar.Add("Custom CRS input not yet implemented", Severity.Info);
            return;
        }

        if (!string.IsNullOrEmpty(crsCode) && !_model.Crs.Contains(crsCode))
        {
            _model.Crs.Add(crsCode);
            EditorState.MarkDirty("layer-editor");
        }
    }

    private void RemoveCrs(string crsCode)
    {
        _model.Crs.Remove(crsCode);
        EditorState.MarkDirty("layer-editor");
    }

    private async Task HandleSaveAsync()
    {
        await _form.Validate();

        if (!_formValid || _model.Crs.Count == 0)
        {
            await FocusFirstInvalidField();
            Snackbar.Add("Please fix validation errors before saving.", Severity.Error);
            return;
        }

        _saving = true;
        _errorMessage = null;

        try
        {
            // Use auto-save base method which handles draft cleanup
            await SaveAsync();

            Snackbar.Add(_isEditMode ? "Layer updated successfully!" : "Layer created successfully!", Severity.Success);
            EditorState.MarkClean("layer-editor");
            NavigateToLayerList();
        }
        catch (HttpRequestException ex)
        {
            _errorMessage = $"Error saving layer: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task HandleCancelAsync()
    {
        if (EditorState.HasUnsavedChanges("layer-editor"))
        {
            var confirmed = await EditorState.ConfirmNavigationAsync(DialogService);
            if (!confirmed)
            {
                return;
            }
        }

        EditorState.MarkClean("layer-editor");
        NavigateToLayerList();
    }

    private async Task HandleDeleteAsync()
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the layer '{_model.Title}'?",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<Components.Shared.ConfirmDialog>("Delete Layer", parameters);
        var result = await dialog.Result;

        if (result.Canceled)
        {
            return;
        }

        _saving = true;

        try
        {
            await LayerApi.DeleteLayerAsync(Id!);
            Snackbar.Add("Layer deleted successfully.", Severity.Success);
            EditorState.MarkClean("layer-editor");
            NavigateToLayerList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error deleting layer: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void NavigateToLayerList()
    {
        if (!string.IsNullOrEmpty(_model.ServiceId))
        {
            Navigation.NavigateTo($"/services/{_model.ServiceId}/layers");
        }
        else
        {
            Navigation.NavigateTo("/layers");
        }
    }

    private void UpdateBreadcrumbs()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Layers", href: "/layers"),
            new BreadcrumbItem(_isEditMode ? $"Edit: {Id}" : "New Layer", href: null, disabled: true)
        };
    }

    private IEnumerable<string> ValidateLayerId(string id)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(id))
        {
            errors.Add("Layer ID is required");
            UpdateFieldValidity(nameof(_model.Id), false);
        }
        else if (!System.Text.RegularExpressions.Regex.IsMatch(id, "^[a-zA-Z0-9_-]+$"))
        {
            errors.Add("Layer ID must contain only alphanumeric characters, hyphens, and underscores");
            UpdateFieldValidity(nameof(_model.Id), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_model.Id), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private IEnumerable<string> ValidateTitleField(string value)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(value))
        {
            errors.Add("Title is required");
            UpdateFieldValidity(nameof(_model.Title), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_model.Title), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private IEnumerable<string> ValidateIdField(string value)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(value))
        {
            errors.Add("ID Field is required");
            UpdateFieldValidity(nameof(_model.IdField), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_model.IdField), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private IEnumerable<string> ValidateGeometryField(string value)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(value))
        {
            errors.Add("Geometry Field is required");
            UpdateFieldValidity(nameof(_model.GeometryField), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_model.GeometryField), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private void UpdateFieldValidity(string fieldName, bool isValid)
    {
        _fieldValidity[fieldName] = isValid;
    }

    private void OnFieldBlur(string fieldName)
    {
        _fieldTouched[fieldName] = true;
        StateHasChanged();
    }

    private string GetValidationIcon(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return string.Empty;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Icons.Material.Filled.CheckCircle
            : Icons.Material.Filled.Error;
    }

    private Color GetValidationColor(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return Color.Default;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Color.Success
            : Color.Error;
    }

    private void UpdateValidationSummary()
    {
        _validationErrors.Clear();

        if (_fieldTouched.GetValueOrDefault(nameof(_model.Id)) && !_fieldValidity.GetValueOrDefault(nameof(_model.Id)))
        {
            _validationErrors.Add("Layer ID: Invalid format or missing");
        }

        if (_fieldTouched.GetValueOrDefault(nameof(_model.Title)) && !_fieldValidity.GetValueOrDefault(nameof(_model.Title)))
        {
            _validationErrors.Add("Title: Required field is missing");
        }

        if (_fieldTouched.GetValueOrDefault(nameof(_model.IdField)) && !_fieldValidity.GetValueOrDefault(nameof(_model.IdField)))
        {
            _validationErrors.Add("ID Field: Required field is missing");
        }

        if (_fieldTouched.GetValueOrDefault(nameof(_model.GeometryField)) && !_fieldValidity.GetValueOrDefault(nameof(_model.GeometryField)))
        {
            _validationErrors.Add("Geometry Field: Required field is missing");
        }

        if (_model.Crs.Count == 0)
        {
            _validationErrors.Add("CRS: At least one coordinate reference system is required");
        }
    }

    private async Task FocusFirstInvalidField()
    {
        if (!_fieldValidity.GetValueOrDefault(nameof(_model.Id)) && _layerIdField != null)
        {
            await _layerIdField.FocusAsync();
        }
        else if (!_fieldValidity.GetValueOrDefault(nameof(_model.Title)) && _titleField != null)
        {
            await _titleField.FocusAsync();
        }
        else if (!_fieldValidity.GetValueOrDefault(nameof(_model.IdField)) && _idField != null)
        {
            await _idField.FocusAsync();
        }
        else if (!_fieldValidity.GetValueOrDefault(nameof(_model.GeometryField)) && _geometryField != null)
        {
            await _geometryField.FocusAsync();
        }
    }

    // Auto-save implementation
    protected override string GetDraftKey() => $"layer_{Id ?? "new"}";

    protected override async Task PerformSaveAsync()
    {
        if (_isEditMode)
        {
            var request = new UpdateLayerRequest
            {
                Title = _model.Title,
                Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description,
                GeometryType = _model.GeometryType,
                IdField = _model.IdField,
                GeometryField = _model.GeometryField,
                DisplayField = string.IsNullOrWhiteSpace(_model.DisplayField) ? null : _model.DisplayField,
                Crs = _model.Crs
            };

            await LayerApi.UpdateLayerAsync(Id!, request);
        }
        else
        {
            var request = new CreateLayerRequest
            {
                Id = _model.Id,
                ServiceId = _model.ServiceId,
                Title = _model.Title,
                Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description,
                GeometryType = _model.GeometryType,
                IdField = _model.IdField,
                GeometryField = _model.GeometryField,
                DisplayField = string.IsNullOrWhiteSpace(_model.DisplayField) ? null : _model.DisplayField,
                Crs = _model.Crs
            };

            await LayerApi.CreateLayerAsync(request);
        }
    }

    protected override bool ShouldLoadDraft() => !_isEditMode;

    // Local model for form binding (public for auto-save)
    public class LayerEditorModel
    {
        public string Id { get; set; } = string.Empty;
        public string ServiceId { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string GeometryType { get; set; } = GeometryTypes.Point;
        public string IdField { get; set; } = "id";
        public string GeometryField { get; set; } = "geom";
        public string DisplayField { get; set; } = string.Empty;
        public List<string> Crs { get; set; } = new();
    }
}
