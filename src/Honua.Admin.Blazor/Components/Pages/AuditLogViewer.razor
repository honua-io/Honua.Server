@page "/audit"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@using Microsoft.JSInterop
@attribute [Authorize(Roles = "administrator")]
@inject AuditLogApiClient AuditApi
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject IJSRuntime JS

<PageTitle>Audit Log - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">Audit Log</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Success"
                       StartIcon="@Icons.Material.Filled.FileDownload"
                       OnClick="ExportToCsv"
                       Disabled="@_loading">
                Export CSV
            </MudButton>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Info"
                       StartIcon="@Icons.Material.Filled.FileDownload"
                       OnClick="ExportToJson"
                       Disabled="@_loading">
                Export JSON
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Default"
                           OnClick="LoadEventsAsync"
                           Title="Refresh" />
        </MudStack>

        <MudAlert Severity="Severity.Info" Class="mb-4">
            View and search audit log events. All administrative actions, data modifications, and authentication events are logged for compliance and security monitoring.
        </MudAlert>

        @* Filter Panel *@
        <MudExpansionPanels Class="mb-4">
            <MudExpansionPanel Text="Advanced Filters">
                <MudGrid>
                    <MudItem xs="12" sm="6" md="4">
                        <MudTextField @bind-Value="_query.SearchText"
                                      Label="Search"
                                      Placeholder="Search description, user, IP..."
                                      Variant="Variant.Outlined"
                                      Adornment="Adornment.Start"
                                      AdornmentIcon="@Icons.Material.Filled.Search" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="string"
                                   @bind-Value="_selectedCategory"
                                   Label="Category"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var category in AuditFilterOptions.Categories)
                            {
                                <MudSelectItem Value="@category">@category</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="string"
                                   @bind-Value="_selectedAction"
                                   Label="Action"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var action in AuditFilterOptions.Actions)
                            {
                                <MudSelectItem Value="@action">@action</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="string"
                                   @bind-Value="_selectedResourceType"
                                   Label="Resource Type"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AnchorOrigin="Origin.BottomCenter">
                            @foreach (var type in AuditFilterOptions.ResourceTypes)
                            {
                                <MudSelectItem Value="@type">@type</MudSelectItem>
                            }
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudTextField @bind-Value="_query.UserIdentifier"
                                      Label="User"
                                      Placeholder="Username or email"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudSelect T="bool?"
                                   @bind-Value="_query.Success"
                                   Label="Status"
                                   Variant="Variant.Outlined"
                                   Clearable="true"
                                   AnchorOrigin="Origin.BottomCenter">
                            <MudSelectItem Value="@((bool?)true)">Success</MudSelectItem>
                            <MudSelectItem Value="@((bool?)false)">Failed</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker @bind-Date="_startDate"
                                       Label="Start Date"
                                       Variant="Variant.Outlined"
                                       Clearable="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudDatePicker @bind-Date="_endDate"
                                       Label="End Date"
                                       Variant="Variant.Outlined"
                                       Clearable="true" />
                    </MudItem>
                    <MudItem xs="12" sm="6" md="4">
                        <MudNumericField @bind-Value="_query.MinRiskScore"
                                         Label="Min Risk Score"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Max="100"
                                         Clearable="true" />
                    </MudItem>
                    <MudItem xs="12">
                        <MudStack Row="true" Spacing="2">
                            <MudButton Variant="Variant.Filled"
                                       Color="Color.Primary"
                                       OnClick="ApplyFilters"
                                       StartIcon="@Icons.Material.Filled.FilterAlt">
                                Apply Filters
                            </MudButton>
                            <MudButton Variant="Variant.Outlined"
                                       OnClick="ClearFilters"
                                       StartIcon="@Icons.Material.Filled.Clear">
                                Clear
                            </MudButton>
                        </MudStack>
                    </MudItem>
                </MudGrid>
            </MudExpansionPanel>
        </MudExpansionPanels>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        @* Audit Events Table *@
        <MudTable Items="@_events"
                  Hover="true"
                  Breakpoint="Breakpoint.Sm"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary"
                  Dense="true">
            <HeaderContent>
                <MudTh>Timestamp</MudTh>
                <MudTh>Category</MudTh>
                <MudTh>Action</MudTh>
                <MudTh>User</MudTh>
                <MudTh>Resource</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>IP Address</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Timestamp">
                    <MudText Typo="Typo.body2">@context.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</MudText>
                    <MudText Typo="Typo.caption">@GetRelativeTime(context.Timestamp)</MudText>
                </MudTd>
                <MudTd DataLabel="Category">
                    <MudChip T="string" Size="Size.Small" Color="GetCategoryColor(context.Category)">@context.Category</MudChip>
                </MudTd>
                <MudTd DataLabel="Action">
                    <MudText Typo="Typo.body2">@context.Action</MudText>
                </MudTd>
                <MudTd DataLabel="User">
                    <MudText Typo="Typo.body2">@(context.UserIdentifier ?? "System")</MudText>
                    @if (context.UserId.HasValue)
                    {
                        <MudText Typo="Typo.caption" Class="text-monospace">@context.UserId.Value.ToString().Substring(0, 8)...</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Resource">
                    @if (!string.IsNullOrEmpty(context.ResourceType))
                    {
                        <MudText Typo="Typo.body2">@context.ResourceType</MudText>
                        @if (!string.IsNullOrEmpty(context.ResourceId))
                        {
                            <MudText Typo="Typo.caption" Class="text-monospace">@context.ResourceId</MudText>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Status">
                    @if (context.Success)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                        <MudText Typo="Typo.body2" Color="Color.Success">Success</MudText>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" />
                        <MudText Typo="Typo.body2" Color="Color.Error">Failed</MudText>
                    }
                    @if (context.RiskScore.HasValue && context.RiskScore >= 80)
                    {
                        <MudChip T="string" Size="Size.Small" Color="Color.Warning">High Risk</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="IP Address">
                    <MudText Typo="Typo.body2" Class="text-monospace">@(context.IpAddress ?? "-")</MudText>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudIconButton Icon="@Icons.Material.Filled.Info"
                                   Size="Size.Small"
                                   Color="Color.Info"
                                   OnClick="@(() => ViewEventDetails(context))"
                                   Title="View details" />
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="py-4">
                    No audit events found. Try adjusting your filters.
                </MudText>
            </NoRecordsContent>
            <PagerContent>
                <MudTablePager PageSizeOptions="new int[] { 25, 50, 100, 200 }"
                               RowsPerPageString="Events per page"
                               InfoFormat="@($"{_result?.Page ?? 0} / {_result?.TotalPages ?? 0} pages ({_result?.TotalCount ?? 0} total events)")" />
            </PagerContent>
        </MudTable>

        @* Pagination Controls *@
        @if (_result != null && _result.TotalPages > 1)
        {
            <MudStack Row="true" Justify="Justify.Center" AlignItems="AlignItems.Center" Class="mt-4">
                <MudButton Variant="Variant.Outlined"
                           Disabled="@(!_result.HasPreviousPage)"
                           OnClick="PreviousPage"
                           StartIcon="@Icons.Material.Filled.NavigateBefore">
                    Previous
                </MudButton>
                <MudText Typo="Typo.body1">Page @_result.Page of @_result.TotalPages</MudText>
                <MudButton Variant="Variant.Outlined"
                           Disabled="@(!_result.HasNextPage)"
                           OnClick="NextPage"
                           EndIcon="@Icons.Material.Filled.NavigateNext">
                    Next
                </MudButton>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Audit Log", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private AuditLogQuery _query = new() { PageSize = 50 };
    private AuditLogResult? _result;
    private List<AuditEvent> _events = new();

    // Filter UI bindings
    private string? _selectedCategory;
    private string? _selectedAction;
    private string? _selectedResourceType;
    private DateTime? _startDate;
    private DateTime? _endDate;

    protected override async Task OnInitializedAsync()
    {
        await LoadEventsAsync();
    }

    private async Task LoadEventsAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            _result = await AuditApi.QueryAsync(_query);
            _events = _result?.Events ?? new List<AuditEvent>();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading audit log: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ApplyFilters()
    {
        _query.Category = _selectedCategory;
        _query.Action = _selectedAction;
        _query.ResourceType = _selectedResourceType;
        _query.StartTime = _startDate.HasValue ? new DateTimeOffset(_startDate.Value, TimeSpan.Zero) : null;
        _query.EndTime = _endDate.HasValue ? new DateTimeOffset(_endDate.Value.AddDays(1).AddSeconds(-1), TimeSpan.Zero) : null;
        _query.Page = 1; // Reset to first page

        await LoadEventsAsync();
    }

    private async Task ClearFilters()
    {
        _query = new AuditLogQuery { PageSize = _query.PageSize };
        _selectedCategory = null;
        _selectedAction = null;
        _selectedResourceType = null;
        _startDate = null;
        _endDate = null;

        await LoadEventsAsync();
    }

    private async Task NextPage()
    {
        if (_result?.HasNextPage == true)
        {
            _query.Page++;
            await LoadEventsAsync();
        }
    }

    private async Task PreviousPage()
    {
        if (_result?.HasPreviousPage == true)
        {
            _query.Page--;
            await LoadEventsAsync();
        }
    }

    private async Task ViewEventDetails(AuditEvent auditEvent)
    {
        var parameters = new DialogParameters
        {
            { "Event", auditEvent }
        };

        await DialogService.ShowAsync<AuditEventDetailsDialog>("Event Details", parameters, new DialogOptions
        {
            MaxWidth = MaxWidth.Large,
            FullWidth = true
        });
    }

    private async Task ExportToCsv()
    {
        try
        {
            _loading = true;
            StateHasChanged();

            var data = await AuditApi.ExportToCsvAsync(_query);
            if (data != null)
            {
                var fileName = $"audit_log_{DateTime.UtcNow:yyyyMMdd_HHmmss}.csv";
                await JS.InvokeVoidAsync("downloadFile", fileName, "text/csv", Convert.ToBase64String(data));
                Snackbar.Add("Audit log exported to CSV successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting to CSV: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task ExportToJson()
    {
        try
        {
            _loading = true;
            StateHasChanged();

            var data = await AuditApi.ExportToJsonAsync(_query);
            if (data != null)
            {
                var fileName = $"audit_log_{DateTime.UtcNow:yyyyMMdd_HHmmss}.json";
                await JS.InvokeVoidAsync("downloadFile", fileName, "application/json", Convert.ToBase64String(data));
                Snackbar.Add("Audit log exported to JSON successfully", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error exporting to JSON: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private Color GetCategoryColor(string category)
    {
        return category switch
        {
            "authentication" => Color.Primary,
            "authorization" => Color.Secondary,
            "data.modification" => Color.Warning,
            "admin.action" => Color.Error,
            "security.event" => Color.Error,
            _ => Color.Default
        };
    }

    private string GetRelativeTime(DateTimeOffset time)
    {
        var span = DateTimeOffset.UtcNow - time.ToUniversalTime();

        if (span.TotalMinutes < 1)
            return "just now";
        if (span.TotalMinutes < 60)
            return $"{(int)span.TotalMinutes} minutes ago";
        if (span.TotalHours < 24)
            return $"{(int)span.TotalHours} hours ago";
        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays} days ago";
        if (span.TotalDays < 30)
            return $"{(int)(span.TotalDays / 7)} weeks ago";
        if (span.TotalDays < 365)
            return $"{(int)(span.TotalDays / 30)} months ago";

        return $"{(int)(span.TotalDays / 365)} years ago";
    }
}
