@page "/services/new"
@page "/services/{Id}/edit"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@inject ServiceApiClient ServiceApi
@inject DataSourceApiClient DataSourceApi
@inject FolderApiClient FolderApi
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject EditorState EditorState

<PageTitle>@(_isEditMode ? "Edit Service" : "Create Service") - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-6 mt-4">
        <MudText Typo="Typo.h4" Class="mb-4">
            @(_isEditMode ? $"Edit Service: {_model.Title}" : "Create New Service")
        </MudText>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        <MudForm @ref="_form" @bind-IsValid="@_formValid">
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudTextField @bind-Value="_model.Id"
                                  Label="Service ID"
                                  Required="true"
                                  Disabled="@_isEditMode"
                                  HelperText="Unique identifier (alphanumeric, hyphens, underscores)"
                                  Validation="@(new Func<string, string>(ValidateServiceId))" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_model.ServiceType"
                               Label="Service Type"
                               Required="true"
                               Disabled="@_isEditMode"
                               HelperText="@(_isEditMode ? "Service type cannot be changed after creation" : "Type of OGC service")">
                        <MudSelectItem Value="@("WMS")">WMS (Web Map Service)</MudSelectItem>
                        <MudSelectItem Value="@("WFS")">WFS (Web Feature Service)</MudSelectItem>
                        <MudSelectItem Value="@("WMTS")">WMTS (Web Map Tile Service)</MudSelectItem>
                        <MudSelectItem Value="@("OGC_API")">OGC API Features</MudSelectItem>
                        <MudSelectItem Value="@("VECTOR_TILES")">Vector Tiles</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_model.DataSourceId"
                               Label="Data Source"
                               Required="@(!_isEditMode)"
                               Disabled="@_isEditMode"
                               HelperText="@(_isEditMode ? "Data source cannot be changed after creation" : "Database connection for this service")">
                        @if (_dataSources.Count == 0)
                        {
                            <MudSelectItem Value="@("")" Disabled="true">No data sources available - create one first</MudSelectItem>
                        }
                        else
                        {
                            @foreach (var ds in _dataSources)
                            {
                                <MudSelectItem Value="@ds.Id">
                                    @ds.Id (@ds.Provider)
                                </MudSelectItem>
                            }
                        }
                    </MudSelect>
                    @if (!_isEditMode && _dataSources.Count == 0)
                    {
                        <MudButton StartIcon="@Icons.Material.Filled.Add"
                                   Size="Size.Small"
                                   Variant="Variant.Text"
                                   Color="Color.Primary"
                                   Href="/datasources"
                                   Class="mt-2">
                            Create Data Source
                        </MudButton>
                    }
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudSelect @bind-Value="_model.FolderId"
                               Label="Folder"
                               Clearable="true"
                               HelperText="Optional folder to organize services">
                        <MudSelectItem Value="@((string?)null)">None</MudSelectItem>
                        @foreach (var folder in _folders)
                        {
                            <MudSelectItem Value="@folder.Id">@folder.Title</MudSelectItem>
                        }
                    </MudSelect>
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Title"
                                  Label="Title"
                                  Required="true"
                                  HelperText="Display name for the service"
                                  Validation="@(new Func<string, string>(ValidateRequired))" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="_model.Description"
                                  Label="Description"
                                  Lines="3"
                                  HelperText="Optional description of the service" />
                </MudItem>

                <MudItem xs="12">
                    <MudText Typo="Typo.h6" Class="mb-2">OGC Service Options</MudText>
                    <MudDivider Class="mb-4" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudCheckBox @bind-Checked="_model.OgcOptions.WmsEnabled"
                                 Label="Enable WMS"
                                 Color="Color.Primary" />
                    <MudCheckBox @bind-Checked="_model.OgcOptions.WfsEnabled"
                                 Label="Enable WFS"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudCheckBox @bind-Checked="_model.OgcOptions.WmtsEnabled"
                                 Label="Enable WMTS"
                                 Color="Color.Primary" />
                    <MudCheckBox @bind-Checked="_model.OgcOptions.OgcApiEnabled"
                                 Label="Enable OGC API Features"
                                 Color="Color.Primary" />
                </MudItem>

                <MudItem xs="12" md="6">
                    <MudNumericField @bind-Value="_model.OgcOptions.MaxFeatures"
                                     Label="Max Features"
                                     Min="1"
                                     Max="100000"
                                     HelperText="Maximum features to return in a single request" />
                </MudItem>
            </MudGrid>
        </MudForm>

        <MudStack Row="true" Class="mt-6" Spacing="2">
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       OnClick="HandleSaveAsync"
                       Disabled="@(!_formValid || _saving)">
                @if (_saving)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                }
                @(_isEditMode ? "Save Changes" : "Create Service")
            </MudButton>

            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       OnClick="HandleCancelAsync"
                       Disabled="@_saving">
                Cancel
            </MudButton>

            @if (_isEditMode)
            {
                <MudSpacer />
                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           OnClick="HandleDeleteAsync"
                           Disabled="@_saving">
                    Delete Service
                </MudButton>
            }
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    [Parameter]
    public string? Id { get; set; }

    private MudForm _form = default!;
    private bool _formValid;
    private bool _loading;
    private bool _saving;
    private bool _isEditMode => !string.IsNullOrEmpty(Id);
    private string? _errorMessage;
    private ServiceEditorModel _model = new();
    private List<DataSourceListItem> _dataSources = new();
    private List<FolderListItem> _folders = new();
    private List<BreadcrumbItem> _breadcrumbs = new();

    protected override async Task OnInitializedAsync()
    {
        UpdateBreadcrumbs();

        // Load data sources and folders in parallel
        await Task.WhenAll(
            LoadDataSourcesAsync(),
            LoadFoldersAsync()
        );

        if (_isEditMode && !string.IsNullOrEmpty(Id))
        {
            await LoadServiceAsync();
        }
        else
        {
            // Set defaults for new service
            _model.ServiceType = "WMS";
        }
    }

    private async Task LoadDataSourcesAsync()
    {
        try
        {
            _dataSources = await DataSourceApi.GetDataSourcesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data sources: {ex.Message}", Severity.Warning);
        }
    }

    private async Task LoadFoldersAsync()
    {
        try
        {
            _folders = await FolderApi.GetFoldersAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading folders: {ex.Message}", Severity.Warning);
        }
    }

    private void UpdateBreadcrumbs()
    {
        _breadcrumbs = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "/"),
            new BreadcrumbItem("Services", href: "/services"),
            new BreadcrumbItem(_isEditMode ? $"Edit: {Id}" : "New Service", href: null, disabled: true)
        };
    }

    private async Task LoadServiceAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            var service = await ServiceApi.GetServiceByIdAsync(Id!);
            if (service == null)
            {
                _errorMessage = $"Service '{Id}' not found.";
                return;
            }

            _model = new ServiceEditorModel
            {
                Id = service.Id,
                Title = service.Title,
                Description = service.Description ?? string.Empty,
                ServiceType = service.ServiceType,
                DataSourceId = service.DataSourceId,
                FolderId = service.FolderId,
                OgcOptions = service.OgcOptions ?? new ServiceOgcOptions()
            };
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading service: {ex.Message}";
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task HandleSaveAsync()
    {
        await _form.Validate();
        if (!_formValid)
        {
            Snackbar.Add("Please fix validation errors before saving.", Severity.Error);
            return;
        }

        _saving = true;
        _errorMessage = null;

        try
        {
            if (_isEditMode)
            {
                var request = new UpdateServiceRequest
                {
                    Title = _model.Title,
                    Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description,
                    FolderId = _model.FolderId ?? string.Empty,
                    OgcOptions = _model.OgcOptions
                };

                await ServiceApi.UpdateServiceAsync(Id!, request);
                Snackbar.Add("Service updated successfully!", Severity.Success);
                EditorState.MarkClean("service-editor");
                Navigation.NavigateTo("/services");
            }
            else
            {
                if (string.IsNullOrWhiteSpace(_model.DataSourceId))
                {
                    Snackbar.Add("Please select a data source", Severity.Error);
                    return;
                }

                var request = new CreateServiceRequest
                {
                    Id = _model.Id,
                    Title = _model.Title,
                    Description = string.IsNullOrWhiteSpace(_model.Description) ? null : _model.Description,
                    ServiceType = _model.ServiceType,
                    DataSourceId = _model.DataSourceId,
                    FolderId = string.IsNullOrWhiteSpace(_model.FolderId) ? null : _model.FolderId,
                    OgcOptions = _model.OgcOptions
                };

                await ServiceApi.CreateServiceAsync(request);
                Snackbar.Add("Service created successfully!", Severity.Success);
                EditorState.MarkClean("service-editor");
                Navigation.NavigateTo("/services");
            }
        }
        catch (HttpRequestException ex)
        {
            _errorMessage = $"Error saving service: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private async Task HandleCancelAsync()
    {
        if (EditorState.HasUnsavedChanges("service-editor"))
        {
            var confirmed = await EditorState.ConfirmNavigationAsync(DialogService);
            if (!confirmed)
            {
                return;
            }
        }

        EditorState.MarkClean("service-editor");
        Navigation.NavigateTo("/services");
    }

    private async Task HandleDeleteAsync()
    {
        var parameters = new DialogParameters
        {
            ["ContentText"] = $"Are you sure you want to delete the service '{_model.Title}'? This will also delete all associated layers.",
            ["ButtonText"] = "Delete",
            ["Color"] = Color.Error
        };

        var dialog = await DialogService.ShowAsync<ConfirmDialog>("Delete Service", parameters);
        var result = await dialog.Result;

        if (result.Canceled)
        {
            return;
        }

        _saving = true;

        try
        {
            await ServiceApi.DeleteServiceAsync(Id!);
            Snackbar.Add("Service deleted successfully.", Severity.Success);
            EditorState.MarkClean("service-editor");
            Navigation.NavigateTo("/services");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error deleting service: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private string ValidateServiceId(string id)
    {
        if (string.IsNullOrWhiteSpace(id))
            return "Service ID is required";

        if (!System.Text.RegularExpressions.Regex.IsMatch(id, "^[a-zA-Z0-9_-]+$"))
            return "Service ID must contain only alphanumeric characters, hyphens, and underscores";

        return string.Empty;
    }

    private string ValidateRequired(string value)
    {
        return string.IsNullOrWhiteSpace(value) ? "This field is required" : string.Empty;
    }

    private void OnModelChanged()
    {
        EditorState.MarkDirty("service-editor");
    }

    // Local model for form binding
    private class ServiceEditorModel
    {
        public string Id { get; set; } = string.Empty;
        public string Title { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string ServiceType { get; set; } = "WMS";
        public string? DataSourceId { get; set; }
        public string? FolderId { get; set; }
        public ServiceOgcOptions OgcOptions { get; set; } = new();
    }
}
