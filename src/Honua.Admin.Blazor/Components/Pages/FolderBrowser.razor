@page "/folders"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator")]
@inject FolderApiClient FolderApi
@inject ServiceApiClient ServiceApi
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Folders - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">Folder Organization</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.CreateNewFolder"
                       OnClick="@(() => OpenCreateFolderDialog())">
                Create Folder
            </MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        @if (!_loading && _folders.Any())
        {
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudText Typo="Typo.h6" Class="mb-4">Folder Tree</MudText>
                    <MudTreeView T="FolderTreeNode" Items="@_treeNodes" @bind-SelectedValue="_selectedNode">
                        <ItemTemplate Context="item">
                            <MudTreeViewItem @bind-Expanded="@item.IsExpanded" Value="@item" Items="@item.Children">
                                <Content>
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                        <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Primary" Size="Size.Small" />
                                        <MudText>@GetFolderDisplayName(item)</MudText>
                                        @if (item.ServiceCount > 0)
                                        {
                                            <MudChip Size="Size.Small" Color="Color.Info">@item.ServiceCount</MudChip>
                                        }
                                    </MudStack>
                                </Content>
                            </MudTreeViewItem>
                        </ItemTemplate>
                    </MudTreeView>
                </MudItem>

                <MudItem xs="12" md="6">
                    @if (_selectedNode != null)
                    {
                        <MudText Typo="Typo.h6" Class="mb-4">Folder Details</MudText>
                        <MudPaper Elevation="1" Class="pa-4">
                            <MudStack Spacing="3">
                                <MudTextField Label="Folder ID"
                                              Value="@_selectedNode.Id"
                                              ReadOnly="true"
                                              Variant="Variant.Filled" />
                                <MudTextField Label="Title"
                                              Value="@_selectedNode.Title"
                                              ReadOnly="true"
                                              Variant="Variant.Filled" />
                                <MudTextField Label="Services"
                                              Value="@_selectedNode.ServiceCount.ToString()"
                                              ReadOnly="true"
                                              Variant="Variant.Filled" />

                                <MudDivider />

                                <MudStack Row="true" Spacing="2">
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Edit"
                                               OnClick="@(() => OpenEditFolderDialog(_selectedNode))">
                                        Rename
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled"
                                               Color="Color.Error"
                                               StartIcon="@Icons.Material.Filled.Delete"
                                               OnClick="@(() => DeleteFolder(_selectedNode))">
                                        Delete
                                    </MudButton>
                                </MudStack>
                            </MudStack>
                        </MudPaper>

                        @if (_selectedNodeServices.Any())
                        {
                            <MudText Typo="Typo.h6" Class="mt-4 mb-2">Services in this Folder</MudText>
                            <MudList>
                                @foreach (var service in _selectedNodeServices)
                                {
                                    <MudListItem>
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Layers" Size="Size.Small" />
                                                <div>
                                                    <MudText Typo="Typo.body1">@service.Title</MudText>
                                                    <MudText Typo="Typo.body2" Class="text-monospace text-muted">@service.Id</MudText>
                                                </div>
                                            </MudStack>
                                            <MudChip Size="Size.Small" Color="@GetServiceTypeColor(service.ServiceType)">
                                                @service.ServiceType
                                            </MudChip>
                                        </MudStack>
                                    </MudListItem>
                                }
                            </MudList>
                        }
                    }
                    else
                    {
                        <MudAlert Severity="Severity.Info">Select a folder to view details</MudAlert>
                    }
                </MudItem>
            </MudGrid>
        }
        else if (!_loading)
        {
            <MudAlert Severity="Severity.Info" Class="mt-4">
                No folders yet. Click "Create Folder" to get started.
            </MudAlert>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Folders", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private List<FolderResponse> _folders = new();
    private List<FolderTreeNode> _treeNodes = new();
    private FolderTreeNode? _selectedNode;
    private List<ServiceListItem> _allServices = new();
    private List<ServiceListItem> _selectedNodeServices = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            // Load folders and services in parallel
            var foldersTask = FolderApi.GetFoldersAsync();
            var servicesTask = ServiceApi.GetServicesAsync();

            await Task.WhenAll(foldersTask, servicesTask);

            _folders = await foldersTask;
            _allServices = await servicesTask;

            // Build tree structure
            BuildFolderTree();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading folders: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void BuildFolderTree()
    {
        _treeNodes = _folders
            .OrderBy(f => f.Order ?? int.MaxValue)
            .ThenBy(f => f.Title ?? f.Id)
            .Select(f => new FolderTreeNode
            {
                Id = f.Id,
                Title = f.Title,
                ServiceCount = f.ServiceCount,
                IsExpanded = false
            })
            .ToList();

        // Select first node by default
        if (_treeNodes.Any())
        {
            _selectedNode = _treeNodes.First();
            UpdateSelectedNodeServices();
        }
    }

    private void UpdateSelectedNodeServices()
    {
        if (_selectedNode != null)
        {
            _selectedNodeServices = _allServices
                .Where(s => s.FolderId == _selectedNode.Id)
                .ToList();
        }
        else
        {
            _selectedNodeServices = new();
        }
    }

    private string GetFolderDisplayName(FolderTreeNode node)
    {
        return node.Title ?? node.Id;
    }

    private Color GetServiceTypeColor(string serviceType)
    {
        return serviceType.ToUpperInvariant() switch
        {
            "WMS" => Color.Primary,
            "WFS" => Color.Success,
            "WMTS" => Color.Info,
            "OGC" => Color.Warning,
            _ => Color.Default
        };
    }

    private async Task OpenCreateFolderDialog()
    {
        var parameters = new DialogParameters
        {
            { "Title", "Create New Folder" },
            { "IsCreate", true }
        };

        var dialog = await DialogService.ShowAsync<FolderDialog>("Create Folder", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is CreateFolderRequest request)
        {
            await CreateFolder(request);
        }
    }

    private async Task OpenEditFolderDialog(FolderTreeNode node)
    {
        var parameters = new DialogParameters
        {
            { "Title", "Rename Folder" },
            { "IsCreate", false },
            { "ExistingTitle", node.Title ?? node.Id }
        };

        var dialog = await DialogService.ShowAsync<FolderDialog>("Rename Folder", parameters);
        var result = await dialog.Result;

        if (!result.Canceled && result.Data is UpdateFolderRequest request)
        {
            await UpdateFolder(node.Id, request);
        }
    }

    private async Task CreateFolder(CreateFolderRequest request)
    {
        try
        {
            await FolderApi.CreateFolderAsync(request);
            Snackbar.Add($"Folder '{request.Title ?? request.Id}' created successfully", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating folder: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdateFolder(string id, UpdateFolderRequest request)
    {
        try
        {
            await FolderApi.UpdateFolderAsync(id, request);
            Snackbar.Add("Folder renamed successfully", Severity.Success);
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error updating folder: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteFolder(FolderTreeNode node)
    {
        if (node.ServiceCount > 0)
        {
            Snackbar.Add("Cannot delete folder with services. Move or delete services first.", Severity.Warning);
            return;
        }

        var confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete folder '{node.Title ?? node.Id}'?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await FolderApi.DeleteFolderAsync(node.Id);
                Snackbar.Add("Folder deleted successfully", Severity.Success);
                _selectedNode = null;
                await LoadDataAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting folder: {ex.Message}", Severity.Error);
            }
        }
    }
}
