@using Honua.MapSDK.Models

<div class="style-panel">
    @if (VectorLayer != null)
    {
        <MudStack Spacing="2">
            <!-- Symbol/Icon Image -->
            <MudTextField @bind-Value="@IconImage"
                         Label="Icon Name"
                         Variant="Variant.Outlined"
                         Margin="Margin.Dense"
                         Placeholder="marker-15"
                         HelperText="Name of icon from sprite sheet" />

            <!-- Icon Size -->
            <div class="property-group">
                <MudText Typo="Typo.caption" Class="property-label">
                    Icon Size: @IconSize
                </MudText>
                <MudSlider @bind-Value="@IconSize"
                          Min="0.1"
                          Max="3"
                          Step="0.1"
                          Variant="Variant.Filled"
                          Color="Color.Primary">
                    @IconSize
                </MudSlider>
            </div>

            <!-- Icon Color (for SDF icons) -->
            <MudSwitch @bind-Value="@UseIconColor"
                      Label="Color Icon (SDF)"
                      Color="Color.Primary"
                      Class="mb-2" />

            @if (UseIconColor)
            {
                <div class="property-group">
                    <MudText Typo="Typo.caption" Class="property-label">Icon Color</MudText>
                    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                        <input type="color"
                               value="@IconColor"
                               @oninput="OnIconColorChanged"
                               class="color-picker" />
                        <MudTextField @bind-Value="@IconColor"
                                     Variant="Variant.Outlined"
                                     Margin="Margin.Dense"
                                     Placeholder="#000000"
                                     Class="flex-1" />
                    </MudStack>
                </div>
            }

            <!-- Icon Opacity -->
            <div class="property-group">
                <MudText Typo="Typo.caption" Class="property-label">
                    Icon Opacity: @IconOpacity.ToString("P0")
                </MudText>
                <MudSlider @bind-Value="@IconOpacity"
                          Min="0"
                          Max="1"
                          Step="0.05"
                          Variant="Variant.Filled"
                          Color="Color.Primary">
                    @IconOpacity.ToString("P0")
                </MudSlider>
            </div>

            <!-- Icon Rotation -->
            <div class="property-group">
                <MudText Typo="Typo.caption" Class="property-label">
                    Icon Rotation: @IconRotation°
                </MudText>
                <MudSlider @bind-Value="@IconRotation"
                          Min="0"
                          Max="360"
                          Step="15"
                          Variant="Variant.Filled"
                          Color="Color.Primary">
                    @IconRotation°
                </MudSlider>
            </div>

            <!-- Icon Anchor -->
            <MudSelect @bind-Value="@IconAnchor"
                      Label="Icon Anchor"
                      Variant="Variant.Outlined"
                      Margin="Margin.Dense">
                <MudSelectItem Value="@("center")">Center</MudSelectItem>
                <MudSelectItem Value="@("left")">Left</MudSelectItem>
                <MudSelectItem Value="@("right")">Right</MudSelectItem>
                <MudSelectItem Value="@("top")">Top</MudSelectItem>
                <MudSelectItem Value="@("bottom")">Bottom</MudSelectItem>
                <MudSelectItem Value="@("top-left")">Top Left</MudSelectItem>
                <MudSelectItem Value="@("top-right")">Top Right</MudSelectItem>
                <MudSelectItem Value="@("bottom-left")">Bottom Left</MudSelectItem>
                <MudSelectItem Value="@("bottom-right")">Bottom Right</MudSelectItem>
            </MudSelect>

            <!-- Advanced Options -->
            <MudExpansionPanels Elevation="0" Class="mt-2">
                <MudExpansionPanel Text="Advanced">
                    <MudSwitch @bind-Value="@AllowOverlap"
                              Label="Allow Overlap"
                              Color="Color.Primary" />

                    <MudSwitch @bind-Value="@IgnorePlacement"
                              Label="Ignore Placement"
                              Color="Color.Primary"
                              Class="mt-2" />

                    <MudTextField @bind-Value="@IconOffsetX"
                                 Label="Offset X"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Class="mt-2" />

                    <MudTextField @bind-Value="@IconOffsetY"
                                 Label="Offset Y"
                                 Variant="Variant.Outlined"
                                 Margin="Margin.Dense"
                                 Class="mt-2" />

                    <MudNumericField @bind-Value="@IconHaloWidth"
                                    Label="Icon Halo Width"
                                    Variant="Variant.Outlined"
                                    Margin="Margin.Dense"
                                    Min="0"
                                    Max="5"
                                    Step="0.5"
                                    Class="mt-2" />

                    <div class="property-group mt-2">
                        <MudText Typo="Typo.caption" Class="property-label">Icon Halo Color</MudText>
                        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                            <input type="color"
                                   value="@IconHaloColor"
                                   @oninput="OnIconHaloColorChanged"
                                   class="color-picker" />
                            <MudTextField @bind-Value="@IconHaloColor"
                                         Variant="Variant.Outlined"
                                         Margin="Margin.Dense"
                                         Placeholder="#ffffff"
                                         Class="flex-1" />
                        </MudStack>
                    </div>
                </MudExpansionPanel>
            </MudExpansionPanels>
        </MudStack>
    }
</div>

@code {
    [Parameter]
    public LayerDefinition? Layer { get; set; }

    [Parameter]
    public EventCallback OnStyleChanged { get; set; }

    private VectorLayer? VectorLayer => Layer as VectorLayer;

    private string _iconImage = "marker-15";
    private string IconImage
    {
        get => _iconImage;
        set
        {
            _iconImage = value;
            UpdateLayout("icon-image", value);
        }
    }

    private double _iconSize = 1.0;
    private double IconSize
    {
        get => _iconSize;
        set
        {
            _iconSize = value;
            UpdateLayout("icon-size", value);
        }
    }

    private bool _useIconColor = false;
    private bool UseIconColor
    {
        get => _useIconColor;
        set
        {
            _useIconColor = value;
            if (value)
            {
                UpdatePaint("icon-color", IconColor);
            }
            else
            {
                RemovePaintProperty("icon-color");
            }
        }
    }

    private string _iconColor = "#000000";
    private string IconColor
    {
        get => _iconColor;
        set
        {
            _iconColor = value;
            if (UseIconColor)
            {
                UpdatePaint("icon-color", value);
            }
        }
    }

    private double _iconOpacity = 1.0;
    private double IconOpacity
    {
        get => _iconOpacity;
        set
        {
            _iconOpacity = value;
            UpdatePaint("icon-opacity", value);
        }
    }

    private double _iconRotation = 0;
    private double IconRotation
    {
        get => _iconRotation;
        set
        {
            _iconRotation = value;
            UpdateLayout("icon-rotate", value);
        }
    }

    private string _iconAnchor = "center";
    private string IconAnchor
    {
        get => _iconAnchor;
        set
        {
            _iconAnchor = value;
            UpdateLayout("icon-anchor", value);
        }
    }

    private bool AllowOverlap { get; set; } = false;
    private bool IgnorePlacement { get; set; } = false;
    private string IconOffsetX { get; set; } = "0";
    private string IconOffsetY { get; set; } = "0";
    private double IconHaloWidth { get; set; } = 0;
    private string IconHaloColor { get; set; } = "#ffffff";

    protected override void OnParametersSet()
    {
        if (VectorLayer != null)
        {
            LoadCurrentValues();
        }
    }

    private void LoadCurrentValues()
    {
        if (VectorLayer == null) return;

        if (VectorLayer.Layout?.TryGetValue("icon-image", out var image) == true)
        {
            _iconImage = image?.ToString() ?? "marker-15";
        }

        if (VectorLayer.Layout?.TryGetValue("icon-size", out var size) == true)
        {
            _iconSize = Convert.ToDouble(size);
        }

        if (VectorLayer.Paint?.TryGetValue("icon-color", out var color) == true)
        {
            _useIconColor = true;
            _iconColor = color?.ToString() ?? "#000000";
        }

        if (VectorLayer.Paint?.TryGetValue("icon-opacity", out var opacity) == true)
        {
            _iconOpacity = Convert.ToDouble(opacity);
        }

        if (VectorLayer.Layout?.TryGetValue("icon-rotate", out var rotation) == true)
        {
            _iconRotation = Convert.ToDouble(rotation);
        }

        if (VectorLayer.Layout?.TryGetValue("icon-anchor", out var anchor) == true)
        {
            _iconAnchor = anchor?.ToString() ?? "center";
        }
    }

    private void OnIconColorChanged(ChangeEventArgs e)
    {
        IconColor = e.Value?.ToString() ?? "#000000";
    }

    private void OnIconHaloColorChanged(ChangeEventArgs e)
    {
        IconHaloColor = e.Value?.ToString() ?? "#ffffff";
    }

    private void UpdatePaint(string property, object value)
    {
        if (VectorLayer?.Paint == null) return;

        VectorLayer.Paint[property] = value;
        VectorLayer.UpdatedAt = DateTime.UtcNow;
        OnStyleChanged.InvokeAsync();
    }

    private void UpdateLayout(string property, object value)
    {
        if (VectorLayer == null) return;

        VectorLayer.Layout ??= new Dictionary<string, object>();
        VectorLayer.Layout[property] = value;
        VectorLayer.UpdatedAt = DateTime.UtcNow;
        OnStyleChanged.InvokeAsync();
    }

    private void RemovePaintProperty(string property)
    {
        if (VectorLayer?.Paint == null) return;

        VectorLayer.Paint.Remove(property);
        VectorLayer.UpdatedAt = DateTime.UtcNow;
        OnStyleChanged.InvokeAsync();
    }
}
