@page "/services"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@inject ServiceApiClient ServiceApi
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject NavigationState NavState
@inject ILogger<ServiceList> Logger

<PageTitle>Services - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">Services</MudText>
            <MudSpacer />
            <MudTextField @bind-Value="_searchText"
                          Placeholder="Search services..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Immediate="true"
                          Style="max-width: 400px" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       Href="/services/new">
                Create Service
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Default"
                           OnClick="LoadServicesAsync"
                           Title="Refresh" />
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        @if (!_services.Any())
        {
            <MudAlert Severity="Severity.Info">
                No services found. Create your first service to get started!
            </MudAlert>
        }
        else
        {
            <MudTable Items="@_filteredServices"
                      Hover="true"
                      Breakpoint="Breakpoint.Sm"
                      Dense="false">
                <HeaderContent>
                    <MudTh>Name</MudTh>
                    <MudTh>Type</MudTh>
                    <MudTh>Folder</MudTh>
                    <MudTh>Layers</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh>Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="Name">
                        <MudLink Href="@($"/services/{context.Id}")">
                            <b>@context.Title</b>
                        </MudLink>
                    </MudTd>
                    <MudTd DataLabel="Type">
                        <MudChip T="string" Size="Size.Small" Color="Color.Primary">@context.ServiceType</MudChip>
                    </MudTd>
                    <MudTd DataLabel="Folder">@(context.FolderId ?? "Root")</MudTd>
                    <MudTd DataLabel="Layers">@context.LayerCount</MudTd>
                    <MudTd DataLabel="Status">
                        @if (context.Enabled)
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">Running</MudChip>
                        }
                        else
                        {
                            <MudChip T="string" Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Cancel">Stopped</MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions">
                        <MudStack Row="true" Spacing="1">
                            @if (context.Enabled)
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.Stop"
                                               Size="Size.Small"
                                               Color="Color.Error"
                                               Title="Stop Service"
                                               OnClick="@(() => StopService(context))" />
                            }
                            else
                            {
                                <MudIconButton Icon="@Icons.Material.Filled.PlayArrow"
                                               Size="Size.Small"
                                               Color="Color.Success"
                                               Title="Start Service"
                                               OnClick="@(() => StartService(context))" />
                            }
                            <MudIconButton Icon="@Icons.Material.Filled.Edit"
                                           Size="Size.Small"
                                           Title="Edit"
                                           Href="@($"/services/{context.Id}/edit")" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           Title="Delete"
                                           OnClick="@(() => DeleteService(context))" />
                        </MudStack>
                    </MudTd>
                </RowTemplate>
                <NoRecordsContent>
                    <MudText Align="Align.Center" Class="py-4">
                        No services found matching your search.
                    </MudText>
                </NoRecordsContent>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Services", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private string _searchText = string.Empty;
    private List<ServiceListItem> _services = new();

    private IEnumerable<ServiceListItem> _filteredServices =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _services
            : _services.Where(s => s.Title.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                                    s.ServiceType.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        NavState.SetBreadcrumbs(_breadcrumbs.ToArray());
        await LoadServicesAsync();
    }

    private async Task LoadServicesAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            _services = await ServiceApi.GetServicesAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load services: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
            Logger.LogError(ex, "Error loading services");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task StartService(ServiceListItem service)
    {
        try
        {
            await ServiceApi.EnableServiceAsync(service.Id);
            Snackbar.Add($"Service '{service.Title}' started successfully", Severity.Success);
            await LoadServicesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Failed to start service: {ex.Message}", Severity.Error);
            Logger.LogError(ex, "Error starting service {ServiceId}", service.Id);
        }
    }

    private async Task StopService(ServiceListItem service)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Stop Service",
            $"Are you sure you want to stop service '{service.Title}'? It will no longer be accessible.",
            yesText: "Stop",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ServiceApi.DisableServiceAsync(service.Id);
                Snackbar.Add($"Service '{service.Title}' stopped successfully", Severity.Success);
                await LoadServicesAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to stop service: {ex.Message}", Severity.Error);
                Logger.LogError(ex, "Error stopping service {ServiceId}", service.Id);
            }
        }
    }

    private async Task DeleteService(ServiceListItem service)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            $"Are you sure you want to delete service '{service.Title}'? This action cannot be undone.",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                await ServiceApi.DeleteServiceAsync(service.Id);
                Snackbar.Add($"Service '{service.Title}' deleted successfully", Severity.Success);
                await LoadServicesAsync();
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Failed to delete service: {ex.Message}", Severity.Error);
                Logger.LogError(ex, "Error deleting service {ServiceId}", service.Id);
            }
        }
    }
}
