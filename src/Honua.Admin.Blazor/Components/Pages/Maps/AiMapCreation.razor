@page "/maps/ai-create"
@using Honua.MapSDK.Models
@using System.Text.Json
@using System.Net.Http.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>AI Map Creation</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                <MudIconButton Icon="@Icons.Material.Filled.ArrowBack"
                              OnClick="@(() => Navigation.NavigateTo("/maps"))" />
                <MudIcon Icon="@Icons.Material.Filled.AutoAwesome" Color="Color.Primary" Size="Size.Large" />
                <MudText Typo="Typo.h4">AI Map Creation</MudText>
            </MudStack>
        </MudStack>
        <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-2">
            Describe the map you want to create in natural language, and AI will generate it for you.
        </MudText>
    </MudPaper>

    @if (!_serviceAvailable.HasValue)
    {
        <MudPaper Class="pa-4 mb-4">
            <MudProgressLinear Indeterminate="true" Color="Color.Primary" />
            <MudText Align="Align.Center" Class="mt-2">Checking AI service availability...</MudText>
        </MudPaper>
    }
    else if (!_serviceAvailable.Value)
    {
        <MudAlert Severity="Severity.Warning" Class="mb-4">
            AI map generation service is not currently available. Please check your configuration or contact your administrator.
        </MudAlert>
    }
    else
    {
        <MudGrid>
            <!-- Prompt Input Section -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Style="height: 100%;">
                    <MudStack Spacing="3">
                        <MudText Typo="Typo.h6">Describe Your Map</MudText>

                        <MudTextField @bind-Value="_prompt"
                                     Label="Map Description"
                                     Lines="6"
                                     Variant="Variant.Outlined"
                                     Placeholder="E.g., Show me all schools within 2 miles of industrial zones"
                                     Disabled="@_isGenerating"
                                     Required="true"
                                     HelperText="Describe what you want to see on the map" />

                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.AutoAwesome"
                                  OnClick="GenerateMap"
                                  Disabled="@(_isGenerating || string.IsNullOrWhiteSpace(_prompt))"
                                  FullWidth="true"
                                  Size="Size.Large">
                            @if (_isGenerating)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                                <span>Generating...</span>
                            }
                            else
                            {
                                <span>Generate Map</span>
                            }
                        </MudButton>

                        @if (_generatedMap != null)
                        {
                            <MudDivider />

                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Outlined"
                                          StartIcon="@Icons.Material.Filled.Edit"
                                          OnClick="EditGeneratedMap"
                                          FullWidth="true">
                                    Edit Map
                                </MudButton>
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Success"
                                          StartIcon="@Icons.Material.Filled.Save"
                                          OnClick="SaveGeneratedMap"
                                          FullWidth="true">
                                    Save Map
                                </MudButton>
                            </MudStack>
                        }

                        <!-- Example Prompts -->
                        <MudExpansionPanels>
                            <MudExpansionPanel Text="Example Prompts" IsInitiallyExpanded="@(_examplePrompts.Any())">
                                <MudList Clickable="true" Dense="true">
                                    @foreach (var example in _examplePrompts)
                                    {
                                        <MudListItem Icon="@Icons.Material.Filled.Lightbulb"
                                                    OnClick="@(() => UseExamplePrompt(example))">
                                            <MudText Typo="Typo.body2">@example</MudText>
                                        </MudListItem>
                                    }
                                </MudList>
                            </MudExpansionPanel>
                        </MudExpansionPanels>
                    </MudStack>
                </MudPaper>
            </MudItem>

            <!-- Results Section -->
            <MudItem xs="12" md="6">
                <MudPaper Class="pa-4" Style="height: 100%;">
                    @if (_generatedMap == null && !_isGenerating)
                    {
                        <MudStack Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 100%; min-height: 400px;">
                            <MudIcon Icon="@Icons.Material.Filled.Map" Size="Size.Large" Color="Color.Secondary" />
                            <MudText Typo="Typo.h6" Color="Color.Secondary">
                                Your generated map will appear here
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                                Enter a description and click "Generate Map" to create an interactive map using AI
                            </MudText>
                        </MudStack>
                    }
                    else if (_isGenerating)
                    {
                        <MudStack Spacing="3" AlignItems="AlignItems.Center" Justify="Justify.Center" Style="height: 100%; min-height: 400px;">
                            <MudProgressCircular Size="Size.Large" Indeterminate="true" Color="Color.Primary" />
                            <MudText Typo="Typo.h6">Generating your map...</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Align="Align.Center">
                                AI is analyzing your request and creating the map configuration
                            </MudText>
                        </MudStack>
                    }
                    else if (_generatedMap != null)
                    {
                        <MudStack Spacing="3">
                            <MudText Typo="Typo.h6">Generated Map</MudText>

                            <MudCard>
                                <MudCardHeader>
                                    <CardHeaderContent>
                                        <MudText Typo="Typo.h6">@_generatedMap.Name</MudText>
                                        <MudText Typo="Typo.body2" Color="Color.Secondary">@_generatedMap.Description</MudText>
                                    </CardHeaderContent>
                                    <CardHeaderActions>
                                        <MudChip Size="Size.Small" Color="Color.Success">
                                            @($"{_confidence:P0}") Confidence
                                        </MudChip>
                                    </CardHeaderActions>
                                </MudCardHeader>
                                <MudCardContent>
                                    @if (!string.IsNullOrWhiteSpace(_explanation))
                                    {
                                        <MudAlert Severity="Severity.Info" Dense="true" Class="mb-3">
                                            <MudText Typo="Typo.body2">@_explanation</MudText>
                                        </MudAlert>
                                    }

                                    <MudText Typo="Typo.subtitle2" Class="mb-2">Map Details:</MudText>
                                    <MudList Dense="true">
                                        <MudListItem Icon="@Icons.Material.Filled.Layers">
                                            <MudText Typo="Typo.body2">@_generatedMap.Layers.Count layer(s)</MudText>
                                        </MudListItem>
                                        <MudListItem Icon="@Icons.Material.Filled.Tune">
                                            <MudText Typo="Typo.body2">@_generatedMap.Controls.Count control(s)</MudText>
                                        </MudListItem>
                                        <MudListItem Icon="@Icons.Material.Filled.ZoomIn">
                                            <MudText Typo="Typo.body2">Zoom: @_generatedMap.Settings.Zoom</MudText>
                                        </MudListItem>
                                        <MudListItem Icon="@Icons.Material.Filled.LocationOn">
                                            <MudText Typo="Typo.body2">
                                                Center: [@_generatedMap.Settings.Center[0].ToString("F4"), @_generatedMap.Settings.Center[1].ToString("F4")]
                                            </MudText>
                                        </MudListItem>
                                    </MudList>

                                    @if (_spatialOperations.Any())
                                    {
                                        <MudDivider Class="my-3" />
                                        <MudText Typo="Typo.subtitle2" Class="mb-2">Spatial Operations:</MudText>
                                        <MudList Dense="true">
                                            @foreach (var operation in _spatialOperations)
                                            {
                                                <MudListItem Icon="@Icons.Material.Filled.Analytics">
                                                    <MudText Typo="Typo.body2">@operation</MudText>
                                                </MudListItem>
                                            }
                                        </MudList>
                                    }

                                    @if (_warnings.Any())
                                    {
                                        <MudDivider Class="my-3" />
                                        <MudAlert Severity="Severity.Warning" Dense="true">
                                            <MudText Typo="Typo.subtitle2">Warnings:</MudText>
                                            @foreach (var warning in _warnings)
                                            {
                                                <MudText Typo="Typo.body2">â€¢ @warning</MudText>
                                            }
                                        </MudAlert>
                                    }
                                </MudCardContent>
                            </MudCard>

                            <!-- Layer Details -->
                            <MudExpansionPanels>
                                <MudExpansionPanel Text="Layer Details">
                                    <MudSimpleTable Dense="true" Hover="true">
                                        <thead>
                                            <tr>
                                                <th>Name</th>
                                                <th>Type</th>
                                                <th>Source</th>
                                                <th>Visible</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var layer in _generatedMap.Layers)
                                            {
                                                <tr>
                                                    <td>@layer.Name</td>
                                                    <td>@layer.Type</td>
                                                    <td>
                                                        <MudText Typo="Typo.body2" Style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                                            @layer.Source
                                                        </MudText>
                                                    </td>
                                                    <td>
                                                        <MudIcon Icon="@(layer.Visible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                                                Size="Size.Small"
                                                                Color="@(layer.Visible ? Color.Success : Color.Default)" />
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </MudSimpleTable>
                                </MudExpansionPanel>

                                <MudExpansionPanel Text="View Configuration JSON">
                                    <MudPaper Class="pa-3" Style="background-color: #f5f5f5; max-height: 400px; overflow-y: auto;">
                                        <pre style="margin: 0; font-size: 12px; font-family: 'Courier New', monospace;">@_configJson</pre>
                                    </MudPaper>
                                </MudExpansionPanel>
                            </MudExpansionPanels>
                        </MudStack>
                    }
                </MudPaper>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

@code {
    private string _prompt = string.Empty;
    private bool _isGenerating = false;
    private bool? _serviceAvailable = null;
    private MapConfiguration? _generatedMap = null;
    private string _explanation = string.Empty;
    private double _confidence = 0;
    private List<string> _warnings = new();
    private List<string> _spatialOperations = new();
    private List<string> _examplePrompts = new();
    private string _configJson = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await CheckServiceAvailability();
        await LoadExamplePrompts();
    }

    private async Task CheckServiceAvailability()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ServiceHealthResponse>("/api/maps/ai/health");
            _serviceAvailable = response?.Available ?? false;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error checking service availability: {ex.Message}");
            _serviceAvailable = false;
        }
    }

    private async Task LoadExamplePrompts()
    {
        try
        {
            var response = await Http.GetFromJsonAsync<ExamplePromptsResponse>("/api/maps/ai/examples");
            _examplePrompts = response?.Examples ?? new List<string>();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading example prompts: {ex.Message}");
        }
    }

    private void UseExamplePrompt(string example)
    {
        _prompt = example;
    }

    private async Task GenerateMap()
    {
        if (string.IsNullOrWhiteSpace(_prompt))
        {
            Snackbar.Add("Please enter a map description", Severity.Warning);
            return;
        }

        _isGenerating = true;
        _generatedMap = null;
        _explanation = string.Empty;
        _confidence = 0;
        _warnings.Clear();
        _spatialOperations.Clear();
        _configJson = string.Empty;

        try
        {
            var request = new MapGenerationRequest { Prompt = _prompt };
            var response = await Http.PostAsJsonAsync("/api/maps/ai/generate", request);

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<MapGenerationResponse>();
                if (result != null)
                {
                    _generatedMap = result.MapConfiguration;
                    _explanation = result.Explanation;
                    _confidence = result.Confidence;
                    _warnings = result.Warnings;
                    _spatialOperations = result.SpatialOperations;

                    _configJson = JsonSerializer.Serialize(_generatedMap, new JsonSerializerOptions
                    {
                        WriteIndented = true
                    });

                    Snackbar.Add("Map generated successfully!", Severity.Success);
                }
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to generate map: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error generating map: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isGenerating = false;
        }
    }

    private void EditGeneratedMap()
    {
        if (_generatedMap != null)
        {
            // Store the configuration in session/local storage or pass as parameter
            Navigation.NavigateTo($"/maps/edit/{_generatedMap.Id}");
        }
    }

    private async Task SaveGeneratedMap()
    {
        if (_generatedMap == null)
            return;

        try
        {
            // Save the map configuration via API
            // This would need to be implemented based on your map storage API
            Snackbar.Add("Map saved successfully! (Implementation pending)", Severity.Success);
            Navigation.NavigateTo("/maps");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving map: {ex.Message}", Severity.Error);
        }
    }

    // DTOs matching the API
    private class MapGenerationRequest
    {
        public string Prompt { get; set; } = string.Empty;
    }

    private class MapGenerationResponse
    {
        public MapConfiguration MapConfiguration { get; set; } = null!;
        public string Explanation { get; set; } = string.Empty;
        public double Confidence { get; set; }
        public List<string> Warnings { get; set; } = new();
        public List<string> SpatialOperations { get; set; } = new();
    }

    private class ServiceHealthResponse
    {
        public bool Available { get; set; }
        public string Message { get; set; } = string.Empty;
    }

    private class ExamplePromptsResponse
    {
        public List<string> Examples { get; set; } = new();
    }
}
