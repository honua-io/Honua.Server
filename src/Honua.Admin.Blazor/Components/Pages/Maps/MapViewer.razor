@page "/maps/view/{Id}"
@using Honua.MapSDK.Components.Map
@using Honua.MapSDK.Models
@using System.Text.Json
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>@_mapName - View Map</PageTitle>

@if (_loading)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
        <MudStack AlignItems="AlignItems.Center" Spacing="4">
            <MudProgressCircular Size="Size.Large" Indeterminate="true" />
            <MudText Typo="Typo.h6">Loading map...</MudText>
        </MudStack>
    </MudContainer>
}
else if (_config == null)
{
    <MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
        <MudAlert Severity="Severity.Error">
            Map configuration not found
        </MudAlert>
    </MudContainer>
}
else
{
    <div class="map-viewer-container">
        <!-- Map -->
        <HonuaMap Id="@Id"
                 MapStyle="@_config.Settings.Style"
                 Center="@_config.Settings.Center"
                 Zoom="@_config.Settings.Zoom"
                 Bearing="@_config.Settings.Bearing"
                 Pitch="@_config.Settings.Pitch"
                 Projection="@_config.Settings.Projection"
                 EnableGPU="@_config.Settings.EnableGPU"
                 MaxBounds="@_config.Settings.MaxBounds"
                 MinZoom="@_config.Settings.MinZoom"
                 MaxZoom="@_config.Settings.MaxZoom"
                 Style="width: 100%; height: 100%;" />

        <!-- Floating Info Panel -->
        <MudPaper Class="@(_showInfoPanel ? "map-info-panel" : "map-info-panel collapsed")" Elevation="4">
            <MudStack Spacing="2">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText Typo="Typo.h6">@_mapName</MudText>
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@(_showInfoPanel ? Icons.Material.Filled.VisibilityOff : Icons.Material.Filled.Visibility)"
                                      Size="Size.Small"
                                      OnClick="@(() => _showInfoPanel = !_showInfoPanel)"
                                      Title="Toggle panel" />
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                      Size="Size.Small"
                                      OnClick="@(() => Navigation.NavigateTo("/maps"))"
                                      Title="Close map" />
                    </MudStack>
                </MudStack>

                @if (_showInfoPanel)
                {
                    @if (!string.IsNullOrEmpty(_config.Description))
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @_config.Description
                        </MudText>
                    }

                    <MudDivider />

                    <MudText Typo="Typo.subtitle2">Map Information</MudText>
                    <MudStack Spacing="1">
                        <MudText Typo="Typo.body2">
                            <strong>Layers:</strong> @_config.Layers.Count
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Controls:</strong> @_config.Controls.Count(c => c.Visible)
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Projection:</strong> @_config.Settings.Projection
                        </MudText>
                    </MudStack>

                    <MudDivider />

                    <MudStack Row="true" Spacing="2">
                        <MudButton Variant="Variant.Outlined"
                                  Size="Size.Small"
                                  FullWidth="true"
                                  StartIcon="@Icons.Material.Filled.Edit"
                                  OnClick="@(() => Navigation.NavigateTo($"/maps/edit/{Id}"))">
                            Edit
                        </MudButton>
                        <MudButton Variant="Variant.Outlined"
                                  Size="Size.Small"
                                  FullWidth="true"
                                  StartIcon="@Icons.Material.Filled.Share"
                                  OnClick="ShowShareDialog">
                            Share
                        </MudButton>
                    </MudStack>
                }
            </MudStack>
        </MudPaper>

        <!-- Layer List (if there are layers) -->
        @if (_config.Layers.Count > 0 && _showLayerList)
        {
            <MudPaper Class="map-layer-panel" Elevation="4">
                <MudStack Spacing="2">
                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                        <MudText Typo="Typo.subtitle1"><strong>Layers</strong></MudText>
                        <MudIconButton Icon="@Icons.Material.Filled.Close"
                                      Size="Size.Small"
                                      OnClick="@(() => _showLayerList = false)"
                                      Title="Close layer list" />
                    </MudStack>
                    @foreach (var layer in _config.Layers)
                    {
                        <MudPaper Outlined="true" Class="pa-2 layer-item">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudStack Spacing="1">
                                    <MudText Typo="Typo.body2"><strong>@layer.Name</strong></MudText>
                                    <MudText Typo="Typo.caption">@layer.Type</MudText>
                                </MudStack>
                                <MudIcon Icon="@(layer.Visible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff)"
                                        Size="Size.Small"
                                        Color="@(layer.Visible ? Color.Success : Color.Default)" />
                            </MudStack>
                        </MudPaper>
                    }
                </MudStack>
            </MudPaper>
        }

        <!-- Toggle Layer List Button -->
        @if (_config.Layers.Count > 0 && !_showLayerList)
        {
            <MudFab Color="Color.Primary"
                   StartIcon="@Icons.Material.Filled.Layers"
                   Class="map-layer-toggle"
                   OnClick="@(() => _showLayerList = true)"
                   Title="Show layers" />
        }
    </div>
}

@code {
    [Parameter]
    public string Id { get; set; } = string.Empty;

    private MapConfiguration? _config;
    private string _mapName = "Map";
    private bool _loading = true;
    private bool _showLayerList = false;
    private bool _showInfoPanel = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadMap();
    }

    private async Task LoadMap()
    {
        _loading = true;
        try
        {
            var response = await Http.GetAsync($"/admin/api/map-configurations/{Id}");
            if (response.IsSuccessStatusCode)
            {
                var entity = await response.Content.ReadFromJsonAsync<MapConfigurationEntity>();
                if (entity != null)
                {
                    _config = JsonSerializer.Deserialize<MapConfiguration>(entity.Configuration);
                    _mapName = entity.Name;
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading map: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void ShowShareDialog()
    {
        Snackbar.Add("Share functionality coming soon", Severity.Info);
    }

    // DTO
    private class MapConfigurationEntity
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string Configuration { get; set; } = "{}";
    }
}
