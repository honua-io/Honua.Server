@page "/maps"
@using Honua.Server.Core.Models
@using Honua.Admin.Blazor.Components.Shared
@using Honua.Admin.Blazor.Shared.Helpers
@using Honua.Admin.Blazor.Shared.Services
@using Microsoft.JSInterop
@inject HttpClient Http
@inject NavigationManager Navigation
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@inject TouchGestureService TouchGestures
@inject ILogger<MapList> Logger
@implements IAsyncDisposable

<PageTitle>Map Configurations</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4" id="maps-container">
    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudText Typo="Typo.h4">Map Configurations</MudText>
            <MudSpacer />
            <MudTextField Value="@_searchText"
                          ValueChanged="@((string value) => OnSearchTextChanged(value))"
                          Placeholder="Search maps..."
                          Adornment="Adornment.Start"
                          AdornmentIcon="@(_searching ? Icons.Material.Filled.HourglassEmpty : Icons.Material.Filled.Search)"
                          Style="max-width: 400px"
                          Clearable="true" />
            <MudButton Variant="Variant.Filled"
                      Color="Color.Primary"
                      StartIcon="@Icons.Material.Filled.Add"
                      OnClick="CreateNew">
                Create New Map
            </MudButton>
        </MudStack>
    </MudPaper>

    <MudPaper Class="pa-4">
        @if (_loading)
        {
            <SkeletonLoader Type="SkeletonLoader.SkeletonType.Table" Rows="5" />
        }
        else if (!_configurations.Any())
        {
            <MudPaper Class="pa-8" Elevation="0">
                <MudStack AlignItems="AlignItems.Center" Spacing="3">
                    <MudIcon Icon="@Icons.Material.Filled.Map" Size="Size.Large" Color="Color.Default" Style="font-size: 4rem; opacity: 0.3;" />
                    <MudText Typo="Typo.h6" Align="Align.Center">No map configurations found</MudText>
                    <MudText Typo="Typo.body1" Color="Color.Secondary" Align="Align.Center">
                        Create your first map configuration to start building interactive geospatial applications!
                    </MudText>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Add"
                               OnClick="CreateNew">
                        Create New Map
                    </MudButton>
                </MudStack>
            </MudPaper>
        }
        else
        {
            <MudTable Items="@_filteredConfigurations"
                     Hover="true"
                     Breakpoint="Breakpoint.Sm"
                     LoadingProgressColor="Color.Primary">
                <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Description</MudTh>
                <MudTh>Created By</MudTh>
                <MudTh>Updated</MudTh>
                <MudTh>Views</MudTh>
                <MudTh>Public</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        @if (!string.IsNullOrEmpty(context.ThumbnailUrl))
                        {
                            <MudImage Src="@context.ThumbnailUrl"
                                     Width="40"
                                     Height="40"
                                     ObjectFit="ObjectFit.Cover"
                                     Class="rounded" />
                        }
                        <div>
                            <MudText Typo="Typo.body2"><strong>@context.Name</strong></MudText>
                            @if (context.IsTemplate)
                            {
                                <MudChip Size="Size.Small" Color="Color.Info">Template</MudChip>
                            }
                        </div>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Description">
                    <MudText Typo="Typo.body2">@(context.Description ?? "-")</MudText>
                </MudTd>
                <MudTd DataLabel="Created By">@context.CreatedBy</MudTd>
                <MudTd DataLabel="Updated">@context.UpdatedAt.ToString("g")</MudTd>
                <MudTd DataLabel="Views">@context.ViewCount</MudTd>
                <MudTd DataLabel="Public">
                    @if (context.IsPublic)
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Public" Color="Color.Success" Size="Size.Small" />
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.Lock" Color="Color.Default" Size="Size.Small" />
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                    OnClick="@(() => EditMap(context.Id))">
                            Edit
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Visibility"
                                    OnClick="@(() => ViewMap(context.Id))">
                            View
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy"
                                    OnClick="@(() => CloneMap(context.Id))">
                            Clone
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Download">
                            Export
                            <MudMenu ActivationEvent="@MouseEvent.MouseOver">
                                <MudMenuItem OnClick="@(() => ExportAs(context.Id, "json"))">
                                    As JSON
                                </MudMenuItem>
                                <MudMenuItem OnClick="@(() => ExportAs(context.Id, "yaml"))">
                                    As YAML
                                </MudMenuItem>
                                <MudMenuItem OnClick="@(() => ExportAs(context.Id, "html"))">
                                    As HTML Embed
                                </MudMenuItem>
                            </MudMenu>
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Delete"
                                    IconColor="Color.Error"
                                    OnClick="@(() => DeleteMap(context.Id))">
                            Delete
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
                <NoRecordsContent>
                    <MudText Typo="Typo.body1" Align="Align.Center" Class="pa-4">
                        No map configurations found.
                    </MudText>
                </NoRecordsContent>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<MapConfigurationListItem> _configurations = new();
    private bool _loading = true;
    private bool _searching = false;
    private string _searchText = string.Empty;
    private SearchDebouncer _searchDebouncer = new(300);
    private DotNetObjectReference<MapList>? _dotNetRef;
    private string? _pullToRefreshGestureId;
    private string? _swipeNavGestureId;

    private IEnumerable<MapConfigurationListItem> _filteredConfigurations =>
        string.IsNullOrWhiteSpace(_searchText)
            ? _configurations
            : _configurations.Where(m =>
                m.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
                (m.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                (m.Tags?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false) ||
                m.CreatedBy.Contains(_searchText, StringComparison.OrdinalIgnoreCase));

    protected override async Task OnInitializedAsync()
    {
        await LoadConfigurations();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            try
            {
                // Initialize touch gestures for mobile
                _dotNetRef = DotNetObjectReference.Create(this);

                // Pull-to-refresh
                _pullToRefreshGestureId = await TouchGestures.InitializePullToRefreshAsync(
                    "maps-container",
                    _dotNetRef
                );

                // Swipe navigation (back to home)
                _swipeNavGestureId = await TouchGestures.InitializeSwipeNavigationAsync(
                    "maps-container",
                    _dotNetRef
                );
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Error initializing touch gestures");
            }
        }
    }

    [JSInvokable]
    public async Task OnPullToRefresh()
    {
        await LoadConfigurations();
        StateHasChanged();
    }

    [JSInvokable]
    public Task OnSwipeBack()
    {
        Navigation.NavigateTo("/");
        return Task.CompletedTask;
    }

    [JSInvokable]
    public async Task OnSwipeDelete(string mapId)
    {
        await DeleteMap(mapId);
    }

    private void OnSearchTextChanged(string value)
    {
        _searchText = value;
        _searching = true;

        _searchDebouncer.Debounce(() =>
        {
            _searching = false;
            StateHasChanged();
        });
    }

    private async Task LoadConfigurations()
    {
        _loading = true;
        try
        {
            _configurations = await Http.GetFromJsonAsync<List<MapConfigurationListItem>>(
                "/admin/api/map-configurations"
            ) ?? new();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading map configurations: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void CreateNew()
    {
        Navigation.NavigateTo("/maps/new");
    }

    private void EditMap(string id)
    {
        Navigation.NavigateTo($"/maps/edit/{id}");
    }

    private void ViewMap(string id)
    {
        Navigation.NavigateTo($"/maps/view/{id}");
    }

    private async Task CloneMap(string id)
    {
        try
        {
            var response = await Http.PostAsync($"/admin/api/map-configurations/{id}/clone", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Map cloned successfully", Severity.Success);
                await LoadConfigurations();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error cloning map: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteMap(string id)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this map configuration?",
            yesText: "Delete",
            cancelText: "Cancel"
        );

        if (result == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"/admin/api/map-configurations/{id}");
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Map deleted successfully", Severity.Success);
                    await LoadConfigurations();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting map: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ExportAs(string id, string format)
    {
        var url = $"/admin/api/map-configurations/{id}/export/{format}";
        Navigation.NavigateTo(url, forceLoad: true);
    }

    // DTO for list view
    private class MapConfigurationListItem
    {
        public string Id { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public DateTime CreatedAt { get; set; }
        public DateTime UpdatedAt { get; set; }
        public string CreatedBy { get; set; } = string.Empty;
        public bool IsPublic { get; set; }
        public bool IsTemplate { get; set; }
        public string? Tags { get; set; }
        public string? ThumbnailUrl { get; set; }
        public int ViewCount { get; set; }
    }

    public async ValueTask DisposeAsync()
    {
        if (_pullToRefreshGestureId != null)
        {
            await TouchGestures.DisposeGestureAsync(_pullToRefreshGestureId);
        }

        if (_swipeNavGestureId != null)
        {
            await TouchGestures.DisposeGestureAsync(_swipeNavGestureId);
        }

        _dotNetRef?.Dispose();
        _searchDebouncer?.Dispose();
    }
}
