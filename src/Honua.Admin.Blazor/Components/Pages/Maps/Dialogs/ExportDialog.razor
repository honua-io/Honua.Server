@using Honua.MapSDK.Models
@using Honua.MapSDK.Services
@inject IMapConfigurationService ConfigService

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.h6">Export Map Configuration</MudText>

            <MudText Typo="Typo.body2" Color="Color.Secondary">
                Choose how you want to export this map configuration. You can use it in your own applications or share with others.
            </MudText>

            <MudDivider />

            <MudTabs Elevation="0" Rounded="true" Centered="true" @bind-ActivePanelIndex="_activeTab">
                <MudTabPanel Text="JSON" Icon="@Icons.Material.Filled.Code">
                    <MudPaper Class="pa-3 mt-3" Outlined="true">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2">JSON Configuration</MudText>
                            <MudText Typo="Typo.caption">
                                Use this format for API calls or programmatic configuration.
                            </MudText>
                            <MudTextField @bind-Value="_jsonExport"
                                         Lines="15"
                                         Variant="Variant.Outlined"
                                         ReadOnly="true"
                                         Style="font-family: monospace; font-size: 12px;" />
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      FullWidth="true"
                                      StartIcon="@Icons.Material.Filled.ContentCopy"
                                      OnClick="@(() => CopyToClipboard(_jsonExport))">
                                Copy JSON
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <MudTabPanel Text="YAML" Icon="@Icons.Material.Filled.Description">
                    <MudPaper Class="pa-3 mt-3" Outlined="true">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2">YAML Configuration</MudText>
                            <MudText Typo="Typo.caption">
                                Human-readable format, great for configuration files.
                            </MudText>
                            <MudTextField @bind-Value="_yamlExport"
                                         Lines="15"
                                         Variant="Variant.Outlined"
                                         ReadOnly="true"
                                         Style="font-family: monospace; font-size: 12px;" />
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      FullWidth="true"
                                      StartIcon="@Icons.Material.Filled.ContentCopy"
                                      OnClick="@(() => CopyToClipboard(_yamlExport))">
                                Copy YAML
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <MudTabPanel Text="HTML Embed" Icon="@Icons.Material.Filled.Web">
                    <MudPaper Class="pa-3 mt-3" Outlined="true">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2">Embeddable HTML</MudText>
                            <MudText Typo="Typo.caption">
                                Complete HTML page you can use anywhere. Just copy and paste!
                            </MudText>

                            <MudTextField @bind-Value="_sdkUrl"
                                         Label="SDK URL"
                                         Variant="Variant.Outlined"
                                         HelperText="Change if hosting SDK on your own CDN" />

                            <MudTextField @bind-Value="_htmlExport"
                                         Lines="15"
                                         Variant="Variant.Outlined"
                                         ReadOnly="true"
                                         Style="font-family: monospace; font-size: 12px;" />
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      FullWidth="true"
                                      StartIcon="@Icons.Material.Filled.ContentCopy"
                                      OnClick="@(() => CopyToClipboard(_htmlExport))">
                                Copy HTML
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>

                <MudTabPanel Text="Blazor Code" Icon="@Icons.Material.Filled.IntegrationInstructions">
                    <MudPaper Class="pa-3 mt-3" Outlined="true">
                        <MudStack Spacing="2">
                            <MudText Typo="Typo.subtitle2">Blazor Component Code</MudText>
                            <MudText Typo="Typo.caption">
                                Ready-to-use Blazor component code for your .NET applications.
                            </MudText>
                            <MudTextField @bind-Value="_blazorExport"
                                         Lines="15"
                                         Variant="Variant.Outlined"
                                         ReadOnly="true"
                                         Style="font-family: monospace; font-size: 12px;" />
                            <MudButton Variant="Variant.Filled"
                                      Color="Color.Primary"
                                      FullWidth="true"
                                      StartIcon="@Icons.Material.Filled.ContentCopy"
                                      OnClick="@(() => CopyToClipboard(_blazorExport))">
                                Copy Blazor Code
                            </MudButton>
                        </MudStack>
                    </MudPaper>
                </MudTabPanel>
            </MudTabs>
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public MapConfiguration Config { get; set; } = new()
    {
        Name = "Map",
        Settings = new MapSettings { Style = "", Center = new[] { 0.0, 0.0 }, Zoom = 2 }
    };

    private int _activeTab = 0;
    private string _sdkUrl = "https://cdn.honua.io/sdk";

    private string _jsonExport = string.Empty;
    private string _yamlExport = string.Empty;
    private string _htmlExport = string.Empty;
    private string _blazorExport = string.Empty;

    protected override void OnParametersSet()
    {
        GenerateExports();
    }

    private void GenerateExports()
    {
        _jsonExport = ConfigService.ExportAsJson(Config, formatted: true);
        _yamlExport = ConfigService.ExportAsYaml(Config);
        _htmlExport = ConfigService.ExportAsHtmlEmbed(Config, _sdkUrl);
        _blazorExport = ConfigService.ExportAsBlazorComponent(Config);
    }

    private async Task CopyToClipboard(string text)
    {
        // Use JSInterop to copy to clipboard
        // For now, just show a message
        await Task.CompletedTask;
        // Snackbar.Add("Copied to clipboard!", Severity.Success);
    }

    private void Close()
    {
        MudDialog?.Close();
    }
}
