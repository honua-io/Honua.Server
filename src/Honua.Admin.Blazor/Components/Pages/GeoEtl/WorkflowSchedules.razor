@page "/geoetl/schedules"
@inject HttpClient Http
@inject NavigationManager Navigation
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject UserContextService UserContext

<PageTitle>Workflow Schedules</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraExtraLarge" Class="mt-4">
    <MudText Typo="Typo.h3" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.Schedule" Class="mr-2" /> Workflow Schedules
    </MudText>

    <MudPaper Class="pa-4 mb-4">
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
            <MudTextField @bind-Value="_searchText"
                          Label="Search schedules"
                          Variant="Variant.Outlined"
                          Adornment="Adornment.Start"
                          AdornmentIcon="@Icons.Material.Filled.Search"
                          Style="max-width: 400px;" />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog">
                Create Schedule
            </MudButton>
        </MudStack>
    </MudPaper>

    @if (_loading)
    {
        <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
    }
    else if (_schedules == null || !_schedules.Any())
    {
        <MudPaper Class="pa-8 text-center">
            <MudIcon Icon="@Icons.Material.Filled.Schedule" Size="Size.Large" Class="mb-4" Style="font-size: 4rem; opacity: 0.3;" />
            <MudText Typo="Typo.h5" Class="mb-2">No schedules yet</MudText>
            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                Create a schedule to automate workflow execution
            </MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog">
                Create Schedule
            </MudButton>
        </MudPaper>
    }
    else
    {
        <MudTable Items="@_filteredSchedules" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading">
            <HeaderContent>
                <MudTh>Name</MudTh>
                <MudTh>Workflow</MudTh>
                <MudTh>Schedule</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Next Run</MudTh>
                <MudTh>Last Run</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Name">
                    <MudText Typo="Typo.body1" Class="font-weight-medium">
                        @context.Name
                    </MudText>
                    @if (!string.IsNullOrEmpty(context.Description))
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">
                            @context.Description
                        </MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Workflow">
                    <MudLink Href="@($"/geoetl/workflows/{context.WorkflowId}")">
                        @GetWorkflowName(context.WorkflowId)
                    </MudLink>
                </MudTd>
                <MudTd DataLabel="Schedule">
                    <MudText Typo="Typo.body2" Class="font-family-monospace">
                        @context.CronExpression
                    </MudText>
                    <MudText Typo="Typo.caption" Color="Color.Secondary">
                        @GetCronDescription(context.CronExpression)
                    </MudText>
                </MudTd>
                <MudTd DataLabel="Status">
                    @if (context.Enabled && context.Status == "Active")
                    {
                        <MudChip Size="Size.Small" Color="Color.Success">Active</MudChip>
                    }
                    else if (context.Status == "Paused" || !context.Enabled)
                    {
                        <MudChip Size="Size.Small" Color="Color.Warning">Paused</MudChip>
                    }
                    else if (context.Status == "Expired")
                    {
                        <MudChip Size="Size.Small" Color="Color.Default">Expired</MudChip>
                    }
                    else
                    {
                        <MudChip Size="Size.Small" Color="Color.Error">Error</MudChip>
                    }
                </MudTd>
                <MudTd DataLabel="Next Run">
                    @if (context.NextRunAt.HasValue)
                    {
                        <MudText Typo="Typo.body2">
                            @context.NextRunAt.Value.ToLocalTime().ToString("g")
                        </MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                            @GetRelativeTime(context.NextRunAt.Value)
                        </MudText>
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">-</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Last Run">
                    @if (context.LastRunAt.HasValue)
                    {
                        <MudText Typo="Typo.body2">
                            @context.LastRunAt.Value.ToLocalTime().ToString("g")
                        </MudText>
                        @if (!string.IsNullOrEmpty(context.LastRunStatus))
                        {
                            <MudChip Size="Size.Small"
                                     Color="@(context.LastRunStatus == "Completed" ? Color.Success : Color.Error)">
                                @context.LastRunStatus
                            </MudChip>
                        }
                    }
                    else
                    {
                        <MudText Typo="Typo.body2" Color="Color.Secondary">Never</MudText>
                    }
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudMenu Icon="@Icons.Material.Filled.MoreVert">
                        @if (context.Enabled)
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.Pause" OnClick="@(() => PauseSchedule(context.Id))">
                                Pause
                            </MudMenuItem>
                        }
                        else
                        {
                            <MudMenuItem Icon="@Icons.Material.Filled.PlayArrow" OnClick="@(() => ResumeSchedule(context.Id))">
                                Resume
                            </MudMenuItem>
                        }
                        <MudMenuItem Icon="@Icons.Material.Filled.PlayCircleOutline" OnClick="@(() => RunNow(context.Id))">
                            Run Now
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.History" OnClick="@(() => ViewHistory(context.Id))">
                            View History
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.CalendarMonth" OnClick="@(() => ViewNextRuns(context.Id))">
                            View Schedule
                        </MudMenuItem>
                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditSchedule(context))">
                            Edit
                        </MudMenuItem>
                        <MudDivider />
                        <MudMenuItem Icon="@Icons.Material.Filled.Delete"
                                     OnClick="@(() => DeleteSchedule(context.Id))">
                            Delete
                        </MudMenuItem>
                    </MudMenu>
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
</MudContainer>

@code {
    private List<WorkflowScheduleDto>? _schedules;
    private List<WorkflowDto>? _workflows;
    private bool _loading = true;
    private string _searchText = "";

    private IEnumerable<WorkflowScheduleDto> _filteredSchedules =>
        _schedules?.Where(s =>
            string.IsNullOrEmpty(_searchText) ||
            s.Name.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ||
            (s.Description?.Contains(_searchText, StringComparison.OrdinalIgnoreCase) ?? false)
        ) ?? Enumerable.Empty<WorkflowScheduleDto>();

    protected override async Task OnInitializedAsync()
    {
        await LoadSchedules();
        await LoadWorkflows();
    }

    private async Task LoadSchedules()
    {
        _loading = true;
        try
        {
            // SECURITY: Extract tenant ID from authentication claims
            var tenantId = await UserContext.GetTenantIdAsync();
            _schedules = await Http.GetFromJsonAsync<List<WorkflowScheduleDto>>(
                $"/admin/api/geoetl/schedules?tenantId={tenantId}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading schedules: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task LoadWorkflows()
    {
        try
        {
            // SECURITY: Extract tenant ID from authentication claims
            var tenantId = await UserContext.GetTenantIdAsync();
            _workflows = await Http.GetFromJsonAsync<List<WorkflowDto>>(
                $"/admin/api/geoetl/workflows?tenantId={tenantId}");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading workflows: {ex.Message}", Severity.Error);
        }
    }

    private string GetWorkflowName(Guid workflowId)
    {
        return _workflows?.FirstOrDefault(w => w.Id == workflowId)?.Metadata?.Name ?? "Unknown";
    }

    private string GetCronDescription(string cronExpression)
    {
        // Simple cron description - could be enhanced with a library
        return cronExpression switch
        {
            "0 0 * * *" => "Daily at midnight",
            "0 * * * *" => "Every hour",
            "*/15 * * * *" => "Every 15 minutes",
            "0 9 * * MON-FRI" => "Weekdays at 9 AM",
            "0 0 * * 0" => "Weekly on Sunday",
            "0 0 1 * *" => "Monthly on the 1st",
            _ => "Custom schedule"
        };
    }

    private string GetRelativeTime(DateTimeOffset time)
    {
        var diff = time - DateTimeOffset.Now;
        if (diff.TotalMinutes < 1) return "in less than a minute";
        if (diff.TotalHours < 1) return $"in {(int)diff.TotalMinutes} minutes";
        if (diff.TotalDays < 1) return $"in {(int)diff.TotalHours} hours";
        return $"in {(int)diff.TotalDays} days";
    }

    private async Task OpenCreateDialog()
    {
        var parameters = new DialogParameters
        {
            ["Workflows"] = _workflows
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ScheduleEditorDialog>("Create Schedule", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadSchedules();
        }
    }

    private async Task EditSchedule(WorkflowScheduleDto schedule)
    {
        var parameters = new DialogParameters
        {
            ["Schedule"] = schedule,
            ["Workflows"] = _workflows
        };

        var options = new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true };
        var dialog = await DialogService.ShowAsync<ScheduleEditorDialog>("Edit Schedule", parameters, options);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            await LoadSchedules();
        }
    }

    private async Task PauseSchedule(Guid scheduleId)
    {
        try
        {
            var response = await Http.PostAsync($"/admin/api/geoetl/schedules/{scheduleId}/pause", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Schedule paused", Severity.Success);
                await LoadSchedules();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error pausing schedule: {ex.Message}", Severity.Error);
        }
    }

    private async Task ResumeSchedule(Guid scheduleId)
    {
        try
        {
            var response = await Http.PostAsync($"/admin/api/geoetl/schedules/{scheduleId}/resume", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Schedule resumed", Severity.Success);
                await LoadSchedules();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error resuming schedule: {ex.Message}", Severity.Error);
        }
    }

    private async Task RunNow(Guid scheduleId)
    {
        try
        {
            // SECURITY: Extract user ID from authentication claims
            var userId = await UserContext.GetUserIdAsync();
            var response = await Http.PostAsync($"/admin/api/geoetl/schedules/{scheduleId}/run-now?userId={userId}", null);
            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Workflow execution started", Severity.Success);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error running workflow: {ex.Message}", Severity.Error);
        }
    }

    private async Task ViewHistory(Guid scheduleId)
    {
        Navigation.NavigateTo($"/geoetl/schedules/{scheduleId}/history");
    }

    private async Task ViewNextRuns(Guid scheduleId)
    {
        try
        {
            var nextRuns = await Http.GetFromJsonAsync<NextRunsResponse>(
                $"/admin/api/geoetl/schedules/{scheduleId}/next-runs?count=10");

            var message = string.Join("\n", nextRuns.NextRuns.Select((r, i) =>
                $"{i + 1}. {r.ToLocalTime():g}"));

            await DialogService.ShowMessageBox("Upcoming Executions", message);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error getting next runs: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteSchedule(Guid scheduleId)
    {
        var confirm = await DialogService.ShowMessageBox(
            "Confirm Delete",
            "Are you sure you want to delete this schedule?",
            yesText: "Delete", cancelText: "Cancel");

        if (confirm == true)
        {
            try
            {
                var response = await Http.DeleteAsync($"/admin/api/geoetl/schedules/{scheduleId}");
                if (response.IsSuccessStatusCode)
                {
                    Snackbar.Add("Schedule deleted", Severity.Success);
                    await LoadSchedules();
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting schedule: {ex.Message}", Severity.Error);
            }
        }
    }

    // DTOs matching the API responses
    public class WorkflowScheduleDto
    {
        public Guid Id { get; set; }
        public Guid WorkflowId { get; set; }
        public Guid TenantId { get; set; }
        public string Name { get; set; } = string.Empty;
        public string? Description { get; set; }
        public string CronExpression { get; set; } = string.Empty;
        public string Timezone { get; set; } = "UTC";
        public bool Enabled { get; set; }
        public string Status { get; set; } = "Active";
        public DateTimeOffset? NextRunAt { get; set; }
        public DateTimeOffset? LastRunAt { get; set; }
        public string? LastRunStatus { get; set; }
        public Guid? LastRunId { get; set; }
    }

    public class WorkflowDto
    {
        public Guid Id { get; set; }
        public WorkflowMetadataDto? Metadata { get; set; }
    }

    public class WorkflowMetadataDto
    {
        public string Name { get; set; } = string.Empty;
    }

    public class NextRunsResponse
    {
        public Guid ScheduleId { get; set; }
        public List<DateTimeOffset> NextRuns { get; set; } = new();
    }
}
