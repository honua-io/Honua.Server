@page "/import/jobs"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator,datapublisher")]
@inject ImportApiClient ImportApi
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Import Jobs - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">Import Jobs</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       Href="/import">
                New Import
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Default"
                           OnClick="LoadJobsAsync"
                           Title="Refresh" />
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        <MudTable Items="@_jobs"
                  Hover="true"
                  Breakpoint="Breakpoint.Sm"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh Style="width: 50px;"></MudTh>
                <MudTh>Job ID</MudTh>
                <MudTh>Source</MudTh>
                <MudTh>Target</MudTh>
                <MudTh>Status</MudTh>
                <MudTh Style="min-width: 250px;">Progress</MudTh>
                <MudTh>Time</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd>
                    @if (HasDetails(context))
                    {
                        <MudIconButton Icon="@(_expandedJobs.Contains(context.JobId) ? Icons.Material.Filled.ExpandLess : Icons.Material.Filled.ExpandMore)"
                                       Size="Size.Small"
                                       OnClick="@(() => ToggleJobDetails(context.JobId))" />
                    }
                </MudTd>
                <MudTd DataLabel="Job ID">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2" Style="font-family: monospace; font-size: 0.85rem;">
                            @context.JobId.ToString().Substring(0, 8)...
                        </MudText>
                        <MudChip Size="Size.Small" Variant="Variant.Outlined">
                            @GetJobTypeLabel(context)
                        </MudChip>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Source">
                    @if (!string.IsNullOrEmpty(context.FileName))
                    {
                        <MudStack Spacing="0">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.InsertDriveFile" Size="Size.Small" />
                                <MudText Typo="Typo.body1">@context.FileName</MudText>
                            </MudStack>
                            @if (context.FileSizeBytes.HasValue)
                            {
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @FormatFileSize(context.FileSizeBytes.Value)
                                </MudText>
                            }
                        </MudStack>
                    }
                    else if (!string.IsNullOrEmpty(context.SourceUrl))
                    {
                        <MudStack Spacing="0">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.Public" Size="Size.Small" />
                                <MudText Typo="Typo.body2">Esri Service</MudText>
                            </MudStack>
                            <MudText Typo="Typo.caption" Color="Color.Secondary" Style="max-width: 200px; overflow: hidden; text-overflow: ellipsis;">
                                @context.SourceUrl
                            </MudText>
                        </MudStack>
                    }
                </MudTd>
                <MudTd DataLabel="Target">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.body2">@context.ServiceId</MudText>
                        <MudText Typo="Typo.caption" Color="Color.Secondary">@context.LayerId</MudText>
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip Size="Size.Small" Color="@GetStatusColor(context.Status)" Icon="@GetStatusIcon(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Progress">
                    @if (context.Status == "Running")
                    {
                        <MudStack Spacing="1">
                            <MudProgressLinear Value="@context.Progress" Color="Color.Primary" Size="Size.Medium" />
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                <MudText Typo="Typo.caption">
                                    @($"{context.RecordsProcessed:N0} / {context.RecordsTotal:N0} features")
                                </MudText>
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @($"{context.Progress:F1}%")
                                </MudText>
                            </MudStack>
                            @if (context.RecordsProcessed > 0 && context.StartedAt.HasValue)
                            {
                                var throughput = CalculateThroughput(context);
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @($"{throughput:N0} features/sec")
                                </MudText>
                            }
                        </MudStack>
                    }
                    else if (context.Status == "Completed")
                    {
                        <MudStack Spacing="0">
                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                                <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                <MudText Typo="Typo.body2">@($"{context.RecordsProcessed:N0} features")</MudText>
                            </MudStack>
                            @if (context.StartedAt.HasValue && context.CompletedAt.HasValue)
                            {
                                var duration = context.CompletedAt.Value - context.StartedAt.Value;
                                <MudText Typo="Typo.caption" Color="Color.Secondary">
                                    @FormatDuration(duration)
                                </MudText>
                            }
                        </MudStack>
                    }
                    else if (context.Status == "Failed")
                    {
                        <MudTooltip Text="@context.ErrorMessage">
                            <MudChip Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Error">
                                Click for details
                            </MudChip>
                        </MudTooltip>
                    }
                    else if (context.Status == "Queued")
                    {
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="1">
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Typo="Typo.caption" Color="Color.Secondary">Waiting to start...</MudText>
                        </MudStack>
                    }
                </MudTd>
                <MudTd DataLabel="Time">
                    <MudStack Spacing="0">
                        <MudText Typo="Typo.caption" Color="Color.Secondary">Created:</MudText>
                        <MudText Typo="Typo.body2">@context.CreatedAt.ToString("yyyy-MM-dd HH:mm")</MudText>
                        @if (context.Status == "Running" && context.StartedAt.HasValue)
                        {
                            var elapsed = DateTime.UtcNow - context.StartedAt.Value;
                            <MudText Typo="Typo.caption" Color="Color.Info">
                                Elapsed: @FormatDuration(elapsed)
                            </MudText>
                        }
                    </MudStack>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="@(() => RefreshJob(context.JobId))"
                                       Title="Refresh Status" />
                        @if (context.Status == "Running" || context.Status == "Queued")
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => CancelJob(context.JobId))"
                                           Title="Cancel" />
                        }
                        @if (context.Status == "Completed")
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.OpenInNew"
                                           Size="Size.Small"
                                           Href="@($"/services/{context.ServiceId}/layers/{context.LayerId}")"
                                           Title="View Layer" />
                        }
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <ChildRowContent>
                @if (_expandedJobs.Contains(context.JobId))
                {
                    <MudTr>
                        <td colspan="8">
                            <MudPaper Outlined="true" Class="pa-4 ma-2">
                                @if (context.Layers?.Any() == true)
                                {
                                    <MudText Typo="Typo.subtitle2" Class="mb-2">Layer Progress:</MudText>
                                    <MudStack Spacing="2">
                                        @foreach (var layer in context.Layers)
                                        {
                                            <MudPaper Outlined="true" Class="pa-3">
                                                <MudStack Spacing="1">
                                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                            <MudIcon Icon="@GetGeometryIcon(layer.GeometryType)" Size="Size.Small" />
                                                            <MudText Typo="Typo.body1"><b>@layer.Name</b></MudText>
                                                            <MudChip Size="Size.Small" Variant="Variant.Outlined">@layer.GeometryType</MudChip>
                                                        </MudStack>
                                                        <MudChip Size="Size.Small" Color="@GetStatusColor(layer.Status)">
                                                            @layer.Status
                                                        </MudChip>
                                                    </MudStack>

                                                    @if (layer.Status == "Running" || layer.Status == "Completed")
                                                    {
                                                        <MudProgressLinear Value="@layer.Progress" Color="Color.Primary" />
                                                        <MudText Typo="Typo.caption">
                                                            @($"{layer.FeaturesImported:N0} / {layer.TotalFeatures:N0} features ({layer.Progress:F1}%)")
                                                        </MudText>
                                                    }

                                                    @if (!string.IsNullOrEmpty(layer.ErrorMessage))
                                                    {
                                                        <MudAlert Severity="Severity.Error" Dense="true">@layer.ErrorMessage</MudAlert>
                                                    }
                                                </MudStack>
                                            </MudPaper>
                                        }
                                    </MudStack>
                                }
                                else
                                {
                                    <MudSimpleTable Dense="true">
                                        <tbody>
                                            <tr>
                                                <td><strong>Job ID:</strong></td>
                                                <td>@context.JobId</td>
                                            </tr>
                                            @if (!string.IsNullOrEmpty(context.SourceUrl))
                                            {
                                                <tr>
                                                    <td><strong>Source URL:</strong></td>
                                                    <td><MudLink Href="@context.SourceUrl" Target="_blank">@context.SourceUrl</MudLink></td>
                                                </tr>
                                            }
                                            @if (context.RecordsTotal.HasValue)
                                            {
                                                <tr>
                                                    <td><strong>Total Features:</strong></td>
                                                    <td>@context.RecordsTotal.Value.ToString("N0")</td>
                                                </tr>
                                            }
                                            @if (!string.IsNullOrEmpty(context.ErrorMessage))
                                            {
                                                <tr>
                                                    <td><strong>Error:</strong></td>
                                                    <td><MudText Color="Color.Error">@context.ErrorMessage</MudText></td>
                                                </tr>
                                            }
                                        </tbody>
                                    </MudSimpleTable>
                                }
                            </MudPaper>
                        </td>
                    </MudTr>
                }
            </ChildRowContent>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="py-4">
                    No import jobs yet. Click "New Import" to get started.
                </MudText>
            </NoRecordsContent>
        </MudTable>

        @if (!string.IsNullOrEmpty(_paginationToken))
        {
            <MudStack Row="true" Justify="Justify.Center" Class="mt-4">
                <MudButton Variant="Variant.Outlined"
                           OnClick="LoadMoreJobsAsync"
                           Disabled="@_loading">
                    Load More
                </MudButton>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Import Data", href: "/import"),
        new BreadcrumbItem("Jobs", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private List<ImportJobSnapshot> _jobs = new();
    private string? _paginationToken;
    private System.Threading.Timer? _refreshTimer;
    private HashSet<Guid> _expandedJobs = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadJobsAsync();

        // Auto-refresh every 5 seconds if there are active jobs
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (_jobs.Any(j => j.Status == "Running" || j.Status == "Queued"))
            {
                await InvokeAsync(async () =>
                {
                    await LoadJobsAsync(silent: true);
                    StateHasChanged();
                });
            }
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadJobsAsync(bool silent = false)
    {
        if (!silent)
            _loading = true;

        _errorMessage = null;

        try
        {
            var result = await ImportApi.ListImportJobsAsync(pageSize: 25);
            _jobs = result.Items;
            _paginationToken = result.NextPageToken;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading import jobs: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            if (!silent)
                _loading = false;
        }
    }

    private async Task LoadMoreJobsAsync()
    {
        if (string.IsNullOrEmpty(_paginationToken))
            return;

        _loading = true;
        try
        {
            var result = await ImportApi.ListImportJobsAsync(pageSize: 25, pageToken: _paginationToken);
            _jobs.AddRange(result.Items);
            _paginationToken = result.NextPageToken;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading more jobs: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RefreshJob(Guid jobId)
    {
        try
        {
            var job = await ImportApi.GetImportJobAsync(jobId);
            if (job != null)
            {
                var index = _jobs.FindIndex(j => j.JobId == jobId);
                if (index >= 0)
                {
                    _jobs[index] = job;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing job: {ex.Message}", Severity.Error);
        }
    }

    private async Task CancelJob(Guid jobId)
    {
        var confirm = await Snackbar.ShowAsync("Are you sure you want to cancel this job?", Severity.Warning);
        // Note: MudBlazor Snackbar doesn't have built-in confirmation, using simple approach

        try
        {
            var success = await ImportApi.CancelImportJobAsync(jobId);
            if (success)
            {
                Snackbar.Add("Job cancelled successfully", Severity.Success);
                await RefreshJob(jobId);
            }
            else
            {
                Snackbar.Add("Failed to cancel job", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error cancelling job: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "completed" => Color.Success,
            "running" => Color.Info,
            "queued" => Color.Default,
            "failed" => Color.Error,
            "cancelled" => Color.Warning,
            _ => Color.Default
        };
    }

    private string GetStatusIcon(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "completed" => Icons.Material.Filled.CheckCircle,
            "running" => Icons.Material.Filled.PlayArrow,
            "queued" => Icons.Material.Filled.Schedule,
            "failed" => Icons.Material.Filled.Error,
            "cancelled" => Icons.Material.Filled.Cancel,
            _ => Icons.Material.Filled.Info
        };
    }

    private bool HasDetails(ImportJobSnapshot job)
    {
        return job.Layers?.Any() == true
            || !string.IsNullOrEmpty(job.SourceUrl)
            || !string.IsNullOrEmpty(job.ErrorMessage);
    }

    private void ToggleJobDetails(Guid jobId)
    {
        if (_expandedJobs.Contains(jobId))
        {
            _expandedJobs.Remove(jobId);
        }
        else
        {
            _expandedJobs.Add(jobId);
        }
    }

    private string GetJobTypeLabel(ImportJobSnapshot job)
    {
        if (!string.IsNullOrEmpty(job.SourceUrl))
        {
            return "Esri Import";
        }
        else if (!string.IsNullOrEmpty(job.FileName))
        {
            var extension = System.IO.Path.GetExtension(job.FileName)?.ToLowerInvariant();
            return extension switch
            {
                ".shp" => "Shapefile",
                ".geojson" or ".json" => "GeoJSON",
                ".gpkg" => "GeoPackage",
                ".kml" => "KML",
                ".gml" => "GML",
                ".csv" => "CSV",
                _ => "File Upload"
            };
        }
        return "Unknown";
    }

    private string FormatFileSize(long bytes)
    {
        string[] sizes = { "B", "KB", "MB", "GB" };
        double len = bytes;
        int order = 0;
        while (len >= 1024 && order < sizes.Length - 1)
        {
            order++;
            len = len / 1024;
        }
        return $"{len:0.##} {sizes[order]}";
    }

    private string FormatDuration(TimeSpan duration)
    {
        if (duration.TotalHours >= 1)
        {
            return $"{duration.Hours}h {duration.Minutes}m";
        }
        else if (duration.TotalMinutes >= 1)
        {
            return $"{duration.Minutes}m {duration.Seconds}s";
        }
        else
        {
            return $"{duration.Seconds}s";
        }
    }

    private double CalculateThroughput(ImportJobSnapshot job)
    {
        if (job.RecordsProcessed == 0 || !job.StartedAt.HasValue)
            return 0;

        var elapsed = DateTime.UtcNow - job.StartedAt.Value;
        if (elapsed.TotalSeconds == 0)
            return 0;

        return job.RecordsProcessed / elapsed.TotalSeconds;
    }

    private string GetGeometryIcon(string? geometryType)
    {
        return geometryType?.ToUpperInvariant() switch
        {
            "POINT" or "MULTIPOINT" => Icons.Material.Filled.Place,
            "LINESTRING" or "MULTILINESTRING" => Icons.Material.Filled.Timeline,
            "POLYGON" or "MULTIPOLYGON" => Icons.Material.Filled.Polyline,
            "GEOMETRY" or "GEOMETRYCOLLECTION" => Icons.Material.Filled.Layers,
            _ => Icons.Material.Filled.Place
        };
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
