@page "/import/jobs"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator,datapublisher")]
@inject ImportApiClient ImportApi
@inject ISnackbar Snackbar
@inject NavigationManager Navigation
@implements IDisposable

<PageTitle>Import Jobs - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-4 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Class="mb-4">
            <MudText Typo="Typo.h4">Import Jobs</MudText>
            <MudSpacer />
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       Href="/import">
                New Import
            </MudButton>
            <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                           Color="Color.Default"
                           OnClick="LoadJobsAsync"
                           Title="Refresh" />
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" Class="mb-4" />
        }

        @if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error" Class="mb-4">@_errorMessage</MudAlert>
        }

        <MudTable Items="@_jobs"
                  Hover="true"
                  Breakpoint="Breakpoint.Sm"
                  Loading="@_loading"
                  LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Job ID</MudTh>
                <MudTh>File Name</MudTh>
                <MudTh>Service / Layer</MudTh>
                <MudTh>Status</MudTh>
                <MudTh>Progress</MudTh>
                <MudTh>Created</MudTh>
                <MudTh>Actions</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Job ID">
                    <MudText Typo="Typo.body2" Class="text-monospace">@context.JobId.ToString().Substring(0, 8)...</MudText>
                </MudTd>
                <MudTd DataLabel="File Name">
                    <MudText Typo="Typo.body1">@context.FileName</MudText>
                </MudTd>
                <MudTd DataLabel="Service / Layer">
                    <MudText Typo="Typo.body2">@context.ServiceId / @context.LayerId</MudText>
                </MudTd>
                <MudTd DataLabel="Status">
                    <MudChip Size="Size.Small" Color="@GetStatusColor(context.Status)">
                        @context.Status
                    </MudChip>
                </MudTd>
                <MudTd DataLabel="Progress">
                    @if (context.Status == "Running")
                    {
                        <MudProgressLinear Value="@context.Progress" Color="Color.Primary" />
                        <MudText Typo="Typo.caption">@($"{context.RecordsProcessed:N0} / {context.RecordsTotal:N0}")</MudText>
                    }
                    else if (context.Status == "Completed")
                    {
                        <MudText Typo="Typo.body2">@($"{context.RecordsProcessed:N0} records")</MudText>
                    }
                    else if (context.Status == "Failed")
                    {
                        <MudTooltip Text="@context.ErrorMessage">
                            <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" />
                        </MudTooltip>
                    }
                </MudTd>
                <MudTd DataLabel="Created">
                    <MudText Typo="Typo.body2">@context.CreatedAt.ToString("yyyy-MM-dd HH:mm")</MudText>
                </MudTd>
                <MudTd DataLabel="Actions">
                    <MudStack Row="true" Spacing="1">
                        <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                       Size="Size.Small"
                                       Color="Color.Primary"
                                       OnClick="@(() => RefreshJob(context.JobId))"
                                       Title="Refresh Status" />
                        @if (context.Status == "Running" || context.Status == "Queued")
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.Cancel"
                                           Size="Size.Small"
                                           Color="Color.Error"
                                           OnClick="@(() => CancelJob(context.JobId))"
                                           Title="Cancel" />
                        }
                    </MudStack>
                </MudTd>
            </RowTemplate>
            <NoRecordsContent>
                <MudText Align="Align.Center" Class="py-4">
                    No import jobs yet. Click "New Import" to get started.
                </MudText>
            </NoRecordsContent>
        </MudTable>

        @if (!string.IsNullOrEmpty(_paginationToken))
        {
            <MudStack Row="true" Justify="Justify.Center" Class="mt-4">
                <MudButton Variant="Variant.Outlined"
                           OnClick="LoadMoreJobsAsync"
                           Disabled="@_loading">
                    Load More
                </MudButton>
            </MudStack>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Import Data", href: "/import"),
        new BreadcrumbItem("Jobs", href: null, disabled: true)
    };

    private bool _loading = true;
    private string? _errorMessage;
    private List<ImportJobSnapshot> _jobs = new();
    private string? _paginationToken;
    private System.Threading.Timer? _refreshTimer;

    protected override async Task OnInitializedAsync()
    {
        await LoadJobsAsync();

        // Auto-refresh every 5 seconds if there are active jobs
        _refreshTimer = new System.Threading.Timer(async _ =>
        {
            if (_jobs.Any(j => j.Status == "Running" || j.Status == "Queued"))
            {
                await InvokeAsync(async () =>
                {
                    await LoadJobsAsync(silent: true);
                    StateHasChanged();
                });
            }
        }, null, TimeSpan.FromSeconds(5), TimeSpan.FromSeconds(5));
    }

    private async Task LoadJobsAsync(bool silent = false)
    {
        if (!silent)
            _loading = true;

        _errorMessage = null;

        try
        {
            var result = await ImportApi.ListImportJobsAsync(pageSize: 25);
            _jobs = result.Items;
            _paginationToken = result.NextPageToken;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading import jobs: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            if (!silent)
                _loading = false;
        }
    }

    private async Task LoadMoreJobsAsync()
    {
        if (string.IsNullOrEmpty(_paginationToken))
            return;

        _loading = true;
        try
        {
            var result = await ImportApi.ListImportJobsAsync(pageSize: 25, pageToken: _paginationToken);
            _jobs.AddRange(result.Items);
            _paginationToken = result.NextPageToken;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading more jobs: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task RefreshJob(Guid jobId)
    {
        try
        {
            var job = await ImportApi.GetImportJobAsync(jobId);
            if (job != null)
            {
                var index = _jobs.FindIndex(j => j.JobId == jobId);
                if (index >= 0)
                {
                    _jobs[index] = job;
                    StateHasChanged();
                }
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing job: {ex.Message}", Severity.Error);
        }
    }

    private async Task CancelJob(Guid jobId)
    {
        var confirm = await Snackbar.ShowAsync("Are you sure you want to cancel this job?", Severity.Warning);
        // Note: MudBlazor Snackbar doesn't have built-in confirmation, using simple approach

        try
        {
            var success = await ImportApi.CancelImportJobAsync(jobId);
            if (success)
            {
                Snackbar.Add("Job cancelled successfully", Severity.Success);
                await RefreshJob(jobId);
            }
            else
            {
                Snackbar.Add("Failed to cancel job", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error cancelling job: {ex.Message}", Severity.Error);
        }
    }

    private Color GetStatusColor(string? status)
    {
        return status?.ToLowerInvariant() switch
        {
            "completed" => Color.Success,
            "running" => Color.Info,
            "queued" => Color.Default,
            "failed" => Color.Error,
            "cancelled" => Color.Warning,
            _ => Color.Default
        };
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
