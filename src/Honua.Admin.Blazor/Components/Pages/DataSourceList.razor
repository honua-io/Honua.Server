@page "/datasources"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator,datapublisher")]
@inject DataSourceApiClient DataSourceApi
@inject ServiceApiClient ServiceApi
@inject ISnackbar Snackbar
@inject IDialogService DialogService

<PageTitle>Data Sources - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-6 mt-4">
        <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
            <MudText Typo="Typo.h4">Data Sources</MudText>
            <MudButton Variant="Variant.Filled"
                       Color="Color.Primary"
                       StartIcon="@Icons.Material.Filled.Add"
                       OnClick="OpenCreateDialog">
                Create Data Source
            </MudButton>
        </MudStack>

        @if (_loading)
        {
            <MudProgressLinear Indeterminate="true" />
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
        }
        else if (!_dataSources.Any())
        {
            <MudAlert Severity="Severity.Info">
                No data sources configured yet. Create your first data source to connect to PostgreSQL, SQL Server, MySQL, or SQLite databases.
            </MudAlert>
        }
        else
        {
            <MudTable Items="@_dataSources" Hover="true" Breakpoint="Breakpoint.Sm" Dense="true">
                <HeaderContent>
                    <MudTh>ID</MudTh>
                    <MudTh>Provider</MudTh>
                    <MudTh>Connection</MudTh>
                    <MudTh>Usage</MudTh>
                    <MudTh>Status</MudTh>
                    <MudTh Style="text-align: right;">Actions</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="ID">
                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                            <MudIcon Icon="@GetProviderIcon(context.Provider)" Color="@GetProviderColor(context.Provider)" />
                            <MudText><b>@context.Id</b></MudText>
                        </MudStack>
                    </MudTd>
                    <MudTd DataLabel="Provider">
                        <MudChip Size="Size.Small" Variant="Variant.Outlined" Color="@GetProviderColor(context.Provider)">
                            @GetProviderDisplayName(context.Provider)
                        </MudChip>
                    </MudTd>
                    <MudTd DataLabel="Connection">
                        <MudText Typo="Typo.caption">@GetConnectionPreview(context.ConnectionString)</MudText>
                    </MudTd>
                    <MudTd DataLabel="Usage">
                        @{
                            var serviceCount = GetServiceCount(context.Id);
                        }
                        @if (serviceCount > 0)
                        {
                            <MudChip Size="Size.Small"
                                     Color="Color.Info"
                                     Icon="@Icons.Material.Filled.Cloud"
                                     OnClick="@(() => ViewServices(context.Id))"
                                     Clickable="true">
                                @serviceCount service(s)
                            </MudChip>
                        }
                        else
                        {
                            <MudChip Size="Size.Small" Color="Color.Default">
                                Unused
                            </MudChip>
                        }
                    </MudTd>
                    <MudTd DataLabel="Status">
                        @if (_connectionStatus.TryGetValue(context.Id, out var status))
                        {
                            @if (status.Success)
                            {
                                <MudChip Size="Size.Small" Color="Color.Success" Icon="@Icons.Material.Filled.CheckCircle">
                                    Connected (@status.ConnectionTime ms)
                                </MudChip>
                            }
                            else
                            {
                                <MudChip Size="Size.Small" Color="Color.Error" Icon="@Icons.Material.Filled.Error">
                                    Failed
                                </MudChip>
                            }
                        }
                        else if (_testingConnections.Contains(context.Id))
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                        }
                        else
                        {
                            <MudIconButton Icon="@Icons.Material.Filled.PlayCircle"
                                           Size="Size.Small"
                                           Color="Color.Info"
                                           Title="Test Connection"
                                           OnClick="@(() => TestConnection(context.Id))" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Actions" Style="text-align: right;">
                        <MudMenu Icon="@Icons.Material.Filled.MoreVert" Size="Size.Small">
                            @{
                                var count = GetServiceCount(context.Id);
                            }
                            @if (count > 0)
                            {
                                <MudMenuItem Icon="@Icons.Material.Filled.Cloud"
                                             OnClick="@(() => ViewServices(context.Id))">
                                    View Services (@count)
                                </MudMenuItem>
                                <MudDivider />
                            }
                            <MudMenuItem Icon="@Icons.Material.Filled.PlayArrow"
                                         OnClick="@(() => TestConnection(context.Id))">
                                Test Connection
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.TableChart"
                                         OnClick="@(() => BrowseTables(context.Id))">
                                Browse Tables
                            </MudMenuItem>
                            <MudDivider />
                            <MudMenuItem Icon="@Icons.Material.Filled.Edit"
                                         OnClick="@(() => OpenEditDialog(context))">
                                Edit
                            </MudMenuItem>
                            <MudMenuItem Icon="@Icons.Material.Filled.Delete"
                                         OnClick="@(() => DeleteDataSource(context))">
                                Delete
                            </MudMenuItem>
                        </MudMenu>
                    </MudTd>
                </RowTemplate>
            </MudTable>
        }
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Data Sources", href: null, disabled: true)
    };

    private List<DataSourceListItem> _dataSources = new();
    private List<ServiceListItem> _services = new();
    private Dictionary<string, TestConnectionResponse> _connectionStatus = new();
    private HashSet<string> _testingConnections = new();
    private bool _loading = true;
    private string? _errorMessage;

    protected override async Task OnInitializedAsync()
    {
        await LoadDataSourcesAsync();
        await LoadServicesAsync();
    }

    private async Task LoadDataSourcesAsync()
    {
        _loading = true;
        _errorMessage = null;

        try
        {
            _dataSources = await DataSourceApi.GetDataSourcesAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Error loading data sources: {ex.Message}";
            Snackbar.Add(_errorMessage, Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        var dialog = await DialogService.ShowAsync<DataSourceDialog>("Create Data Source",
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });

        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadDataSourcesAsync();
            Snackbar.Add("Data source created successfully", Severity.Success);
        }
    }

    private async Task OpenEditDialog(DataSourceListItem dataSource)
    {
        var parameters = new DialogParameters<DataSourceDialog>
        {
            { x => x.DataSourceId, dataSource.Id },
            { x => x.IsEdit, true }
        };

        var dialog = await DialogService.ShowAsync<DataSourceDialog>("Edit Data Source",
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });

        var result = await dialog.Result;
        if (!result.Canceled)
        {
            await LoadDataSourcesAsync();
            Snackbar.Add("Data source updated successfully", Severity.Success);
        }
    }

    private async Task DeleteDataSource(DataSourceListItem dataSource)
    {
        var confirmed = await DialogService.ShowMessageBox(
            "Delete Data Source",
            $"Are you sure you want to delete data source '{dataSource.Id}'?",
            yesText: "Delete",
            cancelText: "Cancel");

        if (confirmed == true)
        {
            try
            {
                await DataSourceApi.DeleteDataSourceAsync(dataSource.Id);
                await LoadDataSourcesAsync();
                Snackbar.Add($"Data source '{dataSource.Id}' deleted", Severity.Success);
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error deleting data source: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task TestConnection(string id)
    {
        _testingConnections.Add(id);
        _connectionStatus.Remove(id);
        StateHasChanged();

        try
        {
            var result = await DataSourceApi.TestConnectionAsync(id);
            _connectionStatus[id] = result;

            if (result.Success)
            {
                Snackbar.Add($"Connection successful ({result.ConnectionTime}ms)", Severity.Success);
            }
            else
            {
                Snackbar.Add($"Connection failed: {result.Message}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error testing connection: {ex.Message}", Severity.Error);
        }
        finally
        {
            _testingConnections.Remove(id);
            StateHasChanged();
        }
    }

    private async Task BrowseTables(string id)
    {
        // TODO: Implement table browser dialog
        Snackbar.Add("Table browser coming soon", Severity.Info);
    }

    private async Task LoadServicesAsync()
    {
        try
        {
            _services = await ServiceApi.GetServicesAsync();
        }
        catch (Exception ex)
        {
            // Don't fail the whole page if services can't be loaded
            // Just log and continue with empty services list
            Snackbar.Add("Warning: Could not load services for usage tracking", Severity.Warning);
            _services = new List<ServiceListItem>();
        }
    }

    private int GetServiceCount(string dataSourceId)
    {
        return _services.Count(s => s.DataSourceId != null &&
                                   s.DataSourceId.Equals(dataSourceId, StringComparison.OrdinalIgnoreCase));
    }

    private async Task ViewServices(string dataSourceId)
    {
        var servicesUsingDataSource = _services
            .Where(s => s.DataSourceId != null &&
                       s.DataSourceId.Equals(dataSourceId, StringComparison.OrdinalIgnoreCase))
            .ToList();

        var parameters = new DialogParameters<DataSourceServicesDialog>
        {
            { x => x.DataSourceId, dataSourceId },
            { x => x.Services, servicesUsingDataSource }
        };

        await DialogService.ShowAsync<DataSourceServicesDialog>(
            $"Services Using Data Source",
            parameters,
            new DialogOptions { MaxWidth = MaxWidth.Medium, FullWidth = true });
    }

    private string GetProviderIcon(string provider)
    {
        return provider.ToLowerInvariant() switch
        {
            "postgis" or "postgresql" => Icons.Material.Filled.Storage,
            "sqlserver" => Icons.Material.Filled.CloudQueue,
            "mysql" => Icons.Material.Filled.DataObject,
            "sqlite" => Icons.Material.Filled.Folder,
            _ => Icons.Material.Filled.Storage
        };
    }

    private Color GetProviderColor(string provider)
    {
        return provider.ToLowerInvariant() switch
        {
            "postgis" or "postgresql" => Color.Primary,
            "sqlserver" => Color.Info,
            "mysql" => Color.Warning,
            "sqlite" => Color.Secondary,
            _ => Color.Default
        };
    }

    private string GetProviderDisplayName(string provider)
    {
        return provider.ToLowerInvariant() switch
        {
            "postgis" => "PostGIS",
            "postgresql" => "PostgreSQL",
            "sqlserver" => "SQL Server",
            "mysql" => "MySQL",
            "sqlite" => "SQLite",
            _ => provider
        };
    }

    private string GetConnectionPreview(string connectionString)
    {
        // Extract key info from connection string for preview
        var parts = connectionString.Split(';');
        var preview = new List<string>();

        foreach (var part in parts.Take(2))
        {
            var keyValue = part.Split('=');
            if (keyValue.Length == 2)
            {
                var key = keyValue[0].Trim();
                var value = keyValue[1].Trim();

                // Hide sensitive info
                if (key.Equals("password", StringComparison.OrdinalIgnoreCase))
                {
                    preview.Add($"{key}=***");
                }
                else
                {
                    preview.Add(part.Trim());
                }
            }
        }

        return string.Join("; ", preview) + (parts.Length > 2 ? "; ..." : "");
    }
}
