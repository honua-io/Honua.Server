@page "/layers/create"
@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@attribute [Authorize(Roles = "administrator,datapublisher")]
@inject DataSourceApiClient DataSourceApi
@inject ServiceApiClient ServiceApi
@inject LayerApiClient LayerApi
@inject ISnackbar Snackbar
@inject NavigationManager Navigation

<PageTitle>Create Layer - Honua Admin</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudBreadcrumbs Items="_breadcrumbs" />

    <MudPaper Elevation="2" Class="pa-6 mt-4">
        <MudText Typo="Typo.h4" Class="mb-6">Create New Layer</MudText>

        <MudStepper @ref="_stepper" Linear="true" HeaderTextView="HeaderTextView.All">

            @* Step 1: Choose Source Type *@
            <MudStep Title="Choose Source" Icon="@Icons.Material.Filled.Source">
                <ChildContent>
                    <MudStack Spacing="4" Class="mt-4">
                        <MudText Typo="Typo.h6">How would you like to create this layer?</MudText>

                        <MudRadioGroup @bind-Value="_sourceType">
                            <MudPaper Outlined="true" Class="pa-4 mb-3 cursor-pointer" @onclick="@(() => _sourceType = LayerSourceType.DatabaseTable)">
                                <MudRadio Value="@LayerSourceType.DatabaseTable" Color="Color.Primary">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                        <MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Primary" Size="Size.Large" />
                                        <div>
                                            <MudText Typo="Typo.h6">From Database Table</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                Connect to an existing table in PostgreSQL, SQL Server, MySQL, or SQLite
                                            </MudText>
                                        </div>
                                    </MudStack>
                                </MudRadio>
                            </MudPaper>

                            <MudPaper Outlined="true" Class="pa-4 mb-3 cursor-pointer" @onclick="@(() => _sourceType = LayerSourceType.FileUpload)">
                                <MudRadio Value="@LayerSourceType.FileUpload" Color="Color.Info">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                        <MudIcon Icon="@Icons.Material.Filled.CloudUpload" Color="Color.Info" Size="Size.Large" />
                                        <div>
                                            <MudText Typo="Typo.h6">Upload Spatial File</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                Import from Shapefile, GeoJSON, GeoPackage, KML, GML, or CSV
                                            </MudText>
                                        </div>
                                    </MudStack>
                                </MudRadio>
                            </MudPaper>

                            <MudPaper Outlined="true" Class="pa-4 cursor-pointer" @onclick="@(() => _sourceType = LayerSourceType.EsriService)">
                                <MudRadio Value="@LayerSourceType.EsriService" Color="Color.Success">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="3">
                                        <MudIcon Icon="@Icons.Material.Filled.Public" Color="Color.Success" Size="Size.Large" />
                                        <div>
                                            <MudText Typo="Typo.h6">Import from Esri Service</MudText>
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                Import layers from ArcGIS Server, ArcGIS Online, or Feature Services
                                            </MudText>
                                        </div>
                                    </MudStack>
                                </MudRadio>
                            </MudPaper>
                        </MudRadioGroup>
                    </MudStack>
                </ChildContent>
                <ActionContent>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="@(() => _stepper.ForceRender())"
                               Disabled="@(_sourceType == LayerSourceType.None)">
                        Next
                    </MudButton>
                </ActionContent>
            </MudStep>

            @* Conditional Steps Based on Source Type *@
            @if (_sourceType == LayerSourceType.DatabaseTable)
            {
                @* Database Table Workflow *@
                <MudStep Title="Select Data Source" Icon="@Icons.Material.Filled.Storage">
                    <ChildContent>
                        <MudStack Spacing="4" Class="mt-4">
                            <MudText Typo="Typo.h6">Select Database Connection</MudText>

                            @if (_dataSources.Any())
                            {
                                <MudSelect @bind-Value="_selectedDataSourceId"
                                           Label="Data Source"
                                           Variant="Variant.Outlined"
                                           Required="true">
                                    @foreach (var ds in _dataSources)
                                    {
                                        <MudSelectItem Value="@ds.Id">
                                            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                <MudIcon Icon="@Icons.Material.Filled.Storage" Size="Size.Small" />
                                                <MudText>@ds.Id</MudText>
                                                <MudChip Size="Size.Small" Variant="Variant.Outlined">@ds.Provider</MudChip>
                                            </MudStack>
                                        </MudSelectItem>
                                    }
                                </MudSelect>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning">
                                    No data sources configured.
                                    <MudLink Href="/datasources" Color="Color.Primary">Create a data source</MudLink> first.
                                </MudAlert>
                            }
                        </MudStack>
                    </ChildContent>
                    <ActionContent>
                        <MudButton Variant="Variant.Text" OnClick="@(() => _stepper.Previous())">Back</MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="LoadTables"
                                   Disabled="@string.IsNullOrEmpty(_selectedDataSourceId)">
                            Next
                        </MudButton>
                    </ActionContent>
                </MudStep>

                <MudStep Title="Select Table" Icon="@Icons.Material.Filled.TableChart">
                    <ChildContent>
                        <DatabaseTableBrowser DataSourceId="@_selectedDataSourceId"
                                              OnTableSelected="HandleTableSelected" />
                    </ChildContent>
                    <ActionContent>
                        <MudButton Variant="Variant.Text" OnClick="@(() => _stepper.Previous())">Back</MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="@(() => _stepper.ForceRender())"
                                   Disabled="@(_selectedTable == null)">
                            Next
                        </MudButton>
                    </ActionContent>
                </MudStep>

                <MudStep Title="Configure Columns" Icon="@Icons.Material.Filled.ViewColumn">
                    <ChildContent>
                        <ColumnConfiguration TableInfo="@_selectedTable"
                                             @bind-SelectedColumns="_selectedColumns"
                                             @bind-ColumnAliases="_columnAliases"
                                             @bind-CodedValueDomains="_codedValueDomains" />
                    </ChildContent>
                    <ActionContent>
                        <MudButton Variant="Variant.Text" OnClick="@(() => _stepper.Previous())">Back</MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="LoadDataPreview">
                            Next
                        </MudButton>
                    </ActionContent>
                </MudStep>

                <MudStep Title="Data Preview" Icon="@Icons.Material.Filled.Preview">
                    <ChildContent>
                        <MudStack Spacing="4" Class="mt-4">
                            <MudText Typo="Typo.h6">Preview Data</MudText>

                            @if (_loadingPreview)
                            {
                                <MudPaper Outlined="true" Class="pa-6 text-center">
                                    <MudProgressCircular Indeterminate="true" />
                                    <MudText Typo="Typo.body2" Class="mt-2">Loading preview data...</MudText>
                                </MudPaper>
                            }
                            else if (_previewData != null && _previewData.Any())
                            {
                                <MudStack Spacing="3">
                                    <MudAlert Severity="Severity.Info" Dense="true">
                                        @if (_estimatedFeatureCount.HasValue)
                                        {
                                            <MudText Typo="Typo.body2">
                                                <strong>Estimated Feature Count:</strong> @_estimatedFeatureCount.Value.ToString("N0") features
                                                @if (!string.IsNullOrEmpty(_whereClause))
                                                {
                                                    <text> (with filter applied)</text>
                                                }
                                            </MudText>
                                        }
                                        <MudText Typo="Typo.body2">
                                            Showing first 10 rows from selected table
                                        </MudText>
                                    </MudAlert>

                                    <MudTable Items="@_previewData"
                                              Dense="true"
                                              Hover="true"
                                              Striped="true"
                                              Elevation="2">
                                        <HeaderContent>
                                            @foreach (var column in _selectedColumns.Take(10))
                                            {
                                                <MudTh>
                                                    @if (_columnAliases.TryGetValue(column, out var alias) && !string.IsNullOrEmpty(alias))
                                                    {
                                                        <div>
                                                            <div>@alias</div>
                                                            <MudText Typo="Typo.caption" Color="Color.Secondary">(@column)</MudText>
                                                        </div>
                                                    }
                                                    else
                                                    {
                                                        <text>@column</text>
                                                    }
                                                </MudTh>
                                            }
                                            @if (_selectedColumns.Count > 10)
                                            {
                                                <MudTh>
                                                    <MudText Typo="Typo.caption">+@(_selectedColumns.Count - 10) more...</MudText>
                                                </MudTh>
                                            }
                                        </HeaderContent>
                                        <RowTemplate>
                                            @foreach (var column in _selectedColumns.Take(10))
                                            {
                                                <MudTd>
                                                    @if (context.TryGetValue(column, out var value))
                                                    {
                                                        <text>@(value?.ToString() ?? "<null>")</text>
                                                    }
                                                </MudTd>
                                            }
                                            @if (_selectedColumns.Count > 10)
                                            {
                                                <MudTd></MudTd>
                                            }
                                        </RowTemplate>
                                    </MudTable>
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Warning">
                                    No preview data available. The table may be empty or there was an error loading the data.
                                </MudAlert>
                            }
                        </MudStack>
                    </ChildContent>
                    <ActionContent>
                        <MudButton Variant="Variant.Text" OnClick="@(() => _stepper.Previous())">Back</MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="@(() => _stepper.ForceRender())">
                            Next
                        </MudButton>
                    </ActionContent>
                </MudStep>

                <MudStep Title="Data Filter (Optional)" Icon="@Icons.Material.Filtered.FilterAlt">
                    <ChildContent>
                        <MudStack Spacing="3">
                            <WhereClauseBuilder TableInfo="@_selectedTable"
                                                @bind-WhereClause="_whereClause" />

                            @if (!string.IsNullOrEmpty(_whereClause))
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween">
                                        <MudText Typo="Typo.body2">
                                            Filter applied. You can refresh the preview to see how many features match your filter.
                                        </MudText>
                                        <MudButton Size="Size.Small"
                                                   Variant="Variant.Outlined"
                                                   Color="Color.Primary"
                                                   StartIcon="@Icons.Material.Filled.Refresh"
                                                   OnClick="RefreshPreviewWithFilter"
                                                   Disabled="@_loadingPreview">
                                            @if (_loadingPreview)
                                            {
                                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                            }
                                            else
                                            {
                                                <text>Update Preview</text>
                                            }
                                        </MudButton>
                                    </MudStack>
                                </MudAlert>

                                @if (_filteredFeatureCount.HasValue && _filteredFeatureCount != _estimatedFeatureCount)
                                {
                                    <MudPaper Outlined="true" Class="pa-3">
                                        <MudText Typo="Typo.body2">
                                            <strong>Estimated Features with Filter:</strong> @_filteredFeatureCount.Value.ToString("N0") features
                                            (reduced from @(_estimatedFeatureCount?.ToString("N0") ?? "unknown"))
                                        </MudText>
                                    </MudPaper>
                                }
                            }
                        </MudStack>
                    </ChildContent>
                    <ActionContent>
                        <MudButton Variant="Variant.Text" OnClick="@(() => _stepper.Previous())">Back</MudButton>
                        <MudButton Variant="Variant.Filled"
                                   Color="Color.Primary"
                                   OnClick="@(() => _stepper.ForceRender())">
                            Next
                        </MudButton>
                    </ActionContent>
                </MudStep>
            }
            else if (_sourceType == LayerSourceType.FileUpload)
            {
                @* File Upload Workflow - Redirect to existing wizard *@
                <MudStep Title="Upload File" Icon="@Icons.Material.Filled.CloudUpload">
                    <ChildContent>
                        <MudAlert Severity="Severity.Info">
                            Redirecting to file upload wizard...
                        </MudAlert>
                    </ChildContent>
                </MudStep>
            }
            else if (_sourceType == LayerSourceType.EsriService)
            {
                @* Esri Import Workflow *@
                <MudStep Title="Service URL" Icon="@Icons.Material.Filled.Link">
                    <ChildContent>
                        <MudAlert Severity="Severity.Info">
                            Esri service import coming soon...
                        </MudAlert>
                    </ChildContent>
                </MudStep>
            }

            @* Final Step: Review & Create *@
            <MudStep Title="Review & Create" Icon="@Icons.Material.Filled.CheckCircle">
                <ChildContent>
                    <MudStack Spacing="4" Class="mt-4">
                        <MudText Typo="Typo.h6">Review Layer Configuration</MudText>

                        <MudTextField @bind-Value="_layerId"
                                      Label="Layer ID"
                                      Required="true"
                                      Variant="Variant.Outlined"
                                      HelperText="Unique identifier (e.g., 'parcels', 'buildings')" />

                        <MudTextField @bind-Value="_layerTitle"
                                      Label="Layer Title"
                                      Required="true"
                                      Variant="Variant.Outlined" />

                        <MudSelect @bind-Value="_targetServiceId"
                                   Label="Target Service"
                                   Variant="Variant.Outlined"
                                   Required="true">
                            @foreach (var service in _services)
                            {
                                <MudSelectItem Value="@service.Id">@service.Title</MudSelectItem>
                            }
                        </MudSelect>

                        @if (_sourceType == LayerSourceType.DatabaseTable && _selectedTable != null)
                        {
                            <MudPaper Outlined="true" Class="pa-4">
                                <MudText Typo="Typo.subtitle2" Class="mb-2">Source Information:</MudText>
                                <MudSimpleTable Dense="true">
                                    <tbody>
                                        <tr>
                                            <td><strong>Data Source:</strong></td>
                                            <td>@_selectedDataSourceId</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Table:</strong></td>
                                            <td>@_selectedTable.Schema.@_selectedTable.Table</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Geometry Column:</strong></td>
                                            <td>@_selectedTable.GeometryColumn</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Geometry Type:</strong></td>
                                            <td>@_selectedTable.GeometryType</td>
                                        </tr>
                                        <tr>
                                            <td><strong>SRID:</strong></td>
                                            <td>@_selectedTable.Srid</td>
                                        </tr>
                                        <tr>
                                            <td><strong>Selected Columns:</strong></td>
                                            <td>@_selectedColumns.Count / @_selectedTable.Columns.Count</td>
                                        </tr>
                                        @if (_estimatedFeatureCount.HasValue)
                                        {
                                            <tr>
                                                <td><strong>Total Features:</strong></td>
                                                <td>@_estimatedFeatureCount.Value.ToString("N0")</td>
                                            </tr>
                                        }
                                        @if (!string.IsNullOrEmpty(_whereClause))
                                        {
                                            <tr>
                                                <td><strong>Filter:</strong></td>
                                                <td><code>@_whereClause</code></td>
                                            </tr>
                                            @if (_filteredFeatureCount.HasValue)
                                            {
                                                <tr>
                                                    <td><strong>Filtered Features:</strong></td>
                                                    <td>@_filteredFeatureCount.Value.ToString("N0") features</td>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </MudSimpleTable>
                            </MudPaper>
                        }
                    </MudStack>
                </ChildContent>
                <ActionContent>
                    <MudButton Variant="Variant.Text" OnClick="@(() => _stepper.Previous())">Back</MudButton>
                    <MudButton Variant="Variant.Filled"
                               Color="Color.Success"
                               StartIcon="@Icons.Material.Filled.Save"
                               OnClick="CreateLayer"
                               Disabled="@_creating">
                        @if (_creating)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                            <MudText Class="ml-2">Creating...</MudText>
                        }
                        else
                        {
                            <text>Create Layer</text>
                        }
                    </MudButton>
                </ActionContent>
            </MudStep>

        </MudStepper>
    </MudPaper>
</MudContainer>

@code {
    private List<BreadcrumbItem> _breadcrumbs = new()
    {
        new BreadcrumbItem("Home", href: "/"),
        new BreadcrumbItem("Layers", href: "/layers"),
        new BreadcrumbItem("Create", href: null, disabled: true)
    };

    private MudStepper? _stepper;
    private LayerSourceType _sourceType = LayerSourceType.None;

    // Common
    private List<DataSourceListItem> _dataSources = new();
    private List<ServiceListItem> _services = new();
    private string _layerId = string.Empty;
    private string _layerTitle = string.Empty;
    private string _targetServiceId = string.Empty;
    private bool _creating;

    // Database table workflow
    private string _selectedDataSourceId = string.Empty;
    private TableInfo? _selectedTable;
    private HashSet<string> _selectedColumns = new();
    private Dictionary<string, string> _columnAliases = new();
    private Dictionary<string, CodedValueDomain> _codedValueDomains = new();
    private string _whereClause = string.Empty;

    // Data preview
    private bool _loadingPreview;
    private List<Dictionary<string, object?>>? _previewData;
    private long? _estimatedFeatureCount;
    private long? _filteredFeatureCount;

    protected override async Task OnInitializedAsync()
    {
        await Task.WhenAll(
            LoadDataSourcesAsync(),
            LoadServicesAsync()
        );
    }

    private async Task LoadDataSourcesAsync()
    {
        try
        {
            _dataSources = await DataSourceApi.GetDataSourcesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data sources: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadServicesAsync()
    {
        try
        {
            _services = await ServiceApi.GetServicesAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading services: {ex.Message}", Severity.Error);
        }
    }

    private async Task LoadTables()
    {
        // Will trigger table loading in next step
        _stepper?.ForceRender();
    }

    private void HandleTableSelected(TableInfo table)
    {
        _selectedTable = table;

        // Pre-select all columns
        _selectedColumns = table.Columns.Select(c => c.Name).ToHashSet();

        // Auto-suggest layer ID from table name
        if (string.IsNullOrEmpty(_layerId))
        {
            _layerId = table.Table.ToLowerInvariant().Replace(" ", "_");
        }

        // Auto-suggest title
        if (string.IsNullOrEmpty(_layerTitle))
        {
            _layerTitle = table.Table;
        }

        // Reset preview data when table changes
        _previewData = null;
        _estimatedFeatureCount = null;
    }

    private async Task LoadDataPreview()
    {
        _loadingPreview = true;
        _previewData = null;
        _estimatedFeatureCount = null;

        try
        {
            // Move to next step first
            _stepper?.ForceRender();

            // Simulate API call delay
            await Task.Delay(800);

            // TODO: Call backend endpoint to fetch preview data
            // For now, generate mock preview data
            _previewData = GenerateMockPreviewData();

            // Use the row count from TableInfo as estimated feature count
            _estimatedFeatureCount = _selectedTable?.RowCount ?? 0;
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading preview data: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingPreview = false;
        }
    }

    private List<Dictionary<string, object?>> GenerateMockPreviewData()
    {
        // TODO: Replace with actual backend API call
        // Example endpoint: GET /admin/datasources/{id}/tables/{schema}.{table}/preview?limit=10&columns=col1,col2

        var mockData = new List<Dictionary<string, object?>>();

        if (_selectedTable == null || !_selectedColumns.Any())
            return mockData;

        // Generate 10 mock rows
        for (int i = 0; i < 10; i++)
        {
            var row = new Dictionary<string, object?>();

            foreach (var column in _selectedColumns)
            {
                var columnInfo = _selectedTable.Columns.FirstOrDefault(c => c.Name == column);
                if (columnInfo == null) continue;

                // Generate mock data based on column type
                row[column] = columnInfo.DataType.ToLower() switch
                {
                    var t when t.Contains("int") => Random.Shared.Next(1, 1000),
                    var t when t.Contains("decimal") || t.Contains("numeric") || t.Contains("float") || t.Contains("double") =>
                        Math.Round(Random.Shared.NextDouble() * 1000, 2),
                    var t when t.Contains("bool") => Random.Shared.Next(0, 2) == 1,
                    var t when t.Contains("date") || t.Contains("time") => DateTime.Now.AddDays(-Random.Shared.Next(0, 365)),
                    var t when t.Contains("geometry") || t.Contains("geography") => "POINT(...)", // Don't show full geometry
                    _ => $"Sample {column} {i + 1}"
                };
            }

            mockData.Add(row);
        }

        return mockData;
    }

    private async Task RefreshPreviewWithFilter()
    {
        _loadingPreview = true;

        try
        {
            // Simulate API call delay
            await Task.Delay(500);

            // TODO: Call backend endpoint to get filtered count
            // Example endpoint: GET /admin/datasources/{id}/tables/{schema}.{table}/count?where={whereClause}

            // Mock: Simulate filter reducing the count
            if (!string.IsNullOrEmpty(_whereClause) && _estimatedFeatureCount.HasValue)
            {
                // Simulate filter reducing results by a random percentage (30-90%)
                var reductionFactor = Random.Shared.NextDouble() * 0.6 + 0.1; // 0.1 to 0.7
                _filteredFeatureCount = (long)(_estimatedFeatureCount.Value * reductionFactor);
            }
            else
            {
                _filteredFeatureCount = _estimatedFeatureCount;
            }

            Snackbar.Add($"Preview updated. Estimated {_filteredFeatureCount:N0} features match your filter.", Severity.Info);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error refreshing preview: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loadingPreview = false;
        }
    }

    private async Task CreateLayer()
    {
        _creating = true;

        try
        {
            // TODO: Create layer with all configurations
            await Task.Delay(1000); // Simulate API call

            Snackbar.Add("Layer created successfully!", Severity.Success);
            Navigation.NavigateTo("/layers");
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating layer: {ex.Message}", Severity.Error);
        }
        finally
        {
            _creating = false;
        }
    }

    private enum LayerSourceType
    {
        None,
        DatabaseTable,
        FileUpload,
        EsriService
    }

    // Placeholder classes - will be implemented
    private class CodedValueDomain
    {
        public string Type { get; set; } = "codedValue";
        public List<CodedValue> Values { get; set; } = new();
    }

    private class CodedValue
    {
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
    }
}
