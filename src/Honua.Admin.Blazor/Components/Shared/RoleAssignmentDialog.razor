@using Honua.Admin.Blazor.Shared.Models
@using Honua.Admin.Blazor.Shared.Services
@using MudBlazor
@inject RbacApiClient RbacApi
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.body1">
                Assign roles to user <b>@User?.Username</b>
            </MudText>

            <MudAlert Severity="Severity.Info">
                Users can have multiple roles. Each role grants specific permissions.
            </MudAlert>

            @if (_loading)
            {
                <MudProgressLinear Indeterminate="true" />
            }
            else if (_availableRoles.Any())
            {
                @foreach (var role in _availableRoles)
                {
                    <MudPaper Elevation="1" Class="pa-3">
                        <MudStack Row="true" AlignItems="AlignItems.Center">
                            <MudCheckBox @bind-Value="@_roleSelections[role.Id]"
                                         Color="Color.Primary" />
                            <MudStack Row="false" Spacing="1" Style="flex: 1">
                                <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                    <MudText Typo="Typo.body1"><b>@role.DisplayName</b></MudText>
                                    @if (role.IsSystem)
                                    {
                                        <MudChip Size="Size.Small" Color="Color.Warning" Icon="@Icons.Material.Filled.Lock">System</MudChip>
                                    }
                                </MudStack>
                                @if (!string.IsNullOrEmpty(role.Description))
                                {
                                    <MudText Typo="Typo.body2">@role.Description</MudText>
                                }
                                <MudStack Row="true" Spacing="1" Style="flex-wrap: wrap;">
                                    <MudText Typo="Typo.caption">Permissions:</MudText>
                                    @if (role.Permissions.Count > 3)
                                    {
                                        <MudChip Size="Size.Small" Variant="Variant.Text">@role.Permissions.Count permissions</MudChip>
                                    }
                                    else
                                    {
                                        @foreach (var permission in role.Permissions)
                                        {
                                            <MudChip Size="Size.Small" Variant="Variant.Text">@permission</MudChip>
                                        }
                                    }
                                </MudStack>
                            </MudStack>
                            <MudIcon Icon="@GetRoleIcon(role.Name)" Color="@GetRoleColor(role.Name)" />
                        </MudStack>
                    </MudPaper>
                }
            }
            else
            {
                <MudAlert Severity="Severity.Warning">
                    No roles available. Please create roles first.
                </MudAlert>
            }

            @if (!_loading && _roleSelections.Values.All(v => !v))
            {
                <MudAlert Severity="Severity.Warning">
                    Warning: User will have no roles assigned. They will not be able to access any resources.
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Submit"
                   Disabled="_loading">
            Update Roles
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private MudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public UserResponse? User { get; set; }

    private bool _loading = true;
    private List<RoleDefinition> _availableRoles = new();
    private Dictionary<string, bool> _roleSelections = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadRolesAsync();
    }

    private async Task LoadRolesAsync()
    {
        try
        {
            var response = await RbacApi.ListRolesAsync();
            _availableRoles = response?.Roles ?? new List<RoleDefinition>();

            // Initialize role selections
            foreach (var role in _availableRoles)
            {
                _roleSelections[role.Id] = User?.Roles.Contains(role.Name, StringComparer.OrdinalIgnoreCase) == true;
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading roles: {ex.Message}", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }

    private void Submit()
    {
        var selectedRoles = _availableRoles
            .Where(r => _roleSelections.GetValueOrDefault(r.Id, false))
            .Select(r => r.Name)
            .ToList();

        MudDialog.Close(DialogResult.Ok(selectedRoles));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private string GetRoleIcon(string roleName)
    {
        return roleName.ToLowerInvariant() switch
        {
            "administrator" => Icons.Material.Filled.AdminPanelSettings,
            "datapublisher" => Icons.Material.Filled.Publish,
            "viewer" => Icons.Material.Filled.Visibility,
            _ => Icons.Material.Filled.Person
        };
    }

    private Color GetRoleColor(string roleName)
    {
        return roleName.ToLowerInvariant() switch
        {
            "administrator" => Color.Error,
            "datapublisher" => Color.Warning,
            "viewer" => Color.Info,
            _ => Color.Default
        };
    }
}
