@using Honua.Admin.Blazor.Shared.Models
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            @if (_validationErrors.Any())
            {
                <MudAlert Severity="Severity.Warning">
                    <MudText Typo="Typo.body1"><b>Please fix @_validationErrors.Count error(s):</b></MudText>
                    <MudList Dense="true" Class="mt-2">
                        @foreach (var error in _validationErrors)
                        {
                            <MudListItem Icon="@Icons.Material.Filled.Error" IconColor="Color.Warning">
                                <MudText Typo="Typo.body2">@error</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudAlert>
            }

            @if (!IsEditMode)
            {
                <MudTextField @ref="_usernameField"
                              @bind-Value="_username"
                              Label="Username"
                              Variant="Variant.Outlined"
                              Required="true"
                              Immediate="true"
                              HelperText="Unique username for login"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidateUsername))"
                              Adornment="Adornment.End"
                              AdornmentIcon="@GetValidationIcon(nameof(_username))"
                              AdornmentColor="@GetValidationColor(nameof(_username))"
                              OnBlur="@(() => OnFieldBlur(nameof(_username)))" />
            }
            else
            {
                <MudTextField Value="@User?.Username"
                              Label="Username"
                              Variant="Variant.Outlined"
                              Disabled="true"
                              HelperText="Username cannot be changed" />
            }

            <MudTextField @bind-Value="_displayName"
                          Label="Display Name"
                          Variant="Variant.Outlined"
                          HelperText="Full name or display name" />

            <MudTextField @ref="_emailField"
                          @bind-Value="_email"
                          Label="Email"
                          Variant="Variant.Outlined"
                          InputType="InputType.Email"
                          Immediate="true"
                          HelperText="Email address for notifications"
                          Validation="@(new Func<string, IEnumerable<string>>(ValidateEmail))"
                          Adornment="Adornment.End"
                          AdornmentIcon="@GetValidationIcon(nameof(_email))"
                          AdornmentColor="@GetValidationColor(nameof(_email))"
                          OnBlur="@(() => OnFieldBlur(nameof(_email)))" />

            @if (!IsEditMode)
            {
                <MudTextField @ref="_passwordField"
                              @bind-Value="_password"
                              Label="Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              Immediate="true"
                              HelperText="Initial password (must be at least 8 characters)"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidatePassword))"
                              Adornment="Adornment.End"
                              AdornmentIcon="@GetValidationIcon(nameof(_password))"
                              AdornmentColor="@GetValidationColor(nameof(_password))"
                              OnBlur="@(() => OnFieldBlur(nameof(_password)))" />

                <MudTextField @ref="_confirmPasswordField"
                              @bind-Value="_confirmPassword"
                              Label="Confirm Password"
                              Variant="Variant.Outlined"
                              InputType="InputType.Password"
                              Required="true"
                              Immediate="true"
                              HelperText="Re-enter password to confirm"
                              Validation="@(new Func<string, IEnumerable<string>>(ValidateConfirmPassword))"
                              Adornment="Adornment.End"
                              AdornmentIcon="@GetValidationIcon(nameof(_confirmPassword))"
                              AdornmentColor="@GetValidationColor(nameof(_confirmPassword))"
                              OnBlur="@(() => OnFieldBlur(nameof(_confirmPassword)))" />
            }

            <MudSelect T="string"
                       Label="Roles"
                       MultiSelection="true"
                       @bind-SelectedValues="_selectedRoles"
                       Variant="Variant.Outlined"
                       HelperText="Select one or more roles"
                       AnchorOrigin="Origin.BottomCenter">
                @foreach (var role in RoleOptions.AvailableRoles)
                {
                    <MudSelectItem Value="@role.Name">
                        <MudStack Row="false" Spacing="0">
                            <MudText Typo="Typo.body2">@role.DisplayName</MudText>
                            <MudText Typo="Typo.caption">@role.Description</MudText>
                        </MudStack>
                    </MudSelectItem>
                }
            </MudSelect>

            <MudSwitch T="bool" @bind-Value="_isEnabled"
                       Label="Enabled"
                       Color="Color.Success"
                       HelperText="User can log in when enabled" />

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Submit">
            @(IsEditMode ? "Update" : "Create")
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public bool IsEditMode { get; set; }

    [Parameter]
    public UserResponse? User { get; set; }

    private string _username = string.Empty;
    private string? _displayName;
    private string? _email;
    private string _password = string.Empty;
    private string _confirmPassword = string.Empty;
    private IEnumerable<string> _selectedRoles = new List<string>();
    private bool _isEnabled = true;
    private string? _errorMessage;

    // Field references
    private MudTextField<string> _usernameField = default!;
    private MudTextField<string?> _emailField = default!;
    private MudTextField<string> _passwordField = default!;
    private MudTextField<string> _confirmPasswordField = default!;

    // Validation tracking
    private Dictionary<string, bool> _fieldValidity = new();
    private Dictionary<string, bool> _fieldTouched = new();
    private List<string> _validationErrors = new();

    protected override void OnInitialized()
    {
        if (IsEditMode && User != null)
        {
            _username = User.Username;
            _displayName = User.DisplayName;
            _email = User.Email;
            _selectedRoles = User.Roles.ToList();
            _isEnabled = User.IsEnabled;
        }
    }

    private async Task Submit()
    {
        _errorMessage = null;

        // Mark all fields as touched for validation display
        _fieldTouched[nameof(_username)] = true;
        _fieldTouched[nameof(_email)] = true;
        _fieldTouched[nameof(_password)] = true;
        _fieldTouched[nameof(_confirmPassword)] = true;

        if (!IsEditMode)
        {
            // Create mode validation
            ValidateUsername(_username);
            ValidateEmail(_email);
            ValidatePassword(_password);
            ValidateConfirmPassword(_confirmPassword);

            if (_validationErrors.Any())
            {
                await FocusFirstInvalidField();
                return;
            }

            var request = new CreateUserRequest
            {
                Username = _username.Trim(),
                Email = string.IsNullOrWhiteSpace(_email) ? null : _email.Trim(),
                DisplayName = string.IsNullOrWhiteSpace(_displayName) ? null : _displayName.Trim(),
                Password = _password,
                Roles = _selectedRoles.ToList(),
                IsEnabled = _isEnabled
            };

            MudDialog.Close(DialogResult.Ok(request));
        }
        else
        {
            // Edit mode - only validate email if present
            if (!string.IsNullOrWhiteSpace(_email))
            {
                ValidateEmail(_email);
            }

            if (_validationErrors.Any())
            {
                await FocusFirstInvalidField();
                return;
            }

            var request = new UpdateUserRequest
            {
                Email = string.IsNullOrWhiteSpace(_email) ? null : _email.Trim(),
                DisplayName = string.IsNullOrWhiteSpace(_displayName) ? null : _displayName.Trim(),
                Roles = _selectedRoles.ToList(),
                IsEnabled = _isEnabled
            };

            MudDialog.Close(DialogResult.Ok(request));
        }
    }

    private IEnumerable<string> ValidateUsername(string username)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(username))
        {
            errors.Add("Username is required");
            UpdateFieldValidity(nameof(_username), false);
        }
        else if (username.Length < 3)
        {
            errors.Add("Username must be at least 3 characters");
            UpdateFieldValidity(nameof(_username), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_username), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private IEnumerable<string> ValidateEmail(string? email)
    {
        var errors = new List<string>();

        if (!string.IsNullOrWhiteSpace(email))
        {
            if (!System.Text.RegularExpressions.Regex.IsMatch(email, @"^[^@\s]+@[^@\s]+\.[^@\s]+$"))
            {
                errors.Add("Invalid email format");
                UpdateFieldValidity(nameof(_email), false);
            }
            else
            {
                UpdateFieldValidity(nameof(_email), true);
            }
        }
        else
        {
            UpdateFieldValidity(nameof(_email), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private IEnumerable<string> ValidatePassword(string password)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(password))
        {
            errors.Add("Password is required");
            UpdateFieldValidity(nameof(_password), false);
        }
        else if (password.Length < 8)
        {
            errors.Add("Password must be at least 8 characters");
            UpdateFieldValidity(nameof(_password), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_password), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private IEnumerable<string> ValidateConfirmPassword(string confirmPassword)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(confirmPassword))
        {
            errors.Add("Please confirm your password");
            UpdateFieldValidity(nameof(_confirmPassword), false);
        }
        else if (confirmPassword != _password)
        {
            errors.Add("Passwords do not match");
            UpdateFieldValidity(nameof(_confirmPassword), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_confirmPassword), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private void UpdateFieldValidity(string fieldName, bool isValid)
    {
        _fieldValidity[fieldName] = isValid;
    }

    private void OnFieldBlur(string fieldName)
    {
        _fieldTouched[fieldName] = true;
        StateHasChanged();
    }

    private string GetValidationIcon(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return string.Empty;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Icons.Material.Filled.CheckCircle
            : Icons.Material.Filled.Error;
    }

    private Color GetValidationColor(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return Color.Default;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Color.Success
            : Color.Error;
    }

    private void UpdateValidationSummary()
    {
        _validationErrors.Clear();

        if (!IsEditMode)
        {
            if (_fieldTouched.GetValueOrDefault(nameof(_username)) && !_fieldValidity.GetValueOrDefault(nameof(_username)))
            {
                _validationErrors.Add("Username: Invalid or missing");
            }

            if (_fieldTouched.GetValueOrDefault(nameof(_password)) && !_fieldValidity.GetValueOrDefault(nameof(_password)))
            {
                _validationErrors.Add("Password: Invalid or missing");
            }

            if (_fieldTouched.GetValueOrDefault(nameof(_confirmPassword)) && !_fieldValidity.GetValueOrDefault(nameof(_confirmPassword)))
            {
                _validationErrors.Add("Confirm Password: Passwords do not match");
            }
        }

        if (!string.IsNullOrWhiteSpace(_email) && _fieldTouched.GetValueOrDefault(nameof(_email)) && !_fieldValidity.GetValueOrDefault(nameof(_email)))
        {
            _validationErrors.Add("Email: Invalid format");
        }
    }

    private async Task FocusFirstInvalidField()
    {
        if (!IsEditMode)
        {
            if (!_fieldValidity.GetValueOrDefault(nameof(_username)) && _usernameField != null)
            {
                await _usernameField.FocusAsync();
                return;
            }
            if (!_fieldValidity.GetValueOrDefault(nameof(_password)) && _passwordField != null)
            {
                await _passwordField.FocusAsync();
                return;
            }
            if (!_fieldValidity.GetValueOrDefault(nameof(_confirmPassword)) && _confirmPasswordField != null)
            {
                await _confirmPasswordField.FocusAsync();
                return;
            }
        }

        if (!_fieldValidity.GetValueOrDefault(nameof(_email)) && _emailField != null)
        {
            await _emailField.FocusAsync();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
