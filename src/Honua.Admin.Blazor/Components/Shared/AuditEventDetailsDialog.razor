@using Honua.Admin.Blazor.Shared.Models
@using System.Text.Json
@using MudBlazor

<MudDialog>
    <DialogContent>
        @if (Event != null)
        {
            <MudStack Spacing="3">
                <MudSimpleTable Dense="true">
                    <tbody>
                        <tr>
                            <td><strong>Event ID:</strong></td>
                            <td class="text-monospace">@Event.Id</td>
                        </tr>
                        <tr>
                            <td><strong>Timestamp:</strong></td>
                            <td>@Event.Timestamp.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss.fff")</td>
                        </tr>
                        <tr>
                            <td><strong>Category:</strong></td>
                            <td><MudChip T="string" Size="Size.Small">@Event.Category</MudChip></td>
                        </tr>
                        <tr>
                            <td><strong>Action:</strong></td>
                            <td>@Event.Action</td>
                        </tr>
                        <tr>
                            <td><strong>User:</strong></td>
                            <td>@(Event.UserIdentifier ?? "System")</td>
                        </tr>
                        @if (Event.UserId.HasValue)
                        {
                            <tr>
                                <td><strong>User ID:</strong></td>
                                <td class="text-monospace">@Event.UserId.Value</td>
                            </tr>
                        }
                        <tr>
                            <td><strong>Status:</strong></td>
                            <td>
                                @if (Event.Success)
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.CheckCircle" Color="Color.Success" Size="Size.Small" />
                                    <span>Success</span>
                                }
                                else
                                {
                                    <MudIcon Icon="@Icons.Material.Filled.Error" Color="Color.Error" Size="Size.Small" />
                                    <span>Failed</span>
                                }
                            </td>
                        </tr>
                        @if (!string.IsNullOrEmpty(Event.ResourceType))
                        {
                            <tr>
                                <td><strong>Resource Type:</strong></td>
                                <td>@Event.ResourceType</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.ResourceId))
                        {
                            <tr>
                                <td><strong>Resource ID:</strong></td>
                                <td class="text-monospace">@Event.ResourceId</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.Description))
                        {
                            <tr>
                                <td><strong>Description:</strong></td>
                                <td>@Event.Description</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.IpAddress))
                        {
                            <tr>
                                <td><strong>IP Address:</strong></td>
                                <td class="text-monospace">@Event.IpAddress</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.UserAgent))
                        {
                            <tr>
                                <td><strong>User Agent:</strong></td>
                                <td style="word-break: break-all;">@Event.UserAgent</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.HttpMethod))
                        {
                            <tr>
                                <td><strong>HTTP Method:</strong></td>
                                <td>@Event.HttpMethod</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.RequestPath))
                        {
                            <tr>
                                <td><strong>Request Path:</strong></td>
                                <td>@Event.RequestPath</td>
                            </tr>
                        }
                        @if (Event.StatusCode.HasValue)
                        {
                            <tr>
                                <td><strong>Status Code:</strong></td>
                                <td>@Event.StatusCode</td>
                            </tr>
                        }
                        @if (Event.DurationMs.HasValue)
                        {
                            <tr>
                                <td><strong>Duration:</strong></td>
                                <td>@Event.DurationMs ms</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.ErrorMessage))
                        {
                            <tr>
                                <td><strong>Error:</strong></td>
                                <td style="color: red;">@Event.ErrorMessage</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.SessionId))
                        {
                            <tr>
                                <td><strong>Session ID:</strong></td>
                                <td class="text-monospace">@Event.SessionId</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.TraceId))
                        {
                            <tr>
                                <td><strong>Trace ID:</strong></td>
                                <td class="text-monospace">@Event.TraceId</td>
                            </tr>
                        }
                        @if (!string.IsNullOrEmpty(Event.Location))
                        {
                            <tr>
                                <td><strong>Location:</strong></td>
                                <td>@Event.Location</td>
                            </tr>
                        }
                        @if (Event.RiskScore.HasValue)
                        {
                            <tr>
                                <td><strong>Risk Score:</strong></td>
                                <td>
                                    <MudChip T="string" Size="Size.Small" Color="@(Event.RiskScore >= 80 ? Color.Error : Event.RiskScore >= 50 ? Color.Warning : Color.Success)">
                                        @Event.RiskScore
                                    </MudChip>
                                </td>
                            </tr>
                        }
                        @if (Event.Tags?.Any() == true)
                        {
                            <tr>
                                <td><strong>Tags:</strong></td>
                                <td>
                                    @foreach (var tag in Event.Tags)
                                    {
                                        <MudChip T="string" Size="Size.Small">@tag</MudChip>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </MudSimpleTable>

                @if (Event.Changes != null && (Event.Changes.Before?.Any() == true || Event.Changes.After?.Any() == true))
                {
                    <MudDivider />
                    <MudText Typo="Typo.subtitle2">Changes</MudText>

                    @if (Event.Changes.ChangedFields?.Any() == true)
                    {
                        <MudText Typo="Typo.caption">Changed fields: @string.Join(", ", Event.Changes.ChangedFields)</MudText>
                    }

                    <MudGrid>
                        @if (Event.Changes.Before?.Any() == true)
                        {
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.body2" Color="Color.Error">Before:</MudText>
                                <MudPaper Elevation="0" Class="pa-2" Style="background-color: #ffe0e0; max-height: 200px; overflow-y: auto;">
                                    <pre style="margin: 0; font-size: 0.75rem;">@FormatJson(Event.Changes.Before)</pre>
                                </MudPaper>
                            </MudItem>
                        }
                        @if (Event.Changes.After?.Any() == true)
                        {
                            <MudItem xs="12" md="6">
                                <MudText Typo="Typo.body2" Color="Color.Success">After:</MudText>
                                <MudPaper Elevation="0" Class="pa-2" Style="background-color: #e0ffe0; max-height: 200px; overflow-y: auto;">
                                    <pre style="margin: 0; font-size: 0.75rem;">@FormatJson(Event.Changes.After)</pre>
                                </MudPaper>
                            </MudItem>
                        }
                    </MudGrid>
                }

                @if (Event.Metadata?.Any() == true)
                {
                    <MudDivider />
                    <MudText Typo="Typo.subtitle2">Additional Metadata</MudText>
                    <MudPaper Elevation="0" Class="pa-3" Style="background-color: #f5f5f5; max-height: 300px; overflow-y: auto;">
                        <pre style="margin: 0; font-size: 0.8rem;">@FormatJson(Event.Metadata)</pre>
                    </MudPaper>
                }
            </MudStack>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Close">Close</MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public AuditEvent? Event { get; set; }

    private void Close()
    {
        MudDialog.Close();
    }

    private string FormatJson(object? obj)
    {
        if (obj == null)
            return "null";

        try
        {
            return JsonSerializer.Serialize(obj, new JsonSerializerOptions
            {
                WriteIndented = true
            });
        }
        catch
        {
            return obj.ToString() ?? "null";
        }
    }
}
