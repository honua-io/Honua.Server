@using Honua.Admin.Blazor.Shared.Services
@using Honua.Admin.Blazor.Shared.Models
@inject DataSourceApiClient DataSourceApi
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudTextField @bind-Value="_dataSourceId"
                          Label="Data Source ID"
                          Required="true"
                          Disabled="@IsEdit"
                          Variant="Variant.Outlined"
                          HelperText="Unique identifier (e.g., 'postgres-main', 'sqlserver-prod')" />

            <MudSelect @bind-Value="_selectedProvider"
                       Label="Provider"
                       Required="true"
                       Variant="Variant.Outlined"
                       OnChange="OnProviderChanged">
                <MudSelectItem Value="@("postgis")">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Storage" Color="Color.Primary" Size="Size.Small" />
                        <MudText>PostGIS / PostgreSQL</MudText>
                    </MudStack>
                </MudSelectItem>
                <MudSelectItem Value="@("sqlserver")">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.CloudQueue" Color="Color.Info" Size="Size.Small" />
                        <MudText>SQL Server</MudText>
                    </MudStack>
                </MudSelectItem>
                <MudSelectItem Value="@("mysql")">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.DataObject" Color="Color.Warning" Size="Size.Small" />
                        <MudText>MySQL</MudText>
                    </MudStack>
                </MudSelectItem>
                <MudSelectItem Value="@("sqlite")">
                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                        <MudIcon Icon="@Icons.Material.Filled.Folder" Color="Color.Secondary" Size="Size.Small" />
                        <MudText>SQLite</MudText>
                    </MudStack>
                </MudSelectItem>
            </MudSelect>

            <MudDivider />

            @if (_selectedProvider == "postgis" || _selectedProvider == "postgresql")
            {
                <MudText Typo="Typo.subtitle2" Color="Color.Primary">PostgreSQL / PostGIS Connection</MudText>

                <MudTextField @bind-Value="_params.Host"
                              Label="Host"
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="e.g., localhost, db.example.com" />

                <MudNumericField @bind-Value="_params.Port"
                                 Label="Port"
                                 Variant="Variant.Outlined"
                                 HelperText="Default: 5432" />

                <MudTextField @bind-Value="_params.Database"
                              Label="Database"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_params.Username"
                              Label="Username"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_params.Password"
                              Label="Password"
                              InputType="InputType.Password"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudSelect @bind-Value="_params.SslMode"
                           Label="SSL Mode"
                           Variant="Variant.Outlined">
                    <MudSelectItem Value="@("Disable")">Disable</MudSelectItem>
                    <MudSelectItem Value="@("Allow")">Allow</MudSelectItem>
                    <MudSelectItem Value="@("Prefer")">Prefer (Recommended)</MudSelectItem>
                    <MudSelectItem Value="@("Require")">Require</MudSelectItem>
                </MudSelect>
            }
            else if (_selectedProvider == "sqlserver")
            {
                <MudText Typo="Typo.subtitle2" Color="Color.Info">SQL Server Connection</MudText>

                <MudTextField @bind-Value="_params.Server"
                              Label="Server"
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="e.g., localhost, server.example.com" />

                <MudTextField @bind-Value="_params.Database"
                              Label="Database"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_params.UserId"
                              Label="User ID"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_params.Password"
                              Label="Password"
                              InputType="InputType.Password"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudSwitch @bind-Value="_params.Encrypt"
                           Label="Encrypt Connection"
                           Color="Color.Primary" />

                <MudSwitch @bind-Value="_params.TrustServerCertificate"
                           Label="Trust Server Certificate"
                           Color="Color.Primary" />
            }
            else if (_selectedProvider == "mysql")
            {
                <MudText Typo="Typo.subtitle2" Color="Color.Warning">MySQL Connection</MudText>

                <MudTextField @bind-Value="_params.Server"
                              Label="Server"
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="e.g., localhost, db.example.com" />

                <MudNumericField @bind-Value="_params.Port"
                                 Label="Port"
                                 Variant="Variant.Outlined"
                                 HelperText="Default: 3306" />

                <MudTextField @bind-Value="_params.Database"
                              Label="Database"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_params.User"
                              Label="User"
                              Required="true"
                              Variant="Variant.Outlined" />

                <MudTextField @bind-Value="_params.Password"
                              Label="Password"
                              InputType="InputType.Password"
                              Required="true"
                              Variant="Variant.Outlined" />
            }
            else if (_selectedProvider == "sqlite")
            {
                <MudText Typo="Typo.subtitle2" Color="Color.Secondary">SQLite Connection</MudText>

                <MudTextField @bind-Value="_params.DataSource"
                              Label="Data Source (File Path)"
                              Required="true"
                              Variant="Variant.Outlined"
                              HelperText="e.g., /data/mydb.sqlite, C:\Data\mydb.db" />
            }

            <MudDivider />

            <MudPaper Outlined="true" Class="pa-3">
                <MudText Typo="Typo.caption" Color="Color.Secondary">Connection String Preview:</MudText>
                <MudText Typo="Typo.body2" Style="font-family: monospace; word-break: break-all;">
                    @GetConnectionStringPreview()
                </MudText>
            </MudPaper>

            @if (_testResult != null)
            {
                <MudAlert Severity="@(_testResult.Success ? Severity.Success : Severity.Error)"
                          Dense="true">
                    @if (_testResult.Success)
                    {
                        <text>Connection successful! (@_testResult.ConnectionTime ms)</text>
                    }
                    else
                    {
                        <text>@_testResult.Message</text>
                    }
                </MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Info"
                   StartIcon="@Icons.Material.Filled.PlayArrow"
                   OnClick="TestConnection"
                   Disabled="@_testing">
            @if (_testing)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <MudText Class="ml-2">Testing...</MudText>
            }
            else
            {
                <text>Test Connection</text>
            }
        </MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Save"
                   Disabled="@_saving">
            @if (_saving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <MudText Class="ml-2">Saving...</MudText>
            }
            else
            {
                <text>@(IsEdit ? "Update" : "Create")</text>
            }
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    MudDialogInstance MudDialog { get; set; } = null!;

    [Parameter]
    public string? DataSourceId { get; set; }

    [Parameter]
    public bool IsEdit { get; set; }

    private string _dataSourceId = string.Empty;
    private string _selectedProvider = "postgis";
    private ConnectionStringParameters _params = new();
    private TestConnectionResponse? _testResult;
    private bool _testing;
    private bool _saving;

    protected override async Task OnInitializedAsync()
    {
        if (IsEdit && !string.IsNullOrEmpty(DataSourceId))
        {
            await LoadDataSourceAsync();
        }
        else
        {
            // Set default port
            _params.Port = 5432;
        }
    }

    private async Task LoadDataSourceAsync()
    {
        try
        {
            var dataSource = await DataSourceApi.GetDataSourceByIdAsync(DataSourceId!);
            if (dataSource != null)
            {
                _dataSourceId = dataSource.Id;
                _selectedProvider = dataSource.Provider.ToLowerInvariant();
                // TODO: Parse connection string back to parameters
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading data source: {ex.Message}", Severity.Error);
        }
    }

    private void OnProviderChanged()
    {
        // Reset params and set default port based on provider
        _params = new ConnectionStringParameters();

        _params.Port = _selectedProvider switch
        {
            "postgis" or "postgresql" => 5432,
            "mysql" => 3306,
            _ => null
        };

        _testResult = null;
    }

    private string GetConnectionStringPreview()
    {
        if (string.IsNullOrEmpty(_selectedProvider))
            return "Select a provider...";

        var connectionString = _params.Build(_selectedProvider);
        return string.IsNullOrEmpty(connectionString) ? "Enter connection details..." : connectionString;
    }

    private async Task TestConnection()
    {
        if (string.IsNullOrEmpty(_dataSourceId))
        {
            Snackbar.Add("Please enter a data source ID", Severity.Warning);
            return;
        }

        var connectionString = _params.Build(_selectedProvider);
        if (string.IsNullOrEmpty(connectionString))
        {
            Snackbar.Add("Please complete the connection details", Severity.Warning);
            return;
        }

        _testing = true;
        _testResult = null;

        try
        {
            // For test, we need to create a temporary data source or use a test endpoint
            // For now, show mock success
            await Task.Delay(500); // Simulate network delay

            _testResult = new TestConnectionResponse
            {
                Success = true,
                Message = "Connection test successful",
                Provider = _selectedProvider,
                ConnectionTime = 125
            };
        }
        catch (Exception ex)
        {
            _testResult = new TestConnectionResponse
            {
                Success = false,
                Message = ex.Message
            };
        }
        finally
        {
            _testing = false;
        }
    }

    private async Task Save()
    {
        if (string.IsNullOrEmpty(_dataSourceId))
        {
            Snackbar.Add("Please enter a data source ID", Severity.Warning);
            return;
        }

        var connectionString = _params.Build(_selectedProvider);
        if (string.IsNullOrEmpty(connectionString))
        {
            Snackbar.Add("Please complete the connection details", Severity.Warning);
            return;
        }

        _saving = true;

        try
        {
            if (IsEdit)
            {
                var request = new UpdateDataSourceRequest
                {
                    Provider = _selectedProvider,
                    ConnectionString = connectionString
                };
                await DataSourceApi.UpdateDataSourceAsync(_dataSourceId, request);
            }
            else
            {
                var request = new CreateDataSourceRequest
                {
                    Id = _dataSourceId,
                    Provider = _selectedProvider,
                    ConnectionString = connectionString
                };
                await DataSourceApi.CreateDataSourceAsync(request);
            }

            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving data source: {ex.Message}", Severity.Error);
        }
        finally
        {
            _saving = false;
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
