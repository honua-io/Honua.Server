@using Honua.Admin.Blazor.Shared.Models
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.body1">
                Change password for user <b>@Username</b>
            </MudText>

            <MudAlert Severity="Severity.Info">
                As an administrator, you can set a new password for this user without knowing their current password.
            </MudAlert>

            <MudTextField @bind-Value="_newPassword"
                          Label="New Password"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Required="true"
                          HelperText="Password must be at least 8 characters" />

            <MudTextField @bind-Value="_confirmPassword"
                          Label="Confirm New Password"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Required="true"
                          HelperText="Re-enter the new password to confirm" />

            <MudStack Row="true" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Small" />
                <MudText Typo="Typo.caption">
                    Password requirements: Minimum 8 characters. Consider using a mix of uppercase, lowercase, numbers, and special characters.
                </MudText>
            </MudStack>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Submit">
            Change Password
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public string? Username { get; set; }

    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string? _errorMessage;

    private void Submit()
    {
        _errorMessage = null;

        // Validate
        if (string.IsNullOrWhiteSpace(_newPassword))
        {
            _errorMessage = "New password is required";
            return;
        }

        if (_newPassword.Length < 8)
        {
            _errorMessage = "Password must be at least 8 characters";
            return;
        }

        if (_newPassword != _confirmPassword)
        {
            _errorMessage = "Passwords do not match";
            return;
        }

        var request = new ChangePasswordRequest
        {
            NewPassword = _newPassword
        };

        MudDialog.Close(DialogResult.Ok(request));
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
