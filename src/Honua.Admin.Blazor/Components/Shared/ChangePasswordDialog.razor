@using Honua.Admin.Blazor.Shared.Models
@using MudBlazor

<MudDialog>
    <DialogContent>
        <MudStack Spacing="3">
            <MudText Typo="Typo.body1">
                Change password for user <b>@Username</b>
            </MudText>

            <MudAlert Severity="Severity.Info">
                As an administrator, you can set a new password for this user without knowing their current password.
            </MudAlert>

            @if (_validationErrors.Any())
            {
                <MudAlert Severity="Severity.Warning">
                    <MudText Typo="Typo.body1"><b>Please fix @_validationErrors.Count error(s):</b></MudText>
                    <MudList Dense="true" Class="mt-2">
                        @foreach (var error in _validationErrors)
                        {
                            <MudListItem Icon="@Icons.Material.Filled.Error" IconColor="Color.Warning">
                                <MudText Typo="Typo.body2">@error</MudText>
                            </MudListItem>
                        }
                    </MudList>
                </MudAlert>
            }

            <MudTextField @ref="_newPasswordField"
                          @bind-Value="_newPassword"
                          Label="New Password"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Required="true"
                          Immediate="true"
                          HelperText="Password must be at least 8 characters"
                          Validation="@(new Func<string, IEnumerable<string>>(ValidateNewPassword))"
                          Adornment="Adornment.End"
                          AdornmentIcon="@GetValidationIcon(nameof(_newPassword))"
                          AdornmentColor="@GetValidationColor(nameof(_newPassword))"
                          OnBlur="@(() => OnFieldBlur(nameof(_newPassword)))" />

            <MudTextField @ref="_confirmPasswordField"
                          @bind-Value="_confirmPassword"
                          Label="Confirm New Password"
                          Variant="Variant.Outlined"
                          InputType="InputType.Password"
                          Required="true"
                          Immediate="true"
                          HelperText="Re-enter the new password to confirm"
                          Validation="@(new Func<string, IEnumerable<string>>(ValidateConfirmPassword))"
                          Adornment="Adornment.End"
                          AdornmentIcon="@GetValidationIcon(nameof(_confirmPassword))"
                          AdornmentColor="@GetValidationColor(nameof(_confirmPassword))"
                          OnBlur="@(() => OnFieldBlur(nameof(_confirmPassword)))" />

            <MudStack Row="true" Spacing="2">
                <MudIcon Icon="@Icons.Material.Filled.Info" Color="Color.Info" Size="Size.Small" />
                <MudText Typo="Typo.caption">
                    Password requirements: Minimum 8 characters. Consider using a mix of uppercase, lowercase, numbers, and special characters.
                </MudText>
            </MudStack>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error">@_errorMessage</MudAlert>
            }
        </MudStack>
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Variant="Variant.Filled"
                   Color="Color.Primary"
                   OnClick="Submit">
            Change Password
        </MudButton>
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter]
    private IMudDialogInstance MudDialog { get; set; } = default!;

    [Parameter]
    public string? Username { get; set; }

    private string _newPassword = string.Empty;
    private string _confirmPassword = string.Empty;
    private string? _errorMessage;

    // Field references
    private MudTextField<string> _newPasswordField = default!;
    private MudTextField<string> _confirmPasswordField = default!;

    // Validation tracking
    private Dictionary<string, bool> _fieldValidity = new();
    private Dictionary<string, bool> _fieldTouched = new();
    private List<string> _validationErrors = new();

    private async Task Submit()
    {
        _errorMessage = null;

        // Mark all fields as touched for validation display
        _fieldTouched[nameof(_newPassword)] = true;
        _fieldTouched[nameof(_confirmPassword)] = true;

        // Validate
        ValidateNewPassword(_newPassword);
        ValidateConfirmPassword(_confirmPassword);

        if (_validationErrors.Any())
        {
            await FocusFirstInvalidField();
            return;
        }

        var request = new ChangePasswordRequest
        {
            NewPassword = _newPassword
        };

        MudDialog.Close(DialogResult.Ok(request));
    }

    private IEnumerable<string> ValidateNewPassword(string password)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(password))
        {
            errors.Add("New password is required");
            UpdateFieldValidity(nameof(_newPassword), false);
        }
        else if (password.Length < 8)
        {
            errors.Add("Password must be at least 8 characters");
            UpdateFieldValidity(nameof(_newPassword), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_newPassword), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private IEnumerable<string> ValidateConfirmPassword(string confirmPassword)
    {
        var errors = new List<string>();

        if (string.IsNullOrWhiteSpace(confirmPassword))
        {
            errors.Add("Please confirm the new password");
            UpdateFieldValidity(nameof(_confirmPassword), false);
        }
        else if (confirmPassword != _newPassword)
        {
            errors.Add("Passwords do not match");
            UpdateFieldValidity(nameof(_confirmPassword), false);
        }
        else
        {
            UpdateFieldValidity(nameof(_confirmPassword), true);
        }

        UpdateValidationSummary();
        return errors;
    }

    private void UpdateFieldValidity(string fieldName, bool isValid)
    {
        _fieldValidity[fieldName] = isValid;
    }

    private void OnFieldBlur(string fieldName)
    {
        _fieldTouched[fieldName] = true;
        StateHasChanged();
    }

    private string GetValidationIcon(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return string.Empty;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Icons.Material.Filled.CheckCircle
            : Icons.Material.Filled.Error;
    }

    private Color GetValidationColor(string fieldName)
    {
        if (!_fieldTouched.GetValueOrDefault(fieldName))
            return Color.Default;

        return _fieldValidity.GetValueOrDefault(fieldName)
            ? Color.Success
            : Color.Error;
    }

    private void UpdateValidationSummary()
    {
        _validationErrors.Clear();

        if (_fieldTouched.GetValueOrDefault(nameof(_newPassword)) && !_fieldValidity.GetValueOrDefault(nameof(_newPassword)))
        {
            _validationErrors.Add("New Password: Invalid or missing (minimum 8 characters)");
        }

        if (_fieldTouched.GetValueOrDefault(nameof(_confirmPassword)) && !_fieldValidity.GetValueOrDefault(nameof(_confirmPassword)))
        {
            _validationErrors.Add("Confirm Password: Passwords do not match");
        }
    }

    private async Task FocusFirstInvalidField()
    {
        if (!_fieldValidity.GetValueOrDefault(nameof(_newPassword)) && _newPasswordField != null)
        {
            await _newPasswordField.FocusAsync();
        }
        else if (!_fieldValidity.GetValueOrDefault(nameof(_confirmPassword)) && _confirmPasswordField != null)
        {
            await _confirmPasswordField.FocusAsync();
        }
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }
}
