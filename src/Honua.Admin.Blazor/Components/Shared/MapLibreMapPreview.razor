@using Microsoft.JSInterop
@inject IJSRuntime JS
@implements IAsyncDisposable

<MudPaper Elevation="2" Class="@Class" Style="@($"height: {Height}px; position: relative; {Style}")">
    @if (_loading)
    {
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000;">
            <MudProgressCircular Indeterminate="true" />
        </div>
    }

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <MudAlert Severity="Severity.Error" Class="ma-4">
            @_errorMessage
        </MudAlert>
    }

    <div id="@_mapContainerId" style="width: 100%; height: 100%;"></div>
</MudPaper>

@code {
    [Parameter]
    public string? Class { get; set; }

    [Parameter]
    public string? Style { get; set; }

    [Parameter]
    public int Height { get; set; } = 400;

    [Parameter]
    public double[]? Center { get; set; }

    [Parameter]
    public double Zoom { get; set; } = 2;

    [Parameter]
    public string? LayerId { get; set; }

    [Parameter]
    public string? ServiceId { get; set; }

    private string _mapContainerId = $"map-{Guid.NewGuid():N}";
    private bool _loading = true;
    private string? _errorMessage;
    private bool _initialized = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeMapAsync();
        }
    }

    private async Task InitializeMapAsync()
    {
        try
        {
            _loading = true;
            StateHasChanged();

            // Initialize map with basic style
            var options = new
            {
                style = new
                {
                    version = 8,
                    sources = new { },
                    layers = new object[] { }
                },
                center = Center ?? new double[] { 0, 0 },
                zoom = Zoom
            };

            await JS.InvokeVoidAsync("honuaMapLibre.initializeMap", _mapContainerId, options);
            _initialized = true;

            // If LayerId is provided, load layer data
            if (!string.IsNullOrEmpty(LayerId) && !string.IsNullOrEmpty(ServiceId))
            {
                await LoadLayerPreviewAsync();
            }

            _loading = false;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to initialize map: {ex.Message}";
            _loading = false;
            StateHasChanged();
        }
    }

    private async Task LoadLayerPreviewAsync()
    {
        try
        {
            // This would fetch actual data from the server
            // For now, we'll use a placeholder
            // TODO: Implement actual layer data fetching
            await Task.CompletedTask;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load layer data: {ex.Message}";
            StateHasChanged();
        }
    }

    public async ValueTask DisposeAsync()
    {
        if (_initialized)
        {
            try
            {
                await JS.InvokeVoidAsync("honuaMapLibre.destroyMap", _mapContainerId);
            }
            catch
            {
                // Ignore errors during disposal
            }
        }
    }

    /// <summary>
    /// Update the map center and zoom
    /// </summary>
    public async Task FlyToAsync(double[] center, double zoom)
    {
        if (_initialized)
        {
            await JS.InvokeVoidAsync("honuaMapLibre.flyTo", _mapContainerId, center, zoom);
        }
    }

    /// <summary>
    /// Add a GeoJSON layer to the map
    /// </summary>
    public async Task AddGeoJsonLayerAsync(string sourceId, object geojson, string layerType, object paint)
    {
        if (_initialized)
        {
            await JS.InvokeVoidAsync("honuaMapLibre.addGeoJsonLayer", _mapContainerId, sourceId, geojson, layerType, paint);
        }
    }

    /// <summary>
    /// Add a vector tile layer to the map
    /// </summary>
    public async Task AddVectorTileLayerAsync(string sourceId, string tilesUrl, string sourceLayer, object style)
    {
        if (_initialized)
        {
            await JS.InvokeVoidAsync("honuaMapLibre.addVectorTileLayer", _mapContainerId, sourceId, tilesUrl, sourceLayer, style);
        }
    }
}
