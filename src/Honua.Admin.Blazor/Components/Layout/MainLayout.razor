@using Honua.Admin.Blazor.Shared.Services
@inherits LayoutComponentBase
@inject FeatureFlagService FeatureFlags
@inject KeyboardShortcutService KeyboardShortcuts
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject NotificationService Notifications
@implements IAsyncDisposable

<MudThemeProvider />
<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1" Dense="@_isMobile">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                      Color="Color.Inherit"
                      Edge="Edge.Start"
                      OnClick="@ToggleDrawer"
                      Title="Toggle menu" />
        <MudText Typo="@(_isMobile ? Typo.h6 : Typo.h5)" Class="ml-3">
            @(_isMobile ? "Honua" : "Honua Admin")
        </MudText>
        <MudSpacer />

        @if (!_isMobile)
        {
            <GlobalSearch Class="mx-4" Style="max-width: 500px; width: 100%;" />
            <MudSpacer />

            @* License Tier Badge *@
            @if (_featureFlags != null)
            {
                <MudChip Color="@GetTierColor()" Size="Size.Small" Icon="@Icons.Material.Filled.Badge" Class="mr-2">
                    @_featureFlags.Tier
                </MudChip>

                @if (_featureFlags.DaysUntilExpiration <= 30 && _featureFlags.DaysUntilExpiration > 0)
                {
                    <MudChip Color="Color.Warning" Size="Size.Small" Icon="@Icons.Material.Filled.Warning" Class="mr-2">
                        Expires in @_featureFlags.DaysUntilExpiration days
                    </MudChip>
                }
                else if (_featureFlags.DaysUntilExpiration <= 0)
                {
                    <MudChip Color="Color.Error" Size="Size.Small" Icon="@Icons.Material.Filled.Error" Class="mr-2">
                        License Expired
                    </MudChip>
                }
            }
        }

        <LoginDisplay />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen"
               ClipMode="DrawerClipMode.Always"
               Elevation="2"
               Variant="@(_isMobile ? DrawerVariant.Temporary : DrawerVariant.Persistent)">
        <NavMenu />
    </MudDrawer>

    <MudMainContent Class="main-content">
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="@(_isMobile ? "mt-2 pa-2" : "mt-4 pa-4")">
            @if (!_isMobile)
            {
                <MudBreadcrumbs Items="_breadcrumbs"></MudBreadcrumbs>
            }
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    private bool _isMobile = false;
    private List<BreadcrumbItem> _breadcrumbs = new();
    private FeatureFlagState? _featureFlags;
    private string? _currentPage;

    [Inject] private NavigationState NavState { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        // Subscribe to breadcrumb changes
        NavState.OnChange += UpdateBreadcrumbs;
        UpdateBreadcrumbs();

        // Load feature flags for license tier display
        _featureFlags = await FeatureFlags.GetFeatureFlagsAsync();

        // Check if mobile on initial load
        CheckIfMobile();

        // Initialize keyboard shortcuts
        await InitializeKeyboardShortcutsAsync();

        // Track current page for context-dependent shortcuts
        Navigation.LocationChanged += OnLocationChanged;
        UpdateCurrentPage();
    }

    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            CheckIfMobile();
        }
    }

    private async Task InitializeKeyboardShortcutsAsync()
    {
        await KeyboardShortcuts.InitializeAsync();

        // Navigation shortcuts
        KeyboardShortcuts.Register(AdminShortcuts.GoToServices, () => NavigateToPage("/services"),
            "Go to Services", "Navigation");
        KeyboardShortcuts.Register(AdminShortcuts.GoToLayers, () => NavigateToPage("/layers"),
            "Go to Layers", "Navigation");
        KeyboardShortcuts.Register(AdminShortcuts.GoToMaps, () => NavigateToPage("/maps"),
            "Go to Maps", "Navigation");

        // Search shortcuts
        KeyboardShortcuts.Register(AdminShortcuts.FocusSearch, FocusGlobalSearch,
            "Focus global search", "Search");

        // Action shortcuts
        KeyboardShortcuts.Register(AdminShortcuts.NewItem, HandleNewItem,
            "Create new item (context-dependent)", "Actions");
        KeyboardShortcuts.Register(AdminShortcuts.Refresh, HandleRefresh,
            "Refresh current page", "Actions");

        // General shortcuts
        KeyboardShortcuts.Register(AdminShortcuts.ShowHelp, ShowKeyboardHelp,
            "Show keyboard shortcuts help", "General");
        KeyboardShortcuts.Register("Shift+?", ShowKeyboardHelp,
            "Show keyboard shortcuts help", "General");
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        UpdateCurrentPage();
    }

    private void UpdateCurrentPage()
    {
        var uri = new Uri(Navigation.Uri);
        _currentPage = uri.AbsolutePath.ToLower();
    }

    private void CheckIfMobile()
    {
        // Simple heuristic: close drawer on mobile
        // In a real app, you'd use JS interop to check window.innerWidth
        _isMobile = false; // Default to desktop, can be enhanced with JS interop
    }

    private void UpdateBreadcrumbs()
    {
        _breadcrumbs = NavState.Breadcrumbs.ToList();
        StateHasChanged();
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private Color GetTierColor() => _featureFlags?.Tier switch
    {
        LicenseTier.Enterprise => Color.Success,
        LicenseTier.Professional => Color.Info,
        _ => Color.Default
    };

    // Keyboard shortcut handlers

    private async Task FocusGlobalSearch()
    {
        try
        {
            // Focus the global search autocomplete input
            await JSRuntime.InvokeVoidAsync("HonuaAdmin.KeyboardShortcuts.focusElementBySelector",
                ".mud-autocomplete input");
            Notifications.Info("Search focused - press Esc to cancel");
        }
        catch
        {
            // Silently fail if search not available
        }
    }

    private void NavigateToPage(string url)
    {
        Navigation.NavigateTo(url);
        Notifications.Info($"Navigated to {url}");
    }

    private void HandleNewItem()
    {
        // Context-dependent "New" action
        var message = _currentPage switch
        {
            var p when p.Contains("/services") => "Create new service",
            var p when p.Contains("/layers") => "Create new layer",
            var p when p.Contains("/maps") => "Create new map",
            var p when p.Contains("/folders") => "Create new folder",
            var p when p.Contains("/datasources") => "Create new data source",
            var p when p.Contains("/users") => "Create new user",
            var p when p.Contains("/roles") => "Create new role",
            _ => "Create new item (navigate to a specific page first)"
        };

        // In a real implementation, this would trigger the actual creation dialog
        // For now, just show feedback
        Notifications.Info(message);
    }

    private async Task HandleRefresh()
    {
        // Refresh current page
        Notifications.Info("Refreshing page...");
        Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
        await Task.CompletedTask;
    }

    private async Task ShowKeyboardHelp()
    {
        var shortcuts = KeyboardShortcuts.GetAllShortcuts();
        var parameters = new DialogParameters
        {
            { "Shortcuts", shortcuts }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        await DialogService.ShowAsync<KeyboardShortcutsHelp>("Keyboard Shortcuts", parameters, options);
    }

    public async ValueTask DisposeAsync()
    {
        NavState.OnChange -= UpdateBreadcrumbs;
        Navigation.LocationChanged -= OnLocationChanged;

        if (KeyboardShortcuts != null)
        {
            await KeyboardShortcuts.DisposeAsync();
        }
    }
}
