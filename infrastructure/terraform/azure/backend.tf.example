# ============================================================================
# Terraform Backend Configuration - Azure
# ============================================================================
# This file configures remote state storage with state locking for the Azure
# AI Deployment Consultant infrastructure.
#
# Prerequisites:
#   1. Deploy state backend infrastructure:
#      cd ../state-backend/azure && terraform apply
#   2. Copy this file: cp backend.tf.example backend.tf
#   3. Update values below with outputs from state backend deployment
#   4. Run: terraform init -migrate-state
#
# State locking is automatic with Azure Blob Leases - no additional resources needed!
# ============================================================================

terraform {
  backend "azurerm" {
    # Resource group containing the storage account
    resource_group_name = "rg-honua-tfstate-shared"

    # Storage account for state storage
    storage_account_name = "sthonuatfstatea1b2c3"

    # Container name for state files
    container_name = "tfstate"

    # Path to state file within container
    # Use a unique path for each deployment
    key = "azure/ai-consultant/terraform.tfstate"

    # Optional: Specify access key directly (not recommended, use environment variable instead)
    # access_key = "storage_account_access_key"

    # Optional: Use SAS token instead of access key
    # sas_token = "storage_account_sas_token"

    # Optional: Use Azure AD authentication (recommended for production)
    # use_azuread_auth = true

    # Optional: Use Managed Identity (for Azure VMs/Container Instances)
    # use_msi = true
  }
}

# ============================================================================
# Authentication Methods (in order of preference)
# ============================================================================
# 1. Azure CLI (development):
#    - Run: az login
#    - Terraform will use your Azure CLI credentials
#    - No additional configuration needed
#
# 2. Managed Identity (production, Azure VMs/Container Instances):
#    - Set: use_msi = true
#    - Grant Storage Blob Data Contributor role to the identity
#
# 3. Service Principal (CI/CD):
#    - Set environment variables:
#      export ARM_CLIENT_ID="..."
#      export ARM_CLIENT_SECRET="..."
#      export ARM_SUBSCRIPTION_ID="..."
#      export ARM_TENANT_ID="..."
#
# 4. Access Key (least secure, not recommended):
#    - Set environment variable: export ARM_ACCESS_KEY="..."
#    - Or use Key Vault reference in backend config
# ============================================================================

# ============================================================================
# State Locking Behavior (Azure Blob Leases)
# ============================================================================
# Azure backend uses blob leases for state locking:
#   1. When terraform plan/apply/destroy runs, it acquires a lease on the state blob
#   2. Lease is held for 60 seconds and automatically renewed
#   3. If another process tries to acquire the lease, it waits/fails
#   4. Lease is automatically released when operation completes
#   5. If Terraform crashes, lease expires after 60 seconds
#
# Manual lock management (if needed):
#   - Force unlock: terraform force-unlock <lease-id>
#   - View lease: Check blob properties in Azure Portal/Storage Explorer
#
# No additional resources like DynamoDB are needed - leasing is built into
# Azure Blob Storage!
# ============================================================================

# ============================================================================
# Using Access Key from Key Vault (Recommended for Shared Access)
# ============================================================================
# Instead of hardcoding access key, reference it from environment variable:
#
# Linux/macOS:
#   export ARM_ACCESS_KEY=$(az keyvault secret show \
#     --vault-name kv-tfstate-xyz \
#     --name terraform-state-storage-key \
#     --query value -o tsv)
#
# Windows PowerShell:
#   $env:ARM_ACCESS_KEY = (az keyvault secret show `
#     --vault-name kv-tfstate-xyz `
#     --name terraform-state-storage-key `
#     --query value -o tsv)
#
# Then run: terraform init
# ============================================================================
