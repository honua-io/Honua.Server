# Promtail Configuration for Honua Process Framework
# Collects logs from Docker containers and forwards to Loki
# Supports structured logging with JSON parsing

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push
    batchwait: 1s
    batchsize: 1048576  # 1MB
    timeout: 10s
    backoff_config:
      min_period: 500ms
      max_period: 5m
      max_retries: 10
    external_labels:
      cluster: honua-process-testing
      environment: local

scrape_configs:
  # Docker container logs - General
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.project=honua-process-testing"]
    relabel_configs:
      # Add container name as label
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'

      # Add compose service name
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'service'

      # Add container ID
      - source_labels: ['__meta_docker_container_id']
        regex: '(.{12})'
        target_label: 'container_id'

      # Add container labels as log labels
      - source_labels: ['__meta_docker_container_label_component']
        target_label: 'component'

      # Add network information
      - source_labels: ['__meta_docker_container_network_mode']
        target_label: 'network_mode'

    pipeline_stages:
      # Parse timestamp from log line
      - regex:
          expression: '^(?P<timestamp>\S+\s+\S+)\s+(?P<level>\S+)\s+(?P<message>.*)'

      # Set timestamp if available
      - timestamp:
          source: timestamp
          format: '2006-01-02T15:04:05.000000000Z07:00'
          fallback_formats:
            - '2006-01-02T15:04:05.000Z'
            - '2006-01-02 15:04:05'
            - RFC3339
            - RFC3339Nano

      # Extract log level
      - labels:
          level:

      # Parse JSON logs if present
      - json:
          expressions:
            level: level
            timestamp: timestamp
            message: message
            trace_id: trace_id
            span_id: span_id
            process_id: process_id
            process_name: process_name
            step_name: step_name
            source_context: source_context
            exception: exception
          source: message

      # Add structured labels
      - labels:
          trace_id:
          span_id:
          process_id:
          process_name:
          step_name:
          source_context:

      # Drop empty labels
      - labeldrop:
          - filename
          - stream

  # Honua.Cli.AI specific logs with enhanced parsing
  - job_name: honua-cli-ai
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["service=honua-cli-ai"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        regex: '/(.*)'
        target_label: 'container'
      - source_labels: ['__meta_docker_container_id']
        regex: '(.{12})'
        target_label: 'container_id'
    pipeline_stages:
      # Parse Serilog structured JSON output
      - json:
          expressions:
            timestamp: Timestamp
            level: Level
            message: RenderedMessage
            message_template: MessageTemplate
            exception: Exception
            properties: Properties
            trace_id: Properties.trace_id
            span_id: Properties.span_id
            process_id: Properties.ProcessId
            process_name: Properties.ProcessName
            step_name: Properties.StepName
            source_context: Properties.SourceContext
            thread_id: Properties.ThreadId
            machine_name: Properties.MachineName

      # Set timestamp from Serilog
      - timestamp:
          source: timestamp
          format: RFC3339Nano

      # Map Serilog levels to standard levels
      - template:
          source: level
          template: '{{ if eq .level "Warning" }}WARN{{ else if eq .level "Information" }}INFO{{ else }}{{ .level | ToUpper }}{{ end }}'

      # Add labels for efficient querying
      - labels:
          level:
          trace_id:
          span_id:
          process_id:
          process_name:
          step_name:
          source_context:
          machine_name:

      # Add metrics from logs
      - metrics:
          error_total:
            type: Counter
            description: "Total number of error logs"
            source: level
            config:
              action: inc
              match_all: true
              value: "1"

          process_step_duration:
            type: Histogram
            description: "Process step duration from logs"
            source: duration_ms
            config:
              buckets: [100, 500, 1000, 5000, 10000, 30000, 60000]

  # Redis logs
  - job_name: redis
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=redis"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - replacement: 'redis'
        target_label: 'service'
    pipeline_stages:
      - regex:
          expression: '^(?P<pid>\d+):(?P<role>\w+)\s+(?P<timestamp>\d+\s+\w+\s+\d+:\d+:\d+\.\d+)\s+(?P<level>[*#.-])\s+(?P<message>.*)'
      - labels:
          role:
          level:
      - timestamp:
          source: timestamp
          format: '02 Jan 15:04:05.000'

  # Prometheus logs
  - job_name: prometheus
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=prometheus"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - replacement: 'prometheus'
        target_label: 'service'
    pipeline_stages:
      - regex:
          expression: '^level=(?P<level>\w+)\s+ts=(?P<timestamp>[\d\-T:.Z]+)\s+caller=(?P<caller>\S+)\s+(?P<message>.*)'
      - labels:
          level:
          caller:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # Grafana logs
  - job_name: grafana
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=grafana"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - replacement: 'grafana'
        target_label: 'service'
    pipeline_stages:
      - regex:
          expression: '^t=(?P<timestamp>[\d\-T:.Z]+)\s+lvl=(?P<level>\w+)\s+msg="(?P<message>[^"]+)"\s*(?P<context>.*)?'
      - labels:
          level:
      - timestamp:
          source: timestamp
          format: '2006-01-02T15:04:05-0700'

  # OpenTelemetry Collector logs
  - job_name: otel-collector
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=otel-collector"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - replacement: 'otel-collector'
        target_label: 'service'
    pipeline_stages:
      - json:
          expressions:
            level: level
            timestamp: ts
            logger: logger
            message: msg
            caller: caller
      - labels:
          level:
          logger:
      - timestamp:
          source: timestamp
          format: Unix

  # Tempo logs
  - job_name: tempo
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=tempo"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - replacement: 'tempo'
        target_label: 'service'
    pipeline_stages:
      - regex:
          expression: '^level=(?P<level>\w+)\s+ts=(?P<timestamp>[\d\-T:.Z]+)\s+caller=(?P<caller>\S+)\s+msg="(?P<message>[^"]+)"'
      - labels:
          level:
          caller:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

  # Loki own logs
  - job_name: loki
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
        refresh_interval: 5s
        filters:
          - name: label
            values: ["com.docker.compose.service=loki"]
    relabel_configs:
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container'
      - replacement: 'loki'
        target_label: 'service'
    pipeline_stages:
      - regex:
          expression: '^level=(?P<level>\w+)\s+ts=(?P<timestamp>[\d\-T:.Z]+)\s+caller=(?P<caller>\S+)\s+msg="(?P<message>[^"]+)"'
      - labels:
          level:
          caller:
      - timestamp:
          source: timestamp
          format: RFC3339Nano

# Limits for Promtail
limits_config:
  readline_rate: 10000
  readline_burst: 20000
  max_streams: 10000
