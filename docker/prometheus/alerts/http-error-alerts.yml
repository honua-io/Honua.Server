groups:
  - name: http_error_rates
    interval: 30s
    rules:
      - alert: HighHttpErrorRate
        expr: |
          (
            sum(rate(honua_http_errors_total{job="honua"}[5m]))
            /
            sum(rate(honua_http_requests_total{job="honua"}[5m]))
          ) > 0.05
        for: 5m
        labels:
          severity: critical
          service: honua
          category: availability
        annotations:
          summary: "High HTTP error rate detected"
          description: "Overall HTTP error rate is {{ $value | humanizePercentage }} (threshold: 5%). This includes both 4xx and 5xx errors."
          runbook_url: "https://docs.honua.io/runbooks/high-error-rate"

      - alert: High5xxErrorRate
        expr: |
          (
            sum(rate(honua_http_errors_total{job="honua",http_status_class="5xx"}[5m]))
            /
            sum(rate(honua_http_requests_total{job="honua"}[5m]))
          ) > 0.01
        for: 3m
        labels:
          severity: critical
          service: honua
          category: availability
        annotations:
          summary: "High 5xx server error rate detected"
          description: "Server error rate (5xx) is {{ $value | humanizePercentage }} (threshold: 1%). This indicates server-side issues."
          runbook_url: "https://docs.honua.io/runbooks/high-5xx-error-rate"

      - alert: High4xxErrorRate
        expr: |
          (
            sum(rate(honua_http_errors_total{job="honua",http_status_class="4xx"}[5m]))
            /
            sum(rate(honua_http_requests_total{job="honua"}[5m]))
          ) > 0.2
        for: 10m
        labels:
          severity: warning
          service: honua
          category: availability
        annotations:
          summary: "High 4xx client error rate detected"
          description: "Client error rate (4xx) is {{ $value | humanizePercentage }} (threshold: 20%). This may indicate API misuse or documentation issues."
          runbook_url: "https://docs.honua.io/runbooks/high-4xx-error-rate"

      - alert: EndpointHighErrorRate
        expr: |
          (
            sum(rate(honua_http_errors_total{job="honua"}[5m])) by (http_endpoint)
            /
            sum(rate(honua_http_requests_total{job="honua"}[5m])) by (http_endpoint)
          ) > 0.1
        for: 5m
        labels:
          severity: warning
          service: honua
          category: availability
        annotations:
          summary: "High error rate on endpoint {{ $labels.http_endpoint }}"
          description: "Endpoint {{ $labels.http_endpoint }} has error rate {{ $value | humanizePercentage }} (threshold: 10%)"
          runbook_url: "https://docs.honua.io/runbooks/endpoint-high-error-rate"

      - alert: ValidationErrorSpike
        expr: |
          sum(rate(honua_http_errors_total{job="honua",error_type="validation"}[5m])) > 5
        for: 5m
        labels:
          severity: warning
          service: honua
          category: validation
        annotations:
          summary: "Spike in validation errors detected"
          description: "Validation error rate is {{ $value | humanize }} per second. This may indicate problematic client integration or API changes."
          runbook_url: "https://docs.honua.io/runbooks/validation-error-spike"

      - alert: AuthenticationErrorSpike
        expr: |
          sum(rate(honua_http_errors_total{job="honua",error_type="auth"}[5m])) > 2
        for: 3m
        labels:
          severity: warning
          service: honua
          category: security
        annotations:
          summary: "Spike in authentication errors detected"
          description: "Authentication error rate is {{ $value | humanize }} per second. This may indicate credential issues or a security incident."
          runbook_url: "https://docs.honua.io/runbooks/auth-error-spike"

      - alert: DatabaseErrorSpike
        expr: |
          sum(rate(honua_http_errors_total{job="honua",error_type="database"}[5m])) > 0.5
        for: 2m
        labels:
          severity: critical
          service: honua
          category: database
        annotations:
          summary: "Spike in database errors detected"
          description: "Database error rate is {{ $value | humanize }} per second. Check database connectivity and health."
          runbook_url: "https://docs.honua.io/runbooks/database-error-spike"

      - alert: TimeoutErrorSpike
        expr: |
          sum(rate(honua_http_errors_total{job="honua",error_type="timeout"}[5m])) > 1
        for: 5m
        labels:
          severity: warning
          service: honua
          category: performance
        annotations:
          summary: "Spike in timeout errors detected"
          description: "Timeout error rate is {{ $value | humanize }} per second. Check downstream service health and network latency."
          runbook_url: "https://docs.honua.io/runbooks/timeout-error-spike"

      - alert: NotFoundErrorSpike
        expr: |
          sum(rate(honua_http_errors_total{job="honua",error_type="not_found"}[5m])) > 10
        for: 10m
        labels:
          severity: info
          service: honua
          category: business
        annotations:
          summary: "Spike in 404 Not Found errors"
          description: "404 error rate is {{ $value | humanize }} per second. This may indicate broken links or missing resources."
          runbook_url: "https://docs.honua.io/runbooks/not-found-spike"

  - name: http_latency_percentiles
    interval: 30s
    rules:
      - alert: HighP95Latency
        expr: |
          histogram_quantile(0.95,
            sum(rate(honua_http_request_duration_milliseconds_bucket{job="honua"}[5m])) by (le)
          ) > 2000
        for: 10m
        labels:
          severity: warning
          service: honua
          category: performance
        annotations:
          summary: "High p95 HTTP latency detected"
          description: "p95 latency is {{ $value | humanize }}ms (threshold: 2000ms)"
          runbook_url: "https://docs.honua.io/runbooks/high-p95-latency"

      - alert: CriticalP95Latency
        expr: |
          histogram_quantile(0.95,
            sum(rate(honua_http_request_duration_milliseconds_bucket{job="honua"}[5m])) by (le)
          ) > 5000
        for: 5m
        labels:
          severity: critical
          service: honua
          category: performance
        annotations:
          summary: "Critical p95 HTTP latency detected"
          description: "p95 latency is {{ $value | humanize }}ms (threshold: 5000ms). Users experiencing severe degradation."
          runbook_url: "https://docs.honua.io/runbooks/critical-p95-latency"

      - alert: HighP99Latency
        expr: |
          histogram_quantile(0.99,
            sum(rate(honua_http_request_duration_milliseconds_bucket{job="honua"}[5m])) by (le)
          ) > 5000
        for: 10m
        labels:
          severity: warning
          service: honua
          category: performance
        annotations:
          summary: "High p99 HTTP latency detected"
          description: "p99 latency is {{ $value | humanize }}ms (threshold: 5000ms)"
          runbook_url: "https://docs.honua.io/runbooks/high-p99-latency"

      - alert: CriticalP99Latency
        expr: |
          histogram_quantile(0.99,
            sum(rate(honua_http_request_duration_milliseconds_bucket{job="honua"}[5m])) by (le)
          ) > 10000
        for: 5m
        labels:
          severity: critical
          service: honua
          category: performance
        annotations:
          summary: "Critical p99 HTTP latency detected"
          description: "p99 latency is {{ $value | humanize }}ms (threshold: 10000ms). Severe performance degradation."
          runbook_url: "https://docs.honua.io/runbooks/critical-p99-latency"

      - alert: HighP999Latency
        expr: |
          histogram_quantile(0.999,
            sum(rate(honua_http_request_duration_milliseconds_bucket{job="honua"}[5m])) by (le)
          ) > 15000
        for: 10m
        labels:
          severity: warning
          service: honua
          category: performance
        annotations:
          summary: "High p99.9 HTTP latency detected"
          description: "p99.9 latency is {{ $value | humanize }}ms (threshold: 15000ms)"
          runbook_url: "https://docs.honua.io/runbooks/high-p999-latency"

      - alert: EndpointHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(honua_http_request_duration_milliseconds_bucket{job="honua"}[5m])) by (http_endpoint, le)
          ) > 3000
        for: 10m
        labels:
          severity: warning
          service: honua
          category: performance
        annotations:
          summary: "High latency on endpoint {{ $labels.http_endpoint }}"
          description: "Endpoint {{ $labels.http_endpoint }} has p95 latency {{ $value | humanize }}ms (threshold: 3000ms)"
          runbook_url: "https://docs.honua.io/runbooks/endpoint-high-latency"

  - name: http_error_budget
    interval: 1m
    rules:
      - alert: ErrorBudgetExhausted
        expr: |
          (
            1 - (
              sum(rate(honua_http_errors_total{job="honua"}[1h]))
              /
              sum(rate(honua_http_requests_total{job="honua"}[1h]))
            )
          ) < 0.995
        for: 5m
        labels:
          severity: critical
          service: honua
          category: slo
        annotations:
          summary: "Error budget exhausted (1h window)"
          description: "1-hour availability is {{ $value | humanizePercentage }} (SLO: 99.5%). Error budget exhausted."
          runbook_url: "https://docs.honua.io/runbooks/error-budget-exhausted"

      - alert: ErrorBudgetBurning
        expr: |
          (
            sum(rate(honua_http_errors_total{job="honua"}[10m]))
            /
            sum(rate(honua_http_requests_total{job="honua"}[10m]))
          ) > 0.02
        for: 5m
        labels:
          severity: warning
          service: honua
          category: slo
        annotations:
          summary: "Error budget burning fast"
          description: "Error rate is {{ $value | humanizePercentage }} over 10m (threshold: 2%). Error budget burning quickly."
          runbook_url: "https://docs.honua.io/runbooks/error-budget-burning"

  - name: http_error_anomalies
    interval: 1m
    rules:
      - alert: SuddenErrorRateIncrease
        expr: |
          (
            sum(rate(honua_http_errors_total{job="honua"}[5m]))
            /
            sum(rate(honua_http_errors_total{job="honua"}[1h] offset 1h))
          ) > 5
        for: 3m
        labels:
          severity: warning
          service: honua
          category: anomaly
        annotations:
          summary: "Sudden increase in error rate detected"
          description: "Error rate increased by {{ $value }}x compared to 1 hour ago. Current rate: {{ with query \"sum(rate(honua_http_errors_total{job='honua'}[5m]))\" }}{{ . | first | value | humanize }}{{ end }} errors/s"
          runbook_url: "https://docs.honua.io/runbooks/error-rate-anomaly"

      - alert: UnusualStatusCodeDistribution
        expr: |
          sum(rate(honua_http_errors_total{job="honua",http_status_code="503"}[5m])) > 1
        for: 5m
        labels:
          severity: critical
          service: honua
          category: availability
        annotations:
          summary: "Service returning 503 Service Unavailable errors"
          description: "503 error rate is {{ $value | humanize }} per second. Service may be overloaded or in degraded state."
          runbook_url: "https://docs.honua.io/runbooks/503-errors"
