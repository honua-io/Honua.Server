groups:
  - name: warnings
    interval: 60s
    rules:
      # Performance Warnings
      - alert: HighLatency
        expr: |
          histogram_quantile(0.95,
            rate(honua_api_request_duration_bucket[5m])
          ) > 2000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High API latency detected"
          description: "95th percentile latency is {{ $value }}ms (threshold: 2000ms)"

      - alert: SlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            rate(pg_stat_statements_mean_exec_time_bucket[5m])
          ) > 1000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time is {{ $value }}ms (threshold: 1000ms)"

      # Cache Performance
      - alert: LowCacheHitRatio
        expr: |
          (
            rate(honua_cache_hits_total[5m]) /
            (rate(honua_cache_hits_total[5m]) + rate(honua_cache_misses_total[5m]))
          ) < 0.7
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Low cache hit ratio"
          description: "Cache hit ratio is {{ $value | humanizePercentage }} (threshold: 70%)"

      - alert: RasterCacheMissRateHigh
        expr: |
          (
            rate(honua_raster_cache_misses_total[10m]) /
            rate(honua_raster_cache_requests_total[10m])
          ) > 0.4
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "High raster cache miss rate"
          description: "Raster cache miss rate is {{ $value | humanizePercentage }} (threshold: 40%)"

      # Resource Warnings
      - alert: DiskSpaceWarning
        expr: |
          (
            node_filesystem_avail_bytes{mountpoint="/",fstype!="rootfs"} /
            node_filesystem_size_bytes{mountpoint="/",fstype!="rootfs"}
          ) < 0.2
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Disk space running low"
          description: "Available disk space is {{ $value | humanizePercentage }} (threshold: 20%)"

      - alert: HighCPUUsage
        expr: |
          (
            100 - (avg by (instance) (rate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
          ) > 80
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "High CPU usage"
          description: "CPU usage is {{ $value }}% (threshold: 80%)"

      - alert: HighMemoryUsage
        expr: |
          (
            1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
          ) > 0.8
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High memory usage"
          description: "Memory usage is {{ $value | humanizePercentage }} (threshold: 80%)"

      # Database Warnings
      - alert: DatabaseConnectionsHigh
        expr: |
          (
            sum(pg_stat_activity_count) /
            pg_settings_max_connections
          ) > 0.7
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Database connection pool usage high"
          description: "Database connections at {{ $value | humanizePercentage }} of maximum"

      - alert: LongRunningQueries
        expr: |
          count(pg_stat_activity_seconds > 300) > 0
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Long-running database queries detected"
          description: "{{ $value }} queries running for more than 5 minutes"

      # Background Job Warnings
      - alert: PreseedJobFailures
        expr: |
          rate(honua_preseed_failures_total[15m]) > 0.1
        for: 15m
        labels:
          severity: warning
        annotations:
          summary: "Preseed job failures detected"
          description: "Preseed jobs failing at {{ $value }} failures/second"

      - alert: PreseedJobBacklog
        expr: |
          honua_preseed_queue_size > 1000
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: "Large preseed job backlog"
          description: "{{ $value }} preseed jobs queued (threshold: 1000)"

      # Storage Warnings
      - alert: S3UploadFailures
        expr: |
          rate(honua_storage_upload_errors_total{backend="s3"}[10m]) > 0.05
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "S3 upload failures detected"
          description: "S3 uploads failing at {{ $value }} errors/second"

      # API Protocol Warnings
      - alert: WMSRequestSlowdown
        expr: |
          histogram_quantile(0.95,
            rate(honua_api_request_duration_bucket{api_protocol="wms"}[5m])
          ) > 3000
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "WMS requests are slow"
          description: "95th percentile WMS latency is {{ $value }}ms (threshold: 3000ms)"

      - alert: VectorTileGenerationSlow
        expr: |
          histogram_quantile(0.95,
            rate(honua_api_request_duration_bucket{api_protocol="vector-tiles"}[5m])
          ) > 1500
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Vector tile generation is slow"
          description: "95th percentile vector tile latency is {{ $value }}ms (threshold: 1500ms)"
