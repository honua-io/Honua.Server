apiVersion: v1
kind: Secret
metadata:
  name: {{ include "honua-server.fullname" . }}-secret
  labels:
    {{- include "honua-server.labels" . | nindent 4 }}
type: Opaque
stringData:
  # Database connection string
  database-connection-string: |
    {{- $dbHost := include "honua-server.databaseHost" . -}}
    {{- $dbPort := include "honua-server.databasePort" . -}}
    {{- $dbName := .Values.database.name -}}
    {{- $dbUser := .Values.database.username -}}
    {{- $sslMode := .Values.database.sslMode | default "prefer" -}}
    Host={{ $dbHost }};Port={{ $dbPort }};Database={{ $dbName }};Username={{ $dbUser }};Password=${DB_PASSWORD};SSL Mode={{ $sslMode }};Pooling=true;Minimum Pool Size={{ .Values.database.pooling.minPoolSize | default 5 }};Maximum Pool Size={{ .Values.database.pooling.maxPoolSize | default 100 }};

  {{- if or .Values.redis.enabled .Values.redis.external }}
  # Redis connection string
  redis-connection-string: |
    {{- $redisHost := include "honua-server.redisHost" . -}}
    {{- $redisPort := include "honua-server.redisPort" . -}}
    {{- if .Values.redis.ssl.enabled -}}
    {{ $redisHost }}:{{ $redisPort }},ssl=true,password=${REDIS_PASSWORD}
    {{- else -}}
    {{ $redisHost }}:{{ $redisPort }},password=${REDIS_PASSWORD}
    {{- end }}
  {{- end }}
