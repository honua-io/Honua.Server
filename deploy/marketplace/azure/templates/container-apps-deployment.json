{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "metadata": {
    "description": "Honua IO Server - Azure Container Apps Serverless Deployment"
  },
  "parameters": {
    "containerAppName": {
      "type": "string",
      "defaultValue": "honua-server",
      "metadata": {
        "description": "Name of the Container App"
      }
    },
    "location": {
      "type": "string",
      "defaultValue": "[resourceGroup().location]",
      "metadata": {
        "description": "Azure region"
      }
    },
    "imageTag": {
      "type": "string",
      "defaultValue": "latest",
      "metadata": {
        "description": "Docker image tag"
      }
    },
    "minReplicas": {
      "type": "int",
      "defaultValue": 1,
      "minValue": 0,
      "maxValue": 30,
      "metadata": {
        "description": "Minimum number of replicas"
      }
    },
    "maxReplicas": {
      "type": "int",
      "defaultValue": 10,
      "minValue": 1,
      "maxValue": 30,
      "metadata": {
        "description": "Maximum number of replicas"
      }
    },
    "cpuCores": {
      "type": "string",
      "defaultValue": "1.0",
      "allowedValues": [
        "0.25",
        "0.5",
        "0.75",
        "1.0",
        "1.25",
        "1.5",
        "1.75",
        "2.0"
      ],
      "metadata": {
        "description": "CPU cores per replica"
      }
    },
    "memorySize": {
      "type": "string",
      "defaultValue": "2Gi",
      "allowedValues": [
        "0.5Gi",
        "1Gi",
        "1.5Gi",
        "2Gi",
        "3Gi",
        "4Gi"
      ],
      "metadata": {
        "description": "Memory per replica"
      }
    },
    "licenseTier": {
      "type": "string",
      "defaultValue": "Professional",
      "allowedValues": [
        "Free",
        "Professional",
        "Enterprise"
      ],
      "metadata": {
        "description": "Honua IO license tier"
      }
    },
    "postgresServerName": {
      "type": "string",
      "defaultValue": "[concat(parameters('containerAppName'), '-db-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name of PostgreSQL Flexible Server"
      }
    },
    "postgresSku": {
      "type": "string",
      "defaultValue": "Standard_D2s_v3",
      "metadata": {
        "description": "PostgreSQL SKU"
      }
    },
    "postgresStorageSize": {
      "type": "int",
      "defaultValue": 128,
      "metadata": {
        "description": "PostgreSQL storage in GB"
      }
    },
    "redisName": {
      "type": "string",
      "defaultValue": "[concat(parameters('containerAppName'), '-redis-', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Name of Azure Cache for Redis"
      }
    },
    "redisSku": {
      "type": "string",
      "defaultValue": "Premium",
      "allowedValues": [
        "Basic",
        "Standard",
        "Premium"
      ],
      "metadata": {
        "description": "Redis SKU"
      }
    },
    "redisCapacity": {
      "type": "int",
      "defaultValue": 1,
      "metadata": {
        "description": "Redis capacity"
      }
    },
    "storageAccountName": {
      "type": "string",
      "defaultValue": "[concat('honua', uniqueString(resourceGroup().id))]",
      "metadata": {
        "description": "Storage account name"
      }
    },
    "azureMarketplaceOfferId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure Marketplace Offer ID"
      }
    },
    "azureMarketplacePlanId": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Azure Marketplace Plan ID"
      }
    },
    "customDomainName": {
      "type": "string",
      "defaultValue": "",
      "metadata": {
        "description": "Custom domain name for Honua IO (e.g., honua.example.com). Leave empty to use default Container Apps domain. Azure will automatically provision a free managed TLS certificate."
      }
    },
    "createDnsZone": {
      "type": "string",
      "defaultValue": "no",
      "allowedValues": ["yes", "no"],
      "metadata": {
        "description": "Create a new Azure DNS zone for your domain? Select 'yes' if you want Azure to manage DNS."
      }
    },
    "existingDnsZoneResourceGroup": {
      "type": "string",
      "defaultValue": "[resourceGroup().name]",
      "metadata": {
        "description": "Resource group of existing DNS zone (if using existing zone)"
      }
    },
    "databaseAdminPassword": {
      "type": "securestring",
      "metadata": {
        "description": "Database password"
      }
    }
  },
  "variables": {
    "containerAppEnvName": "[concat(parameters('containerAppName'), '-env')]",
    "logAnalyticsWorkspaceName": "[concat(parameters('containerAppName'), '-workspace')]",
    "keyVaultName": "[concat(parameters('containerAppName'), '-kv-', uniqueString(resourceGroup().id))]",
    "managedIdentityName": "[concat(parameters('containerAppName'), '-identity')]",
    "hasCustomDomain": "[not(equals(parameters('customDomainName'), ''))]",
    "shouldCreateDnsZone": "[and(equals(parameters('createDnsZone'), 'yes'), not(equals(parameters('customDomainName'), '')))]",
    "dnsZoneName": "[if(variables('hasCustomDomain'), parameters('customDomainName'), 'placeholder.local')]"
  },
  "resources": [
    {
      "type": "Microsoft.ManagedIdentity/userAssignedIdentities",
      "apiVersion": "2023-01-31",
      "name": "[variables('managedIdentityName')]",
      "location": "[parameters('location')]"
    },
    {
      "type": "Microsoft.OperationalInsights/workspaces",
      "apiVersion": "2022-10-01",
      "name": "[variables('logAnalyticsWorkspaceName')]",
      "location": "[parameters('location')]",
      "properties": {
        "sku": {
          "name": "PerGB2018"
        },
        "retentionInDays": 30
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults",
      "apiVersion": "2023-02-01",
      "name": "[variables('keyVaultName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
      ],
      "properties": {
        "sku": {
          "family": "A",
          "name": "standard"
        },
        "tenantId": "[subscription().tenantId]",
        "enableRbacAuthorization": true,
        "enableSoftDelete": true,
        "softDeleteRetentionInDays": 7
      }
    },
    {
      "type": "Microsoft.KeyVault/vaults/secrets",
      "apiVersion": "2023-02-01",
      "name": "[concat(variables('keyVaultName'), '/database-password')]",
      "dependsOn": [
        "[resourceId('Microsoft.KeyVault/vaults', variables('keyVaultName'))]"
      ],
      "properties": {
        "value": "[parameters('databaseAdminPassword')]"
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers",
      "apiVersion": "2023-03-01-preview",
      "name": "[parameters('postgresServerName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "[parameters('postgresSku')]",
        "tier": "GeneralPurpose"
      },
      "properties": {
        "version": "16",
        "administratorLogin": "honua",
        "administratorLoginPassword": "[parameters('databaseAdminPassword')]",
        "storage": {
          "storageSizeGB": "[parameters('postgresStorageSize')]",
          "autoGrow": "Enabled"
        },
        "backup": {
          "backupRetentionDays": 7,
          "geoRedundantBackup": "Enabled"
        },
        "highAvailability": {
          "mode": "ZoneRedundant"
        }
      }
    },
    {
      "type": "Microsoft.DBforPostgreSQL/flexibleServers/databases",
      "apiVersion": "2023-03-01-preview",
      "name": "[concat(parameters('postgresServerName'), '/honua')]",
      "dependsOn": [
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgresServerName'))]"
      ],
      "properties": {
        "charset": "UTF8",
        "collation": "en_US.utf8"
      }
    },
    {
      "type": "Microsoft.Cache/redis",
      "apiVersion": "2023-08-01",
      "name": "[parameters('redisName')]",
      "location": "[parameters('location')]",
      "zones": "[if(equals(parameters('redisSku'), 'Premium'), createArray('1', '2', '3'), createArray())]",
      "properties": {
        "sku": {
          "name": "[parameters('redisSku')]",
          "family": "[if(equals(parameters('redisSku'), 'Premium'), 'P', 'C')]",
          "capacity": "[parameters('redisCapacity')]"
        },
        "enableNonSslPort": false,
        "minimumTlsVersion": "1.2",
        "redisConfiguration": {
          "maxmemory-policy": "allkeys-lru"
        },
        "replicasPerMaster": "[if(equals(parameters('redisSku'), 'Premium'), 1, json('null'))]"
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2023-01-01",
      "name": "[parameters('storageAccountName')]",
      "location": "[parameters('location')]",
      "sku": {
        "name": "Standard_GRS"
      },
      "kind": "StorageV2",
      "properties": {
        "accessTier": "Hot",
        "supportsHttpsTrafficOnly": true,
        "minimumTlsVersion": "TLS1_2",
        "allowBlobPublicAccess": false
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
      "apiVersion": "2023-01-01",
      "name": "[concat(parameters('storageAccountName'), '/default/honua-data')]",
      "dependsOn": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]"
      ],
      "properties": {
        "publicAccess": "None"
      }
    },
    {
      "type": "Microsoft.App/managedEnvironments",
      "apiVersion": "2023-05-01",
      "name": "[variables('containerAppEnvName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName'))]"
      ],
      "properties": {
        "appLogsConfiguration": {
          "destination": "log-analytics",
          "logAnalyticsConfiguration": {
            "customerId": "[reference(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').customerId]",
            "sharedKey": "[listKeys(resourceId('Microsoft.OperationalInsights/workspaces', variables('logAnalyticsWorkspaceName')), '2022-10-01').primarySharedKey]"
          }
        },
        "zoneRedundant": true
      }
    },
    {
      "condition": "[variables('shouldCreateDnsZone')]",
      "type": "Microsoft.Network/dnsZones",
      "apiVersion": "2023-07-01-preview",
      "name": "[variables('dnsZoneName')]",
      "location": "global",
      "properties": {
        "zoneType": "Public"
      }
    },
    {
      "type": "Microsoft.App/containerApps",
      "apiVersion": "2023-05-01",
      "name": "[parameters('containerAppName')]",
      "location": "[parameters('location')]",
      "dependsOn": [
        "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
        "[resourceId('Microsoft.DBforPostgreSQL/flexibleServers/databases', parameters('postgresServerName'), 'honua')]",
        "[resourceId('Microsoft.Cache/redis', parameters('redisName'))]",
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccountName'))]",
        "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]"
      ],
      "identity": {
        "type": "UserAssigned",
        "userAssignedIdentities": {
          "[resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName'))]": {}
        }
      },
      "properties": {
        "managedEnvironmentId": "[resourceId('Microsoft.App/managedEnvironments', variables('containerAppEnvName'))]",
        "configuration": {
          "activeRevisionsMode": "Single",
          "ingress": {
            "external": true,
            "targetPort": 8080,
            "transport": "auto",
            "allowInsecure": false,
            "traffic": [
              {
                "latestRevision": true,
                "weight": 100
              }
            ]
          },
          "secrets": [
            {
              "name": "database-password",
              "value": "[parameters('databaseAdminPassword')]"
            },
            {
              "name": "redis-key",
              "value": "[listKeys(resourceId('Microsoft.Cache/redis', parameters('redisName')), '2023-08-01').primaryKey]"
            }
          ]
        },
        "template": {
          "revisionSuffix": "v1",
          "containers": [
            {
              "name": "honua-server",
              "image": "[concat('ghcr.io/honua-io/honua-server:', parameters('imageTag'))]",
              "resources": {
                "cpu": "[parameters('cpuCores')]",
                "memory": "[parameters('memorySize')]"
              },
              "env": [
                {
                  "name": "ASPNETCORE_ENVIRONMENT",
                  "value": "Production"
                },
                {
                  "name": "DATABASE_HOST",
                  "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgresServerName'))).fullyQualifiedDomainName]"
                },
                {
                  "name": "DATABASE_PORT",
                  "value": "5432"
                },
                {
                  "name": "DATABASE_NAME",
                  "value": "honua"
                },
                {
                  "name": "DATABASE_USER",
                  "value": "honua"
                },
                {
                  "name": "DATABASE_PASSWORD",
                  "secretRef": "database-password"
                },
                {
                  "name": "REDIS_HOST",
                  "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('redisName'))).hostName]"
                },
                {
                  "name": "REDIS_PORT",
                  "value": "[string(reference(resourceId('Microsoft.Cache/redis', parameters('redisName'))).sslPort)]"
                },
                {
                  "name": "REDIS_KEY",
                  "secretRef": "redis-key"
                },
                {
                  "name": "STORAGE_ACCOUNT",
                  "value": "[parameters('storageAccountName')]"
                },
                {
                  "name": "AZURE_MARKETPLACE_OFFER_ID",
                  "value": "[parameters('azureMarketplaceOfferId')]"
                },
                {
                  "name": "AZURE_MARKETPLACE_PLAN_ID",
                  "value": "[parameters('azureMarketplacePlanId')]"
                },
                {
                  "name": "LICENSE_TIER",
                  "value": "[parameters('licenseTier')]"
                },
                {
                  "name": "MANAGED_IDENTITY_CLIENT_ID",
                  "value": "[reference(resourceId('Microsoft.ManagedIdentity/userAssignedIdentities', variables('managedIdentityName')), '2023-01-31').clientId]"
                }
              ],
              "probes": [
                {
                  "type": "Liveness",
                  "httpGet": {
                    "path": "/healthz/live",
                    "port": 8080,
                    "scheme": "HTTP"
                  },
                  "initialDelaySeconds": 30,
                  "periodSeconds": 10,
                  "timeoutSeconds": 5,
                  "failureThreshold": 3
                },
                {
                  "type": "Readiness",
                  "httpGet": {
                    "path": "/healthz/ready",
                    "port": 8080,
                    "scheme": "HTTP"
                  },
                  "initialDelaySeconds": 10,
                  "periodSeconds": 5,
                  "timeoutSeconds": 3,
                  "failureThreshold": 3
                }
              ]
            }
          ],
          "scale": {
            "minReplicas": "[parameters('minReplicas')]",
            "maxReplicas": "[parameters('maxReplicas')]",
            "rules": [
              {
                "name": "http-rule",
                "http": {
                  "metadata": {
                    "concurrentRequests": "50"
                  }
                }
              },
              {
                "name": "cpu-rule",
                "custom": {
                  "type": "cpu",
                  "metadata": {
                    "type": "Utilization",
                    "value": "70"
                  }
                }
              },
              {
                "name": "memory-rule",
                "custom": {
                  "type": "memory",
                  "metadata": {
                    "type": "Utilization",
                    "value": "80"
                  }
                }
              }
            ]
          }
        }
      }
    }
  ],
  "outputs": {
    "containerAppFQDN": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName'))).configuration.ingress.fqdn]"
    },
    "containerAppURL": {
      "type": "string",
      "value": "[concat('https://', reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName'))).configuration.ingress.fqdn)]"
    },
    "postgresServerFqdn": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.DBforPostgreSQL/flexibleServers', parameters('postgresServerName'))).fullyQualifiedDomainName]"
    },
    "redisHostName": {
      "type": "string",
      "value": "[reference(resourceId('Microsoft.Cache/redis', parameters('redisName'))).hostName]"
    },
    "dnsZoneName": {
      "condition": "[variables('shouldCreateDnsZone')]",
      "type": "string",
      "value": "[variables('dnsZoneName')]"
    },
    "dnsZoneResourceId": {
      "condition": "[variables('shouldCreateDnsZone')]",
      "type": "string",
      "value": "[resourceId('Microsoft.Network/dnsZones', variables('dnsZoneName'))]"
    },
    "customDomainInstructions": {
      "condition": "[variables('hasCustomDomain')]",
      "type": "string",
      "value": "[concat('To configure custom domain:\n1. Get Container App validation token:\n   az containerapp hostname list --name ', parameters('containerAppName'), ' --resource-group ', resourceGroup().name, '\n2. Add TXT record to your DNS:\n   Name: asuid.', parameters('customDomainName'), '\n   Value: <validation-token-from-step-1>\n3. Add CNAME record:\n   Name: ', parameters('customDomainName'), '\n   Value: ', reference(resourceId('Microsoft.App/containerApps', parameters('containerAppName'))).configuration.ingress.fqdn, '\n4. Bind custom domain:\n   az containerapp hostname bind --hostname ', parameters('customDomainName'), ' --name ', parameters('containerAppName'), ' --resource-group ', resourceGroup().name, ' --environment ', variables('containerAppEnvName'), ' --validation-method CNAME\n5. Azure will automatically provision a FREE managed TLS certificate!')]"
    }
  }
}

