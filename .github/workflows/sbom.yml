# Software Bill of Materials (SBOM) Generation & Attestation Workflow
#
# Purpose: Generate and sign SBOMs for supply chain security
#
# This workflow:
# - Generates application SBOMs in CycloneDX and SPDX formats
# - Generates container SBOMs using Syft (SPDX, CycloneDX, Syft JSON)
# - Signs container images and SBOMs with Cosign
# - Attaches SBOM attestations to container images
# - Uploads SBOMs as release assets
# - Verifies SBOM integrity and signatures
#
# Documentation: .github/SBOM.md, .github/SECURITY_SCANNING.md
#
# Triggers:
# - Push to: master, dev
# - Release published
# - Manual: Workflow dispatch (Actions tab)
#
name: "SBOM Generation & Attestation"

on:
  push:
    branches: [ "master", "dev" ]
  release:
    types: [ published ]
  workflow_dispatch:

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  generate-sbom:
    name: Generate and Attach SBOM
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write  # For cosign signing

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '9.0.x'

    - name: Restore dependencies
      run: dotnet restore

    # Install SBOM generation tools
    - name: Install CycloneDX tool
      run: dotnet tool install --global CycloneDX
      continue-on-error: true

    - name: Install Microsoft SBOM tool
      run: dotnet tool install --global Microsoft.Sbom.DotNetTool

    - name: Install Syft for container SBOM
      run: |
        curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin

    - name: Install Cosign for signing
      uses: sigstore/cosign-installer@v3.4.0

    # Generate application SBOMs
    - name: Generate SBOM (CycloneDX format)
      run: |
        mkdir -p ./sbom
        dotnet CycloneDX Honua.sln -o ./sbom -f honua-cyclonedx.json -j
      continue-on-error: true

    - name: Generate SBOM (SPDX format)
      run: |
        mkdir -p ./sbom/spdx
        sbom-tool generate \
          -b ./sbom/spdx \
          -bc . \
          -pn "Honua Geospatial Server" \
          -pv ${{ github.sha }} \
          -ps "Honua Project" \
          -nsb https://honua.io \
          -V Information
      continue-on-error: true

    # Setup Docker Buildx with attestation support
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Extract metadata for Docker
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
        tags: |
          type=ref,event=branch
          type=ref,event=pr
          type=semver,pattern={{version}}
          type=semver,pattern={{major}}.{{minor}}
          type=sha,prefix={{branch}}-
          type=raw,value=latest,enable={{is_default_branch}}

    # Build image with SBOM attestation
    - name: Build and push image with SBOM attestation
      id: build-push
      uses: docker/build-push-action@v5
      with:
        context: .
        file: ./Dockerfile
        platforms: linux/amd64,linux/arm64
        push: ${{ github.event_name != 'pull_request' }}
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        # Attach SBOM and provenance attestations
        sbom: true
        provenance: true
        outputs: type=image,name=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }},push-by-digest=true,name-canonical=true

    # Generate container SBOM with Syft
    - name: Generate container SBOM with Syft
      if: github.event_name != 'pull_request'
      run: |
        # Get the image digest
        IMAGE_DIGEST="${{ steps.build-push.outputs.digest }}"
        IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${IMAGE_DIGEST}"

        # Generate SBOM in multiple formats
        syft "$IMAGE_REF" -o spdx-json=./sbom/container-sbom-spdx.json
        syft "$IMAGE_REF" -o cyclonedx-json=./sbom/container-sbom-cyclonedx.json
        syft "$IMAGE_REF" -o syft-json=./sbom/container-sbom-syft.json

    # Sign SBOM with Cosign
    - name: Sign SBOM with Cosign
      if: github.event_name != 'pull_request'
      run: |
        IMAGE_DIGEST="${{ steps.build-push.outputs.digest }}"
        IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${IMAGE_DIGEST}"

        # Sign the image
        cosign sign --yes "${IMAGE_REF}"

        # Attach SBOM as attestation
        cosign attest --yes --predicate ./sbom/container-sbom-spdx.json \
          --type https://spdx.dev/Document "${IMAGE_REF}"

    # Upload SBOM artifacts
    - name: Upload SBOM artifacts
      uses: actions/upload-artifact@v4
      with:
        name: sbom-${{ github.sha }}
        path: |
          ./sbom/*.json
          ./sbom/spdx/
        retention-days: 90

    # Attach SBOM to release
    - name: Attach SBOM to release
      if: github.event_name == 'release'
      uses: softprops/action-gh-release@v1
      with:
        files: |
          ./sbom/*.json
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    # Generate SBOM summary
    - name: Generate SBOM summary
      if: always()
      run: |
        echo "## SBOM Generation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Image**: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}" >> $GITHUB_STEP_SUMMARY
        echo "**Digest**: ${{ steps.build-push.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
        echo "**Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### SBOM Formats Generated" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ CycloneDX (application)" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ SPDX (application)" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ SPDX (container - Syft)" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ CycloneDX (container - Syft)" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ Syft JSON (container)" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Attestations" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ SBOM attached to image as OCI artifact" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ Provenance attestation (SLSA)" >> $GITHUB_STEP_SUMMARY
        echo "- ✓ Cosign signature" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY

        echo "### Verification" >> $GITHUB_STEP_SUMMARY
        echo '```bash' >> $GITHUB_STEP_SUMMARY
        echo "# Verify signature" >> $GITHUB_STEP_SUMMARY
        echo "cosign verify ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build-push.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "# Download SBOM attestation" >> $GITHUB_STEP_SUMMARY
        echo "cosign verify-attestation --type https://spdx.dev/Document \\" >> $GITHUB_STEP_SUMMARY
        echo "  ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}@${{ steps.build-push.outputs.digest }}" >> $GITHUB_STEP_SUMMARY
        echo '```' >> $GITHUB_STEP_SUMMARY

  # Verify SBOM attestation
  verify-sbom:
    name: Verify SBOM Attestation
    runs-on: ubuntu-latest
    needs: generate-sbom
    if: github.event_name != 'pull_request'
    permissions:
      packages: read

    steps:
    - name: Install Cosign
      uses: sigstore/cosign-installer@v3.4.0

    - name: Log in to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ github.actor }}
        password: ${{ secrets.GITHUB_TOKEN }}

    - name: Verify SBOM attestation
      run: |
        IMAGE_REF="${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.ref_name }}"

        echo "Verifying SBOM attestation for: $IMAGE_REF"

        # Verify signature
        echo "Verifying signature..."
        cosign verify "$IMAGE_REF" || echo "::warning::Signature verification requires public key or OIDC"

        # Verify SBOM attestation
        echo "Verifying SBOM attestation..."
        cosign verify-attestation --type https://spdx.dev/Document "$IMAGE_REF" \
          || echo "::warning::SBOM attestation verification requires public key or OIDC"

        # Download and display SBOM
        echo "Downloading SBOM..."
        cosign download sbom "$IMAGE_REF" > verified-sbom.json || true

        if [ -f verified-sbom.json ]; then
          echo "SBOM downloaded successfully"
          echo "Package count: $(jq '.packages | length' verified-sbom.json || echo 'N/A')"
        fi
