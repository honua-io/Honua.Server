name: Terraform Module Tests

on:
  pull_request:
    paths:
      - 'infrastructure/terraform/modules/**'
      - '.github/workflows/terraform-test.yml'
  push:
    branches:
      - main
      - master
      - dev
    paths:
      - 'infrastructure/terraform/modules/**'
      - '.github/workflows/terraform-test.yml'
  workflow_dispatch:  # Allow manual triggering

env:
  TERRAFORM_VERSION: '1.6.0'

jobs:
  # Job to detect which modules changed
  detect-changes:
    name: Detect Changed Modules
    runs-on: ubuntu-latest
    outputs:
      cloud-run: ${{ steps.filter.outputs.cloud-run }}
      lambda: ${{ steps.filter.outputs.lambda }}
      container-apps: ${{ steps.filter.outputs.container-apps }}
      cdn: ${{ steps.filter.outputs.cdn }}
      all-modules: ${{ steps.filter.outputs.all-modules }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v2
        id: filter
        with:
          filters: |
            cloud-run:
              - 'infrastructure/terraform/modules/cloud-run/**'
            lambda:
              - 'infrastructure/terraform/modules/lambda/**'
            container-apps:
              - 'infrastructure/terraform/modules/container-apps/**'
            cdn:
              - 'infrastructure/terraform/modules/cdn/**'
            all-modules:
              - 'infrastructure/terraform/modules/**'

  # Test Cloud Run module
  test-cloud-run:
    name: Test Cloud Run Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.cloud-run == 'true' || needs.detect-changes.outputs.all-modules == 'true'
    strategy:
      matrix:
        test-type: [unit, integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: infrastructure/terraform/modules/cloud-run
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Run ${{ matrix.test-type }} tests
        working-directory: infrastructure/terraform/modules/cloud-run/tests/${{ matrix.test-type }}
        run: |
          echo "Running ${{ matrix.test-type }} tests for Cloud Run module..."
          terraform init -backend=false
          terraform validate
          terraform plan -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v3
        with:
          name: cloud-run-${{ matrix.test-type }}-plan
          path: infrastructure/terraform/modules/cloud-run/tests/${{ matrix.test-type }}/tfplan
          retention-days: 5

  # Test Lambda module
  test-lambda:
    name: Test Lambda Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.lambda == 'true' || needs.detect-changes.outputs.all-modules == 'true'
    strategy:
      matrix:
        test-type: [unit, integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: infrastructure/terraform/modules/lambda
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Run ${{ matrix.test-type }} tests
        working-directory: infrastructure/terraform/modules/lambda/tests/${{ matrix.test-type }}
        run: |
          echo "Running ${{ matrix.test-type }} tests for Lambda module..."
          terraform init -backend=false
          terraform validate
          terraform plan -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v3
        with:
          name: lambda-${{ matrix.test-type }}-plan
          path: infrastructure/terraform/modules/lambda/tests/${{ matrix.test-type }}/tfplan
          retention-days: 5

  # Test Container Apps module
  test-container-apps:
    name: Test Container Apps Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.container-apps == 'true' || needs.detect-changes.outputs.all-modules == 'true'
    strategy:
      matrix:
        test-type: [unit, integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: infrastructure/terraform/modules/container-apps
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Run ${{ matrix.test-type }} tests
        working-directory: infrastructure/terraform/modules/container-apps/tests/${{ matrix.test-type }}
        run: |
          echo "Running ${{ matrix.test-type }} tests for Container Apps module..."
          terraform init -backend=false
          terraform validate
          terraform plan -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v3
        with:
          name: container-apps-${{ matrix.test-type }}-plan
          path: infrastructure/terraform/modules/container-apps/tests/${{ matrix.test-type }}/tfplan
          retention-days: 5

  # Test CDN module
  test-cdn:
    name: Test CDN Module
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.cdn == 'true' || needs.detect-changes.outputs.all-modules == 'true'
    strategy:
      matrix:
        test-type: [unit, integration]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Format Check
        working-directory: infrastructure/terraform/modules/cdn
        run: terraform fmt -check -recursive
        continue-on-error: true

      - name: Run ${{ matrix.test-type }} tests
        working-directory: infrastructure/terraform/modules/cdn/tests/${{ matrix.test-type }}
        run: |
          echo "Running ${{ matrix.test-type }} tests for CDN module..."
          terraform init -backend=false
          terraform validate
          terraform plan -out=tfplan

      - name: Upload plan artifact
        uses: actions/upload-artifact@v3
        with:
          name: cdn-${{ matrix.test-type }}-plan
          path: infrastructure/terraform/modules/cdn/tests/${{ matrix.test-type }}/tfplan
          retention-days: 5

  # Security scanning with tfsec
  security-scan:
    name: Security Scan (tfsec)
    runs-on: ubuntu-latest
    needs: detect-changes
    if: needs.detect-changes.outputs.all-modules == 'true'
    strategy:
      matrix:
        module: [cloud-run, lambda, container-apps, cdn]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run tfsec
        uses: aquasecurity/tfsec-action@v1.0.3
        with:
          working_directory: infrastructure/terraform/modules/${{ matrix.module }}
          soft_fail: true
          format: sarif
          additional_args: --minimum-severity MEDIUM

      - name: Upload SARIF file
        uses: github/codeql-action/upload-sarif@v4
        if: always()
        with:
          sarif_file: results.sarif
          category: tfsec-${{ matrix.module }}

  # Cost estimation with Infracost (optional)
  cost-estimation:
    name: Cost Estimation
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.all-modules == 'true'
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Infracost
        uses: infracost/actions/setup@v2
        with:
          api-key: ${{ secrets.INFRACOST_API_KEY }}
        continue-on-error: true

      - name: Generate Infracost breakdown
        id: infracost
        continue-on-error: true
        run: |
          infracost breakdown \
            --path infrastructure/terraform/modules/cloud-run/tests/integration \
            --format json \
            --out-file /tmp/infracost-cloud-run.json || true

          infracost breakdown \
            --path infrastructure/terraform/modules/lambda/tests/integration \
            --format json \
            --out-file /tmp/infracost-lambda.json || true

          infracost breakdown \
            --path infrastructure/terraform/modules/container-apps/tests/integration \
            --format json \
            --out-file /tmp/infracost-container-apps.json || true

      - name: Post Infracost comment
        if: steps.infracost.outcome == 'success'
        uses: infracost/actions/comment@v1
        continue-on-error: true
        with:
          path: /tmp/infracost-*.json
          behavior: update

  # Final status check
  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [test-cloud-run, test-lambda, test-container-apps, test-cdn, security-scan]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "Test Summary:"
          echo "============="
          echo "Cloud Run: ${{ needs.test-cloud-run.result }}"
          echo "Lambda: ${{ needs.test-lambda.result }}"
          echo "Container Apps: ${{ needs.test-container-apps.result }}"
          echo "CDN: ${{ needs.test-cdn.result }}"
          echo "Security Scan: ${{ needs.security-scan.result }}"

          if [[ "${{ needs.test-cloud-run.result }}" == "failure" ]] || \
             [[ "${{ needs.test-lambda.result }}" == "failure" ]] || \
             [[ "${{ needs.test-container-apps.result }}" == "failure" ]] || \
             [[ "${{ needs.test-cdn.result }}" == "failure" ]]; then
            echo "❌ Some tests failed"
            exit 1
          else
            echo "✅ All tests passed"
            exit 0
          fi
