name: Comprehensive Integration Tests (QGIS + Python)

# This workflow runs comprehensive integration tests against a live Honua server instance
# using both QGIS and Python clients to validate OGC and STAC API compliance.
#
# Test Coverage:
# - QGIS integration tests (WMS, WFS, WCS, WMTS, OGC API Features, OGC API Tiles)
# - Python integration tests (STAC, WFS with OWSLib, WCS with rasterio)
# - Full OGC specification compliance validation
# - Real-world client compatibility testing

on:
  push:
    branches: [master, main, dev]
  # pull_request:
  #   branches: [master, main, dev]
  workflow_dispatch:
    inputs:
      run_slow_tests:
        description: 'Run slow/comprehensive tests (can take 15+ minutes)'
        required: false
        type: boolean
        default: false

env:
  # .NET Configuration
  DOTNET_VERSION: '9.0.x'

  # Docker Configuration
  POSTGRES_IMAGE: 'postgis/postgis:16-3.4'
  QGIS_IMAGE: 'qgis/qgis:3.34'

  # Test Configuration
  HONUA_API_BASE_URL: 'http://honua-server:8080'
  HONUA_QGIS_BASE_URL: 'http://honua-server:8080'
  POSTGRES_DB: 'honua_integration_test'
  POSTGRES_USER: 'honua_test'
  POSTGRES_PASSWORD: 'test_password_123'

  # Default test layer/collection for integration tests
  HONUA_QGIS_WMS_LAYER: 'test-data:features'
  HONUA_QGIS_COLLECTION_ID: 'test-data::features'

jobs:
  # =============================================================================
  # Build Honua Server Docker Image
  # =============================================================================
  build-server:
    name: Build Honua Server Image
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      image-tag: ${{ steps.build.outputs.image-tag }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Honua Server image
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: false
          load: true
          tags: honua-server:test-${{ github.sha }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            BUILDKIT_INLINE_CACHE=1

      - name: Save Docker image
        run: |
          docker save honua-server:test-${{ github.sha }} | gzip > honua-server.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: honua-server-image
          path: honua-server.tar.gz
          retention-days: 1

  # =============================================================================
  # QGIS Integration Tests
  # =============================================================================
  qgis-integration-tests:
    name: QGIS Integration Tests
    runs-on: ubuntu-latest
    needs: build-server
    timeout-minutes: 45

    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U honua_test -d honua_integration_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --name postgres-server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Honua server image
        uses: actions/download-artifact@v4
        with:
          name: honua-server-image

      - name: Load Honua server image
        run: |
          docker load < honua-server.tar.gz
          docker images

      - name: Create Docker network
        run: |
          docker network create honua-test-network
          docker network connect honua-test-network postgres-server

      - name: Start Honua server container
        run: |
          docker run -d \
            --name honua-server \
            --network honua-test-network \
            -p 8080:8080 \
            -e ASPNETCORE_ENVIRONMENT=Development \
            -e ConnectionStrings__DefaultConnection="Host=postgres-server;Port=5432;Database=${{ env.POSTGRES_DB }};Username=${{ env.POSTGRES_USER }};Password=${{ env.POSTGRES_PASSWORD }}" \
            -e Honua__DataStore__Provider=PostgreSQL \
            -e Honua__Security__RequireHttps=false \
            --health-cmd="wget --no-verbose --tries=1 --spider http://localhost:8080/healthz/live || exit 1" \
            --health-interval=5s \
            --health-timeout=3s \
            --health-retries=10 \
            --health-start-period=30s \
            honua-server:test-${{ github.sha }}

      - name: Wait for Honua server to be healthy
        run: |
          echo "Waiting for Honua server to become healthy..."
          timeout 180 bash -c '
            until docker inspect --format="{{.State.Health.Status}}" honua-server | grep -q "healthy"; do
              echo "Server status: $(docker inspect --format="{{.State.Health.Status}}" honua-server)"
              sleep 5
            done
          '
          echo "Honua server is healthy!"

      - name: Verify server is responding
        run: |
          curl -f http://localhost:8080/healthz/live || {
            echo "Health check failed!"
            docker logs honua-server
            exit 1
          }
          echo "Server health check passed!"

      - name: Show server logs (startup)
        run: |
          echo "=== Honua Server Startup Logs ==="
          docker logs honua-server --tail 100

      - name: Run QGIS integration tests
        run: |
          docker run --rm \
            --network honua-test-network \
            -v ${{ github.workspace }}/tests/qgis:/tests \
            -v ${{ github.workspace }}/test-results:/test-results \
            -e HONUA_QGIS_BASE_URL=${{ env.HONUA_QGIS_BASE_URL }} \
            -e HONUA_QGIS_WMS_LAYER=${{ env.HONUA_QGIS_WMS_LAYER }} \
            -e HONUA_QGIS_COLLECTION_ID=${{ env.HONUA_QGIS_COLLECTION_ID }} \
            -e QT_QPA_PLATFORM=offscreen \
            -w /tests \
            ${{ env.QGIS_IMAGE }} \
            sh -c "
              set -e
              echo '=== Installing Python test dependencies ==='
              pip3 install -r requirements.txt

              echo '=== Running QGIS integration tests ==='
              pytest -v \
                --timeout=300 \
                --tb=short \
                --junit-xml=/test-results/qgis-junit.xml \
                --html=/test-results/qgis-report.html \
                --self-contained-html \
                ${{ github.event.inputs.run_slow_tests == 'true' && '' || '-m "not slow"' }} \
                .
            "

      - name: Upload QGIS test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: qgis-test-results
          path: test-results/
          retention-days: 7

      - name: Publish QGIS test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: QGIS Integration Tests
          path: 'test-results/qgis-junit.xml'
          reporter: java-junit
          fail-on-error: false

      - name: Show server logs on failure
        if: failure()
        run: |
          echo "=== Honua Server Logs ==="
          docker logs honua-server

      - name: Cleanup containers
        if: always()
        run: |
          docker stop honua-server || true
          docker rm honua-server || true
          docker network disconnect honua-test-network postgres-server || true
          docker network rm honua-test-network || true

  # =============================================================================
  # Python Integration Tests
  # =============================================================================
  python-integration-tests:
    name: Python Integration Tests
    runs-on: ubuntu-latest
    needs: build-server
    timeout-minutes: 30

    services:
      postgres:
        image: postgis/postgis:16-3.4
        env:
          POSTGRES_DB: ${{ env.POSTGRES_DB }}
          POSTGRES_USER: ${{ env.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ env.POSTGRES_PASSWORD }}
          POSTGRES_HOST_AUTH_METHOD: trust
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U honua_test -d honua_integration_test"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --name postgres-server

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install system dependencies (GDAL)
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gdal-bin \
            libgdal-dev \
            python3-gdal \
            proj-bin \
            libproj-dev

      - name: Install Python test dependencies
        run: |
          pip install --upgrade pip
          pip install -r tests/python/requirements.txt
          pip install pytest-html pytest-json-report

      - name: Download Honua server image
        uses: actions/download-artifact@v4
        with:
          name: honua-server-image

      - name: Load Honua server image
        run: |
          docker load < honua-server.tar.gz

      - name: Create Docker network
        run: |
          docker network create honua-test-network
          docker network connect honua-test-network postgres-server

      - name: Start Honua server container
        run: |
          docker run -d \
            --name honua-server \
            --network honua-test-network \
            -p 8080:8080 \
            -e ASPNETCORE_ENVIRONMENT=Development \
            -e ConnectionStrings__DefaultConnection="Host=postgres-server;Port=5432;Database=${{ env.POSTGRES_DB }};Username=${{ env.POSTGRES_USER }};Password=${{ env.POSTGRES_PASSWORD }}" \
            -e Honua__DataStore__Provider=PostgreSQL \
            -e Honua__Security__RequireHttps=false \
            --health-cmd="wget --no-verbose --tries=1 --spider http://localhost:8080/healthz/live || exit 1" \
            --health-interval=5s \
            --health-timeout=3s \
            --health-retries=10 \
            --health-start-period=30s \
            honua-server:test-${{ github.sha }}

      - name: Wait for Honua server to be healthy
        run: |
          echo "Waiting for Honua server to become healthy..."
          timeout 180 bash -c '
            until docker inspect --format="{{.State.Health.Status}}" honua-server | grep -q "healthy"; do
              echo "Server status: $(docker inspect --format="{{.State.Health.Status}}" honua-server)"
              sleep 5
            done
          '
          echo "Honua server is healthy!"

      - name: Verify server is responding
        run: |
          curl -f http://localhost:8080/healthz/live || {
            echo "Health check failed!"
            docker logs honua-server
            exit 1
          }

      - name: Run Python integration tests
        env:
          HONUA_API_BASE_URL: 'http://localhost:8080'
          HONUA_QGIS_BASE_URL: 'http://localhost:8080'
        run: |
          cd tests/python
          pytest -v \
            --timeout=120 \
            --tb=short \
            --junit-xml=../../test-results/python-junit.xml \
            --html=../../test-results/python-report.html \
            --self-contained-html \
            --json-report \
            --json-report-file=../../test-results/python-report.json \
            ${{ github.event.inputs.run_slow_tests == 'true' && '' || '-m "not slow"' }} \
            .

      - name: Upload Python test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: python-test-results
          path: test-results/
          retention-days: 7

      - name: Publish Python test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: Python Integration Tests
          path: 'test-results/python-junit.xml'
          reporter: java-junit
          fail-on-error: false

      - name: Show server logs on failure
        if: failure()
        run: |
          echo "=== Honua Server Logs ==="
          docker logs honua-server

      - name: Cleanup containers
        if: always()
        run: |
          docker stop honua-server || true
          docker rm honua-server || true
          docker network disconnect honua-test-network postgres-server || true
          docker network rm honua-test-network || true

  # =============================================================================
  # Generate Test Summary and PR Comment
  # =============================================================================
  test-summary:
    name: Generate Test Summary
    runs-on: ubuntu-latest
    needs: [qgis-integration-tests, python-integration-tests]
    if: always()

    steps:
      - name: Download all test results
        uses: actions/download-artifact@v4
        with:
          pattern: '*-test-results'
          merge-multiple: true

      - name: Generate test summary
        if: always()
        run: |
          echo "# Integration Test Results Summary" > test-summary.md
          echo "" >> test-summary.md
          echo "## Test Execution" >> test-summary.md
          echo "" >> test-summary.md
          echo "| Test Suite | Status |" >> test-summary.md
          echo "|------------|--------|" >> test-summary.md
          echo "| QGIS Integration Tests | ${{ needs.qgis-integration-tests.result }} |" >> test-summary.md
          echo "| Python Integration Tests | ${{ needs.python-integration-tests.result }} |" >> test-summary.md
          echo "" >> test-summary.md

          # Add test details if available
          if [ -f qgis-junit.xml ]; then
            echo "### QGIS Tests" >> test-summary.md
            echo "Test results available in artifacts." >> test-summary.md
            echo "" >> test-summary.md
          fi

          if [ -f python-junit.xml ]; then
            echo "### Python Tests" >> test-summary.md
            echo "Test results available in artifacts." >> test-summary.md
            echo "" >> test-summary.md
          fi

          echo "## Artifacts" >> test-summary.md
          echo "- QGIS test results and HTML report" >> test-summary.md
          echo "- Python test results and HTML report" >> test-summary.md
          echo "- Server logs (if tests failed)" >> test-summary.md

          cat test-summary.md

      - name: Add summary to PR comment
        if: github.event_name == 'pull_request'
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: integration-tests
          path: test-summary.md

      - name: Publish combined test results
        uses: dorny/test-reporter@v1
        if: always()
        with:
          name: All Integration Tests
          path: '*.xml'
          reporter: java-junit
          fail-on-error: false

  # =============================================================================
  # Final Status Check
  # =============================================================================
  all-tests-passed:
    name: All Integration Tests Passed
    runs-on: ubuntu-latest
    needs: [qgis-integration-tests, python-integration-tests]
    if: always()

    steps:
      - name: Check test results
        run: |
          echo "=== Test Results Summary ==="
          echo "QGIS Integration Tests: ${{ needs.qgis-integration-tests.result }}"
          echo "Python Integration Tests: ${{ needs.python-integration-tests.result }}"
          echo ""

          # Fail if any test suite failed
          if [ "${{ needs.qgis-integration-tests.result }}" != "success" ]; then
            echo "::error::QGIS integration tests failed!"
            exit 1
          fi

          if [ "${{ needs.python-integration-tests.result }}" != "success" ]; then
            echo "::error::Python integration tests failed!"
            exit 1
          fi

          echo "::notice::All integration tests passed successfully!"
