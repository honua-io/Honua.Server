# syntax=docker/dockerfile:1
# Dockerfile for building honua-server:test image used in Docker integration tests
# This image is optimized for testing and includes debugging tools

FROM mcr.microsoft.com/dotnet/sdk:9.0 AS build
WORKDIR /source

# Copy project files
COPY NuGet.Config ./
COPY src/Honua.Server.Core/Honua.Server.Core.csproj src/Honua.Server.Core/
COPY src/Honua.Server.Host/Honua.Server.Host.csproj src/Honua.Server.Host/
RUN dotnet restore src/Honua.Server.Host/Honua.Server.Host.csproj

# Copy all source code
COPY . ./

# Build and publish
RUN dotnet publish src/Honua.Server.Host/Honua.Server.Host.csproj \
    --configuration Debug \
    --no-restore \
    --output /app/publish \
    /p:UseAppHost=false

# Runtime stage - using full aspnet image (not chiseled) for better compatibility with test scenarios
FROM mcr.microsoft.com/dotnet/aspnet:9.0 AS runtime
WORKDIR /app

ENV ASPNETCORE_URLS=http://+:5000 \
    ASPNETCORE_ENVIRONMENT=Development

# Install curl for health checks (needed for Testcontainers wait strategies)
RUN apt-get update && \
    apt-get install -y --no-install-recommends curl wget && \
    rm -rf /var/lib/apt/lists/*

# Copy published app
COPY --from=build /app/publish ./

# Create directory for mounted metadata files
RUN mkdir -p /app/metadata && chmod 777 /app/metadata

EXPOSE 5000

# Health check using ASP.NET Core health endpoint
HEALTHCHECK --interval=10s --timeout=3s --start-period=15s --retries=5 \
    CMD curl -f http://localhost:5000/healthz/live || exit 1

ENTRYPOINT ["dotnet", "Honua.Server.Host.dll"]
