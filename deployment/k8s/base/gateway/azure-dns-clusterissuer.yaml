# Azure DNS ClusterIssuer for cert-manager
# Uses Managed Identity for authentication (no credentials needed)
# Provisions wildcard certificates for *.honua.io
---
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-prod-azure-dns
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: clusterissuer
spec:
  acme:
    # Let's Encrypt production server
    server: https://acme-v02.api.letsencrypt.org/directory
    email: admin@honua.io  # UPDATE THIS

    # Private key for ACME account
    privateKeySecretRef:
      name: letsencrypt-prod-azure-dns-key

    # DNS-01 challenge solver using Azure DNS
    solvers:
      - dns01:
          azureDNS:
            # Azure subscription ID
            subscriptionID: "AZURE_SUBSCRIPTION_ID"  # UPDATE THIS

            # Resource group containing the DNS zone
            resourceGroupName: "honua-dns-rg"  # UPDATE THIS

            # DNS zone name
            hostedZoneName: "honua.io"

            # Azure environment (AzurePublicCloud, AzureChinaCloud, AzureGermanCloud, AzureUSGovernmentCloud)
            environment: AzurePublicCloud

            # Use Managed Identity (recommended for AKS)
            managedIdentity:
              # Client ID of the user-assigned managed identity
              clientID: "MANAGED_IDENTITY_CLIENT_ID"  # UPDATE THIS

        # Match all DNS names under honua.io
        selector:
          dnsZones:
            - "honua.io"

---
# Staging ClusterIssuer for testing (higher rate limits)
apiVersion: cert-manager.io/v1
kind: ClusterIssuer
metadata:
  name: letsencrypt-staging-azure-dns
  labels:
    app.kubernetes.io/name: cert-manager
    app.kubernetes.io/component: clusterissuer
spec:
  acme:
    server: https://acme-staging-v02.api.letsencrypt.org/directory
    email: admin@honua.io  # UPDATE THIS

    privateKeySecretRef:
      name: letsencrypt-staging-azure-dns-key

    solvers:
      - dns01:
          azureDNS:
            subscriptionID: "AZURE_SUBSCRIPTION_ID"  # UPDATE THIS
            resourceGroupName: "honua-dns-rg"  # UPDATE THIS
            hostedZoneName: "honua.io"
            environment: AzurePublicCloud
            managedIdentity:
              clientID: "MANAGED_IDENTITY_CLIENT_ID"  # UPDATE THIS
        selector:
          dnsZones:
            - "honua.io"
