# AWS EKS Specific Configuration
# Apply these configurations when deploying to Amazon EKS

# AWS Load Balancer Controller Service Configuration
apiVersion: v1
kind: Service
metadata:
  name: honua-api-lb
  namespace: honua
  annotations:
    # AWS Network Load Balancer
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
    service.beta.kubernetes.io/aws-load-balancer-cross-zone-load-balancing-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-backend-protocol: "tcp"
    service.beta.kubernetes.io/aws-load-balancer-connection-idle-timeout: "3600"

    # SSL/TLS termination at load balancer
    service.beta.kubernetes.io/aws-load-balancer-ssl-cert: "arn:aws:acm:us-west-2:ACCOUNT_ID:certificate/CERT_ID"
    service.beta.kubernetes.io/aws-load-balancer-ssl-ports: "443"

    # Access logging
    service.beta.kubernetes.io/aws-load-balancer-access-log-enabled: "true"
    service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-name: "honua-lb-logs"
    service.beta.kubernetes.io/aws-load-balancer-access-log-s3-bucket-prefix: "api-lb"

    # Internal vs external
    # service.beta.kubernetes.io/aws-load-balancer-internal: "true"  # Uncomment for internal LB

    # Target group settings
    service.beta.kubernetes.io/aws-load-balancer-target-group-attributes: "deregistration_delay.timeout_seconds=30,stickiness.enabled=true,stickiness.type=source_ip"
spec:
  type: LoadBalancer
  selector:
    app.kubernetes.io/name: honua
    app.kubernetes.io/component: api
  ports:
    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP

---
# StorageClass for AWS EBS GP3 volumes
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: gp3
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: ebs.csi.aws.com
parameters:
  type: gp3
  iops: "3000"
  throughput: "125"
  encrypted: "true"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true

---
# StorageClass for high-performance SSD (io2)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: fast-ssd
provisioner: ebs.csi.aws.com
parameters:
  type: io2
  iops: "10000"
  encrypted: "true"
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true

---
# EFS StorageClass for shared storage
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: efs-sc
provisioner: efs.csi.aws.com
parameters:
  provisioningMode: efs-ap
  fileSystemId: fs-XXXXXXXX  # Replace with your EFS ID
  directoryPerms: "700"
  gidRangeStart: "1000"
  gidRangeEnd: "2000"
  basePath: "/honua"

---
# IAM Role for Service Account (IRSA) - API Service
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-api-sa
  namespace: honua
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/HonuaAPIRole

---
# IAM Role for Service Account (IRSA) - Intake Service
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-intake-sa
  namespace: honua
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/HonuaIntakeRole

---
# IAM Role for Service Account (IRSA) - Orchestrator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-orchestrator-sa
  namespace: honua
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::ACCOUNT_ID:role/HonuaOrchestratorRole

---
# Cluster Autoscaler configuration
apiVersion: v1
kind: ConfigMap
metadata:
  name: cluster-autoscaler-config
  namespace: kube-system
data:
  aws-region: us-west-2
  cluster-name: honua-eks-cluster
