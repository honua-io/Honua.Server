# Google Cloud GKE Specific Configuration
# Apply these configurations when deploying to Google Kubernetes Engine

# GCP Load Balancer Service Configuration
apiVersion: v1
kind: Service
metadata:
  name: honua-api-lb
  namespace: honua
  annotations:
    # Use Network Load Balancer (L4)
    cloud.google.com/load-balancer-type: "External"

    # Backend configuration
    cloud.google.com/backend-config: '{"default": "honua-backend-config"}'

    # Session affinity
    cloud.google.com/app-protocols: '{"https":"HTTP2"}'

    # NEG (Network Endpoint Groups) for container-native load balancing
    cloud.google.com/neg: '{"ingress": true}'

    # Health check
    cloud.google.com/health-check: '{"type": "http", "port": 8080, "request-path": "/health"}'
spec:
  type: LoadBalancer
  selector:
    app.kubernetes.io/name: honua
    app.kubernetes.io/component: api
  ports:
    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 3600

---
# BackendConfig for load balancer settings
apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: honua-backend-config
  namespace: honua
spec:
  healthCheck:
    checkIntervalSec: 10
    timeoutSec: 5
    healthyThreshold: 2
    unhealthyThreshold: 3
    type: HTTP
    requestPath: /health
    port: 8080
  connectionDraining:
    drainingTimeoutSec: 30
  sessionAffinity:
    affinityType: "CLIENT_IP"
    affinityCookieTtlSec: 3600
  timeoutSec: 30

---
# GCP Persistent Disk StorageClass (SSD)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: pd-ssd
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: pd.csi.storage.gke.io
parameters:
  type: pd-ssd
  replication-type: regional-pd
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true

---
# GCP Persistent Disk StorageClass (Balanced)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: pd-balanced
provisioner: pd.csi.storage.gke.io
parameters:
  type: pd-balanced
  replication-type: regional-pd
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true

---
# GCP Filestore StorageClass (for shared storage)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: filestore-premium
provisioner: filestore.csi.storage.gke.io
parameters:
  tier: premium
  network: default
volumeBindingMode: WaitForFirstConsumer
allowVolumeExpansion: true

---
# Workload Identity for API Service
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-api-sa
  namespace: honua
  annotations:
    iam.gke.io/gcp-service-account: honua-api@PROJECT_ID.iam.gserviceaccount.com

---
# Workload Identity for Intake Service
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-intake-sa
  namespace: honua
  annotations:
    iam.gke.io/gcp-service-account: honua-intake@PROJECT_ID.iam.gserviceaccount.com

---
# Workload Identity for Orchestrator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-orchestrator-sa
  namespace: honua
  annotations:
    iam.gke.io/gcp-service-account: honua-orchestrator@PROJECT_ID.iam.gserviceaccount.com

---
# GCP ManagedCertificate for SSL
apiVersion: networking.gke.io/v1
kind: ManagedCertificate
metadata:
  name: honua-cert
  namespace: honua
spec:
  domains:
    - api.honua.io
    - intake.honua.io

---
# GCP Ingress with Google Cloud Load Balancer
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: honua-gcp-ingress
  namespace: honua
  annotations:
    kubernetes.io/ingress.class: "gce"
    kubernetes.io/ingress.global-static-ip-name: "honua-static-ip"
    networking.gke.io/managed-certificates: "honua-cert"
    kubernetes.io/ingress.allow-http: "true"
spec:
  rules:
    - host: api.honua.io
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: honua-api
                port:
                  number: 8080
    - host: intake.honua.io
      http:
        paths:
          - path: /*
            pathType: ImplementationSpecific
            backend:
              service:
                name: honua-intake
                port:
                  number: 8080

---
# FrontendConfig for URL redirect HTTP to HTTPS
apiVersion: networking.gke.io/v1beta1
kind: FrontendConfig
metadata:
  name: honua-frontend-config
  namespace: honua
spec:
  redirectToHttps:
    enabled: true
    responseCodeName: MOVED_PERMANENTLY_DEFAULT

---
# Google Cloud Armor Security Policy
apiVersion: cloud.google.com/v1
kind: BackendConfig
metadata:
  name: honua-security-config
  namespace: honua
spec:
  securityPolicy:
    name: "honua-security-policy"
  iap:
    enabled: false
    oauthclientCredentials:
      secretName: oauth-client-secret

---
# ConfigMap for Google Cloud Operations
apiVersion: v1
kind: ConfigMap
metadata:
  name: stackdriver-config
  namespace: kube-system
data:
  config: |
    {
      "enableMetadataAgent": true,
      "enableNodeProblemDetector": true,
      "enableSystemdCollector": true,
      "logging": {
        "enabled": true
      },
      "monitoring": {
        "enabled": true
      }
    }
