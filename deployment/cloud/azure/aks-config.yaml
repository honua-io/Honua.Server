# Azure AKS Specific Configuration
# Apply these configurations when deploying to Azure AKS

# Azure Load Balancer Service Configuration
apiVersion: v1
kind: Service
metadata:
  name: honua-api-lb
  namespace: honua
  annotations:
    # Azure Load Balancer type (internal or external)
    service.beta.kubernetes.io/azure-load-balancer-internal: "false"

    # Use Standard SKU load balancer
    service.beta.kubernetes.io/azure-load-balancer-sku: "standard"

    # Session affinity
    service.beta.kubernetes.io/azure-load-balancer-disable-tcp-reset: "false"

    # Health probe settings
    service.beta.kubernetes.io/azure-load-balancer-health-probe-interval: "5"
    service.beta.kubernetes.io/azure-load-balancer-health-probe-num-of-probe: "2"
    service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: "/health"

    # Resource group (if different from cluster)
    # service.beta.kubernetes.io/azure-load-balancer-resource-group: "honua-rg"

    # Static IP (if pre-allocated)
    # service.beta.kubernetes.io/azure-load-balancer-ipv4: "20.XX.XX.XX"
spec:
  type: LoadBalancer
  selector:
    app.kubernetes.io/name: honua
    app.kubernetes.io/component: api
  ports:
    - name: https
      port: 443
      targetPort: 8080
      protocol: TCP
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP

---
# Azure Disk StorageClass (Premium SSD)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: managed-premium
  annotations:
    storageclass.kubernetes.io/is-default-class: "true"
provisioner: disk.csi.azure.com
parameters:
  skuName: Premium_LRS
  kind: Managed
  cachingMode: ReadOnly
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer

---
# Azure Disk StorageClass (Standard SSD)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: managed-standard
provisioner: disk.csi.azure.com
parameters:
  skuName: StandardSSD_LRS
  kind: Managed
  cachingMode: ReadOnly
reclaimPolicy: Delete
allowVolumeExpansion: true
volumeBindingMode: WaitForFirstConsumer

---
# Azure Files StorageClass (for shared storage)
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: azurefile-premium
provisioner: file.csi.azure.com
parameters:
  skuName: Premium_LRS
  protocol: nfs
  storageAccount: honuafilestorage  # Replace with your storage account
mountOptions:
  - dir_mode=0777
  - file_mode=0777
  - uid=1000
  - gid=1000
  - mfsymlinks
  - cache=strict
  - actimeo=30
allowVolumeExpansion: true

---
# Azure Workload Identity for API Service
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-api-sa
  namespace: honua
  annotations:
    azure.workload.identity/client-id: "CLIENT_ID_FOR_API"
    azure.workload.identity/tenant-id: "TENANT_ID"

---
# Azure Workload Identity for Intake Service
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-intake-sa
  namespace: honua
  annotations:
    azure.workload.identity/client-id: "CLIENT_ID_FOR_INTAKE"
    azure.workload.identity/tenant-id: "TENANT_ID"

---
# Azure Workload Identity for Orchestrator
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-orchestrator-sa
  namespace: honua
  annotations:
    azure.workload.identity/client-id: "CLIENT_ID_FOR_ORCHESTRATOR"
    azure.workload.identity/tenant-id: "TENANT_ID"

---
# Application Gateway Ingress Controller Configuration
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: honua-appgw-ingress
  namespace: honua
  annotations:
    kubernetes.io/ingress.class: azure/application-gateway
    appgw.ingress.kubernetes.io/ssl-redirect: "true"
    appgw.ingress.kubernetes.io/cookie-based-affinity: "true"
    appgw.ingress.kubernetes.io/connection-draining: "true"
    appgw.ingress.kubernetes.io/connection-draining-timeout: "30"
    appgw.ingress.kubernetes.io/backend-protocol: "http"
    appgw.ingress.kubernetes.io/backend-path-prefix: "/"
    cert-manager.io/cluster-issuer: "letsencrypt-prod"
spec:
  tls:
    - hosts:
        - api.honua.io
        - intake.honua.io
      secretName: honua-tls
  rules:
    - host: api.honua.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: honua-api
                port:
                  number: 8080
    - host: intake.honua.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: honua-intake
                port:
                  number: 8080

---
# Azure Monitor ConfigMap
apiVersion: v1
kind: ConfigMap
metadata:
  name: container-azm-ms-agentconfig
  namespace: kube-system
data:
  schema-version: v1
  config-version: ver1
  log-data-collection-settings: |-
    [log_collection_settings]
       [log_collection_settings.stdout]
          enabled = true
          exclude_namespaces = ["kube-system"]
       [log_collection_settings.stderr]
          enabled = true
          exclude_namespaces = ["kube-system"]
       [log_collection_settings.env_var]
          enabled = true
  prometheus-data-collection-settings: |-
    [prometheus_data_collection_settings.cluster]
        interval = "1m"
        monitor_kubernetes_pods = true
    [prometheus_data_collection_settings.node]
        interval = "1m"
