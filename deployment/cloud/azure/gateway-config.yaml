# Azure AKS Specific Configuration for YARP Gateway
# Apply these configurations when deploying YARP Gateway to Azure Kubernetes Service

---
# Azure Load Balancer for YARP Gateway
apiVersion: v1
kind: Service
metadata:
  name: honua-gateway
  namespace: honua
  labels:
    app.kubernetes.io/name: honua-gateway
    app.kubernetes.io/component: gateway
  annotations:
    # Azure Load Balancer Type
    service.beta.kubernetes.io/azure-load-balancer-internal: "false"

    # Load Balancer SKU (Standard recommended)
    service.beta.kubernetes.io/azure-load-balancer-sku: "standard"

    # Session persistence
    service.beta.kubernetes.io/azure-load-balancer-tcp-idle-timeout: "30"

    # Health probe settings
    service.beta.kubernetes.io/azure-load-balancer-health-probe-protocol: "http"
    service.beta.kubernetes.io/azure-load-balancer-health-probe-request-path: "/health/live"
    service.beta.kubernetes.io/azure-load-balancer-health-probe-interval: "30"
    service.beta.kubernetes.io/azure-load-balancer-health-probe-num-of-probe: "2"

    # Resource group (optional - for specific resource group)
    # service.beta.kubernetes.io/azure-load-balancer-resource-group: "honua-resources"

    # Public IP configuration
    service.beta.kubernetes.io/azure-pip-name: "honua-gateway-ip"
    service.beta.kubernetes.io/azure-dns-label-name: "honua-gateway"

    # Tags
    service.beta.kubernetes.io/azure-load-balancer-additional-tags: |
      Environment=production
      Application=honua
      Component=gateway

spec:
  type: LoadBalancer
  externalTrafficPolicy: Local  # Preserve source IP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800

  ports:
    - name: http
      port: 80
      targetPort: 8080
      protocol: TCP
    - name: https
      port: 443
      targetPort: 8443
      protocol: TCP

  selector:
    app.kubernetes.io/name: honua-gateway
    app.kubernetes.io/component: gateway

---
# Service Account with Azure Managed Identity
apiVersion: v1
kind: ServiceAccount
metadata:
  name: honua-gateway
  namespace: honua
  labels:
    app.kubernetes.io/name: honua-gateway
    app.kubernetes.io/component: gateway
  annotations:
    azure.workload.identity/client-id: "CLIENT_ID"
    azure.workload.identity/tenant-id: "TENANT_ID"

# Setup Azure Managed Identity:
# 1. Create managed identity:
#    az identity create --name honua-gateway --resource-group honua-resources
#
# 2. Get the identity details:
#    az identity show --name honua-gateway --resource-group honua-resources
#
# 3. Assign roles:
#    az role assignment create \
#      --assignee <PRINCIPAL_ID> \
#      --role "Monitoring Metrics Publisher" \
#      --scope /subscriptions/<SUBSCRIPTION_ID>/resourceGroups/honua-resources
#
# 4. Establish federated credential:
#    az identity federated-credential create \
#      --name honua-gateway-federated \
#      --identity-name honua-gateway \
#      --resource-group honua-resources \
#      --issuer <OIDC_ISSUER_URL> \
#      --subject system:serviceaccount:honua:honua-gateway

---
# Azure Application Gateway Ingress Controller (AGIC) Configuration
# Alternative to LoadBalancer service - provides L7 routing
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: honua-gateway-agic
  namespace: honua
  labels:
    app.kubernetes.io/name: honua-gateway
    app.kubernetes.io/component: gateway
  annotations:
    kubernetes.io/ingress.class: azure/application-gateway
    appgw.ingress.kubernetes.io/ssl-redirect: "true"
    appgw.ingress.kubernetes.io/connection-draining: "true"
    appgw.ingress.kubernetes.io/connection-draining-timeout: "30"
    appgw.ingress.kubernetes.io/request-timeout: "600"
    appgw.ingress.kubernetes.io/backend-path-prefix: "/"

    # WAF policy
    appgw.ingress.kubernetes.io/waf-policy-for-path: "/subscriptions/SUBSCRIPTION_ID/resourceGroups/honua-resources/providers/Microsoft.Network/applicationGatewayWebApplicationFirewallPolicies/honua-waf-policy"

    # Health probe
    appgw.ingress.kubernetes.io/health-probe-path: "/health/live"
    appgw.ingress.kubernetes.io/health-probe-status-codes: "200-399"
    appgw.ingress.kubernetes.io/health-probe-interval: "30"
    appgw.ingress.kubernetes.io/health-probe-timeout: "10"
    appgw.ingress.kubernetes.io/health-probe-unhealthy-threshold: "3"

spec:
  rules:
    - host: api.honua.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: honua-gateway
                port:
                  number: 8080

    - host: intake.honua.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: honua-gateway
                port:
                  number: 8080

    - host: orchestrator.honua.io
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: honua-gateway
                port:
                  number: 8080

  tls:
    - hosts:
        - api.honua.io
        - intake.honua.io
        - orchestrator.honua.io
      secretName: honua-tls-cert

---
# Azure Front Door Configuration (for global load balancing)
# Note: Front Door is configured via Azure Portal or ARM templates
# This is a reference configuration

# Example ARM template snippet:
# {
#   "type": "Microsoft.Network/frontDoors",
#   "apiVersion": "2020-05-01",
#   "name": "honua-frontdoor",
#   "location": "global",
#   "properties": {
#     "enabledState": "Enabled",
#     "frontendEndpoints": [
#       {
#         "name": "honua-api-frontend",
#         "properties": {
#           "hostName": "api.honua.io",
#           "sessionAffinityEnabledState": "Enabled"
#         }
#       }
#     ],
#     "backendPools": [
#       {
#         "name": "honua-gateway-pool",
#         "properties": {
#           "backends": [
#             {
#               "address": "honua-gateway.westus2.cloudapp.azure.com",
#               "httpPort": 80,
#               "httpsPort": 443,
#               "weight": 50,
#               "priority": 1,
#               "enabledState": "Enabled"
#             }
#           ],
#           "healthProbeSettings": {
#             "path": "/health/live",
#             "protocol": "Http",
#             "intervalInSeconds": 30
#           }
#         }
#       }
#     ]
#   }
# }

---
# Network Policy for AKS
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: honua-gateway-network-policy
  namespace: honua
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: honua-gateway
      app.kubernetes.io/component: gateway

  policyTypes:
    - Ingress
    - Egress

  ingress:
    # Allow incoming traffic from Azure Load Balancer
    - from:
        - ipBlock:
            cidr: 168.63.129.16/32  # Azure Load Balancer health probes
      ports:
        - protocol: TCP
          port: 8080

    # Allow traffic from within cluster
    - from:
        - podSelector: {}
      ports:
        - protocol: TCP
          port: 8080
        - protocol: TCP
          port: 8443
        - protocol: TCP
          port: 8081

  egress:
    # Allow outbound to backend services
    - to:
        - namespaceSelector:
            matchLabels:
              name: honua
      ports:
        - protocol: TCP
          port: 8080

    # Allow DNS
    - to:
        - namespaceSelector:
            matchLabels:
              name: kube-system
      ports:
        - protocol: UDP
          port: 53

    # Allow HTTPS for external services
    - ports:
        - protocol: TCP
          port: 443

    # Allow Azure services
    - to:
        - ipBlock:
            cidr: 169.254.169.254/32  # Azure Instance Metadata Service
      ports:
        - protocol: TCP
          port: 80

---
# Pod Identity Exception for Azure
apiVersion: "aadpodidentity.k8s.io/v1"
kind: AzurePodIdentityException
metadata:
  name: honua-gateway-exception
  namespace: honua
spec:
  podLabels:
    app.kubernetes.io/name: honua-gateway
    app.kubernetes.io/component: gateway
